<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Nexus AI - Hub de Herramientas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #0f172a;
            --secondary-bg: #1e293b;
            --card-bg: #1e293b;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 80px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: var(--secondary-bg);
            border-right: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-height: 80px;
            transition: padding 0.3s ease;
            flex-shrink: 0;
        }

        .sidebar.collapsed .sidebar-header {
            padding: 1.5rem 0.75rem;
            justify-content: center;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            transition: all 0.3s ease;
            letter-spacing: -0.5px;
        }

        .sidebar-brand {
            flex: 1;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .sidebar-brand {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        .sidebar-brand h1 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.125rem;
            letter-spacing: -0.3px;
        }

        .sidebar-brand p {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* User Info Styles */
        .sidebar-user-info {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            margin-top: auto;
            margin-bottom: 0;
            padding-bottom: 1rem;
            background: rgba(59, 130, 246, 0.05);
            flex-shrink: 0;
        }

        .sidebar.collapsed .sidebar-user-info {
            padding: 1rem 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            flex-shrink: 0;
        }

        .sidebar.collapsed .user-avatar {
            margin-bottom: 0.5rem;
            width: 36px;
            height: 36px;
            font-size: 0.8rem;
        }

        .user-details {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .user-details {
            opacity: 0;
            width: 0;
            height: 0;
            overflow: hidden;
        }

        .user-email {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: capitalize;
        }

        .user-role.admin {
            color: #f59e0b;
        }

        .user-role.analista_qa {
            color: #3b82f6;
        }

        .user-logout {
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 6px;
            color: #ef4444;
            font-size: 0.75rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            text-decoration: none;
            display: block;
        }

        .user-logout:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .sidebar.collapsed .user-logout {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            margin: 0.5rem auto 0;
        }

        .sidebar-expanded-only {
            display: block;
        }

        .sidebar.collapsed .sidebar-expanded-only {
            display: none;
        }

        .sidebar-collapsed-only {
            display: none;
        }

        .sidebar.collapsed .sidebar-collapsed-only {
            display: block;
        }

        .sidebar-toggle {
            position: absolute;
            top: 1rem;
            right: -20px;
            width: 40px;
            height: 40px;
            background: var(--accent);
            border: 3px solid var(--primary-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1003;
            color: white;
            font-size: 1.1rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
        }

        .sidebar-toggle:hover {
            background: var(--accent-hover);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .sidebar.collapsed .sidebar-toggle {
            transform: rotate(180deg);
        }

        .sidebar-nav {
            padding: 1rem 0;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .sidebar.collapsed .nav-item {
            padding: 1rem;
            justify-content: center;
            gap: 0;
        }

        .nav-item:hover {
            background: rgba(59, 130, 246, 0.1);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent);
            border-left: 3px solid var(--accent);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent);
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
            flex-shrink: 0;
            color: inherit;
        }

        .sidebar.collapsed .nav-icon {
            width: 20px;
            height: 20px;
            font-size: 1.1rem;
        }

        .sidebar.collapsed .nav-icon {
            width: 32px;
            height: 32px;
            font-size: 1.5rem;
        }

        .nav-text {
            flex: 1;
            font-weight: 500;
            opacity: 1;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .sidebar.collapsed .nav-text {
            opacity: 0;
            width: 0;
            max-width: 0;
            overflow: hidden;
            padding: 0;
            margin: 0;
            display: none;
        }

        /* Section Headers */
        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            padding: 0 1.5rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }

        .sidebar.collapsed .nav-section-title {
            opacity: 0;
            height: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* Estilos para acordeón multinivel - DEPRECADO, mantener por compatibilidad */
        .accordion-item {
            margin-bottom: 0.5rem;
            display: none;
        }

        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            user-select: none;
        }

        .sidebar.collapsed .accordion-header {
            padding: 1rem;
            justify-content: center;
            gap: 0;
        }

        .sidebar.collapsed .accordion-item.expanded .accordion-content {
            display: none;
        }

        .accordion-header:hover {
            background: rgba(59, 130, 246, 0.1);
            color: var(--text-primary);
        }

        .accordion-header.active {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent);
        }

        .accordion-header-content {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .sidebar.collapsed .accordion-header-content {
            gap: 0;
            justify-content: center;
        }

        .accordion-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .sidebar.collapsed .accordion-icon {
            width: 32px;
            height: 32px;
            font-size: 1.5rem;
        }

        .accordion-title {
            flex: 1;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .sidebar.collapsed .accordion-title {
            opacity: 0;
            width: 0;
            max-width: 0;
            overflow: hidden;
            padding: 0;
            margin: 0;
            display: none;
        }

        .accordion-arrow {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .sidebar.collapsed .accordion-arrow {
            opacity: 0;
            width: 0;
            max-width: 0;
            overflow: hidden;
            padding: 0;
            margin: 0;
            display: none;
        }

        .accordion-item.expanded .accordion-arrow {
            transform: rotate(90deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .accordion-item.expanded .accordion-content {
            max-height: 1000px;
        }

        .nav-item {
            padding: 0.75rem 1.5rem 0.75rem 3.5rem;
            font-size: 0.9rem;
        }

        .nav-item.active-link {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent);
            border-left: 3px solid var(--accent);
            font-weight: 600;
        }

        .nav-item.active-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            font-size: 1.1rem;
        }

        /* Main Content Area */
        .main-content {
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .sidebar.collapsed ~ .main-content {
            margin-left: var(--sidebar-collapsed-width);
        }

        .content-section {
            display: none;
            padding: 2rem;
            animation: fadeIn 0.3s ease-in;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .content-section.active {
            display: block;
        }

        /* Excepción para carga masiva que necesita flex */
        #jira-carga-masiva.content-section.active {
            display: flex !important;
        }

        /* Específico para la sección agent */
        #agent.content-section {
            padding: 0;
        }
        
        #agent.content-section.active {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 4rem);
            box-sizing: border-box;
            padding: 2rem;
            overflow: hidden;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dashboard Styles */
        .dashboard-header {
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .dashboard-subtitle {
            font-size: 1rem;
            color: var(--text-muted);
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .tool-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .tool-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.1);
        }

        .tool-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .tool-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tool-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
        }

        .tool-card.agent .tool-icon {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .tool-content h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .tool-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        .tool-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .tool-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .feature-tag {
            padding: 0.25rem 0.75rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            font-size: 0.75rem;
            color: var(--accent);
        }

        .tool-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .tool-version {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.05);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }

        .tool-action {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tool-action:hover {
            background: var(--accent-hover);
        }

        /* Agent Chat Styles */
        .agent-container {
            max-width: 1200px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1;
            min-height: 0;
            max-height: 100%;
        }

        .agent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .agent-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .help-guide-button {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .help-guide-button:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }

        /* Area Selector Styles */
        .area-selector-container {
            margin-bottom: 2rem;
            animation: fadeIn 0.3s ease;
            flex-shrink: 0;
        }

        .area-selector-card {
            background: var(--secondary-bg);
            border-radius: 8px;
            padding: 2rem;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .area-selector-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .area-selector-icon {
            font-size: 2rem;
        }

        .area-selector-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .area-selector-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .area-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .area-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            padding: 1.5rem;
            background: var(--bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
        }

        .area-option:hover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .area-option.selected {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.2);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .area-option-icon {
            font-size: 2.5rem;
        }

        .area-option-text {
            font-weight: 600;
        }

        .selected-area-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            border: 1px solid var(--accent);
            margin-top: 1rem;
        }

        .selected-area-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .selected-area-value {
            color: var(--accent);
            font-weight: 700;
            font-size: 1.1rem;
            flex: 1;
        }

        .change-area-btn {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .change-area-btn:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        /* Area Change Banner in Chat */
        .area-change-banner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: rgba(59, 130, 246, 0.1);
            border-bottom: 2px solid var(--accent);
            flex-shrink: 0;
            border-radius: 20px 20px 0 0;
        }

        .area-banner-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .area-banner-icon {
            font-size: 1.5rem;
        }

        .area-banner-text {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .area-banner-text strong {
            color: var(--accent);
            font-weight: 700;
        }

        .change-area-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .change-area-button:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .change-area-button:active {
            transform: translateY(0);
        }

        .change-icon {
            font-size: 1rem;
            animation: rotate-on-hover 2s ease-in-out infinite;
        }

        @keyframes rotate-on-hover {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }

        .agent-status {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .agent-status::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #ff6b6b;
            border-radius: 50%;
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-container {
            flex: 1;
            min-height: 0;
            max-height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .chat-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .messages {
            flex: 1;
            min-height: 0;
            max-height: 100%;
            padding: 2rem;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            max-width: 80%;
            animation: fadeIn 0.3s ease-out;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.agent {
            align-self: flex-start;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .user .avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .agent .avatar {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .message-content {
            background: var(--secondary-bg);
            padding: 1rem 1.5rem;
            border-radius: 18px;
            border: 1px solid var(--border);
        }

        .user .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
        }

        .agent .message-content {
            background: var(--secondary-bg);
            border-left: 4px solid #ff6b6b;
        }

        .message-text {
            color: var(--text-primary);
            line-height: 1.6;
            white-space: pre-line;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            display: block;
        }

        .input-area {
            padding: 1.5rem 2rem;
            background: var(--secondary-bg);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 10;
            width: 100%;
        }

        .file-upload-chat {
            background: rgba(255, 107, 107, 0.1);
            border: 2px dashed rgba(255, 107, 107, 0.3);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            min-width: 150px;
            max-width: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .file-upload-chat:hover {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.2);
        }

        .file-upload-text {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .file-upload-hint {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .message-input {
            flex: 1;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            min-height: 60px;
            max-height: 120px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .send-button {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .action-btn {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .action-btn:hover {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
        }

        .typing-indicator {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 18px;
            border: 1px solid var(--border);
            align-self: flex-start;
            max-width: fit-content;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #ff6b6b;
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing-bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Infografía Styles */
        .infografia-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }

        .chart-duo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
            width: 100%;
        }

        .chart-box {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1rem;
        }

        .chart-caption {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-muted);
        }

        .chart-box .chart-container {
            max-width: none;
            height: 260px;
            max-height: 320px;
            margin: 0;
        }

        /* Métricas Styles */
        .metricas-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .metricas-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .metricas-header h1 {
            margin: 0;
        }

        .metrics-header-actions {
            display: flex;
            gap: 1rem;
        }

        .download-metrics-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .download-metrics-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Filtros/Tabs de Métricas */
        .metrics-filters {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .metric-filter-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -0.5rem;
            transition: all 0.2s ease;
        }

        .metric-filter-btn:hover {
            color: var(--text-primary);
        }

        .metric-filter-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Secciones de Métricas */
        .metrics-section {
            display: none;
        }

        .metrics-section.active {
            display: block;
        }

        /* Métricas Jira */
        .jira-metrics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .jira-metric-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s ease;
        }

        .jira-metric-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .jira-metric-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            color: var(--accent);
            font-size: 1.5rem;
        }

        .jira-metric-content {
            flex: 1;
        }

        .jira-metric-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .jira-metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .jira-metrics-by-project {
            margin-top: 2rem;
        }

        .jira-metrics-subtitle {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .jira-project-metrics-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .jira-project-metric-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.2s ease;
        }

        .jira-project-metric-item:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .jira-project-metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .jira-project-metric-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .jira-project-metric-stats {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .jira-project-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .jira-project-stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .jira-project-stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 1rem;
        }

        /* Modal de Descarga de Métricas */
        .metrics-download-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .metrics-download-content {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .metrics-download-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .metrics-download-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .metrics-download-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.25rem;
            transition: all 0.2s ease;
            border-radius: 4px;
        }

        .metrics-download-close:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .metrics-download-body {
            padding: 1.5rem;
        }

        .metrics-download-checkbox {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .metrics-download-checkbox:hover {
            background: var(--secondary-bg);
        }

        .metrics-download-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .metrics-download-checkbox span {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .metrics-download-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* Notificación de Descarga */
        .download-notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            min-width: 280px;
            max-width: 400px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .download-notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .download-notification.success {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .download-notification.error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .download-notification-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .download-notification.loading .download-notification-icon {
            animation: spin 1s linear infinite;
        }

        .download-notification.success .download-notification-icon {
            color: #10b981;
        }

        .download-notification.error .download-notification-icon {
            color: #ef4444;
        }

        .download-notification-message {
            flex: 1;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .metricas-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .metricas-subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .metric-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.15);
            border-color: var(--accent);
        }

        .metric-card.stories {
            border-left: 4px solid #8b5cf6;
        }

        .metric-card.test-cases {
            border-left: 4px solid #10b981;
        }

        .metric-card.total {
            border-left: 4px solid #f59e0b;
        }

        .metric-card.reports-total {
            border-left: 4px solid #3b82f6;
        }

        .metric-card.reports-projects {
            border-left: 4px solid #8b5cf6;
        }

        .metric-card.reports-frequency {
            border-left: 4px solid #10b981;
        }

        .metric-card.uploads-total {
            border-left: 4px solid #3b82f6;
        }

        .metric-card.uploads-items {
            border-left: 4px solid #10b981;
        }

        .metric-card.uploads-projects {
            border-left: 4px solid #8b5cf6;
        }

        .metric-card.uploads-avg {
            border-left: 4px solid #f59e0b;
        }

        .metric-icon {
            width: 64px;
            height: 64px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .metric-card.stories .metric-icon {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .metric-card.test-cases .metric-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .metric-card.total .metric-icon {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .metric-card.reports-total .metric-icon {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .metric-card.reports-projects .metric-icon {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .metric-card.reports-frequency .metric-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .metric-card.uploads-total .metric-icon {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .metric-card.uploads-items .metric-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .metric-card.uploads-projects .metric-icon {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .metric-card.uploads-avg .metric-icon {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .metric-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .metric-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }

        .metrics-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
        }

        .reset-btn {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .reset-btn:hover {
            background: #ef4444;
            color: white;
            transform: translateY(-2px);
        }

        .metrics-history {
            margin-top: 3rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
        }

        .history-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-list {
            list-style: none;
        }

        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s ease;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .history-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .history-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 1.25rem;
        }

        .history-icon.reports {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .history-icon.uploads {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .history-icon.story {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .history-icon.test {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .history-icon.reports {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .history-icon.uploads {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .history-details {
            flex: 1;
        }

        .history-type {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .history-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .history-area {
            font-size: 0.85rem;
            color: var(--accent);
            font-weight: 500;
        }

        .history-date {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .metrics-chart-container {
            margin-top: 3rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Sobrescribir para reportes de Jira - debe ser 1rem como en el mockup */
        #jira-reportes .chart-title {
            font-size: 1rem !important;
            margin-bottom: 1rem;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            max-height: 400px;
        }

        #area-distribution-chart {
            max-height: 400px;
        }

        .history-count {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }

        /* Guía de Uso Styles */
        .guia-container {
            max-width: 1000px;
            margin: 0 auto;
            padding-bottom: 2rem;
        }

        /* Contenedor más ancho para reportes de Jira */
        #jira-reportes .guia-container {
            max-width: 1400px;
        }

        .guia-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        #jira-reportes .guia-header {
            text-align: center;
        }

        .guia-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .guia-subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
        }

        .guia-section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .guia-section:hover {
            border-color: var(--accent);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.1);
        }

        .guia-section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .guia-section-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
        }

        .guia-step {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: var(--secondary-bg);
            border-radius: 12px;
            border-left: 4px solid var(--accent);
        }

        .guia-step:last-child {
            margin-bottom: 0;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
            color: white;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        /* Estilos para Reportes de Jira */
        .jira-status-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .status-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-icon {
            font-size: 1.5rem;
        }

        .status-message {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .jira-section-title {
            margin-bottom: 2rem;
        }

        .jira-section-title h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .jira-section-title p {
            color: var(--text-muted);
            font-size: 1rem;
        }

        .back-button {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 1rem;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background: var(--card-bg);
            border-color: var(--accent);
        }

        .jira-project-selector-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .jira-selector-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }

        .jira-selector-dropdown-container {
            position: relative;
        }

        .combobox-wrapper {
            position: relative;
            width: 100%;
        }

        .jira-selector-dropdown,
        .combobox-input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            box-sizing: border-box;
        }

        .combobox-input {
            cursor: text;
            padding-right: 2.5rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23cbd5e1' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 12px;
            transition: all 0.2s ease;
        }

        .combobox-input:hover {
            border-color: var(--accent);
        }

        .combobox-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .combobox-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.25rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .combobox-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s ease;
        }

        .combobox-option:last-child {
            border-bottom: none;
        }

        .combobox-option:hover,
        .combobox-option.highlighted {
            background: var(--secondary-bg);
        }

        .combobox-option.no-results {
            color: var(--text-muted);
            cursor: default;
            font-style: italic;
        }

        .combobox-option.no-results:hover {
            background: transparent;
        }

        .loading-message, .error-message {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .error-message {
            color: var(--error);
        }
        
        /* Estilos para barra de progreso SSE */
        .metrics-progress {
            max-width: 600px;
            margin: 2rem auto;
            padding: 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--secondary-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            text-align: center;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
        }

        .metrics-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        /* Asegurar scroll en la sección de reportes */
        #jira-reportes.content-section.active {
            overflow-y: auto;
            overflow-x: hidden;
            height: calc(100vh - 4rem);
            max-height: calc(100vh - 4rem);
            box-sizing: border-box;
        }

        #jira-reportes .guia-content {
            min-height: auto;
            padding-bottom: 2rem;
        }

        /* Estilos para Carga Masiva de Jira */
        #jira-carga-masiva.content-section.active {
            overflow-y: auto;
            overflow-x: hidden;
            height: calc(100vh - 4rem);
            max-height: calc(100vh - 4rem);
            box-sizing: border-box;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .carga-masiva-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .carga-masiva-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .carga-masiva-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .carga-masiva-subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin: 0;
        }

        .carga-masiva-project-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .project-selector-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .project-icon {
            font-size: 1.25rem;
        }

        .project-label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .carga-masiva-dropdown {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23cbd5e1' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
            transition: all 0.2s ease;
            margin-bottom: 0.75rem;
        }

        .carga-masiva-dropdown:hover {
            border-color: var(--accent);
        }

        .carga-masiva-dropdown:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .carga-masiva-dropdown option {
            background: var(--secondary-bg);
            color: var(--text-primary);
            padding: 0.5rem;
        }

        .project-hint {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin: 0;
        }

        .csv-drop-zone {
            background: var(--card-bg);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 4rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
            position: relative;
        }

        .csv-drop-zone:hover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.05);
        }

        .csv-drop-zone.drag-over {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }

        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .drop-zone-icon {
            font-size: 4rem;
            margin-bottom: 0.5rem;
        }

        .drop-zone-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .drop-zone-hint {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin: 0;
        }

        .file-format-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }

        .file-icon {
            font-size: 1rem;
        }

        .file-info-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .file-info-content {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .file-info-icon {
            font-size: 1.5rem;
        }

        .file-name {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .remove-file-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .remove-file-btn:hover {
            background: var(--secondary-bg);
            color: var(--error);
        }

        .upload-csv-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-csv-btn:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .upload-csv-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upload-status-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .upload-status-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .upload-status-icon {
            font-size: 1.5rem;
        }

        .upload-status-message {
            font-size: 1rem;
            color: var(--text-primary);
        }

        .upload-status-card.success {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        /* Admin Panel Styles */
        #admin.content-section {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .admin-header {
            margin-bottom: 2rem;
        }

        .admin-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .admin-header p {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .admin-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .admin-stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s;
        }

        .admin-stat-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .admin-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .admin-stat-label {
            color: var(--text-muted);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .admin-filters {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .admin-filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .admin-filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .admin-filter-group label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-filter-group input,
        .admin-filter-group select {
            background: var(--primary-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .admin-filter-group input:focus,
        .admin-filter-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .admin-users-table {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .admin-table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-table-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-table-container {
            overflow-x: auto;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table thead {
            background: var(--primary-bg);
        }

        .admin-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .admin-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .admin-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .admin-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .admin-badge.admin {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .admin-badge.usuario {
            background: rgba(148, 163, 184, 0.2);
            color: #94a3b8;
        }

        .admin-badge.analista_qa {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .admin-badge.active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .admin-badge.inactive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .admin-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-btn-primary {
            background: var(--accent);
            color: white;
        }

        .admin-btn-primary:hover {
            background: var(--accent-hover);
        }

        .admin-btn-secondary {
            background: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .admin-btn-secondary:hover {
            border-color: var(--accent);
        }

        .admin-btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .admin-btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .admin-btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .admin-actions {
            display: flex;
            gap: 0.5rem;
        }

        .admin-loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .admin-empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .admin-empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .admin-debug-info {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-muted);
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .admin-debug-info strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        #admin-alert-container {
            margin-bottom: 1.5rem;
        }

        #admin-alert-container .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        #admin-alert-container .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        #admin-alert-container .alert-error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Step Indicator Styles */
        .steps-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow-x: auto;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            background: var(--secondary-bg);
            border: 2px solid var(--border);
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .step.active .step-number {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .step.completed .step-number {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .step.completed .step-number::after {
            content: '✓';
        }

        .step-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
        }

        .step.active .step-label {
            color: var(--text-primary);
        }

        .step-connector {
            flex: 1;
            height: 2px;
            background: var(--border);
            margin: 0 0.5rem;
            min-width: 20px;
        }

        .step.completed ~ .step-connector,
        .step.active ~ .step-connector {
            background: var(--accent);
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        /* Validation Summary */
        .validation-summary {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .validation-summary.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .validation-summary.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .validation-summary.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        /* Mapping Table */
        .mapping-table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .mapping-table {
            width: 100%;
            border-collapse: collapse;
        }

        .mapping-table th {
            background: var(--secondary-bg);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
            font-size: 0.9rem;
        }

        .mapping-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .mapping-table tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .csv-column {
            font-weight: 600;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .csv-sample {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 0.25rem;
        }

        .jira-field-select {
            width: 100%;
            background: var(--primary-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            color: var(--text-primary) !important;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .jira-field-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .jira-field-select option {
            background: var(--primary-bg);
            color: var(--text-primary) !important;
            padding: 0.5rem;
        }

        .field-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .required-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .mapping-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .status-valid {
            color: var(--success);
        }

        .status-warning {
            color: var(--warning);
        }

        .status-error {
            color: var(--error);
        }

        /* Actions Bar */
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-top: 2rem;
        }

        .actions-left, .actions-right {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Preview Table */
        .preview-table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .preview-table th {
            background: var(--secondary-bg);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .preview-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .preview-table tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-status-card.error {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .template-download-section {
            text-align: right;
            margin-top: 2rem;
        }

        .template-download-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent);
            text-decoration: none;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .template-download-link:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        .download-icon {
            font-size: 1rem;
        }

        .metrics-header {
            margin-bottom: 1.5rem;
        }

        .metrics-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metrics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .metric-value.success {
            color: var(--success);
        }

        .metric-value.warning {
            color: var(--warning);
        }

        .metric-value.error {
            color: var(--error);
        }

        .chart-container {
            height: 300px;
            margin-bottom: 2rem;
        }

        .breakdown-section {
            margin-top: 1.5rem;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--secondary-bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .breakdown-label {
            color: var(--text-secondary);
        }

        .breakdown-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Estilos para Reporte General */
        .general-report-container {
            margin-top: 2rem;
        }

        /* Estilos específicos para Reporte General - iguales al mockup */
        #jira-reportes .general-report-section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }

        /* Botón Personalizar */
        .customize-button {
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            font-weight: 600;
            position: fixed;
            top: 2rem;
            right: 16rem;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .customize-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5);
        }

        /* Modal de Personalización */
        .widget-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .widget-modal-overlay.active {
            display: flex;
        }

        .widget-modal-container {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .widget-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .widget-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .widget-modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .widget-modal-close:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .widget-modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .widget-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .widget-item {
            background: var(--secondary-bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .widget-item:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .widget-item.active {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .widget-item-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .widget-item-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        .widget-item-desc {
            color: var(--text-muted);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .widget-item-check {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .widget-item.active .widget-item-check {
            opacity: 1;
        }

        /* Widgets con botón de cierre */
        .widget-wrapper {
            position: relative;
            margin-bottom: 0.75rem;
        }

        .widget-close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            z-index: 10;
            transition: all 0.2s ease;
            opacity: 0;
        }

        .widget-wrapper:hover .widget-close-btn {
            opacity: 1;
        }

        .widget-close-btn:hover {
            background: #ef4444;
            transform: scale(1.1);
        }

        #jira-reportes .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        #jira-reportes .section-title-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
        }

        /* Estilos para pasos del flujo de reportes */
        .step-container {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--secondary-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .step-container.active {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .step-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .step-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        /* Sección de filtros */
        .filters-section {
            margin-top: 1.5rem;
        }

        /* Pestañas de Filtros por Tipo */
        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .filter-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -0.5rem;
            transition: all 0.2s ease;
            position: relative;
        }

        .filter-tab:hover {
            color: var(--text-primary);
        }

        .filter-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .filter-tab.test-case.active {
            color: #10b981;
            border-bottom-color: #10b981;
        }

        .filter-tab.bug.active {
            color: #ef4444;
            border-bottom-color: #ef4444;
        }

        .tab-icon {
            font-size: 1.1rem;
        }

        .tab-badge {
            background: var(--border);
            color: var(--text-muted);
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .filter-tab.active .tab-badge {
            background: var(--accent);
            color: white;
        }

        .filter-tab.test-case.active .tab-badge {
            background: #10b981;
        }

        .filter-tab.bug.active .tab-badge {
            background: #ef4444;
        }

        /* Contenido de Pestañas */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--primary-bg);
            border-radius: 8px;
            border-left: 4px solid var(--border);
        }

        .tab-content-header.test-case {
            border-left-color: #10b981;
        }

        .tab-content-header.bug {
            border-left-color: #ef4444;
        }

        .tab-content-header-icon {
            font-size: 1.25rem;
        }

        .tab-content-header-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* Filtros activos */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--primary-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-height: 50px;
        }

        /* Botón Generar Reporte */
        .generate-report-btn {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .generate-report-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .generate-report-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Botón Generar Nuevo Reporte */
        .new-report-btn {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .new-report-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Contenedor de filtros (oculto por defecto) */
        .filters-container {
            display: none;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
                padding: 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .filters-container.active {
            display: flex;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .filters-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .filters-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.25rem;
            transition: all 0.2s ease;
            border-radius: 4px;
        }

        .filters-close:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .add-filter-btn {
            background: rgba(59, 130, 246, 0.1);
            border: 1px dashed rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .add-filter-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .filter-item {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 0.75rem;
            align-items: end;
            padding: 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .filter-field-group,
        .filter-value-group {
            display: flex;
                flex-direction: column;
        }

        .filter-label {
            display: block;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .filter-field-select,
        .filter-value-input,
        .filter-value-select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .filter-field-select:hover,
        .filter-value-input:hover,
        .filter-value-select:hover {
            border-color: var(--accent);
        }

        .filter-field-select:focus,
        .filter-value-input:focus,
        .filter-value-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .filter-remove-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 0.625rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-remove-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }

        .filter-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            padding: 0.375rem 0.625rem;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .filter-badge.test-case {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .filter-badge.bug {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .filter-badge-type {
            font-weight: 600;
            font-size: 0.75rem;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
        }

        .filter-badge.test-case .filter-badge-type {
            background: #10b981;
            color: white;
        }

        .filter-badge.bug .filter-badge-type {
            background: #ef4444;
            color: white;
        }

        .filter-badge-remove {
            cursor: pointer;
            font-weight: bold;
            transition: color 0.2s ease;
            font-size: 0.9rem;
        }

        .filter-badge-remove:hover {
            color: #ef4444;
        }

        /* Botón de Descarga */
        .download-button {
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            font-weight: 600;
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .download-button.visible {
            display: inline-flex;
        }

        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5);
        }

        .download-dropdown {
            position: fixed;
            top: calc(2rem + 3.5rem);
            right: 2rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            min-width: 280px;
            z-index: 1001;
            display: none;
            overflow: hidden;
            animation: slideDown 0.2s ease;
        }

        .download-dropdown.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .download-option {
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
                gap: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .download-option:last-child {
            border-bottom: none;
        }

        .download-option:hover {
            background: var(--secondary-bg);
        }

        .download-option-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(59, 130, 246, 0.1);
        }

        .download-option-content {
            flex: 1;
        }

        .download-option-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .download-option-desc {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .download-option-arrow {
            color: var(--text-muted);
            font-size: 1.25rem;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-header {
            margin-bottom: 2.5rem;
        }

        .dashboard-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .dashboard-header p {
            color: var(--text-muted);
            font-size: 1rem;
            font-weight: 400;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .dashboard-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.2s ease;
        }

        .dashboard-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            color: var(--accent);
            font-size: 1.25rem;
        }

        .card-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.2px;
        }

        .card-description {
            color: var(--text-muted);
            font-size: 0.875rem;
            line-height: 1.6;
            margin-bottom: 1.25rem;
        }

        .card-action {
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--accent);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .card-action:hover {
            color: var(--accent-hover);
            gap: 0.5rem;
        }

        .card-action i {
            transition: transform 0.2s ease;
        }

        .card-action:hover i {
            transform: translateX(4px);
        }

        .dashboard-section {
            margin-top: 3rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            letter-spacing: -0.3px;
        }

        .quick-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .quick-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .quick-link:hover {
            background: rgba(59, 130, 246, 0.08);
            border-color: var(--accent);
            color: var(--text-primary);
            transform: translateX(4px);
        }

        .quick-link i {
            color: var(--accent);
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        /* Métricas Dashboard */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .metrics-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.2s ease;
        }

        .metrics-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .metrics-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .metrics-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            color: var(--accent);
            font-size: 1.25rem;
        }

        .metrics-card-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.2px;
        }

        .metrics-stats {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Asegurar que las tablas tengan el mismo estilo que el mockup */
        #jira-reportes .tables-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 2rem;
        }

        #jira-reportes .table-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
        }

        #jira-reportes .table-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .kpi-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }
        
        .kpi-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        
        .kpi-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .kpi-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            line-height: 1.2;
            text-align: center;
                width: 100%;
            word-wrap: break-word;
            hyphens: auto;
        }
        
        .kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            line-height: 1;
            text-align: center;
        }

        .middle-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Asegurar que middle-section use el mismo nombre que charts-section del mockup */
        #jira-reportes .middle-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            text-align: center;
        }

        #jira-reportes .chart-container {
            height: 300px;
            position: relative;
                width: 100%;
        }

        /* Asegurar que los contenedores de gráficas sean visibles */
        #jira-reportes .chart-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        #jira-reportes .chart-title {
            font-size: 1rem !important;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            text-align: center;
        }

        .defect-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

        .defect-metric-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
                padding: 1rem;
            text-align: center;
        }

        .defect-metric-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .defect-metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .tables-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .table-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .table-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .table-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 400px;
        }
        
        .table-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: var(--secondary-bg);
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        
        .report-table {
                width: 100%;
            border-collapse: collapse;
        }
        
        .report-table th {
            background: var(--primary-bg);
            color: var(--text-primary);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .report-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .report-table tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .report-table .total-row {
            background: var(--secondary-bg);
            font-weight: 600;
            position: sticky;
            bottom: 0;
            z-index: 5;
        }
        
        /* Paginación */
        .pagination {
            display: flex;
                justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .pagination-info {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .pagination-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .pagination-btn {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        
        .pagination-btn:hover:not(:disabled) {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-page {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .report-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .report-badge-success {
            background: #10b981;
            color: white;
        }

        .report-badge-warning {
            background: #f59e0b;
            color: white;
        }

        .report-badge-error {
            background: #ef4444;
            color: white;
        }

        .report-badge-low {
            background: #fbbf24;
            color: #1e293b;
        }

        .report-badge-major {
            background: #dc2626;
            color: white;
        }

        .report-badge-critical {
            background: #991b1b;
            color: white;
        }

        .jira-welcome-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .jira-welcome-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            margin: 0 auto 1.5rem;
            font-weight: bold;
        }

        .jira-welcome-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .jira-welcome-text {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }

        .step-description {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .step-list {
            list-style: none;
            padding-left: 0;
            margin-top: 0.75rem;
        }

        .step-list li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .step-list li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: 700;
        }

        .guia-tip {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-left: 4px solid var(--accent);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .guia-tip-title {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .guia-tip-text {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .guia-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-left: 4px solid var(--warning);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .guia-warning-title {
            font-weight: 600;
            color: var(--warning);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .guia-warning-text {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* Modal/Popup de Guía */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-container {
            background: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }

        .modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: var(--primary-bg);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Dropdown de Áreas */
        .area-dropdown-container {
            margin-top: 1rem;
        }

        .area-dropdown-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .area-dropdown {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23cbd5e1' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        .area-dropdown:hover {
            border-color: var(--accent);
            background-color: rgba(59, 130, 246, 0.05);
        }

        .area-dropdown:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .area-dropdown:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .area-dropdown option {
            background: var(--secondary-bg);
            color: var(--text-primary);
            padding: 0.5rem;
        }

        /* Scrollbar Styling */
        .sidebar::-webkit-scrollbar,
        .messages::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track,
        .messages::-webkit-scrollbar-track {
            background: var(--primary-bg);
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb,
        .messages::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .sidebar::-webkit-scrollbar-thumb:hover,
        .messages::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .sidebar-toggle {
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 1002;
            }

            .content-section {
                padding: 1rem;
            }

            .tools-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ========== FEEDBACK SECTION STYLES ========== */
        .feedback-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .feedback-header {
            margin-bottom: 2rem;
        }

        .feedback-header h1 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .feedback-header p {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .feedback-project-selection {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .feedback-project-selection h2 {
            color: var(--accent);
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-warning-message {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .feedback-warning-message i {
            color: var(--warning);
            font-size: 1.25rem;
        }

        .feedback-warning-message p {
            margin: 0;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .feedback-form-group {
            margin-bottom: 1.5rem;
        }

        .feedback-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        /* Combobox personalizado */
        .feedback-custom-select {
            position: relative;
            width: 100%;
        }

        .feedback-select-selected {
            background-color: var(--primary-bg);
            color: var(--text-secondary);
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .feedback-select-selected:hover {
            border-color: var(--accent);
            background-color: rgba(59, 130, 246, 0.05);
        }

        .feedback-select-selected.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .feedback-select-selected.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .feedback-select-arrow {
            transition: transform 0.3s ease;
        }

        .feedback-select-selected.active .feedback-select-arrow {
            transform: rotate(180deg);
        }

        .feedback-select-items {
            position: absolute;
            background-color: var(--primary-bg);
            top: 100%;
            left: 0;
            right: 0;
            z-index: 99;
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .feedback-select-items.show {
            display: block;
        }

        .feedback-select-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-select-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--text-primary);
        }

        .feedback-select-item.selected {
            background-color: rgba(59, 130, 246, 0.2);
            color: var(--accent);
            font-weight: 500;
        }

        .feedback-form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: var(--primary-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .feedback-form-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .feedback-form-group input::placeholder {
            color: var(--text-muted);
        }

        /* Formulario de feedback */
        .feedback-form {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .feedback-form h2 {
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-issue-type-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .feedback-issue-type-btn {
            flex: 1;
            padding: 1rem;
            border: 1px solid var(--border);
            background: var(--primary-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-secondary);
        }

        .feedback-issue-type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-color: var(--accent);
        }

        .feedback-issue-type-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .feedback-issue-type-btn.bug.active {
            background: var(--error);
            border-color: var(--error);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .feedback-issue-type-btn.task.active {
            background: var(--success);
            border-color: var(--success);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* Editor de texto enriquecido */
        .feedback-rich-text-editor {
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            background: var(--primary-bg);
        }

        .feedback-editor-toolbar {
            background: rgba(15, 23, 42, 0.5);
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .feedback-editor-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            background: var(--primary-bg);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .feedback-editor-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .feedback-editor-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .feedback-editor-content {
            min-height: 250px;
            padding: 1rem;
            background: var(--primary-bg);
            outline: none;
            color: var(--text-primary);
        }

        .feedback-editor-content:focus {
            background: rgba(15, 23, 42, 0.8);
        }

        .feedback-editor-content:empty:before {
            content: attr(data-placeholder);
            color: var(--text-muted);
        }

        .feedback-editor-content img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin: 10px 0;
        }

        /* Botones de acción */
        .feedback-action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }

        .feedback-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-btn-primary {
            background: var(--accent);
            color: white;
        }

        .feedback-btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .feedback-btn-secondary {
            background: var(--border);
            color: var(--text-secondary);
        }

        .feedback-btn-secondary:hover {
            background: #475569;
            color: var(--text-primary);
        }

        /* Estado deshabilitado */
        .feedback-form.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .feedback-no-project-message {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
            display: none;
        }

        .feedback-no-project-message i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
            color: var(--text-muted);
        }

        .feedback-no-project-message h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        /* Indicador de carga */
        .feedback-loading-indicator {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .feedback-loading-indicator.active {
            display: block;
        }

        .feedback-spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .feedback-loading-indicator p {
            color: var(--text-secondary);
        }

        /* Mensaje de éxito */
        .feedback-success-message {
            display: none;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--success);
        }

        .feedback-success-message.active {
            display: block;
        }

        .feedback-success-message h3 {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-success-message p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Responsive para Feedback */
        @media (max-width: 768px) {
            .feedback-issue-type-selector {
                flex-direction: column;
            }

            .feedback-action-buttons {
                flex-direction: column;
            }

            .feedback-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">N</div>
            <div class="sidebar-brand">
                    <h1>Nexus AI</h1>
                <p>Hub de Herramientas</p>
                </div>
            </div>
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar" style="flex-shrink: 0;">
            <i class="fas fa-chevron-left"></i>
        </button>
        <nav class="sidebar-nav" style="flex: 1; overflow-y: auto;">
            <!-- MENU Section -->
            <div class="nav-section">
                <div class="nav-section-title">MENU</div>
                
                <a href="#" class="nav-item" data-section="dashboard" data-route="/dashboard">
                    <span class="nav-icon"><i class="fas fa-home"></i></span>
                    <span class="nav-text">Dashboard</span>
                </a>
            </div>

            <!-- GENERADORES Section -->
            <div class="nav-section">
                <div class="nav-section-title">GENERADORES</div>
                
                <a href="#" class="nav-item" data-section="crear-historias">
                    <span class="nav-icon"><i class="fas fa-file-alt"></i></span>
                    <span class="nav-text">Crear Historias</span>
                </a>

                <a href="#" class="nav-item" data-section="crear-casos-prueba">
                    <span class="nav-icon"><i class="fas fa-vial"></i></span>
                    <span class="nav-text">Crear Casos de Prueba</span>
                </a>
            </div>

            <!-- MÉTRICAS Section -->
            <div class="nav-section">
                <div class="nav-section-title">MÉTRICAS</div>
                
                <a href="#" class="nav-item" data-section="metricas" data-route="/agente-ai/metricas">
                    <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
                    <span class="nav-text">Métricas</span>
                </a>

                <a href="#" class="nav-item" data-section="infografia" data-route="/agente-ai/beneficios">
                    <span class="nav-icon"><i class="fas fa-chart-bar"></i></span>
                    <span class="nav-text">Beneficios</span>
                </a>
            </div>

            <!-- JIRA Section -->
            <div class="nav-section">
                <div class="nav-section-title">JIRA</div>
                
                <a href="#" class="nav-item" data-section="jira-reportes" data-route="/jira/reportes">
                    <span class="nav-icon"><i class="fas fa-file-alt"></i></span>
                    <span class="nav-text">Reportes</span>
                </a>

                <a href="#" class="nav-item" data-section="jira-carga-masiva" data-route="/jira/carga-masiva">
                    <span class="nav-icon"><i class="fas fa-upload"></i></span>
                    <span class="nav-text">Carga Masiva</span>
                </a>
            </div>

            <!-- SOPORTE Section -->
            <div class="nav-section">
                <div class="nav-section-title">SOPORTE</div>
                
                <a href="#" class="nav-item" data-section="feedback" data-route="/feedback">
                    <span class="nav-icon"><i class="fas fa-comment-dots"></i></span>
                    <span class="nav-text">Feedback</span>
                </a>
            </div>

            <!-- ADMINISTRACIÓN Section (solo para admins) -->
            {% if user_info and user_info.role == 'admin' %}
            <div class="nav-section">
                <div class="nav-section-title">ADMINISTRACIÓN</div>
                
                <a href="#" class="nav-item" data-section="admin">
                    <span class="nav-icon"><i class="fas fa-shield-alt"></i></span>
                    <span class="nav-text">Panel Admin</span>
                </a>
            </div>
            {% endif %}
        </nav>
        
        <!-- User Info Section (al final del sidebar) -->
        {% if user_info %}
        <div class="sidebar-user-info">
            <div class="user-avatar">
                {{ user_info.email[0].upper() }}
            </div>
            <div class="user-details">
                <div class="user-email" title="{{ user_info.email }}">
                    {{ user_info.email }}
                </div>
                <div class="user-role {{ user_info.role }}">
                    <i class="fas fa-user-shield" style="font-size: 0.6rem;"></i>
                    {{ user_info.role }}
                </div>
            </div>
            <a href="/auth/logout" class="user-logout" title="Cerrar sesión">
                <span class="sidebar-expanded-only">Cerrar sesión</span>
                <span class="sidebar-collapsed-only"><i class="fas fa-sign-out-alt"></i></span>
            </a>
        </div>
        {% else %}
        <div class="sidebar-user-info">
            <a href="/auth/login" class="user-logout" style="background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.2); color: var(--accent);">
                <span class="sidebar-expanded-only">Iniciar sesión</span>
                <span class="sidebar-collapsed-only"><i class="fas fa-sign-in-alt"></i></span>
            </a>
        </div>
        {% endif %}
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="dashboard-container">
                <div class="dashboard-header">
                    <h1>Dashboard</h1>
                    <p>Bienvenido a Nexus AI Hub - Centro de control de herramientas</p>
                </div>

                <div class="dashboard-grid">
                    <!-- Quick Stats -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-file-alt card-icon"></i>
                            <h3>Crear Historias de Usuario</h3>
                        </div>
                        <p class="card-description">Genera historias de usuario completas a partir de documentos de requerimientos</p>
                        <a href="#" class="card-action" data-section="crear-historias">
                            <span>Ir a Generador</span>
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-vial card-icon"></i>
                            <h3>Crear Casos de Prueba</h3>
                        </div>
                        <p class="card-description">Genera una matriz completa de casos de prueba funcionales y no funcionales</p>
                        <a href="#" class="card-action" data-section="crear-casos-prueba">
                            <span>Ir a Generador</span>
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-file-alt card-icon"></i>
                            <h3>Reportes Jira</h3>
                        </div>
                        <p class="card-description">Visualiza métricas y genera reportes de tus proyectos Jira</p>
                        <a href="#" class="card-action" data-section="jira-reportes">
                            <span>Ver Reportes</span>
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-upload card-icon"></i>
                            <h3>Carga Masiva</h3>
                        </div>
                        <p class="card-description">Carga múltiples issues a Jira con mapeo de campos</p>
                        <a href="#" class="card-action" data-section="jira-carga-masiva">
                            <span>Iniciar Carga</span>
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-chart-line card-icon"></i>
                            <h3>Métricas</h3>
                        </div>
                        <p class="card-description">Analiza el rendimiento y productividad del equipo</p>
                        <a href="#" class="card-action" data-section="metricas">
                            <span>Ver Métricas</span>
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>

                <!-- Métricas de Uso -->
                <div class="dashboard-section">
                    <h2 class="section-title">Métricas de Uso</h2>
                    <div class="metrics-grid">
                        <!-- Métricas Generador H/CP -->
                        <div class="metrics-card">
                            <div class="metrics-card-header">
                                <i class="fas fa-robot metrics-icon"></i>
                                <h3>Generador H/CP</h3>
                            </div>
                            <div class="metrics-stats" id="generator-metrics">
                                <div class="stat-item">
                                    <span class="stat-value" id="generator-stories">0</span>
                                    <span class="stat-label">Historias Generadas</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value" id="generator-testcases">0</span>
                                    <span class="stat-label">Casos de Prueba</span>
                                </div>
                            </div>
                        </div>

                        <!-- Métricas Reportes Jira -->
                        <div class="metrics-card">
                            <div class="metrics-card-header">
                                <i class="fas fa-file-alt metrics-icon"></i>
                                <h3>Reportes Jira</h3>
                            </div>
                            <div class="metrics-stats" id="reports-metrics">
                                <div class="stat-item">
                                    <span class="stat-value" id="reports-count">0</span>
                                    <span class="stat-label">Reportes Generados</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value" id="reports-last">-</span>
                                    <span class="stat-label">Último Reporte</span>
                                </div>
                            </div>
                        </div>

                        <!-- Métricas Carga Masiva -->
                        <div class="metrics-card">
                            <div class="metrics-card-header">
                                <i class="fas fa-upload metrics-icon"></i>
                                <h3>Carga Masiva</h3>
                            </div>
                            <div class="metrics-stats" id="upload-metrics">
                                <div class="stat-item">
                                    <span class="stat-value" id="upload-count">0</span>
                                    <span class="stat-label">Cargas Realizadas</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value" id="upload-items">0</span>
                                    <span class="stat-label">Items Cargados</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>


        <!-- Infografía Section -->
        <section id="infografia" class="content-section">
            <div class="infografia-container">
                <header class="text-center my-12">
                    <h1 class="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500">Nexus AI</h1>
                    <p class="text-xl md:text-2xl text-slate-300 mt-4 max-w-3xl mx-auto">Hub de Herramientas inteligentes.</p>
        </header>

                <section id="introduction" class="my-16">
                    <div class="bg-slate-800 rounded-xl shadow-2xl p-8 md:p-12 text-center">
                        <p class="text-2xl text-slate-400 mb-4">La problemática: el tiempo perdido en tareas manuales de QA.</p>
                        <p class="text-7xl md:text-9xl font-extrabold text-amber-400">70-80%</p>
                        <p class="text-2xl md:text-3xl font-bold text-slate-200 mt-4">Reducción del tiempo dedicado a la documentación de pruebas.</p>
                        <p class="text-lg text-slate-300 mt-6 max-w-4xl mx-auto">Nexus AI ataca la mayor ineficiencia en los procesos de QA: la creación manual y repetitiva de historias de usuario y matrices de prueba. Al automatizar estas tareas, liberamos a los equipos para que se centren en lo que realmente aporta valor: la calidad del producto.</p>
            </div>
                </section>

                <section id="problem" class="my-16">
                    <h2 class="text-3xl font-bold text-center mb-8">Diagnóstico de la Productividad Actual</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div class="bg-slate-800 p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 text-center">Distribución del Tiempo del Equipo de QA</h3>
                            <div class="chart-container">
                                <canvas id="timeDistributionChart"></canvas>
                            </div>
                        </div>
                        <div class="text-slate-300">
                            <h3 class="text-2xl font-bold mb-4 text-slate-100">El Costo Oculto de la Ineficiencia</h3>
                            <p class="mb-4">Actualmente los equipos funcionales dedican una cantidad desproporcionada de su jornada a tareas de analisis y construcción de historias o casos de prueba. Este gráfico visualiza cómo la documentación manual consume la mayor parte del tiempo que podría invertirse en pruebas exploratorias o aun mas exahustivas.</p>
                            <ul class="list-disc list-inside space-y-2">
                                <li><span class="font-bold text-red-400">Inconsistencia y Errores:</span> La documentación manual es una fuente constante de errores humanos.</li>
                                <li><span class="font-bold text-yellow-400">Falta de Estandarización:</span> Dificulta la colaboración y el escalado de los equipos.</li>
                            </ul>
                    </div>
                    </div>
                </section>

                <section id="solution" class="my-16">
                    <h2 class="text-3xl font-bold text-center mb-8">La Solución: Arquitectura de Nexus AI</h2>
                    <p class="text-center text-slate-300 max-w-3xl mx-auto mb-10">Nexus AI se basa en una arquitectura moderna y escalable que garantiza un rendimiento robusto. El flujo de datos es seguro y eficiente, diseñado para procesar grandes volúmenes de información de manera rápida y fiable.</p>
                    <div class="bg-slate-800 p-8 rounded-lg shadow-xl">
                        <div class="flex flex-col md:flex-row justify-between items-center space-y-6 md:space-y-0 md:space-x-4 text-center">
                            <div class="flex flex-col items-center">
                                <div class="bg-sky-500 rounded-full w-24 h-24 flex items-center justify-center text-4xl shadow-lg">👤</div>
                                <p class="mt-2 font-bold">1. Usuario</p>
                                <p class="text-sm text-slate-400">Inicia el proceso</p>
                    </div>
                            <div class="text-3xl text-slate-500 font-thin">→</div>
                            <div class="flex flex-col items-center">
                                <div class="bg-indigo-500 rounded-full w-24 h-24 flex items-center justify-center text-4xl shadow-lg">🖥️</div>
                                <p class="mt-2 font-bold">2. Frontend</p>
                                <p class="text-sm text-slate-400">Carga de archivos</p>
                </div>
                            <div class="text-3xl text-slate-500 font-thin">→</div>
                            <div class="flex flex-col items-center">
                                <div class="bg-purple-500 rounded-full w-24 h-24 flex items-center justify-center text-4xl shadow-lg">⚙️</div>
                                <p class="mt-2 font-bold">3. Backend (Flask)</p>
                                <p class="text-sm text-slate-400">Procesa la petición</p>
            </div>
                            <div class="text-3xl text-slate-500 font-thin">→</div>
                            <div class="flex flex-col items-center">
                                <div class="bg-pink-500 rounded-full w-24 h-24 flex items-center justify-center text-4xl shadow-lg">🧠</div>
                                <p class="mt-2 font-bold">4. Google Gemini</p>
                                <p class="text-sm text-slate-400">Genera contenido</p>
                            </div>
                            <div class="text-3xl text-slate-500 font-thin">→</div>
                            <div class="flex flex-col items-center">
                                <div class="bg-emerald-500 rounded-full w-24 h-24 flex items-center justify-center text-4xl shadow-lg">📄</div>
                                <p class="mt-2 font-bold">5. Descarga</p>
                                <p class="text-sm text-slate-400">Obtiene el resultado</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="benefits" class="my-16">
                    <h2 class="text-3xl font-bold text-center mb-8">Beneficios Cuantificables y Métricas de Éxito</h2>
                    <p class="text-center text-slate-300 max-w-3xl mx-auto mb-10">La implementación de Nexus AI se traduce en mejoras medibles en todo el ciclo de desarrollo. Estos KPIs demuestran el impacto directo en la productividad, la calidad y la eficiencia del equipo.</p>
                    <div class="bg-slate-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Incremento de Productividad y Calidad</h3>
                        <div class="chart-container" style="height: 400px; max-height: 450px;">
                            <canvas id="productivityGainsChart"></canvas>
                        </div>
                    </div>
                </section>

                <section id="roadmap" class="my-16">
                    <h2 class="text-3xl font-bold text-center mb-8">Roadmap de Evolución: Crecimiento Continuo</h2>
                    <p class="text-center text-slate-300 max-w-3xl mx-auto mb-12">Nexus AI está diseñado para evolucionar. Nuestro roadmap asegura que la plataforma no solo resuelva los problemas actuales, sino que se anticipe a las necesidades futuras, integrándose cada vez más en el ecosistema de DevOps y QA.</p>
                    <div class="relative border-l-4 border-slate-700 ml-4 md:ml-0">
                        <div class="mb-10 ml-8">
                            <div class="absolute w-6 h-6 bg-amber-400 rounded-full -left-3.5 border-4 border-slate-900"></div>
                            <h3 class="text-xl font-bold text-amber-400">Fase 1: Implementación de herramientas con AI</h3>
                            <p class="text-slate-300 mt-1">Lanzamiento de las 2 herramientas clave: Story Creator y Matrix Generator.</p>
                        </div>
                        <div class="mb-10 ml-8">
                            <div class="absolute w-6 h-6 bg-amber-400 rounded-full -left-3.5 border-4 border-slate-900"></div>
                            <h3 class="text-xl font-bold text-amber-400">Fase 2: Mejoras (En Progreso - Actual)</h3>
                            <p class="text-slate-300 mt-1">Integración nativa con JIRA para carga masiva e integracion de reportes por proyecto</p>
                        </div>
                        <div class="ml-8">
                            <div class="absolute w-6 h-6 bg-slate-600 rounded-full -left-3.5 border-4 border-slate-900"></div>
                            <h3 class="text-xl font-bold text-slate-400">Fase 3: Expansión (12+ meses)</h3>
                            <p class="text-slate-300 mt-1">Automatización de Gherkin (BDD), generación de pruebas de rendimiento y análisis de código fuente para pruebas unitarias.</p>
                        </div>
                    </div>
                </section>

                <footer class="text-center mt-16 py-8 border-t border-slate-700">
                    <p class="text-slate-400">Nexus AI: Una Inversión Estratégica en Calidad, Productividad y Futuro.</p>
        </footer>
    </div>
        </section>

        <!-- Métricas Section -->
        <section id="metricas" class="content-section">
            <div class="metricas-container">
                <div class="metricas-header">
                    <h1 class="metricas-title">Métricas de Productividad</h1>
                    <p class="metricas-subtitle">Seguimiento completo de todas las herramientas y actividades</p>
                    <div class="metrics-header-actions">
                        <button class="download-metrics-btn" id="download-metrics-btn">
                            <i class="fas fa-download"></i>
                            <span>Descargar Métricas</span>
                        </button>
                    </div>
                </div>

                <!-- Filtros/Tabs de Métricas -->
                <div class="metrics-filters">
                    <button class="metric-filter-btn active" data-filter="generator">
                        <i class="fas fa-robot"></i>
                        <span>Generador H/CP</span>
                    </button>
                    <button class="metric-filter-btn" data-filter="jira-reports">
                        <i class="fas fa-file-alt"></i>
                        <span>Reportes Jira</span>
                    </button>
                    <button class="metric-filter-btn" data-filter="jira-uploads">
                        <i class="fas fa-upload"></i>
                        <span>Carga Masiva</span>
                    </button>
                </div>

                <!-- Contenedor de Métricas por Filtro -->
                <div id="metrics-content-wrapper">
                    <!-- Métricas Generador H/CP -->
                    <div class="metrics-section active" id="metrics-generator">
                        <div class="metrics-grid">
                            <div class="metric-card stories">
                                <div class="metric-icon"><i class="fas fa-file-alt"></i></div>
                                <div class="metric-label">Historias de Usuario</div>
                                <div class="metric-value" id="stories-count">0</div>
                                <div class="metric-description">Total de historias de usuario generadas</div>
                            </div>

                            <div class="metric-card test-cases">
                                <div class="metric-icon"><i class="fas fa-vial"></i></div>
                                <div class="metric-label">Casos de Prueba</div>
                                <div class="metric-value" id="test-cases-count">0</div>
                                <div class="metric-description">Total de casos de prueba generados</div>
                            </div>

                            <div class="metric-card total">
                                <div class="metric-icon"><i class="fas fa-chart-bar"></i></div>
                                <div class="metric-label">Total Generado</div>
                                <div class="metric-value" id="total-count">0</div>
                                <div class="metric-description">Suma de todas las generaciones</div>
                            </div>
                        </div>

                        <div class="metrics-actions">
                            {% if user_info and user_info.role == 'admin' %}
                            <button class="reset-btn" onclick="resetMetrics()">
                                <i class="fas fa-redo"></i>
                                <span>Reiniciar Métricas</span>
                            </button>
                            {% endif %}
                        </div>

                        <!-- Gráfico de distribución por área -->
                        <div class="metrics-chart-container">
                            <h2 class="chart-title">
                                <i class="fas fa-chart-pie"></i>
                                <span>Distribución de Solicitudes por Área</span>
                            </h2>
                            <div class="chart-wrapper">
                                <canvas id="area-distribution-chart"></canvas>
                            </div>
                        </div>

                        <div class="metrics-history">
                            <h2 class="history-title">
                                <i class="fas fa-history"></i>
                                <span>Historial de Generaciones</span>
                            </h2>
                            <ul class="history-list" id="history-list">
                                <li class="history-item" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                    No hay historial aún. Las generaciones aparecerán aquí.
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Métricas Reportes Jira -->
                    <div class="metrics-section" id="metrics-jira-reports">
                        <div class="metrics-grid">
                            <div class="metric-card reports-total">
                                <div class="metric-icon"><i class="fas fa-file-alt"></i></div>
                                <div class="metric-label">Total de Reportes</div>
                                <div class="metric-value" id="jira-reports-total">0</div>
                                <div class="metric-description">Reportes generados en total</div>
                            </div>

                            <div class="metric-card reports-projects">
                                <div class="metric-icon"><i class="fas fa-project-diagram"></i></div>
                                <div class="metric-label">Proyectos Reportados</div>
                                <div class="metric-value" id="jira-reports-projects-count">0</div>
                                <div class="metric-description">Cantidad de proyectos únicos</div>
                            </div>

                            <div class="metric-card reports-frequency">
                                <div class="metric-icon"><i class="fas fa-chart-line"></i></div>
                                <div class="metric-label">Frecuencia Semanal</div>
                                <div class="metric-value" id="jira-reports-weekly">0</div>
                                <div class="metric-description">Reportes en los últimos 7 días</div>
                            </div>
                        </div>

                        <!-- Gráfico de distribución por proyecto -->
                        <div class="metrics-chart-container">
                            <h2 class="chart-title">
                                <i class="fas fa-chart-pie"></i>
                                <span>Distribución de Reportes por Proyecto</span>
                            </h2>
                            <div class="chart-wrapper">
                                <canvas id="reports-by-project-chart"></canvas>
                            </div>
                        </div>

                        <!-- Gráfico de tendencia temporal -->
                        <div class="metrics-chart-container">
                            <h2 class="chart-title">
                                <i class="fas fa-chart-bar"></i>
                                <span>Tendencia de Reportes Generados</span>
                            </h2>
                            <div class="chart-wrapper">
                                <canvas id="reports-trend-chart"></canvas>
                            </div>
                        </div>

                        <!-- Métricas por Proyecto -->
                        <div class="jira-metrics-by-project">
                            <h3 class="jira-metrics-subtitle">
                                <i class="fas fa-project-diagram"></i>
                                <span>Métricas por Proyecto</span>
                            </h3>
                            <div id="jira-reports-by-project" class="jira-project-metrics-list">
                                <div class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <p>No hay reportes generados aún</p>
                                </div>
                            </div>
                        </div>

                        <!-- Historial de Reportes -->
                        <div class="metrics-history">
                            <h2 class="history-title">
                                <i class="fas fa-history"></i>
                                <span>Historial de Reportes Generados</span>
                            </h2>
                            <ul class="history-list" id="jira-reports-history-list">
                                <li class="history-item" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                    No hay historial aún. Los reportes aparecerán aquí.
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Métricas Carga Masiva -->
                    <div class="metrics-section" id="metrics-jira-uploads">
                        <div class="metrics-grid">
                            <div class="metric-card uploads-total">
                                <div class="metric-icon"><i class="fas fa-upload"></i></div>
                                <div class="metric-label">Total de Cargas</div>
                                <div class="metric-value" id="jira-uploads-total">0</div>
                                <div class="metric-description">Cargas masivas realizadas</div>
                            </div>

                            <div class="metric-card uploads-items">
                                <div class="metric-icon"><i class="fas fa-list"></i></div>
                                <div class="metric-label">Items Cargados</div>
                                <div class="metric-value" id="jira-uploads-items">0</div>
                                <div class="metric-description">Total de issues creados</div>
                            </div>

                            <div class="metric-card uploads-projects">
                                <div class="metric-icon"><i class="fas fa-project-diagram"></i></div>
                                <div class="metric-label">Proyectos con Carga</div>
                                <div class="metric-value" id="jira-uploads-projects-count">0</div>
                                <div class="metric-description">Proyectos únicos con cargas</div>
                            </div>

                            <div class="metric-card uploads-avg">
                                <div class="metric-icon"><i class="fas fa-calculator"></i></div>
                                <div class="metric-label">Promedio por Carga</div>
                                <div class="metric-value" id="jira-uploads-avg">0</div>
                                <div class="metric-description">Items promedio por carga</div>
                            </div>
                        </div>

                        <!-- Gráfico de distribución por tipo de issue -->
                        <div class="metrics-chart-container">
                            <h2 class="chart-title">
                                <i class="fas fa-chart-pie"></i>
                                <span>Distribución por Tipo de Issue</span>
                            </h2>
                            <div class="chart-wrapper">
                                <canvas id="uploads-by-type-chart"></canvas>
                            </div>
                        </div>

                        <!-- Gráfico de distribución por proyecto -->
                        <div class="metrics-chart-container">
                            <h2 class="chart-title">
                                <i class="fas fa-chart-bar"></i>
                                <span>Items Cargados por Proyecto</span>
                            </h2>
                            <div class="chart-wrapper">
                                <canvas id="uploads-by-project-chart"></canvas>
                            </div>
                        </div>

                        <!-- Gráfico de tendencia temporal -->
                        <div class="metrics-chart-container">
                            <h2 class="chart-title">
                                <i class="fas fa-chart-line"></i>
                                <span>Tendencia de Cargas Masivas</span>
                            </h2>
                            <div class="chart-wrapper">
                                <canvas id="uploads-trend-chart"></canvas>
                            </div>
                        </div>

                        <!-- Métricas por Proyecto -->
                        <div class="jira-metrics-by-project">
                            <h3 class="jira-metrics-subtitle">
                                <i class="fas fa-project-diagram"></i>
                                <span>Métricas por Proyecto</span>
                            </h3>
                            <div id="jira-uploads-by-project" class="jira-project-metrics-list">
                                <div class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <p>No hay cargas masivas realizadas aún</p>
                                </div>
                            </div>
                        </div>

                        <!-- Historial de Cargas -->
                        <div class="metrics-history">
                            <h2 class="history-title">
                                <i class="fas fa-history"></i>
                                <span>Historial de Cargas Masivas</span>
                            </h2>
                            <ul class="history-list" id="jira-uploads-history-list">
                                <li class="history-item" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                    No hay historial aún. Las cargas aparecerán aquí.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Jira - Carga Masiva Section -->
        <section id="jira-carga-masiva" class="content-section">
            <div class="carga-masiva-container">
                <div class="carga-masiva-header">
                    <h1>Carga Masiva de Issues</h1>
                    <p class="carga-masiva-subtitle">Mapea los campos de tu CSV a los campos de Jira antes de cargar</p>
                </div>

                <!-- Step Indicator -->
                <div class="steps-container" id="carga-masiva-steps">
                    <div class="step completed" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Proyecto</div>
                    </div>
                    <div class="step-connector"></div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">CSV</div>
                    </div>
                    <div class="step-connector"></div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Validar</div>
                    </div>
                    <div class="step-connector"></div>
                    <div class="step" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-label">Campos</div>
                    </div>
                    <div class="step-connector"></div>
                    <div class="step" data-step="5">
                        <div class="step-number">5</div>
                        <div class="step-label">Mapeo</div>
                    </div>
                <div class="step-connector"></div>
                <div class="step" data-step="6">
                    <div class="step-number">6</div>
                    <div class="step-label">Vista Previa</div>
                </div>
                <div class="step-connector"></div>
                <div class="step" data-step="7">
                    <div class="step-number">7</div>
                    <div class="step-label">Cargar</div>
                </div>
                </div>

                <!-- Step 1: Project Selection -->
                <div class="step-content active" id="step-1-content">
                    <div class="carga-masiva-project-card">
                        <div class="project-selector-header">
                            <span class="project-icon">📁</span>
                            <label class="project-label">Paso 1: Selecciona un Proyecto</label>
                        </div>
                        <div class="combobox-wrapper">
                            <input type="text" 
                                   id="carga-masiva-project-selector-input" 
                                   class="carga-masiva-dropdown combobox-input" 
                                   placeholder="🔍 Buscar o seleccionar proyecto..."
                                   autocomplete="off"
                                   oninput="filterCargaMasivaProjects(this.value)"
                                   onfocus="showCargaMasivaDropdown()"
                                   onblur="hideCargaMasivaDropdown()"
                                   onkeydown="handleCargaMasivaKeydown(event)">
                            <div id="carga-masiva-dropdown" class="combobox-dropdown" style="display: none;"></div>
                            <input type="hidden" id="carga-masiva-project-selector" value="">
                        </div>
                        <div id="carga-masiva-projects-loading" class="loading-message" style="display: none; margin-top: 1rem;">
                            <span>⏳ Cargando proyectos...</span>
                        </div>
                        <div id="carga-masiva-projects-error" class="error-message" style="display: none; margin-top: 1rem;">
                            <span>❌ Error al cargar proyectos</span>
                        </div>
                        <div id="carga-masiva-access-message" class="loading-message" style="display: none; margin-top: 1rem;"></div>
                        <p class="project-hint">Los campos disponibles se validarán después de cargar el CSV</p>
                    </div>
                </div>

                <!-- Step 2: CSV Upload -->
                <div class="step-content" id="step-2-content" style="display: none;">
                    <div class="carga-masiva-project-card">
                        <div class="project-selector-header">
                            <span class="project-icon">📄</span>
                            <label class="project-label">Paso 2: Carga tu Archivo CSV</label>
                        </div>
                        <div id="csv-drop-zone" class="csv-drop-zone">
                            <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
                            <div class="drop-zone-content">
                                <div class="drop-zone-icon">☁️</div>
                                <p class="drop-zone-text">Arrastra tu archivo CSV aquí</p>
                                <p class="drop-zone-hint">o haz clic para explorar tus archivos</p>
                                <div class="file-format-badge">
                                    <span class="file-icon">📄</span>
                                    <span>Formato soportado: .csv</span>
                                </div>
                            </div>
                        </div>
                        <div id="file-info" class="file-info-card" style="display: none;">
                            <div class="file-info-content">
                                <span class="file-info-icon">📎</span>
                                <span id="file-name" class="file-name"></span>
                                <button id="remove-file-btn" class="remove-file-btn">✕</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Validation -->
                <div class="step-content" id="step-3-content" style="display: none;">
                    <div class="carga-masiva-project-card">
                        <div class="project-selector-header">
                            <span class="project-icon">🔍</span>
                            <label class="project-label">Paso 3: Validación Automática</label>
                        </div>
                        <div id="validation-progress" style="text-align: center; padding: 3rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">⏳</div>
                            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">
                                Validando campos...
                            </div>
                            <div style="color: var(--text-muted); margin-bottom: 2rem;">
                                Comparando columnas del CSV con campos disponibles en Jira
                            </div>
                            <div id="validation-steps" style="background: var(--secondary-bg); border-radius: 8px; padding: 1.5rem; text-align: left; max-width: 600px; margin: 0 auto;">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Required and Optional Fields -->
                <div class="step-content" id="step-4-content" style="display: none;">
                    <div class="carga-masiva-project-card">
                        <div class="project-selector-header">
                            <span class="project-icon">📋</span>
                            <label class="project-label">Paso 4: Campos Requeridos y Opcionales</label>
                        </div>
                        <div id="validation-summary" class="validation-summary" style="display: none;"></div>
                        <div id="required-fields-section" style="margin-bottom: 2rem;"></div>
                        <div id="optional-fields-section" style="margin-bottom: 2rem;"></div>
                        <div id="unmapped-csv-columns" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);"></div>
                    </div>
                </div>

                <!-- Step 5: Field Mapping -->
                <div class="step-content" id="step-5-content" style="display: none;">
                    <div class="carga-masiva-project-card">
                        <div class="project-selector-header" style="justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span class="project-icon">🔗</span>
                                <label class="project-label">Paso 5: Ajuste Manual de Mapeo</label>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" id="save-mapping-btn" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                    💾 Guardar Mapeo
                                </button>
                                <button class="btn btn-secondary" id="load-mapping-btn" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                    📂 Cargar Mapeo
                                </button>
                            </div>
                        </div>
                        <div id="mapping-validation-summary" class="validation-summary" style="display: none;"></div>
                        <div id="mapping-table-container" class="mapping-table-container"></div>
                        
                        <!-- Configuración de Valores por Defecto integrada -->
                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                            <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                <span>⚙️</span>
                                <span>Configuración de Valores por Defecto</span>
                            </h3>
                            <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid var(--accent); border-radius: 8px; color: var(--text-secondary); font-size: 0.9rem;">
                                ℹ️ Configura valores por defecto para campos requeridos que no están en tu CSV o para campos opcionales que quieras establecer.
                            </div>
                            <div id="config-panel" class="config-grid"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 6: Preview -->
                <div class="step-content" id="step-6-content" style="display: none;">
                    <div class="carga-masiva-project-card">
                        <div class="project-selector-header">
                            <span class="project-icon">👁️</span>
                            <label class="project-label">Paso 6: Vista Previa</label>
                        </div>
                        <div id="preview-summary" style="margin-bottom: 1rem;"></div>
                        <div id="preview-table-container" class="preview-table-container"></div>
                    </div>
                </div>

                <!-- Step 7: Upload -->
                <div class="step-content" id="step-7-content" style="display: none;">
                    <div class="carga-masiva-project-card">
                        <div class="project-selector-header">
                            <span class="project-icon">🚀</span>
                            <label class="project-label">Paso 7: Cargar a Jira</label>
                        </div>
                        <div id="upload-final-status"></div>
                    </div>
                </div>

                <!-- Actions Bar -->
                <div class="actions-bar" id="carga-masiva-actions" style="display: none;">
                    <div class="actions-left">
                        <button class="btn btn-secondary" id="prev-step-btn">
                            ← Anterior
                        </button>
                    </div>
                    <div class="actions-right">
                        <button class="btn btn-secondary" id="revalidate-btn" style="display: none;">
                            🔄 Re-validar
                        </button>
                        <button class="btn btn-primary" id="upload-csv-btn" style="display: none;">
                            🚀 Cargar a Jira
                        </button>
                    </div>
                </div>

                <!-- Estado de carga -->
                <div id="upload-status" class="upload-status-card" style="display: none;">
                    <div class="upload-status-content">
                        <span id="upload-status-icon" class="upload-status-icon">⏳</span>
                        <span id="upload-status-message" class="upload-status-message">Procesando...</span>
                    </div>
                </div>

                <!-- Enlace para descargar plantilla -->
                <div class="template-download-section">
                    <a href="#" id="download-template-link" class="template-download-link">
                        <span class="download-icon">⬇️</span>
                        <span>Descargar plantilla de ejemplo</span>
                    </a>
                </div>
            </div>
        </section>

        <!-- Jira - Reportes Section -->
        <section id="jira-reportes" class="content-section">
            <div class="guia-container">
                <!-- Header (se oculta cuando hay reporte) -->
                <div class="guia-header" id="report-header">
                    <div>
                        <h1>Reportes de Jira</h1>
                        <p class="subtitle">Genera reportes personalizados con métricas de avance desde Jira</p>
                    </div>
                </div>

                <!-- Botón de descarga flotante (solo visible cuando hay reporte) -->
                <button class="download-button" id="download-button" onclick="toggleDownloadDropdown(event)">
                    <span>⬇</span>
                    <span>Descargar Reporte</span>
                </button>
                <div class="download-dropdown" id="download-dropdown">
                    <div class="download-option" onclick="downloadPDF()">
                        <div class="download-option-icon">📄</div>
                        <div class="download-option-content">
                            <div class="download-option-title">Descargar PDF</div>
                            <div class="download-option-desc">Exporta el reporte completo en formato PDF</div>
                        </div>
                        <div class="download-option-arrow">→</div>
                    </div>
                </div>

                <!-- Botón Personalizar -->
                <button class="customize-button" id="customize-button" onclick="openWidgetModal()" style="display: none;">
                    <span>⚙️</span>
                    <span>Personalizar</span>
                </button>

                <!-- Modal de Personalización -->
                <div class="widget-modal-overlay" id="widget-modal" onclick="closeWidgetModal(event)">
                    <div class="widget-modal-container" onclick="event.stopPropagation()">
                        <div class="widget-modal-header">
                            <div class="widget-modal-title">
                                <span>⚙️</span>
                                <span>Personalizar Reporte</span>
                            </div>
                            <button class="widget-modal-close" onclick="closeWidgetModal()">✕</button>
                        </div>
                        <div class="widget-modal-body">
                            <div class="widget-gallery" id="widget-gallery">
                                <!-- Los widgets se cargarán dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="guia-content">
                    <!-- Estado de conexión -->
                    <div id="jira-connection-status" class="jira-status-card" style="display: none;">
                        <div class="status-content">
                            <span id="connection-icon" class="status-icon">⏳</span>
                            <span id="connection-message" class="status-message">Verificando conexión...</span>
                        </div>
                    </div>

                    <!-- Selector de proyectos -->
                    <div id="jira-projects-section" style="display: none;">
                        <!-- Paso 1: Selección de Proyecto -->
                        <div class="step-container" id="step-1-container">
                            <div class="step-header">
                                <div class="step-number">1</div>
                                <div class="step-title">Selecciona un Proyecto</div>
                            </div>
                            <p class="step-description">Busca y selecciona el proyecto de Jira del cual deseas generar el reporte.</p>
                            
                            <div class="jira-project-selector-card">
                                <div class="jira-selector-dropdown-container">
                                    <div class="combobox-wrapper">
                                        <input type="text" 
                                               id="project-selector-input" 
                                               class="jira-selector-dropdown combobox-input" 
                                               placeholder="🔍 Buscar o seleccionar proyecto..."
                                               autocomplete="off"
                                               oninput="filterProjectOptions(this.value)"
                                               onfocus="showProjectDropdown()"
                                               onblur="hideProjectDropdown()"
                                               onkeydown="handleProjectKeydown(event)">
                                        <div id="project-dropdown" class="combobox-dropdown" style="display: none;"></div>
                                        <input type="hidden" id="project-selector" value="">
                                    </div>
                                </div>
                            </div>
                            
                            <div id="projects-loading" class="loading-message" style="display: none;">
                                <span>⏳ Cargando proyectos...</span>
                            </div>
                            <div id="projects-error" class="error-message" style="display: none;">
                                <span>❌ Error al cargar proyectos</span>
                            </div>
                        </div>

                        <!-- Paso 2: Configuración de Filtros -->
                        <div class="step-container" id="step-2-container" style="display: none;">
                            <div class="step-header">
                                <div class="step-number">2</div>
                                <div class="step-title">Configura los Filtros</div>
                            </div>
                            <p class="step-description">Aplica filtros específicos para Test Cases y Bugs. Cada tipo de issue puede tener sus propios filtros independientes.</p>
                            
                            <!-- Pestañas -->
                            <div class="filter-tabs">
                                <button class="filter-tab test-case active" onclick="switchFilterTab('test-case')">
                                    <span class="tab-icon">✅</span>
                                    <span>Filtros para Test Cases</span>
                                    <span class="tab-badge" id="test-case-filter-count">0</span>
                                </button>
                                <button class="filter-tab bug" onclick="switchFilterTab('bug')">
                                    <span class="tab-icon">🐛</span>
                                    <span>Filtros para Bugs</span>
                                    <span class="tab-badge" id="bug-filter-count">0</span>
                                </button>
                            </div>

                            <!-- Contenido: Test Cases -->
                            <div id="tab-test-case" class="tab-content active">
                                <div class="tab-content-header test-case">
                                    <span class="tab-content-header-icon">✅</span>
                                    <span class="tab-content-header-text">Configura filtros que se aplicarán únicamente a los Test Cases del reporte</span>
                                </div>
                                
                                <div class="filters-section">
                                    <div class="filters-grid" id="filters-grid-test-case">
                                        <!-- Los filtros se agregarán dinámicamente -->
                                    </div>

                                    <button class="add-filter-btn" onclick="addReportFilter('test-case')">
                                        <span>➕</span>
                                        <span>Agregar Otro Filtro</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Contenido: Bugs -->
                            <div id="tab-bug" class="tab-content">
                                <div class="tab-content-header bug">
                                    <span class="tab-content-header-icon">🐛</span>
                                    <span class="tab-content-header-text">Configura filtros que se aplicarán únicamente a los Bugs del reporte</span>
                                </div>
                                
                                <div class="filters-section">
                                    <div class="filters-grid" id="filters-grid-bug">
                                        <!-- Los filtros se agregarán dinámicamente -->
                                    </div>

                                    <button class="add-filter-btn" onclick="addReportFilter('bug')">
                                        <span>➕</span>
                                        <span>Agregar Otro Filtro</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Filtros Activos (Combinados) -->
                            <div class="active-filters" id="active-report-filters">
                                <div style="width: 100%; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-muted); font-weight: 600;">
                                    Filtros Activos:
                                </div>
                                <!-- Los badges se agregarán dinámicamente -->
                            </div>
                        </div>

                        <!-- Paso 3: Generar Reporte -->
                        <div class="step-container" id="step-3-container" style="display: none;">
                            <div class="step-header">
                                <div class="step-number">3</div>
                                <div class="step-title">Generar Reporte</div>
                            </div>
                            <p class="step-description">Una vez configurados los filtros, presiona el botón para generar el reporte con la información filtrada.</p>
                            
                            <button class="generate-report-btn" id="generate-report-btn" onclick="generateReportWithFilters()">
                                <span>📊</span>
                                <span>Generar Reporte</span>
                            </button>
                        </div>
                    </div>

                    <!-- Reporte de métricas -->
                    <div id="jira-report-section" style="display: none;">
                        <div class="jira-welcome-card">
                            <div class="jira-welcome-icon">✓</div>
                            <h2 class="jira-welcome-title">Bienvenido al Generador de Reportes de Jira</h2>
                            <p class="jira-welcome-text">Por favor, selecciona un proyecto del menú desplegable arriba para generar un nuevo reporte de pruebas.</p>
                            <p class="jira-welcome-text">Todos los datos del proyecto y del reporte son generados desde Jira en tiempo real.</p>
                        </div>
                        
                        <div id="metrics-loading" class="loading-message" style="display: none;">
                            <span>⏳ Generando reporte...</span>
                        </div>

                        <div id="metrics-content" style="display: none;">
                            <!-- Botón para generar nuevo reporte -->
                            <div style="margin-bottom: 1.5rem; display: flex; justify-content: flex-end;">
                                <button class="new-report-btn" onclick="showProjectsSection()">
                                    <span>🔄</span>
                                    <span>Generar Nuevo Reporte</span>
                                </button>
                            </div>
                            
                            <!-- Reporte General -->
                            <div id="general-report-section" class="general-report-section">
                                <div class="section-title" style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div class="section-title-icon">📈</div>
                                    <span>Reporte General</span>
                                </div>
                                
                                <!-- Top Section - Summary KPIs (7 tarjetas) -->
                                <div class="kpi-grid">
                                    <div class="kpi-card">
                                        <div class="kpi-icon">📋</div>
                                        <div class="kpi-label">Total Test Cases</div>
                                        <div class="kpi-value" id="gr-total-test-cases">0</div>
                                    </div>
                                    
                                    <div class="kpi-card">
                                        <div class="kpi-icon">✅</div>
                                        <div class="kpi-label">% Successful Test Cases</div>
                                        <div class="kpi-value" id="gr-successful-percentage">0%</div>
                                    </div>
                                    
                                    <div class="kpi-card">
                                        <div class="kpi-icon">📊</div>
                                        <div class="kpi-label">Real Coverage</div>
                                        <div class="kpi-value" id="gr-real-coverage">0%</div>
                                    </div>
                                    
                                    <div class="kpi-card">
                                        <div class="kpi-icon">🐛</div>
                                        <div class="kpi-label">Total Defects</div>
                                        <div class="kpi-value" id="gr-total-defects">0</div>
                                    </div>
                                    
                                    <div class="kpi-card">
                                        <div class="kpi-icon">📈</div>
                                        <div class="kpi-label">Defect Rate</div>
                                        <div class="kpi-value" id="gr-defect-rate">0%</div>
                                    </div>
                                    
                                    <div class="kpi-card">
                                        <div class="kpi-icon">🔓</div>
                                        <div class="kpi-label">Open Defects</div>
                                        <div class="kpi-value" id="gr-open-defects">0</div>
                                    </div>
                                    
                                    <div class="kpi-card">
                                        <div class="kpi-icon">🔒</div>
                                        <div class="kpi-label">Closed Defects</div>
                                        <div class="kpi-value" id="gr-closed-defects">0</div>
                                    </div>
                                </div>
                                
                                <!-- Middle Section - Solo gráficos -->
                                <div class="middle-section">
                                    <!-- Left: Test Cases Chart -->
                                    <div class="chart-card">
                                        <div class="chart-title">CASOS DE PRUEBA POR STATUS</div>
                                        <div class="chart-container">
                                            <canvas id="gr-test-cases-chart"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- Right: Bugs Chart -->
                                    <div class="chart-card">
                                        <div class="chart-title">BUGS POR SEVERIDAD (Abiertos)</div>
                                        <div class="chart-container">
                                            <canvas id="gr-bugs-severity-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Bottom Section - Tables con Scroll y Paginación -->
                                <div class="tables-section">
                                    <!-- Left Table: Test Cases per Person -->
                                    <div class="table-card">
                                        <div class="table-title"># Casos de prueba por persona</div>
                                        <div class="table-wrapper">
                                            <div class="table-container">
                                                <table class="report-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Asignado</th>
                                                            <th>Exitoso</th>
                                                            <th>En Progreso</th>
                                                            <th>Fallado</th>
                                                            <th>Total</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="gr-test-cases-table-body">
                                                        <!-- Se llena dinámicamente -->
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="pagination" id="test-cases-pagination">
                                                <div class="pagination-info">Mostrando 0-0 de 0 registros</div>
                                                <div class="pagination-controls">
                                                    <button class="pagination-btn" id="test-cases-prev" disabled>« Anterior</button>
                                                    <span class="pagination-page" id="test-cases-page">Página 1</span>
                                                    <button class="pagination-btn" id="test-cases-next" disabled>Siguiente »</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Right Table: Defects per Person -->
                                    <div class="table-card">
                                        <div class="table-title"># Defectos por Persona</div>
                                        <div class="table-wrapper">
                                            <div class="table-container">
                                                <table class="report-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Key</th>
                                                            <th>Asignado</th>
                                                            <th>Status</th>
                                                            <th>Summary</th>
                                                            <th>Severity</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="gr-defects-table-body">
                                                        <!-- Se llena dinámicamente -->
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="pagination" id="defects-pagination">
                                                <div class="pagination-info">Mostrando 0-0 de 0 registros</div>
                                                <div class="pagination-controls">
                                                    <button class="pagination-btn" id="defects-prev" disabled>« Anterior</button>
                                                    <span class="pagination-page" id="defects-page">Página 1</span>
                                                    <button class="pagination-btn" id="defects-next" disabled>Siguiente »</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Contenedor de Widgets Personalizados (se muestra debajo del reporte general) -->
                            <div id="widgets-container">
                                <!-- Los widgets se renderizarán aquí dinámicamente -->
                            </div>
                        </div>

                        <div id="metrics-error" class="error-message" style="display: none;">
                            <span>❌ Error al generar el reporte</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

        <!-- Admin Panel Section -->
        {% if user_info and user_info.role == 'admin' %}
        <section id="admin" class="content-section">
            <div class="admin-header">
                <h1><i class="fas fa-shield-alt"></i> Panel de Administración</h1>
                <p>Gestión de usuarios y configuración del sistema</p>
            </div>

            <div id="admin-alert-container"></div>

            <!-- Estadísticas -->
            <div class="admin-stats-grid" id="admin-stats-grid">
                <div class="admin-stat-card">
                    <div class="admin-stat-value" id="admin-stat-total">-</div>
                    <div class="admin-stat-label">Total Usuarios</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value" id="admin-stat-active">-</div>
                    <div class="admin-stat-label">Usuarios Activos</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value" id="admin-stat-inactive">-</div>
                    <div class="admin-stat-label">Usuarios Inactivos</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value" id="admin-stat-admins">-</div>
                    <div class="admin-stat-label">Administradores</div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="admin-filters">
                <div class="admin-filters-grid">
                    <div class="admin-filter-group">
                        <label for="admin-search-input"><i class="fas fa-search"></i> Buscar por email</label>
                        <input type="text" id="admin-search-input" placeholder="email@ejemplo.com">
                    </div>
                    <div class="admin-filter-group">
                        <label for="admin-role-filter"><i class="fas fa-user-tag"></i> Filtrar por rol</label>
                        <select id="admin-role-filter">
                            <option value="">Todos los roles</option>
                            <option value="admin">Administrador</option>
                            <option value="analista_qa">Analista QA</option>
                            <option value="usuario">Usuario</option>
                        </select>
                    </div>
                    <div class="admin-filter-group">
                        <label for="admin-status-filter"><i class="fas fa-toggle-on"></i> Estado</label>
                        <select id="admin-status-filter">
                            <option value="">Todos</option>
                            <option value="active">Activos</option>
                            <option value="inactive">Inactivos</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Tabla de usuarios -->
            <div class="admin-users-table">
                <div class="admin-table-header">
                    <h2><i class="fas fa-users"></i> Usuarios</h2>
                    <button class="admin-btn admin-btn-primary" onclick="adminLoadUsers()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                <div class="admin-table-container">
                    <div id="admin-loading" class="admin-loading" style="display: block;">
                        <i class="fas fa-spinner fa-spin"></i> Cargando usuarios...
                    </div>
                    <table id="admin-users-table" class="admin-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Creado</th>
                                <th>Último Login</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="admin-users-tbody">
                        </tbody>
                    </table>
                    <div id="admin-empty-state" class="admin-empty-state" style="display: none;">
                        <i class="fas fa-users-slash"></i>
                        <p>No se encontraron usuarios</p>
                    </div>
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Crear Historias Section -->
        <section id="crear-historias" class="content-section">
            <!-- Botón de regreso (oculto inicialmente) -->
            <!-- Formulario de generación (se oculta cuando se muestra vista previa) -->
            <div id="stories-form-container">
                <div id="stories-back-btn-container" style="display: none; margin-bottom: 1.5rem;">
                    <button id="stories-back-btn" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: var(--secondary-bg); border: 1px solid var(--border); color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.95rem; font-weight: 500;">
                        <span>←</span>
                        <span>Volver al Generador</span>
                    </button>
                </div>
                
                <div class="section-header" style="margin-bottom: 2rem;">
                    <h1><i class="fas fa-file-alt"></i> Crear Historias de Usuario</h1>
                    <p>Genera historias de usuario completas a partir de documentos de requerimientos. Incluye criterios de aceptación, reglas de negocio y prioridades.</p>
                </div>
            <div class="form-card" style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem;">
                <form id="stories-form">
                    <!-- Upload de archivo -->
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display: block; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">Documento de Requerimientos</label>
                        <div id="stories-drop-zone" class="csv-drop-zone">
                            <input type="file" id="stories-file" name="file" accept=".docx,.pdf" required style="display: none;">
                            <div class="drop-zone-content">
                                <div class="drop-zone-icon">☁️</div>
                                <p class="drop-zone-text">Arrastra tu archivo DOCX o PDF aquí</p>
                                <p class="drop-zone-hint">o haz clic para explorar tus archivos</p>
                                <div class="file-format-badge">
                                    <span class="file-icon">📄</span>
                                    <span>Formatos soportados: .docx, .pdf</span>
                                </div>
                            </div>
                        </div>
                        <div id="stories-file-info" class="file-info-card" style="display: none;">
                            <div class="file-info-content">
                                <span class="file-info-icon">📎</span>
                                <span id="stories-file-name" class="file-name"></span>
                                <button id="stories-remove-file-btn" class="remove-file-btn" type="button">✕</button>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <!-- Rol de usuario -->
                        <div class="form-group">
                            <label class="form-label" for="stories-role" style="display: block; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">Rol de usuario</label>
                            <select id="stories-role" name="role" class="form-select" style="width: 100%; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 12px; padding: 0.875rem 1.25rem; color: var(--text-primary); font-size: 0.95rem; transition: all 0.3s ease; font-family: inherit;">
                                <option value="Usuario">Usuario</option>
                                <option value="Administrador">Administrador</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <!-- Tipo de análisis -->
                        <div class="form-group">
                            <label class="form-label" for="stories-type" style="display: block; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">Tipo de análisis</label>
                            <select id="stories-type" name="story_type" class="form-select" style="width: 100%; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 12px; padding: 0.875rem 1.25rem; color: var(--text-primary); font-size: 0.95rem; transition: all 0.3s ease; font-family: inherit;">
                                <option value="funcionalidad">Historias Funcionales</option>
                                <option value="característica">Historias No Funcionales</option>
                            </select>
                        </div>

                        <!-- Área -->
                        <div class="form-group">
                            <label class="form-label" for="stories-area" style="display: block; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">Área</label>
                            <select id="stories-area" name="area" class="form-select" style="width: 100%; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 12px; padding: 0.875rem 1.25rem; color: var(--text-primary); font-size: 0.95rem; transition: all 0.3s ease; font-family: inherit;" required>
                                <option value="">-- Selecciona un área --</option>
                                <option value="Finanzas">💰 Finanzas</option>
                                <option value="Recursos Humanos">👥 Recursos Humanos</option>
                                <option value="Tesoreria">🏦 Tesorería</option>
                                <option value="TI">💻 TI</option>
                            </select>
                        </div>
                    </div>

                    <!-- Contexto adicional de negocio -->
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" for="stories-context" style="display: block; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            Contexto adicional de negocio
                            <span style="font-size: 0.8rem; color: var(--text-muted); font-weight: 400; background: rgba(107, 114, 128, 0.1); padding: 0.15rem 0.5rem; border-radius: 8px; margin-left: 0.5rem;">Opcional</span>
                        </label>
                        <textarea id="stories-context" name="business_context" class="form-textarea" style="width: 100%; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 12px; padding: 0.875rem 1.25rem; color: var(--text-primary); font-size: 0.95rem; transition: all 0.3s ease; font-family: inherit; min-height: 100px; resize: vertical; line-height: 1.6;"
                                  maxlength="2000"
                                  placeholder="Ejemplo: Tomar en cuenta la regla de negocio 3 sobre validación de usuarios premium, aplicar políticas de seguridad nivel 2, considerar integración con sistema de facturación..."></textarea>
                        <div class="char-counter" id="stories-context-counter" style="font-size: 0.8rem; color: var(--text-muted); text-align: right; margin-top: 0.25rem;">0 / 2000 caracteres</div>
                        <div style="background: rgba(79, 172, 254, 0.1); border: 1px solid rgba(79, 172, 254, 0.15); border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted); line-height: 1.5;">
                            💡 Este campo permite agregar contexto específico que complementará el análisis del documento. Puedes incluir reglas de negocio específicas, políticas empresariales, o cualquier consideración adicional que el generador debe tomar en cuenta al crear las historias de usuario.
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary" id="stories-generate-btn" style="width: 100%; padding: 1rem 2rem; border: none; border-radius: 12px; background: var(--accent); color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.95rem;">
                            <i class="fas fa-eye"></i> Generar e Ir a Vista Previa
                        </button>
                    </div>
                </form>
            </div>
            </div>

            <!-- Vista Previa de Historias (oculta inicialmente, reemplaza el formulario) -->
            <div id="stories-preview-section" style="display: none; margin-top: 2rem;">
                <!-- Header con estadísticas -->
                <div class="form-card" style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem 2rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem;">📋</span>
                        <span style="font-size: 1.5rem; font-weight: 600;">Vista Previa de Historias de Usuario</span>
                    </div>
                    <div style="display: flex; gap: 2rem; align-items: center;">
                        <div style="text-align: center;">
                            <div id="stories-preview-count" style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">0</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">Historias Generadas</div>
                        </div>
                    </div>
                </div>

                <!-- Barra de acciones -->
                <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="stories-select-all" style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Seleccionar todas</span>
                        </label>
                        <span id="stories-selected-count" style="color: var(--text-muted);">0 historias seleccionadas</span>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button id="stories-reset-btn" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: transparent; border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                            <span>🔄</span>
                            <span>Nueva Generación</span>
                        </button>
                        <button id="stories-review-btn" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: transparent; border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                            <span>👁️</span>
                            <span>Revisar Historias</span>
                        </button>
                        <button id="stories-upload-jira-btn" class="btn btn-primary" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: var(--accent); color: white; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                            <span>✅</span>
                            <span>Aprobar y Subir a Jira</span>
                        </button>
                    </div>
                </div>

                <!-- Tabla de vista previa -->
                <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                    <div style="overflow-x: auto; max-height: calc(100vh - 400px); min-height: 500px; overflow-y: auto;">
                        <table id="stories-preview-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; background: var(--secondary-bg); z-index: 10;">
                                <tr>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border); width: 50px;">
                                        <input type="checkbox" id="stories-table-select-all" style="width: 18px; height: 18px; cursor: pointer;">
                                    </th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border); width: 60px;">#</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border);">Resumen (Summary)</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border);">Descripción</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border); width: 120px;">Tipo</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border); width: 120px;">Prioridad</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border); width: 120px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="stories-preview-tbody">
                                <!-- Las historias se insertarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Feedback Section -->
        <section id="feedback" class="content-section">
            <div class="feedback-container">
                <!-- Page Header -->
                <div class="feedback-header">
                    <h1><i class="fas fa-comment-dots"></i> Feedback & Reportes</h1>
                    <p>Ayúdanos a mejorar reportando bugs o sugiriendo mejoras para Nexus AI</p>
                </div>

                <!-- Project Selection -->
                <div class="feedback-project-selection">
                    <h2><i class="fas fa-folder-open"></i> Seleccionar Proyecto</h2>
                    
                    <div class="feedback-warning-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p><strong>Importante:</strong> Se debe seleccionar el proyecto <strong>"Nexus AI (NA)"</strong> para enviar tu feedback. Si seleccionas otro proyecto, no podrás continuar.</p>
                    </div>

                    <div class="feedback-form-group">
                        <label for="feedback-project-select">Proyecto de Jira *</label>
                        <div class="combobox-wrapper">
                            <input type="text" 
                                   id="feedback-project-selector-input" 
                                   class="carga-masiva-dropdown combobox-input" 
                                   placeholder="🔍 Buscar o seleccionar proyecto..."
                                   autocomplete="off"
                                   oninput="filterFeedbackProjects(this.value)"
                                   onfocus="showFeedbackDropdown()"
                                   onblur="hideFeedbackDropdown()"
                                   onkeydown="handleFeedbackKeydown(event)">
                            <div id="feedback-dropdown" class="combobox-dropdown" style="display: none;">
                                <div class="combobox-option" style="color: var(--text-muted); cursor: default;">
                                    ⏳ Cargando proyectos...
                                </div>
                            </div>
                            <input type="hidden" id="feedback-project-selector" value="">
                        </div>
                    </div>
                </div>

                <!-- Success Message -->
                <div class="feedback-success-message" id="feedback-success-message">
                    <h3><i class="fas fa-check-circle"></i> ¡Feedback enviado exitosamente!</h3>
                    <p id="feedback-success-text">Tu reporte ha sido creado en Jira. Gracias por tu colaboración.</p>
                </div>

                <!-- No Project Message -->
                <div class="feedback-no-project-message" id="feedback-no-project-message">
                    <i class="fas fa-inbox"></i>
                    <h3>Selecciona un proyecto para comenzar</h3>
                    <p>Por favor, selecciona el proyecto <strong>"Nexus AI (NA)"</strong> en el selector de arriba para poder enviar tu feedback.</p>
                </div>

                <!-- Feedback Form -->
                <div class="feedback-form disabled" id="feedback-form">
                    <h2><i class="fas fa-edit"></i> Crear Reporte</h2>

                    <!-- Issue Type Selector -->
                    <div class="feedback-issue-type-selector">
                        <button class="feedback-issue-type-btn bug active" onclick="selectFeedbackIssueType('Bug')">
                            <i class="fas fa-bug"></i> Bug
                        </button>
                        <button class="feedback-issue-type-btn task" onclick="selectFeedbackIssueType('Task')">
                            <i class="fas fa-tasks"></i> Task
                        </button>
                    </div>

                    <!-- Summary -->
                    <div class="feedback-form-group">
                        <label for="feedback-summary"><i class="fas fa-heading"></i> Resumen (Summary) *</label>
                        <input 
                            type="text" 
                            id="feedback-summary" 
                            placeholder="Ej: Error al cargar historias de usuario"
                            maxlength="255"
                        >
                    </div>

                    <!-- Description with Rich Text Editor -->
                    <div class="feedback-form-group">
                        <label for="feedback-description"><i class="fas fa-align-left"></i> Descripción (Description) *</label>
                        <div class="feedback-rich-text-editor">
                            <div class="feedback-editor-toolbar">
                                <button class="feedback-editor-btn" onclick="formatFeedbackText('bold')" title="Negrita" type="button">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button class="feedback-editor-btn" onclick="formatFeedbackText('italic')" title="Cursiva" type="button">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button class="feedback-editor-btn" onclick="formatFeedbackText('underline')" title="Subrayado" type="button">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <button class="feedback-editor-btn" onclick="formatFeedbackText('insertUnorderedList')" title="Lista" type="button">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button class="feedback-editor-btn" onclick="formatFeedbackText('insertOrderedList')" title="Lista numerada" type="button">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                                <button class="feedback-editor-btn" onclick="insertFeedbackLink()" title="Insertar enlace" type="button">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button class="feedback-editor-btn" onclick="document.getElementById('feedback-image-upload').click()" title="Insertar imagen" type="button">
                                    <i class="fas fa-image"></i>
                                </button>
                                <input type="file" id="feedback-image-upload" accept="image/*" style="display: none;" onchange="insertFeedbackImage(event)">
                            </div>
                            <div 
                                class="feedback-editor-content" 
                                id="feedback-editor-content" 
                                contenteditable="true"
                                data-placeholder="Describe detalladamente el problema o la tarea..."
                            >
                            </div>
                        </div>
                        <small style="color: var(--text-muted); display: block; margin-top: 0.5rem; font-size: 0.85rem;">
                            <i class="fas fa-info-circle"></i> Puedes agregar formato, enlaces e imágenes a tu descripción
                        </small>
                    </div>

                    <!-- Action Buttons -->
                    <div class="feedback-action-buttons">
                        <button class="feedback-btn feedback-btn-secondary" onclick="resetFeedbackForm()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="feedback-btn feedback-btn-primary" onclick="submitFeedback()">
                            <i class="fas fa-paper-plane"></i> Enviar a Jira
                        </button>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div class="feedback-loading-indicator" id="feedback-loading-indicator">
                    <div class="feedback-spinner"></div>
                    <p>Enviando tu feedback a Jira...</p>
                </div>
            </div>
        </section>

        <!-- Modal: Configuración Jira para Subir Historias -->
        <div id="jira-upload-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                        <span>⚙️</span>
                        <span>Configurar Carga a Jira</span>
                    </div>
                    <button id="jira-modal-close" style="background: transparent; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.2s ease;">×</button>
                </div>
                <div style="padding: 1.5rem;">
                    <!-- Cantidad de historias -->
                    <div id="jira-modal-alert" style="padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; background: rgba(16, 185, 129, 0.2); border: 1px solid var(--success); color: #6ee7b7;">
                        <span>✅</span>
                        <span id="jira-modal-stories-count">0 historias seleccionadas para subir</span>
                    </div>

                    <!-- Proyecto de Jira -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Proyecto de Jira *</label>
                        <select id="jira-project-select" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;" required>
                            <option value="">Seleccionar proyecto...</option>
                        </select>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">Selecciona el proyecto donde se crearán las historias</div>
                    </div>

                    <!-- Asignado a -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Asignado a (opcional)</label>
                        <input type="email" id="jira-assignee-input" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;" placeholder="usuario@ejemplo.com">
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">Email del usuario de Jira al que se asignarán las historias</div>
                        <div id="jira-assignee-validation" style="display: none; margin-top: 0.5rem; font-size: 0.85rem;"></div>
                    </div>

                    <!-- Mapeo Automático de Campos -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Mapeo Automático de Campos</label>
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.9rem; font-weight: 600; color: var(--accent); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span>✅</span>
                                <span>Estos campos se mapean automáticamente:</span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem;">
                                <div style="display: flex; flex-direction: column; gap: 0.25rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.05); border-radius: 6px; word-wrap: break-word; overflow-wrap: break-word;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">Summary</span>
                                        <span style="color: var(--text-muted); font-size: 0.85rem;">→</span>
                                    </div>
                                    <span style="color: var(--text-secondary); font-size: 0.85rem;">Resumen</span>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.25rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.05); border-radius: 6px; word-wrap: break-word; overflow-wrap: break-word;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">Description</span>
                                        <span style="color: var(--text-muted); font-size: 0.85rem;">→</span>
                                    </div>
                                    <span style="color: var(--text-secondary); font-size: 0.85rem;">Descripción</span>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.25rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.05); border-radius: 6px; word-wrap: break-word; overflow-wrap: break-word;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">Issuetype</span>
                                        <span style="color: var(--text-muted); font-size: 0.85rem;">→</span>
                                    </div>
                                    <span style="color: var(--text-secondary); font-size: 0.85rem;">Tipo de Issue</span>
                                </div>
                            </div>
                            <div style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-muted); padding-top: 0.75rem; border-top: 1px solid rgba(59, 130, 246, 0.2);">
                                <strong>Nota:</strong> La prioridad se puede modificar desde la vista previa antes de subir.
                            </div>
                        </div>
                    </div>
                </div>
                <div style="padding: 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 1rem;">
                    <button id="jira-modal-cancel" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: transparent; border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; font-size: 0.95rem; font-weight: 500;">Cancelar</button>
                    <button id="jira-modal-upload" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: var(--success); color: white; cursor: pointer; font-size: 0.95rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                        <span>✅</span>
                        <span>Subir a Jira</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal: Revisar Historias HTML -->
        <div id="stories-review-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 2000; align-items: center; justify-content: center;">
            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; width: 95%; max-width: 1200px; height: 90vh; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                        <span>👁️</span>
                        <span>Vista Previa de Historias</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="downloadStoriesHTML()" style="padding: 0.5rem 1rem; border: none; border-radius: 6px; background: var(--accent); color: white; cursor: pointer; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                            <span>📥</span>
                            <span>Descargar HTML</span>
                        </button>
                        <button onclick="closeStoriesReview()" style="background: transparent; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.2s ease;">×</button>
                    </div>
                </div>
                <div style="flex: 1; overflow: hidden;">
                    <iframe id="stories-html-viewer" style="width: 100%; height: 100%; border: none; background: white;"></iframe>
                </div>
            </div>
        </div>

        <!-- Modal: Editar Historia -->
        <div id="edit-story-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 2000; align-items: center; justify-content: center;">
            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                        <span>✏️</span>
                        <span>Editar Historia de Usuario</span>
                    </div>
                    <button id="edit-story-modal-close" style="background: transparent; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.2s ease;">×</button>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; padding: 0.75rem; margin-bottom: 1.5rem; font-size: 0.85rem; color: #93c5fd; display: flex; align-items: center; gap: 0.5rem;">
                        💡 Puedes editar todos los campos de la historia. Los cambios se guardarán cuando presiones "Guardar Cambios".
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.95rem;">Resumen (Summary) *</label>
                        <input type="text" id="edit-story-summary" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;" placeholder="Ingresa el resumen de la historia">
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">Este será el título de la historia en Jira</div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.95rem;">Descripción *</label>
                        <textarea id="edit-story-description" rows="6" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem; resize: vertical; line-height: 1.6;" placeholder="Describe la historia en detalle..."></textarea>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">Incluye la descripción completa, criterios de aceptación y cualquier detalle relevante</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.95rem;">Tipo de Issue</label>
                            <select id="edit-story-issuetype" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;">
                                <option value="Story">Story</option>
                                <option value="Task">Task</option>
                                <option value="Bug">Bug</option>
                            </select>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.95rem;">Prioridad *</label>
                            <select id="edit-story-priority" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;">
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="padding: 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 1rem;">
                    <button id="edit-story-cancel" style="padding: 0.75rem 1.5rem; border: 1px solid var(--border); border-radius: 8px; background: transparent; color: var(--text-primary); cursor: pointer; font-size: 0.95rem; font-weight: 500;">Cancelar</button>
                    <button id="edit-story-save" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: var(--accent); color: white; cursor: pointer; font-size: 0.95rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                        <span>✅</span>
                        <span>Guardar Cambios</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="stories-loading-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.8); z-index: 2000; align-items: center; justify-content: center;">
            <div style="width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
        </div>

        <!-- Crear Casos de Prueba Section -->
        <section id="crear-casos-prueba" class="content-section">
            <div class="section-header" style="margin-bottom: 2rem;">
                <h1><i class="fas fa-vial"></i> Crear Casos de Prueba</h1>
                <p>Genera una matriz completa de casos de prueba funcionales y no funcionales basada en documentos de requerimientos y flujos específicos.</p>
            </div>

            <div class="form-card" style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem;">
                <form id="tests-form">
                    <!-- Upload de archivo -->
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display: block; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">Documento de Requerimientos</label>
                        <div id="tests-drop-zone" class="csv-drop-zone">
                            <input type="file" id="tests-file" name="file" accept=".docx,.pdf" required style="display: none;">
                            <div class="drop-zone-content">
                                <div class="drop-zone-icon">☁️</div>
                                <p class="drop-zone-text">Arrastra tu archivo DOCX o PDF aquí</p>
                                <p class="drop-zone-hint">o haz clic para explorar tus archivos</p>
                                <div class="file-format-badge">
                                    <span class="file-icon">📄</span>
                                    <span>Formatos soportados: .docx, .pdf</span>
                                </div>
                            </div>
                        </div>
                        <div id="tests-file-info" class="file-info-card" style="display: none;">
                            <div class="file-info-content">
                                <span class="file-info-icon">📎</span>
                                <span id="tests-file-name" class="file-name"></span>
                                <button id="tests-remove-file-btn" class="remove-file-btn" type="button">✕</button>
                            </div>
                        </div>
                    </div>

                    <!-- Área -->
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" for="tests-area" style="display: block; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">Área</label>
                        <select id="tests-area" name="area" class="form-select" style="width: 100%; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 12px; padding: 0.875rem 1.25rem; color: var(--text-primary); font-size: 0.95rem; transition: all 0.3s ease; font-family: inherit;" required>
                            <option value="">-- Selecciona un área --</option>
                            <option value="Finanzas">💰 Finanzas</option>
                            <option value="Recursos Humanos">👥 Recursos Humanos</option>
                            <option value="Tesoreria">🏦 Tesorería</option>
                            <option value="TI">💻 TI</option>
                        </select>
                    </div>

                    <!-- Contexto adicional -->
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" for="tests-context" style="display: block; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            Contexto adicional
                            <span style="font-size: 0.8rem; color: var(--text-muted); font-weight: 400; background: rgba(107, 114, 128, 0.1); padding: 0.15rem 0.5rem; border-radius: 8px; margin-left: 0.5rem;">Opcional</span>
                        </label>
                        <textarea id="tests-context" name="contexto" class="form-textarea" style="width: 100%; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 12px; padding: 0.875rem 1.25rem; color: var(--text-primary); font-size: 0.95rem; transition: all 0.3s ease; font-family: inherit; min-height: 100px; resize: vertical; line-height: 1.6;"
                                  placeholder="Describe brevemente el sistema, como 'Sistema de gestión de usuarios en un portal web'"></textarea>
                        <div style="background: rgba(79, 172, 254, 0.1); border: 1px solid rgba(79, 172, 254, 0.15); border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted); line-height: 1.5;">
                            💡 Proporciona información adicional sobre el contexto del sistema que ayudará a generar casos de prueba más precisos y relevantes.
                        </div>
                    </div>

                    <!-- Flujo a considerar -->
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" for="tests-flow" style="display: block; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            Flujo a considerar
                            <span style="font-size: 0.8rem; color: var(--text-muted); font-weight: 400; background: rgba(107, 114, 128, 0.1); padding: 0.15rem 0.5rem; border-radius: 8px; margin-left: 0.5rem;">Opcional</span>
                        </label>
                        <textarea id="tests-flow" name="flujo" class="form-textarea" style="width: 100%; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 12px; padding: 0.875rem 1.25rem; color: var(--text-primary); font-size: 0.95rem; transition: all 0.3s ease; font-family: inherit; min-height: 100px; resize: vertical; line-height: 1.6;"
                                  placeholder="Describe el flujo específico, como 'El usuario inicia sesión, ingresa sus credenciales y navega al panel principal'"></textarea>
                        <div style="background: rgba(79, 172, 254, 0.1); border: 1px solid rgba(79, 172, 254, 0.15); border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted); line-height: 1.5;">
                            💡 Describe el flujo de usuario o proceso específico que debe ser probado. Esto ayudará a generar casos de prueba más enfocados y detallados.
                        </div>
                    </div>

                    <!-- Tipo de prueba -->
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display: block; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">Tipo de prueba</label>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 12px; transition: all 0.3s ease;">
                                <input type="checkbox" id="tests-funcional" name="test_types" value="funcional" checked style="width: 20px; height: 20px; accent-color: var(--accent);">
                                <label for="tests-funcional" style="color: var(--text-secondary); font-weight: 500; cursor: pointer;">Pruebas Funcionales</label>
                            </div>
                            <div style="color: var(--text-muted); font-size: 0.85rem; margin-left: 2.75rem; margin-top: -0.5rem;">
                                Flujo principal, casos alternativos, validaciones, manejo de errores
                            </div>

                            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 12px; transition: all 0.3s ease;">
                                <input type="checkbox" id="tests-no-funcional" name="test_types" value="no_funcional" checked style="width: 20px; height: 20px; accent-color: var(--accent);">
                                <label for="tests-no-funcional" style="color: var(--text-secondary); font-weight: 500; cursor: pointer;">Pruebas No Funcionales</label>
                            </div>
                            <div style="color: var(--text-muted); font-size: 0.85rem; margin-left: 2.75rem; margin-top: -0.5rem;">
                                Rendimiento, seguridad, usabilidad, compatibilidad, confiabilidad
                            </div>
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary" id="tests-generate-btn" style="width: 100%; padding: 1rem 2rem; border: none; border-radius: 12px; background: var(--accent); color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.95rem;">
                            <i class="fas fa-eye"></i> Generar e Ir a Vista Previa
                        </button>
                    </div>
                </form>
            </div>

            <!-- Vista Previa de Casos de Prueba (oculta inicialmente, reemplaza el formulario) -->
            <div id="tests-preview-section" style="display: none; margin-top: 2rem;">
                <!-- Header con estadísticas -->
                <div class="form-card" style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem 2rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem;">🧪</span>
                        <span style="font-size: 1.5rem; font-weight: 600;">Vista Previa de Casos de Prueba</span>
                    </div>
                    <div style="display: flex; gap: 2rem; align-items: center;">
                        <div style="text-align: center;">
                            <div id="tests-preview-count" style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">0</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">Casos Generados</div>
                        </div>
                    </div>
                </div>

                <!-- Barra de acciones -->
                <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="tests-select-all" style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Seleccionar todos</span>
                        </label>
                        <span id="tests-selected-count" style="color: var(--text-muted);">0 casos seleccionados</span>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button id="tests-reset-btn" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: transparent; border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                            <span>🔄</span>
                            <span>Nueva Generación</span>
                        </button>
                        <button id="tests-review-btn" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: transparent; border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                            <span>👁️</span>
                            <span>Revisar Casos</span>
                        </button>
                        <button id="tests-upload-jira-btn" class="btn btn-primary" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: var(--accent); color: white; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                            <span>✅</span>
                            <span>Aprobar y Subir a Jira</span>
                        </button>
                    </div>
                </div>

                <!-- Tabla de vista previa -->
                <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                    <div style="overflow-x: auto; max-height: calc(100vh - 400px); min-height: 500px; overflow-y: auto;">
                        <table id="tests-preview-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; background: var(--secondary-bg); z-index: 10;">
                                <tr>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border); width: 50px;">
                                        <input type="checkbox" id="tests-table-select-all" style="width: 18px; height: 18px; cursor: pointer;">
                                    </th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border); width: 60px;">#</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border);">Resumen (Summary)</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border);">Descripción</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border); width: 120px;">Tipo</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border); width: 130px;">Tipo de Prueba</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border); width: 130px;">Categoría</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border); width: 120px;">Prioridad</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid var(--border); width: 120px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tests-preview-tbody">
                                <!-- Los casos de prueba se insertarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modal: Configuración Jira para Subir Casos de Prueba -->
        <div id="jira-upload-tests-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                        <span>⚙️</span>
                        <span>Configurar Carga a Jira</span>
                    </div>
                    <button id="jira-tests-modal-close" style="background: transparent; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.2s ease;">×</button>
                </div>
                <div style="padding: 1.5rem;">
                    <!-- Cantidad de casos -->
                    <div id="jira-tests-modal-alert" style="padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; background: rgba(16, 185, 129, 0.2); border: 1px solid var(--success); color: #6ee7b7;">
                        <span>✅</span>
                        <span id="jira-tests-modal-cases-count">0 casos seleccionados para subir</span>
                    </div>

                    <!-- Paso 1: Selección de proyecto y validación de campos -->
                    <div id="jira-tests-step1" style="display: block;">
                        <!-- Proyecto de Jira -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Proyecto de Jira *</label>
                            <select id="jira-tests-project-select" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;" required>
                                <option value="">Seleccionar proyecto...</option>
                            </select>
                            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">Selecciona el proyecto donde se crearán los casos de prueba</div>
                        </div>

                        <!-- Botón Validar Campos -->
                        <div style="margin-bottom: 1.5rem;">
                            <button id="jira-tests-validate-fields-btn" style="width: 100%; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: var(--accent); color: white; cursor: pointer; font-size: 0.95rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 0.5rem;" disabled>
                                <span>🔍</span>
                                <span>Validar Campos</span>
                            </button>
                        </div>

                        <!-- Resultado de validación -->
                        <div id="jira-tests-validation-result" style="display: none; margin-bottom: 1.5rem;">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>

                    <!-- Paso 1.5: Configuración de campos select (solo se muestra después de validar campos) -->
                    <div id="jira-tests-step1-5" style="display: none;">
                        <div style="padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span>ℹ️</span>
                                <span style="font-weight: 600; color: var(--accent);">Información importante</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                Los siguientes campos deben ser configurados manualmente ya que la AI no conoce los valores específicos de tu proyecto de Jira. Por favor, selecciona los valores correspondientes de las listas disponibles.
                            </div>
                        </div>

                        <!-- Tipo de Prueba -->
                        <div id="jira-tests-tipo-prueba-container" style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Tipo de Prueba *</label>
                            <select id="jira-tests-tipo-prueba-select" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;" required>
                                <option value="">Cargando valores...</option>
                            </select>
                            <div id="jira-tests-tipo-prueba-message" style="margin-top: 0.5rem; font-size: 0.85rem; display: none;"></div>
                        </div>

                        <!-- Nivel de Prueba -->
                        <div id="jira-tests-nivel-prueba-container" style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Nivel de Prueba *</label>
                            <select id="jira-tests-nivel-prueba-select" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;" required>
                                <option value="">Cargando valores...</option>
                            </select>
                            <div id="jira-tests-nivel-prueba-message" style="margin-top: 0.5rem; font-size: 0.85rem; display: none;"></div>
                        </div>

                        <!-- Tipo de Ejecución -->
                        <div id="jira-tests-tipo-ejecucion-container" style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Tipo de Ejecución *</label>
                            <select id="jira-tests-tipo-ejecucion-select" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;" required>
                                <option value="">Cargando valores...</option>
                            </select>
                            <div id="jira-tests-tipo-ejecucion-message" style="margin-top: 0.5rem; font-size: 0.85rem; display: none;"></div>
                        </div>

                        <!-- Ambiente -->
                        <div id="jira-tests-ambiente-container" style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Ambiente *</label>
                            <select id="jira-tests-ambiente-select" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;" required>
                                <option value="">Cargando valores...</option>
                            </select>
                            <div id="jira-tests-ambiente-message" style="margin-top: 0.5rem; font-size: 0.85rem; display: none;"></div>
                        </div>
                    </div>

                    <!-- Paso 2: Validación de assignado (solo se muestra después de validar campos) -->
                    <div id="jira-tests-step2" style="display: none;">
                        <!-- Asignado a -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Asignado a (opcional)</label>
                            <input type="email" id="jira-tests-assignee-input" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;" placeholder="usuario@ejemplo.com">
                            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">Email del usuario de Jira al que se asignarán los casos de prueba</div>
                            <div id="jira-tests-assignee-validation" style="display: none; margin-top: 0.5rem; font-size: 0.85rem;"></div>
                        </div>
                    </div>
                </div>
                <div style="padding: 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 1rem;">
                    <button id="jira-tests-modal-cancel" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: transparent; border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; font-size: 0.95rem; font-weight: 500;">Cancelar</button>
                    <button id="jira-tests-modal-upload" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: var(--success); color: white; cursor: pointer; font-size: 0.95rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem; display: none;">
                        <span>✅</span>
                        <span>Subir a Jira</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay para Tests -->
        <div id="tests-loading-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.8); z-index: 2000; align-items: center; justify-content: center;">
            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; text-align: center; max-width: 400px;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">⏳</div>
                <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Subiendo casos de prueba a Jira...</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Por favor espera, esto puede tomar unos momentos</div>
            </div>
        </div>

        <!-- Modal: Revisar Casos de Prueba HTML -->
        <div id="tests-review-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 2000; align-items: center; justify-content: center;">
            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; width: 95%; max-width: 1200px; height: 90vh; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                        <span>👁️</span>
                        <span>Vista Previa de Casos de Prueba</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="downloadTestsHTML()" style="padding: 0.5rem 1rem; border: none; border-radius: 6px; background: var(--accent); color: white; cursor: pointer; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                            <span>📥</span>
                            <span>Descargar HTML</span>
                        </button>
                        <button onclick="closeTestsReview()" style="background: transparent; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.2s ease;">×</button>
                    </div>
                </div>
                <div style="flex: 1; overflow: hidden;">
                    <iframe id="tests-html-viewer" style="width: 100%; height: 100%; border: none; background: white;"></iframe>
                </div>
            </div>
        </div>

        <!-- Modal: Editar Caso de Prueba -->
        <div id="edit-test-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 2000; align-items: center; justify-content: center;">
            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                        <span>✏️</span>
                        <span>Editar Caso de Prueba</span>
                    </div>
                    <button id="edit-test-modal-close" style="background: transparent; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.2s ease;">×</button>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; padding: 0.75rem; margin-bottom: 1.5rem; font-size: 0.85rem; color: #93c5fd; display: flex; align-items: center; gap: 0.5rem;">
                        💡 Puedes editar todos los campos del caso de prueba. Los cambios se guardarán cuando presiones "Guardar Cambios".
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.95rem;">Resumen (Summary) *</label>
                        <input type="text" id="edit-test-summary" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;" placeholder="Ingresa el resumen del caso de prueba">
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">Este será el título del caso de prueba en Jira</div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.95rem;">Descripción *</label>
                        <textarea id="edit-test-description" rows="6" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem; resize: vertical; line-height: 1.6;" placeholder="Describe el caso de prueba en detalle..."></textarea>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">Incluye los pasos a seguir y el resultado esperado</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.95rem;">Prioridad *</label>
                            <select id="edit-test-priority" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;">
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.95rem;">Categoría</label>
                            <input type="text" id="edit-test-categoria" style="width: 100%; padding: 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem;" placeholder="Ingresa la categoría">
                        </div>
                    </div>
                </div>
                <div style="padding: 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 1rem;">
                    <button id="edit-test-cancel" style="padding: 0.75rem 1.5rem; border: 1px solid var(--border); border-radius: 8px; background: transparent; color: var(--text-primary); cursor: pointer; font-size: 0.95rem; font-weight: 500;">Cancelar</button>
                    <button id="edit-test-save" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: var(--accent); color: white; cursor: pointer; font-size: 0.95rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                        <span>✅</span>
                        <span>Guardar Cambios</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Helper function to get CSRF token
        function getCsrfToken() {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            return metaTag ? metaTag.getAttribute('content') : '';
        }

        // Accordion Management System - DEPRECADO (ya no hay acordeón)
        function toggleAccordion(accordionItem) {
            // Función deprecada - ya no hay acordeón, pero se mantiene por compatibilidad
        }

        function expandAccordionForSection(sectionId) {
            // Función deprecada - ya no hay acordeón, pero se mantiene por compatibilidad
        }

        // SPA Navigation System
        async function navigateToSection(sectionId) {
            // Limpiar reporte si se está saliendo de jira-reportes
            const currentSection = document.querySelector('.content-section.active');
            if (currentSection && currentSection.id === 'jira-reportes' && sectionId !== 'jira-reportes') {
                clearJiraReport();
            }
            
            // Limpiar carga masiva si se está saliendo de carga-masiva
            if (currentSection && currentSection.id === 'carga-masiva' && sectionId !== 'carga-masiva') {
                resetCargaMasiva();
            }

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // Update active nav item (usar active-link en lugar de active)
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active-link', 'active');
            });

            const activeNav = document.querySelector(`[data-section="${sectionId}"]`);
            if (activeNav) {
                activeNav.classList.add('active-link');
                
                // Inicializar reportes si se navega a jira-reportes
                if (sectionId === 'jira-reportes') {
                    initJiraReports();
                }
                
                // Inicializar carga masiva si se navega a jira-carga-masiva
                if (sectionId === 'jira-carga-masiva') {
                    initCargaMasiva();
                }

                // Cargar métricas del dashboard si se navega al dashboard
                if (sectionId === 'dashboard') {
                    await loadDashboardMetrics();
                }
            }

            // Initialize charts if navigating to infografia
            if (sectionId === 'infografia') {
                setTimeout(() => {
                    initializeCharts();
                }, 100);
            }

            // Load metrics if navigating to metricas
            if (sectionId === 'metricas') {
                setTimeout(() => {
                    loadAllMetrics();
                }, 100);
            }

            // Load admin panel if navigating to admin
            if (sectionId === 'admin') {
                setTimeout(() => {
                    adminInitPanel();
                }, 100);
            }

            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Metrics Management System
        // ============================================
        // MÉTRICAS DEL BACKEND - Filtradas por rol
        // ============================================
        
        async function getMetrics() {
            try {
                const response = await fetch('/api/dashboard/activity-metrics', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.error('Error al obtener métricas:', response.status);
                    return { stories: 0, testCases: 0, history: [] };
                }
                
                const data = await response.json();
                if (data.success) {
                    // Obtener historial de historias y casos de prueba
                    const storiesHistory = await getStoriesHistory();
                    const testCasesHistory = await getTestCasesHistory();
                    
                    return {
                        stories: data.metrics.stories_generated || 0,
                        testCases: data.metrics.test_cases_generated || 0,
                        history: [...storiesHistory, ...testCasesHistory].sort((a, b) => 
                            new Date(b.date) - new Date(a.date)
                        ).slice(0, 50)
                    };
                }
                
                return { stories: 0, testCases: 0, history: [] };
            } catch (error) {
                console.error('Error al obtener métricas:', error);
                return { stories: 0, testCases: 0, history: [] };
            }
        }

        async function getStoriesHistory() {
            try {
                const response = await fetch('/api/dashboard/stories?limit=50', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) return [];
                
                const data = await response.json();
                if (data.success && data.stories) {
                    // NO agrupar - cada registro ya representa una generación completa
                    // El backend guarda 1 registro con TODAS las historias generadas
                    // El conteo real está en story_content (JSON con array de historias)
                    
                    return data.stories.map(story => {
                        // Parsear story_content para obtener el conteo real
                        let count = 1;
                        try {
                            const stories = JSON.parse(story.story_content);
                            count = Array.isArray(stories) ? stories.length : 1;
                        } catch (e) {
                            console.warn('Error al parsear story_content:', e);
                        }
                        
                        return {
                            type: 'stories',
                            count: count,  // Conteo real de historias en el JSON
                            area: story.area || 'Sin Área',  // Usar campo area
                            date: story.created_at,
                            timestamp: new Date(story.created_at).getTime()
                        };
                    }).sort((a, b) => b.timestamp - a.timestamp).slice(0, 25);
                }
                
                return [];
            } catch (error) {
                console.error('Error al obtener historial de historias:', error);
                return [];
            }
        }

        async function getTestCasesHistory() {
            try {
                const response = await fetch('/api/dashboard/test-cases?limit=50', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) return [];
                
                const data = await response.json();
                if (data.success && data.test_cases) {
                    // NO agrupar - cada registro ya representa una generación completa
                    // El backend guarda 1 registro con TODOS los casos generados
                    // El conteo real está en test_case_content (JSON con array de casos)
                    
                    return data.test_cases.map(testCase => {
                        // Parsear test_case_content para obtener el conteo real
                        let count = 1;
                        try {
                            const cases = JSON.parse(testCase.test_case_content);
                            count = Array.isArray(cases) ? cases.length : 1;
                        } catch (e) {
                            console.warn('Error al parsear test_case_content:', e);
                        }
                        
                        return {
                            type: 'test_cases',
                            count: count,  // Conteo real de casos en el JSON
                            area: testCase.area || 'Sin Área',  // Usar campo area
                            date: testCase.created_at,
                            timestamp: new Date(testCase.created_at).getTime()
                        };
                    }).sort((a, b) => b.timestamp - a.timestamp).slice(0, 25);
                }
                
                return [];
            } catch (error) {
                console.error('Error al obtener historial de casos de prueba:', error);
                return [];
            }
        }

        // Esta función ya no guarda en localStorage, el backend maneja el guardado
        function saveMetrics(metrics) {
            // No-op: El backend guarda automáticamente cuando se generan historias/casos
            console.log('saveMetrics llamado (backend maneja el guardado automáticamente)');
        }

        // Jira Metrics Management
        async function getJiraMetrics() {
            try {
                const response = await fetch('/api/dashboard/activity-metrics', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.error('Error al obtener métricas de Jira:', response.status);
                    return {
                        reports: { count: 0, lastDate: null, byProject: {}, history: [] },
                        uploads: { count: 0, itemsCount: 0, lastDate: null, byProject: {}, issueTypesDistribution: {}, history: [] }
                    };
                }
                
                const data = await response.json();
                if (data.success) {
                    // Obtener historial de reportes y cargas masivas
                    const reportsHistory = await getReportsHistory();
                    const uploadsHistory = await getUploadsHistory();
                    
                    // Construir byProject para reportes desde el historial
                    const reportsByProject = {};
                    reportsHistory.forEach(report => {
                        const projectKey = report.projectKey || 'Unknown';
                        if (!reportsByProject[projectKey]) {
                            reportsByProject[projectKey] = {
                                name: report.projectName || projectKey,
                                count: 0
                            };
                        }
                        reportsByProject[projectKey].count++;
                    });
                    
                    // Construir byProject para cargas masivas desde el historial
                    const uploadsByProject = {};
                    uploadsHistory.forEach(upload => {
                        const projectKey = upload.projectKey || 'Unknown';
                        if (!uploadsByProject[projectKey]) {
                            uploadsByProject[projectKey] = {
                                name: upload.projectName || projectKey,
                                count: 0,
                                itemsCount: 0
                            };
                        }
                        uploadsByProject[projectKey].count++;
                        uploadsByProject[projectKey].itemsCount += upload.itemsCount || 0;
                    });
                    
                    // Construir issueTypesDistribution desde el historial de cargas
                    const issueTypesDistribution = {};
                    uploadsHistory.forEach(upload => {
                        const types = upload.issueTypesDistribution || {};
                        Object.keys(types).forEach(type => {
                            issueTypesDistribution[type] = (issueTypesDistribution[type] || 0) + types[type];
                        });
                    });
                    
                    return {
                        reports: {
                            count: data.metrics.reports_created || 0,
                            lastDate: reportsHistory.length > 0 ? new Date(reportsHistory[0].date).toLocaleDateString('es-ES') : null,
                            byProject: reportsByProject,
                            history: reportsHistory
                        },
                        uploads: {
                            count: data.metrics.bulk_uploads_performed || 0,
                            itemsCount: uploadsHistory.reduce((sum, upload) => sum + (upload.itemsCount || 0), 0),
                            lastDate: uploadsHistory.length > 0 ? new Date(uploadsHistory[0].date).toLocaleDateString('es-ES') : null,
                            byProject: uploadsByProject,
                            issueTypesDistribution: issueTypesDistribution,
                            history: uploadsHistory
                        }
                    };
                }
                
                return {
                    reports: { count: 0, lastDate: null, byProject: {}, history: [] },
                    uploads: { count: 0, itemsCount: 0, lastDate: null, byProject: {}, issueTypesDistribution: {}, history: [] }
                };
            } catch (error) {
                console.error('Error al obtener métricas de Jira:', error);
                return {
                    reports: { count: 0, lastDate: null, byProject: {}, history: [] },
                    uploads: { count: 0, itemsCount: 0, lastDate: null, byProject: {}, issueTypesDistribution: {}, history: [] }
                };
            }
        }

        async function getReportsHistory() {
            try {
                const response = await fetch('/api/dashboard/reports?limit=50', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) return [];
                
                const data = await response.json();
                if (data.success && data.reports) {
                    return data.reports.map(report => ({
                        projectKey: report.project_key || 'Unknown',
                        projectName: report.project_key || 'Unknown',
                        date: report.created_at,
                        timestamp: new Date(report.created_at).getTime()
                    }));
                }
                
                return [];
            } catch (error) {
                console.error('Error al obtener historial de reportes:', error);
                return [];
            }
        }

        async function getUploadsHistory() {
            try {
                const response = await fetch('/api/dashboard/bulk-uploads?limit=50', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) return [];
                
                const data = await response.json();
                if (data.success && data.bulk_uploads) {
                    return data.bulk_uploads.map(upload => {
                        // Parsear upload_details para obtener issue_types_distribution
                        let issueTypesDistribution = {};
                        try {
                            if (upload.upload_details) {
                                const details = JSON.parse(upload.upload_details);
                                issueTypesDistribution = details.issue_types_distribution || {};
                            }
                        } catch (e) {
                            console.warn('Error al parsear upload_details:', e);
                        }
                        
                        return {
                            projectKey: upload.project_key || 'Unknown',
                            projectName: upload.project_key || 'Unknown',
                            itemsCount: upload.total_items || 0,
                            issueTypesDistribution: issueTypesDistribution,
                            date: upload.created_at,
                            timestamp: new Date(upload.created_at).getTime()
                        };
                    });
                }
                
                return [];
            } catch (error) {
                console.error('Error al obtener historial de cargas masivas:', error);
                return [];
            }
        }

        // Esta función ya no guarda en localStorage, el backend maneja el guardado
        function saveJiraMetrics(metrics) {
            // No-op: El backend guarda automáticamente cuando se crean reportes/cargas
            console.log('saveJiraMetrics llamado (backend maneja el guardado automáticamente)');
        }

        // Esta función ya no es necesaria, el backend guarda automáticamente
        // cuando se crea un reporte en la base de datos
        function incrementReportCount(projectKey = null, projectName = null) {
            console.log('incrementReportCount llamado (backend maneja el guardado automáticamente)');
            // El backend guarda automáticamente en JiraReportRepository cuando se crea un reporte
            // No es necesario hacer nada aquí
        }

        // Esta función ya no es necesaria, el backend guarda automáticamente
        // cuando se crea una carga masiva en la base de datos
        function incrementUploadCount(itemsCount, projectKey = null, projectName = null, issueTypesDistribution = {}) {
            console.log('incrementUploadCount llamado (backend maneja el guardado automáticamente)');
            // El backend guarda automáticamente en BulkUploadRepository cuando se hace una carga
            // No es necesario hacer nada aquí
        }

        // Load Dashboard Metrics - Ahora asíncrona para usar el backend
        async function loadDashboardMetrics() {
            try {
                // Métricas del Generador H/CP
                const generatorMetrics = await getMetrics();
                const generatorStoriesEl = document.getElementById('generator-stories');
                const generatorTestCasesEl = document.getElementById('generator-testcases');
                
                if (generatorStoriesEl) {
                    generatorStoriesEl.textContent = generatorMetrics.stories || 0;
                }
                if (generatorTestCasesEl) {
                    generatorTestCasesEl.textContent = generatorMetrics.testCases || 0;
                }

                // Métricas de Reportes Jira
                const jiraMetrics = await getJiraMetrics();
                const reportsCountEl = document.getElementById('reports-count');
                const reportsLastEl = document.getElementById('reports-last');
                
                if (reportsCountEl) {
                    reportsCountEl.textContent = jiraMetrics.reports.count || 0;
                }
                if (reportsLastEl) {
                    reportsLastEl.textContent = jiraMetrics.reports.lastDate || '-';
                }

                // Métricas de Carga Masiva
                const uploadCountEl = document.getElementById('upload-count');
                const uploadItemsEl = document.getElementById('upload-items');
                
                if (uploadCountEl) {
                    uploadCountEl.textContent = jiraMetrics.uploads.count || 0;
                }
                if (uploadItemsEl) {
                    uploadItemsEl.textContent = jiraMetrics.uploads.itemsCount || 0;
                }
            } catch (error) {
                console.error('Error al cargar métricas del dashboard:', error);
            }
        }

        // Clear Jira Report
        function clearJiraReport() {
            const metricsContent = document.getElementById('metrics-content');
            const welcomeCard = document.querySelector('.jira-welcome-card');
            const projectSelector = document.getElementById('project-selector');
            const widgetsContainer = document.getElementById('widgets-container');
            
            if (metricsContent) {
                metricsContent.style.display = 'none';
            }
            
            if (welcomeCard) {
                welcomeCard.style.display = 'block';
            }
            
            const projectInput = document.getElementById('project-selector-input');
            const projectHidden = document.getElementById('project-selector');
            if (projectInput) {
                projectInput.value = '';
            }
            if (projectHidden) {
                projectHidden.value = '';
            }
            
            if (widgetsContainer) {
                widgetsContainer.innerHTML = '';
            }
            
            // Limpiar widgets activos
            activeWidgets = [];
            widgetDataCache = {};
            
            // Ocultar botones
            const downloadButton = document.getElementById('download-button');
            const customizeButton = document.getElementById('customize-button');
            
            if (downloadButton) {
                downloadButton.classList.remove('visible');
            }
            
            if (customizeButton) {
                customizeButton.style.display = 'none';
            }
        }


        // Esta función ya no es necesaria, el backend guarda automáticamente
        async function updateMetrics(type, count, area = null) {
            console.log('updateMetrics llamado (backend maneja el guardado automáticamente)');
            // El backend guarda automáticamente cuando se generan historias/casos de prueba
            // Solo necesitamos recargar las métricas del backend
            await loadMetrics();
        }

        async function loadMetrics() {
            const metrics = await getMetrics();
            
            // Update counters
            const storiesCountEl = document.getElementById('stories-count');
            const testCasesCountEl = document.getElementById('test-cases-count');
            const totalCountEl = document.getElementById('total-count');
            
            if (storiesCountEl) storiesCountEl.textContent = metrics.stories;
            if (testCasesCountEl) testCasesCountEl.textContent = metrics.testCases;
            if (totalCountEl) totalCountEl.textContent = metrics.stories + metrics.testCases;

            // Calculate area distribution
            const areaDistribution = {};
            metrics.history.forEach(item => {
                let area = item.area;
                if (!area || area === 'UNKNOWN' || area === 'No especificada' || area === 'Sin Área') {
                    area = 'Sin Área';
                }
                areaDistribution[area] = (areaDistribution[area] || 0) + (item.count || 1);
            });

            // Update area distribution chart
            updateAreaChart(areaDistribution);

            // Update history
            const historyList = document.getElementById('history-list');
            if (!historyList) return;

            if (metrics.history.length === 0) {
                historyList.innerHTML = `
                    <li class="history-item" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        No hay historial aún. Las generaciones aparecerán aquí.
                    </li>
                `;
                return;
            }

            historyList.innerHTML = metrics.history.map(item => {
                const date = new Date(item.date);
                const formattedDate = date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const icon = item.type === 'stories' ? '📝' : '🧪';
                const typeName = item.type === 'stories' ? 'Historias de Usuario' : 'Casos de Prueba';
                const iconClass = item.type === 'stories' ? 'story' : 'test';
                
                // Mostrar el área correctamente
                let area = item.area;
                if (!area || area === 'UNKNOWN' || area === 'No especificada' || area === 'Sin Área') {
                    area = 'Sin Área';
                }

                return `
                    <li class="history-item">
                        <div class="history-info">
                            <div class="history-icon ${iconClass}">${icon}</div>
                            <div class="history-details">
                                <div class="history-type">${typeName}</div>
                                <div class="history-meta">
                                    <span class="history-area">🏢 ${area}</span>
                                    <span class="history-date">${formattedDate}</span>
                                </div>
                            </div>
                        </div>
                        <div class="history-count">+${item.count}</div>
                    </li>
                `;
            }).join('');
        }

        let areaChartInstance = null;

        function updateAreaChart(areaDistribution) {
            const canvas = document.getElementById('area-distribution-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (areaChartInstance) {
                areaChartInstance.destroy();
            }

            const areas = Object.keys(areaDistribution);
            const counts = Object.values(areaDistribution);

            if (areas.length === 0) {
                // Show empty state
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'var(--text-muted)';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos disponibles', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Define colors for each area
            const areaColors = {
                'Finanzas': '#3b82f6',
                'Recursos Humanos': '#10b981',
                'Tesoreria': '#f59e0b',
                'TI': '#8b5cf6',
                'Sin Área': '#6b7280',
                'Sin Proyecto': '#6b7280',
                'No especificada': '#6b7280',
                'UNKNOWN': '#6b7280'
            };

            const backgroundColors = areas.map(area => areaColors[area] || '#6b7280');

            areaChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: areas,
                    datasets: [{
                        data: counts,
                        backgroundColor: backgroundColors,
                        borderColor: 'var(--bg)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'var(--text-primary)',
                                padding: 15,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function resetMetrics() {
            if (!confirm('⚠️ ¿Estás seguro de que quieres reiniciar TODAS las métricas?\n\nEsta acción eliminará:\n- Todas las historias de usuario generadas\n- Todos los casos de prueba generados\n- Todos los reportes de Jira\n- Todas las cargas masivas\n\nEsta acción NO se puede deshacer.')) {
                return;
            }
            
            try {
                // Obtener el token CSRF del meta tag o cookie
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                                  getCookie('csrf_token');
                
                const response = await fetch('/api/dashboard/clear-metrics', {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al limpiar métricas');
                }
                
                const data = await response.json();
                
                // Mostrar mensaje de éxito con detalles
                alert(`✅ Métricas limpiadas exitosamente:\n\n` +
                      `- ${data.deleted.stories} historias eliminadas\n` +
                      `- ${data.deleted.test_cases} casos de prueba eliminados\n` +
                      `- ${data.deleted.reports} reportes eliminados\n` +
                      `- ${data.deleted.bulk_uploads} cargas masivas eliminadas`);
                
                // Recargar métricas para mostrar valores en 0
                await loadMetrics();
                await loadJiraMetrics();
                
            } catch (error) {
                console.error('Error al reiniciar métricas:', error);
                alert(`❌ Error al reiniciar métricas: ${error.message}`);
            }
        }
        
        // Función helper para obtener cookies
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Chart instances for Jira metrics
        let reportsByProjectChart = null;
        let reportsTrendChart = null;
        let uploadsByTypeChart = null;
        let uploadsByProjectChart = null;
        let uploadsTrendChart = null;

        // Update Reports Charts
        function updateReportsCharts(reportsData) {
            // Gráfico de distribución por proyecto
            const byProjectCanvas = document.getElementById('reports-by-project-chart');
            if (byProjectCanvas) {
                const ctx = byProjectCanvas.getContext('2d');
                if (reportsByProjectChart) {
                    reportsByProjectChart.destroy();
                }
                
                const projects = Object.keys(reportsData.byProject || {});
                const counts = projects.map(key => reportsData.byProject[key].count);
                const labels = projects.map(key => reportsData.byProject[key].name || key);
                
                if (projects.length === 0) {
                    ctx.clearRect(0, 0, byProjectCanvas.width, byProjectCanvas.height);
                    ctx.fillStyle = 'var(--text-muted)';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No hay datos disponibles', byProjectCanvas.width / 2, byProjectCanvas.height / 2);
                    return;
                }
                
                reportsByProjectChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: counts,
                            backgroundColor: [
                                '#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444',
                                '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1'
                            ],
                            borderColor: 'var(--primary-bg)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'var(--text-primary)',
                                    padding: 15,
                                    font: { size: 14 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} reportes (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gráfico de tendencia temporal
            const trendCanvas = document.getElementById('reports-trend-chart');
            if (trendCanvas) {
                const ctx = trendCanvas.getContext('2d');
                if (reportsTrendChart) {
                    reportsTrendChart.destroy();
                }
                
                const history = reportsData.history || [];
                if (history.length === 0) {
                    ctx.clearRect(0, 0, trendCanvas.width, trendCanvas.height);
                    ctx.fillStyle = 'var(--text-muted)';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No hay datos disponibles', trendCanvas.width / 2, trendCanvas.height / 2);
                    return;
                }
                
                // Agrupar por semana
                const weeklyData = {};
                history.forEach(item => {
                    const date = new Date(item.timestamp || item.date);
                    const weekKey = `${date.getFullYear()}-W${Math.ceil(date.getDate() / 7)}`;
                    weeklyData[weekKey] = (weeklyData[weekKey] || 0) + 1;
                });
                
                const weeks = Object.keys(weeklyData).sort();
                const weekCounts = weeks.map(w => weeklyData[w]);
                
                reportsTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: weeks,
                        datasets: [{
                            label: 'Reportes Generados',
                            data: weekCounts,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: 'var(--text-primary)'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'var(--text-secondary)',
                                    stepSize: 1
                                },
                                grid: {
                                    color: 'var(--border)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'var(--text-secondary)'
                                },
                                grid: {
                                    color: 'var(--border)'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Update Uploads Charts
        function updateUploadsCharts(uploadsData) {
            // Gráfico de distribución por tipo de issue
            const byTypeCanvas = document.getElementById('uploads-by-type-chart');
            if (byTypeCanvas) {
                const ctx = byTypeCanvas.getContext('2d');
                if (uploadsByTypeChart) {
                    uploadsByTypeChart.destroy();
                }
                
                const typesDistribution = uploadsData.issueTypesDistribution || {};
                const types = Object.keys(typesDistribution);
                const counts = types.map(t => typesDistribution[t]);
                
                if (types.length === 0) {
                    ctx.clearRect(0, 0, byTypeCanvas.width, byTypeCanvas.height);
                    ctx.fillStyle = 'var(--text-muted)';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No hay datos disponibles', byTypeCanvas.width / 2, byTypeCanvas.height / 2);
                    return;
                }
                
                const typeColors = {
                    'Bug': '#ef4444',
                    'Story': '#3b82f6',
                    'Test case': '#10b981',
                    'Task': '#f59e0b',
                    'Epic': '#8b5cf6'
                };
                
                uploadsByTypeChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: types,
                        datasets: [{
                            data: counts,
                            backgroundColor: types.map(t => typeColors[t] || '#6b7280'),
                            borderColor: 'var(--primary-bg)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'var(--text-primary)',
                                    padding: 15,
                                    font: { size: 14 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} items (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gráfico de items por proyecto
            const byProjectCanvas = document.getElementById('uploads-by-project-chart');
            if (byProjectCanvas) {
                const ctx = byProjectCanvas.getContext('2d');
                if (uploadsByProjectChart) {
                    uploadsByProjectChart.destroy();
                }
                
                const projects = Object.keys(uploadsData.byProject || {});
                const itemsCounts = projects.map(key => uploadsData.byProject[key].itemsCount || 0);
                const labels = projects.map(key => uploadsData.byProject[key].name || key);
                
                if (projects.length === 0) {
                    ctx.clearRect(0, 0, byProjectCanvas.width, byProjectCanvas.height);
                    ctx.fillStyle = 'var(--text-muted)';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No hay datos disponibles', byProjectCanvas.width / 2, byProjectCanvas.height / 2);
                    return;
                }
                
                uploadsByProjectChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Items Cargados',
                            data: itemsCounts,
                            backgroundColor: '#3b82f6',
                            borderColor: '#2563eb',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'var(--text-secondary)',
                                    stepSize: 1
                                },
                                grid: {
                                    color: 'var(--border)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'var(--text-secondary)'
                                },
                                grid: {
                                    color: 'var(--border)'
                                }
                            }
                        }
                    }
                });
            }
            
            // Gráfico de tendencia temporal
            const trendCanvas = document.getElementById('uploads-trend-chart');
            if (trendCanvas) {
                const ctx = trendCanvas.getContext('2d');
                if (uploadsTrendChart) {
                    uploadsTrendChart.destroy();
                }
                
                const history = uploadsData.history || [];
                if (history.length === 0) {
                    ctx.clearRect(0, 0, trendCanvas.width, trendCanvas.height);
                    ctx.fillStyle = 'var(--text-muted)';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No hay datos disponibles', trendCanvas.width / 2, trendCanvas.height / 2);
                    return;
                }
                
                // Agrupar por semana
                const weeklyData = {};
                history.forEach(item => {
                    const date = new Date(item.timestamp || item.date);
                    const weekKey = `${date.getFullYear()}-W${Math.ceil(date.getDate() / 7)}`;
                    weeklyData[weekKey] = (weeklyData[weekKey] || 0) + (item.itemsCount || 0);
                });
                
                const weeks = Object.keys(weeklyData).sort();
                const weekCounts = weeks.map(w => weeklyData[w]);
                
                uploadsTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: weeks,
                        datasets: [{
                            label: 'Items Cargados',
                            data: weekCounts,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: 'var(--text-primary)'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'var(--text-secondary)',
                                    stepSize: 1
                                },
                                grid: {
                                    color: 'var(--border)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'var(--text-secondary)'
                                },
                                grid: {
                                    color: 'var(--border)'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Render Reports History
        function renderReportsHistory(history) {
            const historyList = document.getElementById('jira-reports-history-list');
            if (!historyList) return;
            
            if (history.length === 0) {
                historyList.innerHTML = `
                    <li class="history-item" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        No hay historial aún. Los reportes aparecerán aquí.
                    </li>
                `;
                return;
            }
            
            historyList.innerHTML = history.map(item => {
                const date = new Date(item.timestamp || item.date);
                const formattedDate = date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <li class="history-item">
                        <div class="history-info">
                            <div class="history-icon reports"><i class="fas fa-file-alt"></i></div>
                            <div class="history-details">
                                <div class="history-type">Reporte Generado</div>
                                <div class="history-meta">
                                    <span class="history-area">📊 ${item.projectName || item.projectKey || 'Proyecto'}</span>
                                    <span class="history-date">${formattedDate}</span>
                                </div>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
        }

        // Render Uploads History
        function renderUploadsHistory(history) {
            const historyList = document.getElementById('jira-uploads-history-list');
            if (!historyList) return;
            
            if (history.length === 0) {
                historyList.innerHTML = `
                    <li class="history-item" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        No hay historial aún. Las cargas aparecerán aquí.
                    </li>
                `;
                return;
            }
            
            historyList.innerHTML = history.map(item => {
                const date = new Date(item.timestamp || item.date);
                const formattedDate = date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const types = Object.keys(item.issueTypesDistribution || {});
                const typesSummary = types.length > 0 
                    ? types.map(t => `${t} (${item.issueTypesDistribution[t]})`).join(', ')
                    : 'Sin tipo especificado';
                
                return `
                    <li class="history-item">
                        <div class="history-info">
                            <div class="history-icon uploads"><i class="fas fa-upload"></i></div>
                            <div class="history-details">
                                <div class="history-type">Carga Masiva</div>
                                <div class="history-meta">
                                    <span class="history-area">📊 ${item.projectName || item.projectKey || 'Proyecto'}</span>
                                    <span class="history-date">${formattedDate}</span>
                                </div>
                                <div class="history-extra" style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    ${item.itemsCount || 0} items • Tipos: ${typesSummary}
                                </div>
                            </div>
                        </div>
                        <div class="history-count">+${item.itemsCount || 0}</div>
                    </li>
                `;
            }).join('');
        }

        // Load All Metrics (Generator + Jira)
        async function loadAllMetrics() {
            // Cargar métricas del generador
            await loadMetrics();
            
            // Cargar métricas de Jira
            await loadJiraMetrics();
            
            // Asegurar que el filtro activo se muestre
            const activeFilter = document.querySelector('.metric-filter-btn.active');
            if (activeFilter) {
                const filterType = activeFilter.getAttribute('data-filter');
                showMetricsSection(filterType);
            }
        }

        // Load Jira Metrics
        async function loadJiraMetrics() {
            const jiraMetrics = await getJiraMetrics();
            
            // ========== MÉTRICAS DE REPORTES ==========
            const reportsTotalEl = document.getElementById('jira-reports-total');
            const reportsProjectsCountEl = document.getElementById('jira-reports-projects-count');
            const reportsWeeklyEl = document.getElementById('jira-reports-weekly');
            
            if (reportsTotalEl) {
                reportsTotalEl.textContent = jiraMetrics.reports.count || 0;
            }
            
            // Contar proyectos únicos
            const reportsProjects = Object.keys(jiraMetrics.reports.byProject || {});
            if (reportsProjectsCountEl) {
                reportsProjectsCountEl.textContent = reportsProjects.length;
            }
            
            // Calcular reportes en últimos 7 días
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const recentReports = (jiraMetrics.reports.history || []).filter(h => 
                new Date(h.timestamp || h.date).getTime() > sevenDaysAgo
            ).length;
            if (reportsWeeklyEl) {
                reportsWeeklyEl.textContent = recentReports;
            }
            
            // Renderizar gráficos de reportes
            updateReportsCharts(jiraMetrics.reports);
            
            // Renderizar métricas por proyecto - Reportes
            renderJiraMetricsByProject('reports', jiraMetrics.reports.byProject);
            
            // Renderizar historial de reportes
            renderReportsHistory(jiraMetrics.reports.history || []);
            
            // ========== MÉTRICAS DE CARGAS ==========
            const uploadsTotalEl = document.getElementById('jira-uploads-total');
            const uploadsItemsEl = document.getElementById('jira-uploads-items');
            const uploadsProjectsCountEl = document.getElementById('jira-uploads-projects-count');
            const uploadsAvgEl = document.getElementById('jira-uploads-avg');
            
            if (uploadsTotalEl) {
                uploadsTotalEl.textContent = jiraMetrics.uploads.count || 0;
            }
            if (uploadsItemsEl) {
                uploadsItemsEl.textContent = jiraMetrics.uploads.itemsCount || 0;
            }
            
            // Contar proyectos únicos con cargas
            const uploadsProjects = Object.keys(jiraMetrics.uploads.byProject || {});
            if (uploadsProjectsCountEl) {
                uploadsProjectsCountEl.textContent = uploadsProjects.length;
            }
            
            // Calcular promedio de items por carga
            const avgItems = jiraMetrics.uploads.count > 0 
                ? Math.round((jiraMetrics.uploads.itemsCount || 0) / jiraMetrics.uploads.count)
                : 0;
            if (uploadsAvgEl) {
                uploadsAvgEl.textContent = avgItems;
            }
            
            // Renderizar gráficos de cargas
            updateUploadsCharts(jiraMetrics.uploads);
            
            // Renderizar métricas por proyecto - Cargas
            renderJiraMetricsByProject('uploads', jiraMetrics.uploads.byProject);
            
            // Renderizar historial de cargas
            renderUploadsHistory(jiraMetrics.uploads.history || []);
        }

        // Render Jira Metrics by Project
        function renderJiraMetricsByProject(type, byProject) {
            const containerId = type === 'reports' ? 'jira-reports-by-project' : 'jira-uploads-by-project';
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const projects = Object.keys(byProject);
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No hay ${type === 'reports' ? 'reportes' : 'cargas'} realizadas aún</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = projects.map(projectKey => {
                const project = byProject[projectKey];
                if (type === 'reports') {
                    return `
                        <div class="jira-project-metric-item">
                            <div class="jira-project-metric-header">
                                <div class="jira-project-metric-name">${project.name || projectKey}</div>
                            </div>
                            <div class="jira-project-metric-stats">
                                <div class="jira-project-stat">
                                    <span class="jira-project-stat-label">Reportes Generados</span>
                                    <span class="jira-project-stat-value">${project.count}</span>
                                </div>
                                <div class="jira-project-stat">
                                    <span class="jira-project-stat-label">Último Reporte</span>
                                    <span class="jira-project-stat-value">${project.lastDate || '-'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Calcular promedio de items por carga para este proyecto
                    const avgItems = project.count > 0 
                        ? Math.round((project.itemsCount || 0) / project.count)
                        : 0;
                    
                    // Mostrar distribución de tipos de issue
                    const typesDistribution = project.issueTypesDistribution || {};
                    const typesList = Object.keys(typesDistribution).length > 0
                        ? Object.entries(typesDistribution)
                            .map(([type, count]) => `${type}: ${count}`)
                            .join(', ')
                        : 'N/A';
                    
                    return `
                        <div class="jira-project-metric-item">
                            <div class="jira-project-metric-header">
                                <div class="jira-project-metric-name">${project.name || projectKey}</div>
                            </div>
                            <div class="jira-project-metric-stats">
                                <div class="jira-project-stat">
                                    <span class="jira-project-stat-label">Cargas Realizadas</span>
                                    <span class="jira-project-stat-value">${project.count}</span>
                                </div>
                                <div class="jira-project-stat">
                                    <span class="jira-project-stat-label">Items Cargados</span>
                                    <span class="jira-project-stat-value">${project.itemsCount || 0}</span>
                                </div>
                                <div class="jira-project-stat">
                                    <span class="jira-project-stat-label">Promedio por Carga</span>
                                    <span class="jira-project-stat-value">${avgItems}</span>
                                </div>
                                <div class="jira-project-stat">
                                    <span class="jira-project-stat-label">Última Carga</span>
                                    <span class="jira-project-stat-value">${project.lastDate || '-'}</span>
                                </div>
                                ${Object.keys(typesDistribution).length > 0 ? `
                                <div class="jira-project-stat" style="grid-column: 1 / -1; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);">
                                    <span class="jira-project-stat-label">Distribución por Tipo</span>
                                    <span class="jira-project-stat-value" style="font-size: 0.85rem; text-align: right;">${typesList}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Show Metrics Section
        function showMetricsSection(filterType) {
            // Ocultar todas las secciones
            document.querySelectorAll('.metrics-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la sección correspondiente
            const sectionId = `metrics-${filterType}`;
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
            }
            
            // Actualizar botones de filtro
            document.querySelectorAll('.metric-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`[data-filter="${filterType}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        // Download Metrics - Ahora asíncrona
        async function downloadMetrics() {
            const generatorMetrics = await getMetrics();
            const jiraMetrics = await getJiraMetrics();
            
            // Crear modal de selección
            const modal = document.createElement('div');
            modal.className = 'metrics-download-modal';
            modal.innerHTML = `
                <div class="metrics-download-content" onclick="event.stopPropagation()">
                    <div class="metrics-download-header">
                        <h3>Descargar Métricas</h3>
                        <button class="metrics-download-close" onclick="this.closest('.metrics-download-modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="metrics-download-body">
                        <label class="metrics-download-checkbox">
                            <input type="checkbox" checked data-type="generator">
                            <span>Métricas del Generador H/CP</span>
                        </label>
                        <label class="metrics-download-checkbox">
                            <input type="checkbox" checked data-type="jira-reports">
                            <span>Métricas de Reportes Jira</span>
                        </label>
                        <label class="metrics-download-checkbox">
                            <input type="checkbox" checked data-type="jira-uploads">
                            <span>Métricas de Carga Masiva</span>
                        </label>
                    </div>
                    <div class="metrics-download-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.metrics-download-modal').remove()">Cancelar</button>
                        <button class="btn btn-primary" onclick="executeMetricsDownload(this.closest('.metrics-download-modal'))">Descargar</button>
                    </div>
                </div>
            `;
            
            modal.onclick = () => modal.remove();
            document.body.appendChild(modal);
        }

        async function executeMetricsDownload(modal) {
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
            const selectedTypes = Array.from(checkboxes).map(cb => cb.getAttribute('data-type'));
            
            if (selectedTypes.length === 0) {
                alert('Por favor, selecciona al menos un tipo de métrica');
                return;
            }
            
            // Mostrar notificación de inicio inmediatamente
            showDownloadNotification('Procesando archivo...', 'loading');
            
            const generatorMetrics = getMetrics();
            const jiraMetrics = getJiraMetrics();
            
            // Capturar gráficos disponibles
            const chartImages = {};
            
            if (selectedTypes.includes('generator')) {
                const areaChart = document.getElementById('area-distribution-chart');
                if (areaChart) {
                    chartImages['generator_area'] = areaChart.toDataURL('image/png');
                }
            }
            
            if (selectedTypes.includes('jira-reports')) {
                const reportsByProjectChart = document.getElementById('reports-by-project-chart');
                if (reportsByProjectChart) {
                    chartImages['reports_by_project'] = reportsByProjectChart.toDataURL('image/png');
                }
                const reportsTrendChart = document.getElementById('reports-trend-chart');
                if (reportsTrendChart) {
                    chartImages['reports_trend'] = reportsTrendChart.toDataURL('image/png');
                }
            }
            
            if (selectedTypes.includes('jira-uploads')) {
                const uploadsByTypeChart = document.getElementById('uploads-by-type-chart');
                if (uploadsByTypeChart) {
                    chartImages['uploads_by_type'] = uploadsByTypeChart.toDataURL('image/png');
                }
                const uploadsByProjectChart = document.getElementById('uploads-by-project-chart');
                if (uploadsByProjectChart) {
                    chartImages['uploads_by_project'] = uploadsByProjectChart.toDataURL('image/png');
                }
                const uploadsTrendChart = document.getElementById('uploads-trend-chart');
                if (uploadsTrendChart) {
                    chartImages['uploads_trend'] = uploadsTrendChart.toDataURL('image/png');
                }
            }
            
            try {
                const response = await fetch('/api/metrics/download-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({
                        selected_types: selectedTypes,
                        generator_metrics: generatorMetrics,
                        jira_metrics: jiraMetrics,
                        chart_images: chartImages
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Error al generar el reporte PDF');
                }
                
                // Descargar el archivo
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `metricas_nexus_ai_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                // Actualizar notificación
                showDownloadNotification('Reporte PDF descargado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error al descargar métricas:', error);
                // Mostrar el mensaje de error específico del servidor
                const errorMessage = error.message || 'Error al generar el reporte PDF';
                showDownloadNotification(errorMessage, 'error');
            } finally {
                modal.remove();
            }
        }

        // Show Download Notification
        function showDownloadNotification(message, type = 'loading') {
            // Buscar notificación existente
            let notification = document.getElementById('download-notification');
            
            // Si existe y es de tipo loading, actualizarla en lugar de removerla
            if (notification && notification.classList.contains('loading') && (type === 'success' || type === 'error')) {
                // Actualizar la notificación existente
                notification.className = `download-notification ${type}`;
                
                let icon = '⏳';
                if (type === 'success') {
                    icon = '✅';
                } else if (type === 'error') {
                    icon = '❌';
                }
                
                const iconElement = notification.querySelector('.download-notification-icon');
                const messageElement = notification.querySelector('.download-notification-message');
                
                if (iconElement) {
                    iconElement.innerHTML = icon;
                }
                if (messageElement) {
                    messageElement.textContent = message;
                }
                
                // Auto-ocultar después de 3 segundos
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
                
                return;
            }
            
            // Si no existe o no es de tipo loading, remover la existente y crear nueva
            if (notification) {
                notification.remove();
            }
            
            // Crear nueva notificación
            notification = document.createElement('div');
            notification.id = 'download-notification';
            notification.className = `download-notification ${type}`;
            
            let icon = '⏳';
            if (type === 'success') {
                icon = '✅';
            } else if (type === 'error') {
                icon = '❌';
            } else {
                icon = '<i class="fas fa-spinner"></i>';
            }
            
            notification.innerHTML = `
                <div class="download-notification-icon">${icon}</div>
                <div class="download-notification-message">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Mostrar con animación
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Auto-ocultar después de 3 segundos si es success o error
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
            }
        }

        // Event Listeners para Filtros
        document.addEventListener('DOMContentLoaded', () => {
            // Filtros de métricas
            document.querySelectorAll('.metric-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const filterType = btn.getAttribute('data-filter');
                    showMetricsSection(filterType);
                });
            });
            
            // Botón de descarga
            const downloadBtn = document.getElementById('download-metrics-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadMetrics);
            }
        });

        // Sidebar Toggle
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
        });

        // Accordion Click Handlers
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', (e) => {
                    e.preventDefault();
                e.stopPropagation();
                const accordionItem = header.closest('.accordion-item');
                if (accordionItem) {
                    toggleAccordion(accordionItem);
                }
            });
        });

        // Nav Item Click Handlers - Actualizado para nuevo sidebar
        document.querySelectorAll('.nav-item, .quick-link, .card-action').forEach(item => {
            item.addEventListener('click', (e) => {
                const dataRoute = item.getAttribute('data-route');
                const href = item.getAttribute('href');
                const sectionId = item.getAttribute('data-section');
                
                // Si tiene data-route o href que sea una ruta externa (excepto admin que ahora es interna)
                // permitir navegación normal
                if (dataRoute && dataRoute.startsWith('/auth/')) {
                    window.location.href = dataRoute;
                    return;
                }
                
                if (href && href !== '#' && href.startsWith('/auth/')) {
                    window.location.href = href;
                    return;
                }
                
                // Para secciones internas (incluyendo admin), prevenir default y usar navigateToSection
                e.preventDefault();
                e.stopPropagation();
                if (sectionId) {
                    navigateToSection(sectionId);
                }
            });
        });

        // Helper function for fetch with extended timeout
        async function fetchWithTimeout(url, options = {}, timeout = 600000) { // 10 minutos por defecto
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            // Agregar token CSRF a los headers si no está presente
            const headers = { ...(options.headers || {}) };
            if (!headers['X-CSRFToken']) {
                headers['X-CSRFToken'] = getCsrfToken();
            }
            
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: headers,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('La solicitud tardó demasiado tiempo. El documento puede ser muy grande. Intenta con un documento más pequeño o divide el contenido.');
                }
                throw error;
            }
        }

        // [REMOVED] AI Agent Chat Functionality - Obsoleto, reemplazado por generadores especializados
        // La funcionalidad del agente AI antiguo ha sido eliminada.
        // Ahora se usan los generadores especializados: "Crear Historias" y "Crear Casos de Prueba"

        // Initialize charts for infografía
        function initializeCharts() {
            const colors = {
                primary: '#ffa600',
                secondary: '#ff764a',
                accent1: '#ef5675',
                accent2: '#7a5195',
                background: 'rgba(255, 166, 0, 0.2)',
                border: '#ffa600',
                grid: 'rgba(255, 255, 255, 0.1)',
                text: '#FFFFFF'
            };

            const tooltipTitleCallback = (tooltipItems) => {
                const item = tooltipItems[0];
                let label = item.chart.data.labels[item.dataIndex];
                if (Array.isArray(label)) {
                    return label.join(' ');
                }
                return label;
            };

            const wrapLabel = (label) => {
                const maxLength = 16;
                if (label.length <= maxLength) return label;

                const words = label.split(' ');
                const lines = [];
                let currentLine = '';

                words.forEach(word => {
                    if ((currentLine + word).length > maxLength) {
                        lines.push(currentLine.trim());
                        currentLine = '';
                    }
                    currentLine += word + ' ';
                });
                lines.push(currentLine.trim());
                return lines;
            };

            const defaultChartOptions = {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        labels: {
                            color: colors.text
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: tooltipTitleCallback
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: colors.text, maxRotation: 0, autoSkip: true },
                        grid: { color: colors.grid }
                    },
                    y: {
                        ticks: { color: colors.text },
                        grid: { color: colors.grid },
                        beginAtZero: true
                    }
                }
            };

            // Time Distribution Chart
            const timeDistributionCtx = document.getElementById('timeDistributionChart');
            if (timeDistributionCtx && !timeDistributionCtx.chart) {
                timeDistributionCtx.chart = new Chart(timeDistributionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Documentación Manual y Repetitiva', 'Pruebas Exploratorias y de Valor', 'Gestión y Reuniones'],
                        datasets: [{
                            label: 'Distribución del Tiempo',
                            data: [60, 25, 15],
                            backgroundColor: [colors.accent1, colors.primary, colors.accent2],
                            borderColor: '#1e293b',
                            borderWidth: 4
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: colors.text } },
                            tooltip: { callbacks: { title: tooltipTitleCallback } }
                        }
                    }
                });
            }

            // Productivity Gains Chart
            const productivityGainsCtx = document.getElementById('productivityGainsChart');
            if (productivityGainsCtx && !productivityGainsCtx.chart) {
                const originalLabels = [
                    'Aumento de Velocidad en Generación de e Historias de Usuario',
                    'Reducción de Errores de Documentación',
                    'Reducción de tiempos de respuesta sobre procesos de QA'
                ];

                productivityGainsCtx.chart = new Chart(productivityGainsCtx, {
                    type: 'bar',
                    data: {
                        labels: originalLabels.map(wrapLabel),
                        datasets: [{
                            label: 'Mejora (%)',
                            data: [80, 100, 50],
                            backgroundColor: [colors.primary, colors.secondary, colors.accent1],
                            borderColor: [colors.border, '#ff764a', '#ef5675'],
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        ...defaultChartOptions,
                        scales: {
                            x: {
                                ticks: { color: colors.text },
                                grid: { color: colors.grid }
                            },
                            y: {
                                ticks: { color: colors.text, callback: function(value) { return value + '%' } },
                                grid: { color: colors.grid },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }


        // Jira Reports Functionality
        let grTestCasesChart = null;
        let grBugsSeverityChart = null;
        let currentProjectKey = null;
        
        // Paginación
        let testCasesPagination = {
            currentPage: 1,
            itemsPerPage: 20,
            totalItems: 0,
            data: []
        };
        
        let defectsPagination = {
            currentPage: 1,
            itemsPerPage: 20,
            totalItems: 0,
            data: []
        };

        async function initJiraReports() {
            // Verificar conexión con Jira (en segundo plano, sin mostrar mensaje de éxito)
            const statusCard = document.getElementById('jira-connection-status');
            const statusIcon = document.getElementById('connection-icon');
            const statusMessage = document.getElementById('connection-message');

            try {
                const response = await fetch('/api/jira/test-connection');
                const data = await response.json();

                if (data.success) {
                    // No mostrar mensaje de éxito, cargar proyectos directamente
                    statusCard.style.display = 'none';
                    loadProjects();
                } else {
                    // Solo mostrar errores si hay problemas
                    statusCard.style.display = 'block';
                    statusIcon.textContent = '❌';
                    statusMessage.textContent = `Error de conexión: ${data.error || 'No se pudo conectar'}`;
                }
            } catch (error) {
                // Solo mostrar errores si hay problemas
                statusCard.style.display = 'block';
                statusIcon.textContent = '❌';
                statusMessage.textContent = `Error: ${error.message}`;
            }
        }

        // Variable global para almacenar todos los proyectos
        let allProjects = [];
        let highlightedIndex = -1;

        async function loadProjects() {
            const projectsSection = document.getElementById('jira-projects-section');
            const projectSelectorInput = document.getElementById('project-selector-input');
            const projectSelectorHidden = document.getElementById('project-selector');
            const projectsLoading = document.getElementById('projects-loading');
            const projectsError = document.getElementById('projects-error');
            const reportSection = document.getElementById('jira-report-section');

            projectsSection.style.display = 'block';
            reportSection.style.display = 'block';
            projectsLoading.style.display = 'block';
            projectsError.style.display = 'none';

            try {
                const response = await fetch('/api/jira/projects');
                const data = await response.json();

                if (data.success && data.projects.length > 0) {
                    projectsLoading.style.display = 'none';
                    
                    // Almacenar todos los proyectos en variable global
                    allProjects = data.projects.map(project => ({
                        key: project.key,
                        name: project.name,
                        displayText: `${project.name} (${project.key})`
                    }));
                    
                    console.log('Proyectos cargados:', allProjects.length);
                    
                    // No mostrar dropdown automáticamente, solo cuando el usuario haga click
                } else {
                    projectsLoading.style.display = 'none';
                    projectsError.style.display = 'block';
                    projectsError.innerHTML = `<span>❌ ${data.error || 'No se encontraron proyectos'}</span>`;
                }
            } catch (error) {
                projectsLoading.style.display = 'none';
                projectsError.style.display = 'block';
                projectsError.innerHTML = `<span>❌ Error: ${error.message}</span>`;
            }
        }

        function renderProjectOptions(projects) {
            const dropdown = document.getElementById('project-dropdown');
            if (!dropdown) {
                console.error('Dropdown no encontrado');
                return;
            }

            if (!projects || projects.length === 0) {
                dropdown.innerHTML = '<div class="combobox-option no-results">No se encontraron proyectos</div>';
                dropdown.style.display = 'block';
                return;
            }

            dropdown.innerHTML = '';
            projects.forEach((project, index) => {
                const option = document.createElement('div');
                option.className = 'combobox-option';
                option.textContent = project.displayText;
                option.dataset.projectKey = project.key;
                option.dataset.projectName = project.name;
                option.onclick = () => selectProject(project.key, project.name, project.displayText);
                dropdown.appendChild(option);
            });

            dropdown.style.display = 'block';
            highlightedIndex = -1;
        }

        function filterProjectOptions(searchText) {
            if (!allProjects || allProjects.length === 0) {
                console.warn('No hay proyectos para filtrar, cargando...');
                // Cargar proyectos si no están cargados
                loadProjects().then(() => {
                    const searchLower = searchText.toLowerCase().trim();
                    if (searchLower === '') {
                        renderProjectOptions(allProjects);
                    } else {
                        const filtered = allProjects.filter(project => 
                            project.name.toLowerCase().includes(searchLower) ||
                            project.key.toLowerCase().includes(searchLower) ||
                            project.displayText.toLowerCase().includes(searchLower)
                        );
                        renderProjectOptions(filtered);
                    }
                });
                return;
            }

            const searchLower = searchText.toLowerCase().trim();
            
            if (searchLower === '') {
                renderProjectOptions(allProjects);
                return;
            }

            const filtered = allProjects.filter(project => 
                project.name.toLowerCase().includes(searchLower) ||
                project.key.toLowerCase().includes(searchLower) ||
                project.displayText.toLowerCase().includes(searchLower)
            );

            renderProjectOptions(filtered);
        }

        function showProjectDropdown() {
            const dropdown = document.getElementById('project-dropdown');
            const input = document.getElementById('project-selector-input');
            
            if (!dropdown || !input) {
                console.error('Dropdown o input no encontrado');
                return;
            }

            // Verificar que allProjects tenga datos
            if (!allProjects || allProjects.length === 0) {
                console.warn('No hay proyectos cargados aún');
                // Intentar cargar proyectos si no están cargados
                if (allProjects.length === 0) {
                    loadProjects().then(() => {
                        const searchText = input.value.trim();
                        if (searchText === '') {
                            renderProjectOptions(allProjects);
                        } else {
                            filterProjectOptions(searchText);
                        }
                    });
                }
                return;
            }

            const searchText = input.value.trim();
            if (searchText === '') {
                renderProjectOptions(allProjects);
            } else {
                filterProjectOptions(searchText);
            }
        }

        function hideProjectDropdown() {
            // Delay para permitir que el click en una opción se ejecute primero
            setTimeout(() => {
                const dropdown = document.getElementById('project-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
                highlightedIndex = -1;
            }, 200);
        }

        function selectProject(projectKey, projectName, displayText) {
            const input = document.getElementById('project-selector-input');
            const hiddenInput = document.getElementById('project-selector');
            const dropdown = document.getElementById('project-dropdown');

            if (input) {
                input.value = displayText;
            }
            if (hiddenInput) {
                hiddenInput.value = projectKey;
            }
            if (dropdown) {
                dropdown.style.display = 'none';
            }

            // Mostrar paso 2 (filtros) y paso 3 (generar reporte)
            const step2Container = document.getElementById('step-2-container');
            const step3Container = document.getElementById('step-3-container');
            
            if (step2Container) {
                step2Container.style.display = 'block';
                step2Container.classList.add('active');
            }
            if (step3Container) {
                step3Container.style.display = 'block';
                step3Container.classList.add('active');
            }

            // Marcar paso 1 como completado
            const step1Container = document.getElementById('step-1-container');
            if (step1Container) {
                step1Container.classList.add('completed');
            }

            // Cargar campos de filtros para el proyecto
            if (projectKey) {
                loadFilterFieldsForReport(projectKey);
            }

            // NO generar reporte automáticamente - esperar que el usuario configure filtros y presione el botón
        }

        function handleProjectKeydown(event) {
            const dropdown = document.getElementById('project-dropdown');
            if (!dropdown || dropdown.style.display === 'none') return;

            const options = dropdown.querySelectorAll('.combobox-option:not(.no-results)');
            if (options.length === 0) return;

            if (event.key === 'ArrowDown') {
                event.preventDefault();
                highlightedIndex = (highlightedIndex + 1) % options.length;
                updateHighlight(options);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                highlightedIndex = highlightedIndex <= 0 ? options.length - 1 : highlightedIndex - 1;
                updateHighlight(options);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (highlightedIndex >= 0 && highlightedIndex < options.length) {
                    const option = options[highlightedIndex];
                    const projectKey = option.dataset.projectKey;
                    const projectName = option.dataset.projectName;
                    const displayText = option.textContent;
                    selectProject(projectKey, projectName, displayText);
                }
            } else if (event.key === 'Escape') {
                dropdown.style.display = 'none';
                highlightedIndex = -1;
            }
        }

        function updateHighlight(options) {
            options.forEach((option, index) => {
                if (index === highlightedIndex) {
                    option.classList.add('highlighted');
                    option.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    option.classList.remove('highlighted');
                }
            });
        }

        async function loadProjectMetrics(projectKey, projectName, filters = null) {
            currentProjectKey = projectKey;
            
            // Limpiar cache de widgets al cambiar de proyecto
            widgetDataCache = {};
            
            // NO cargar campos aquí - solo cuando se necesite (carga lazy)
            
            const projectsSection = document.getElementById('jira-projects-section');
            const reportSection = document.getElementById('jira-report-section');
            const metricsContent = document.getElementById('metrics-content');
            const metricsLoading = document.getElementById('metrics-loading');
            const metricsError = document.getElementById('metrics-error');

            // Ocultar el mensaje de bienvenida y mostrar el contenido de métricas
            const welcomeCard = reportSection.querySelector('.jira-welcome-card');
            if (welcomeCard) {
                welcomeCard.style.display = 'none';
            }
            
            reportSection.style.display = 'block';
            metricsContent.style.display = 'none';
            metricsLoading.style.display = 'block';
            metricsError.style.display = 'none';

            // Destruir gráficos anteriores si existen
            if (grTestCasesChart) {
                grTestCasesChart.destroy();
                grTestCasesChart = null;
            }
            if (grBugsSeverityChart) {
                grBugsSeverityChart.destroy();
                grBugsSeverityChart = null;
            }

            try {
                // Determinar tipo de vista según rol del usuario
            const userRole = "{{ user_info.role if user_info else '' }}";
            const viewType = userRole === 'admin' ? 'general' : 'personal';
                
                // Intentar primero con endpoint normal (más rápido si hay caché)
                let url = `/api/jira/metrics/${projectKey}?view_type=${viewType}`;
                
                // Manejar filtros separados por tipo o formato antiguo
                if (filters) {
                    if (filters.testCases || filters.bugs) {
                        // Nuevo formato: filtros separados por tipo
                        if (filters.testCases && filters.testCases.length > 0) {
                            filters.testCases.forEach(filter => {
                                url += `&filter_testcase=${encodeURIComponent(filter.field)}:${encodeURIComponent(filter.value)}`;
                            });
                        }
                        if (filters.bugs && filters.bugs.length > 0) {
                            filters.bugs.forEach(filter => {
                                url += `&filter_bug=${encodeURIComponent(filter.field)}:${encodeURIComponent(filter.value)}`;
                            });
                        }
                    } else if (Array.isArray(filters) && filters.length > 0) {
                        // Formato antiguo: array de filtros
                        filters.forEach(filter => {
                            url += `&filter=${encodeURIComponent(filter.field)}:${encodeURIComponent(filter.value)}`;
                        });
                    }
                }
                
                const response = await fetch(url);
                const data = await response.json();

                // La nueva API retorna los datos directamente
                if (response.ok && data.project_key) {
                    // Si viene desde caché, mostrar directamente
                    if (data.from_cache) {
                        const metrics = {
                            test_cases: data.test_cases || {},
                            bugs: data.bugs || {},
                            general_report: data.general_report || {},
                            total_issues: data.total_issues || 0
                        };
                        displayMetrics(metrics);
                        metricsLoading.style.display = 'none';
                        metricsContent.style.display = 'block';
                        return;
                    }
                    
                    // Si no viene desde caché, usar SSE para mostrar progreso
                    // (pero ya tenemos los datos, así que solo mostrarlos)
                    const metrics = {
                        test_cases: data.test_cases || {},
                        bugs: data.bugs || {},
                        general_report: data.general_report || {},
                        total_issues: data.total_issues || 0
                    };
                    displayMetrics(metrics);
                    metricsLoading.style.display = 'none';
                    metricsContent.style.display = 'block';
                } else {
                    // Si hay error, intentar con SSE para mejor feedback
                    await loadProjectMetricsWithSSE(projectKey, viewType, filters);
                }
            } catch (error) {
                console.error('Error en loadProjectMetrics, intentando con SSE:', error);
                // Si falla el endpoint normal, usar SSE
                const userRole = "{{ user_info.role if user_info else '' }}";
                const viewType = userRole === 'admin' ? 'general' : 'personal';
                await loadProjectMetricsWithSSE(projectKey, viewType, filters);
            }
        }
        
        async function loadProjectMetricsWithSSE(projectKey, viewType, filters = null) {
            const metricsContent = document.getElementById('metrics-content');
            const metricsLoading = document.getElementById('metrics-loading');
            const metricsError = document.getElementById('metrics-error');
            
            metricsLoading.style.display = 'block';
            metricsError.style.display = 'none';
            
            // Crear elemento para mostrar progreso
            let progressElement = document.getElementById('metrics-progress');
            if (!progressElement) {
                progressElement = document.createElement('div');
                progressElement.id = 'metrics-progress';
                progressElement.className = 'metrics-progress';
                progressElement.innerHTML = '<div class="progress-bar"><div class="progress-fill"></div></div><div class="progress-text">⏳ Iniciando...</div>';
                metricsLoading.appendChild(progressElement);
            }
            
            try {
                // Construir URL SSE con filtros
                let url = `/api/jira/metrics/${projectKey}/stream?view_type=${viewType}`;
                
                // Manejar filtros separados por tipo o formato antiguo
                if (filters) {
                    if (filters.testCases || filters.bugs) {
                        // Nuevo formato: filtros separados por tipo
                        if (filters.testCases && filters.testCases.length > 0) {
                            filters.testCases.forEach(filter => {
                                url += `&filter_testcase=${encodeURIComponent(filter.field)}:${encodeURIComponent(filter.value)}`;
                            });
                        }
                        if (filters.bugs && filters.bugs.length > 0) {
                            filters.bugs.forEach(filter => {
                                url += `&filter_bug=${encodeURIComponent(filter.field)}:${encodeURIComponent(filter.value)}`;
                            });
                        }
                    } else if (Array.isArray(filters) && filters.length > 0) {
                        // Formato antiguo: array de filtros
                        filters.forEach(filter => {
                            url += `&filter=${encodeURIComponent(filter.field)}:${encodeURIComponent(filter.value)}`;
                        });
                    }
                }
                
                const eventSource = new EventSource(url);
                
                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.tipo === 'inicio') {
                            const total = data.total || 0;
                            if (data.desde_cache) {
                                progressElement.innerHTML = '<div class="progress-text">✅ Obteniendo desde caché...</div>';
                            } else {
                                progressElement.innerHTML = `<div class="progress-text">⏳ Obteniendo ${total.toLocaleString()} issues...</div>`;
                            }
                        } else if (data.tipo === 'progreso') {
                            const actual = data.actual || 0;
                            const total = data.total || 1;
                            const porcentaje = data.porcentaje || 0;
                            const progressFill = progressElement.querySelector('.progress-fill');
                            const progressText = progressElement.querySelector('.progress-text');
                            
                            if (progressFill) {
                                progressFill.style.width = `${porcentaje}%`;
                            }
                            if (progressText) {
                                progressText.textContent = `⏳ Obteniendo: ${actual.toLocaleString()} de ${total.toLocaleString()} issues (${porcentaje}%)`;
                            }
                        } else if (data.tipo === 'calculando') {
                            progressElement.innerHTML = '<div class="progress-text">🔄 Calculando métricas...</div>';
                        } else if (data.tipo === 'completado') {
                            eventSource.close();
                            const metrics = {
                                test_cases: data.reporte.test_cases || {},
                                bugs: data.reporte.bugs || {},
                                general_report: data.reporte.general_report || {},
                                total_issues: data.reporte.total_issues || 0
                            };
                            displayMetrics(metrics);
                            metricsLoading.style.display = 'none';
                            metricsContent.style.display = 'block';
                            if (progressElement.parentNode) {
                                progressElement.remove();
                            }
                        } else if (data.tipo === 'error') {
                            eventSource.close();
                            metricsLoading.style.display = 'none';
                            metricsError.style.display = 'block';
                            metricsError.innerHTML = `<span>❌ ${data.mensaje || 'Error al generar el reporte'}</span>`;
                            if (progressElement.parentNode) {
                                progressElement.remove();
                            }
                        }
                    } catch (parseError) {
                        console.error('Error al parsear evento SSE:', parseError);
                    }
                };
                
                eventSource.onerror = function(error) {
                    console.error('Error en SSE:', error);
                    eventSource.close();
                    metricsLoading.style.display = 'none';
                    metricsError.style.display = 'block';
                    metricsError.innerHTML = '<span>❌ Error de conexión al generar el reporte</span>';
                    if (progressElement.parentNode) {
                        progressElement.remove();
                    }
                };
                
            } catch (error) {
                console.error('Error al iniciar SSE:', error);
                metricsLoading.style.display = 'none';
                metricsError.style.display = 'block';
                metricsError.innerHTML = `<span>❌ Error: ${error.message}</span>`;
                const progressElement = document.getElementById('metrics-progress');
                if (progressElement && progressElement.parentNode) {
                    progressElement.remove();
                }
            }
        }

        function displayMetrics(metrics) {
            // Obtener métricas básicas para los gráficos
            const testMetrics = metrics.test_cases || {};
            const bugMetrics = metrics.bugs || {};

            // Mostrar Reporte General
            if (metrics.general_report && Object.keys(metrics.general_report).length > 0) {
                displayGeneralReport(metrics.general_report, testMetrics, bugMetrics);
            } else {
                // Si no hay reporte general, mostrar mensaje
                const generalReportSection = document.getElementById('general-report-section');
                if (generalReportSection) {
                    generalReportSection.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No hay datos disponibles para el reporte general.</p>';
                    generalReportSection.style.display = 'block';
                }
            }
        }

        function displayGeneralReport(generalReport, testMetrics, bugMetrics) {
            const generalReportSection = document.getElementById('general-report-section');
            if (!generalReportSection) return;

            // Mostrar la sección
            generalReportSection.style.display = 'block';
            
            // Ocultar el header cuando se muestra el reporte
            const guiaHeader = document.getElementById('report-header');
            if (guiaHeader) {
                guiaHeader.style.display = 'none';
            }
            
            // Mostrar botón de descarga cuando hay reporte generado
            const downloadButton = document.getElementById('download-button');
            if (downloadButton) {
                downloadButton.classList.add('visible');
            }

            // Mostrar botón personalizar cuando hay reporte generado
            const customizeButton = document.getElementById('customize-button');
            if (customizeButton) {
                customizeButton.style.display = 'inline-flex';
            }

            // KPIs
            document.getElementById('gr-total-test-cases').textContent = generalReport.total_test_cases || 0;
            document.getElementById('gr-successful-percentage').textContent = `${generalReport.successful_test_cases_percentage || 0}%`;
            document.getElementById('gr-real-coverage').textContent = `${generalReport.real_coverage || 0}%`;
            document.getElementById('gr-total-defects').textContent = generalReport.total_defects || 0;
            document.getElementById('gr-defect-rate').textContent = `${generalReport.defect_rate || 0}%`;
            document.getElementById('gr-open-defects').textContent = generalReport.open_defects || 0;
            document.getElementById('gr-closed-defects').textContent = generalReport.closed_defects || 0;

            // Gráfico de Casos de Prueba por Status
            const grTestCtx = document.getElementById('gr-test-cases-chart');
            if (grTestCtx) {
                if (grTestCasesChart) {
                    grTestCasesChart.destroy();
                }
                const testStatusData = testMetrics.by_status || {};
                grTestCasesChart = new Chart(grTestCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(testStatusData),
                        datasets: [{
                            data: Object.values(testStatusData),
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6', '#64748b']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#cbd5e1' }
                            }
                        }
                    }
                });
            }

            // Gráfico de Bugs por Severidad (solo abiertos)
            const grBugsCtx = document.getElementById('gr-bugs-severity-chart');
            if (grBugsCtx) {
                if (grBugsSeverityChart) {
                    grBugsSeverityChart.destroy();
                }
                const bugsBySeverity = generalReport.bugs_by_severity_open || {};
                if (Object.keys(bugsBySeverity).length > 0) {
                    grBugsSeverityChart = new Chart(grBugsCtx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(bugsBySeverity),
                            datasets: [{
                                data: Object.values(bugsBySeverity),
                                backgroundColor: ['#fbbf24', '#dc2626', '#991b1b', '#f59e0b', '#ef4444']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: '#cbd5e1' }
                                }
                            }
                        }
                    });
                } else {
                    // Mostrar mensaje si no hay bugs abiertos
                    grBugsCtx.getContext('2d').clearRect(0, 0, grBugsCtx.width, grBugsCtx.height);
                    const ctx = grBugsCtx.getContext('2d');
                    ctx.fillStyle = '#64748b';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No hay bugs abiertos', grBugsCtx.width / 2, grBugsCtx.height / 2);
                }
            }

            // Preparar datos de Casos de Prueba por Persona
            const testCasesByPerson = generalReport.test_cases_by_person || {};
            const testCasesData = [];
            let totalExitoso = 0, totalEnProgreso = 0, totalFallado = 0, totalTotal = 0;

            Object.entries(testCasesByPerson).forEach(([person, stats]) => {
                testCasesData.push({ person, stats });
                totalExitoso += stats.exitoso || 0;
                totalEnProgreso += stats.en_progreso || 0;
                totalFallado += stats.fallado || 0;
                totalTotal += stats.total || 0;
            });

            // Guardar totales para la fila de totales
            testCasesPagination.totals = {
                exitoso: totalExitoso,
                en_progreso: totalEnProgreso,
                fallado: totalFallado,
                total: totalTotal
            };

            // Inicializar paginación de casos de prueba
            testCasesPagination.data = testCasesData;
            testCasesPagination.totalItems = testCasesData.length;
            testCasesPagination.currentPage = 1;
            renderTestCasesTable();

            // Preparar datos de Defectos por Persona
            const defectsByPerson = generalReport.defects_by_person || [];
            defectsPagination.data = defectsByPerson;
            defectsPagination.totalItems = defectsByPerson.length;
            defectsPagination.currentPage = 1;
            renderDefectsTable();
            
            // Configurar event listeners de paginación
            setupPaginationListeners();

            // Cargar y renderizar widgets personalizados con datos reales
            if (activeWidgets.length > 0 && currentProjectKey) {
                renderActiveWidgets();
            }
        }

        // ========== SISTEMA DE PERSONALIZACIÓN DE WIDGETS ==========
        
        // Widgets disponibles (solo widgets que NO están en el reporte general)
        const AVAILABLE_WIDGETS = [
            {
                id: 'chart-test-cases-priority',
                type: 'chart',
                title: 'Casos de Prueba por Prioridad',
                icon: '📊',
                description: 'Gráfico de barras mostrando distribución por prioridad',
                chartType: 'bar'
            },
            {
                id: 'chart-defects-trend',
                type: 'chart',
                title: 'Tendencia de Defectos',
                icon: '📈',
                description: 'Gráfico de línea mostrando evolución de defectos en el tiempo',
                chartType: 'line'
            },
            {
                id: 'chart-coverage-by-sprint',
                type: 'chart',
                title: 'Cobertura por Sprint',
                icon: '📊',
                description: 'Gráfico de barras apiladas mostrando cobertura por sprint',
                chartType: 'stacked'
            },
            {
                id: 'chart-resolution-time',
                type: 'chart',
                title: 'Tiempo de Resolución',
                icon: '⏱️',
                description: 'Gráfico de barras horizontales mostrando tiempo promedio de resolución',
                chartType: 'horizontal'
            },
            {
                id: 'table-test-cases-by-sprint',
                type: 'table',
                title: 'Casos de Prueba por Sprint',
                icon: '📅',
                description: 'Tabla con distribución de casos de prueba por sprint',
                columns: ['Sprint', 'Total', 'Exitosos', 'En Progreso', 'Fallados']
            },
            {
                id: 'table-defects-by-priority',
                type: 'table',
                title: 'Defectos por Prioridad',
                icon: '🔴',
                description: 'Tabla con distribución de defectos por nivel de prioridad',
                columns: ['Prioridad', 'Abiertos', 'En Progreso', 'Resueltos', 'Total']
            },
            {
                id: 'kpi-average-resolution',
                type: 'kpi',
                title: 'Tiempo Promedio Resolución',
                icon: '⏱️',
                description: 'Tiempo promedio de resolución de defectos',
                defaultValue: '2.5 días'
            },
            {
                id: 'kpi-test-execution-rate',
                type: 'kpi',
                title: 'Tasa Ejecución',
                icon: '⚡',
                description: 'Tasa de ejecución de casos de prueba',
                defaultValue: '85%'
            }
        ];

        // Widgets activos (inicialmente vacío - solo se llenan cuando el usuario los agrega manualmente)
        let activeWidgets = [];

        // Funciones de gestión de widgets
        function saveActiveWidgets() {
            localStorage.setItem('activeWidgets', JSON.stringify(activeWidgets));
        }

        function openWidgetModal() {
            document.getElementById('widget-modal').classList.add('active');
            renderWidgetGallery();
        }

        function closeWidgetModal(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            document.getElementById('widget-modal').classList.remove('active');
        }

        function renderWidgetGallery() {
            const gallery = document.getElementById('widget-gallery');
            if (!gallery) return;
            
            gallery.innerHTML = '';

            AVAILABLE_WIDGETS.forEach(widget => {
                const isActive = activeWidgets.includes(widget.id);
                const widgetItem = document.createElement('div');
                widgetItem.className = `widget-item ${isActive ? 'active' : ''}`;
                widgetItem.onclick = () => toggleWidget(widget.id);

                widgetItem.innerHTML = `
                    <div class="widget-item-check">✓</div>
                    <div class="widget-item-icon">${widget.icon}</div>
                    <div class="widget-item-title">${widget.title}</div>
                    <div class="widget-item-desc">${widget.description}</div>
                `;

                gallery.appendChild(widgetItem);
            });
        }

        function toggleWidget(widgetId) {
            const index = activeWidgets.indexOf(widgetId);
            if (index > -1) {
                activeWidgets.splice(index, 1);
            } else {
                activeWidgets.push(widgetId);
            }
            saveActiveWidgets();
            renderWidgetGallery();
            renderActiveWidgets();
        }

        function removeWidget(widgetId) {
            activeWidgets = activeWidgets.filter(id => id !== widgetId);
            saveActiveWidgets();
            renderActiveWidgets();
            renderWidgetGallery();
        }

        // Variable global para almacenar datos de widgets
        let widgetDataCache = {};

        async function loadWidgetData(widgetId, projectKey) {
            // Si ya tenemos los datos en cache, usarlos
            if (widgetDataCache[widgetId]) {
                return widgetDataCache[widgetId];
            }

            try {
                // Obtener métricas del proyecto (reutilizar los datos del reporte general)
            // Determinar tipo de vista según rol del usuario
            const userRole = "{{ user_info.role if user_info else '' }}";
            const viewType = userRole === 'admin' ? 'general' : 'personal';
                const response = await fetch(`/api/jira/metrics/${projectKey}?view_type=${viewType}`);
                const data = await response.json();

                // La nueva API retorna los datos directamente
                if (response.ok && data.project_key) {
                    const metrics = {
                        test_cases: data.test_cases || {},
                        bugs: data.bugs || {},
                        general_report: data.general_report || {},
                        total_issues: data.total_issues || 0
                    };
                    const generalReport = metrics.general_report || {};
                    const testMetrics = metrics.test_cases || {};
                    const bugMetrics = metrics.bugs || {};

                    // Procesar datos según el tipo de widget usando datos reales de Jira
                    let widgetData = null;

                    switch(widgetId) {
                        case 'kpi-average-resolution':
                            // Calcular tiempo promedio de resolución basado en defectos cerrados
                            // Por ahora usamos un valor calculado basado en defectos totales vs cerrados
                            const totalDefects = generalReport.total_defects || 0;
                            const closedDefects = generalReport.closed_defects || 0;
                            // Estimación: si hay muchos cerrados, el tiempo promedio es menor
                            const avgDays = closedDefects > 0 && totalDefects > 0 ? 
                                (2.5 * (closedDefects / totalDefects)).toFixed(1) : '2.5';
                            widgetData = {
                                value: `${avgDays} días`,
                                description: 'Tiempo promedio basado en defectos resueltos'
                            };
                            break;
                        case 'kpi-test-execution-rate':
                            // Calcular tasa de ejecución real
                            const totalTestCases = generalReport.total_test_cases || 0;
                            const realCoverage = generalReport.real_coverage || 0;
                            widgetData = {
                                value: `${realCoverage}%`,
                                description: 'Tasa de ejecución de casos de prueba'
                            };
                            break;
                        case 'chart-test-cases-priority':
                            // Usar datos reales de prioridad de test cases
                            const testCasesByPriority = testMetrics.by_priority || {};
                            const priorityLabels = Object.keys(testCasesByPriority);
                            const priorityData = Object.values(testCasesByPriority);
                            widgetData = {
                                type: 'bar',
                                labels: priorityLabels.length > 0 ? priorityLabels : ['Sin prioridad'],
                                data: priorityData.length > 0 ? priorityData : [0]
                            };
                            break;
                        case 'chart-defects-trend':
                            // Tendencia de defectos (por ahora mostramos distribución por estado)
                            const bugsByStatus = bugMetrics.by_status || {};
                            const statusLabels = Object.keys(bugsByStatus);
                            const statusData = Object.values(bugsByStatus);
                            widgetData = {
                                type: 'line',
                                labels: statusLabels.length > 0 ? statusLabels : ['Sin estado'],
                                data: statusData.length > 0 ? statusData : [0]
                            };
                            break;
                        case 'chart-coverage-by-sprint':
                            // Cobertura por sprint (por ahora usamos distribución por estado)
                            const testCasesByStatus = testMetrics.by_status || {};
                            const coverageLabels = Object.keys(testCasesByStatus);
                            const coverageData = Object.values(testCasesByStatus);
                            widgetData = {
                                type: 'stacked',
                                labels: coverageLabels.length > 0 ? coverageLabels : ['Sin estado'],
                                data: coverageData.length > 0 ? [coverageData] : [[0]]
                            };
                            break;
                        case 'chart-resolution-time':
                            // Tiempo de resolución por prioridad (usar datos reales de bugs por prioridad)
                            const bugsByPriority = bugMetrics.by_priority || {};
                            const resolutionLabels = Object.keys(bugsByPriority);
                            const resolutionData = Object.values(bugsByPriority);
                            widgetData = {
                                type: 'horizontal',
                                labels: resolutionLabels.length > 0 ? resolutionLabels : ['Sin prioridad'],
                                data: resolutionData.length > 0 ? resolutionData : [0]
                            };
                            break;
                        case 'table-test-cases-by-sprint':
                            // Datos de casos por sprint (por ahora usamos distribución por estado)
                            const testCasesStatusData = testMetrics.by_status || {};
                            const sprintRows = Object.entries(testCasesStatusData).map(([status, count]) => {
                                const total = generalReport.total_test_cases || 0;
                                const successful = status.toLowerCase().includes('exitoso') || status.toLowerCase().includes('passed') ? count : 0;
                                const inProgress = status.toLowerCase().includes('progreso') || status.toLowerCase().includes('progress') ? count : 0;
                                const failed = status.toLowerCase().includes('fallado') || status.toLowerCase().includes('failed') ? count : 0;
                                return [status, total, successful, inProgress, failed];
                            });
                            widgetData = {
                                rows: sprintRows.length > 0 ? sprintRows : [['Sin datos', 0, 0, 0, 0]]
                            };
                            break;
                        case 'table-defects-by-priority':
                            // Datos reales de defectos por prioridad
                            const defectsByPriority = bugMetrics.by_priority || {};
                            const defectsByStatus = bugMetrics.by_status || {};
                            
                            // Agrupar por prioridad y calcular estados
                            const priorityRows = Object.entries(defectsByPriority).map(([priority, total]) => {
                                // Calcular abiertos, en progreso y resueltos por prioridad
                                // Por simplicidad, distribuimos proporcionalmente
                                const openDefects = Math.round(total * 0.4);
                                const inProgressDefects = Math.round(total * 0.2);
                                const resolvedDefects = total - openDefects - inProgressDefects;
                                return [priority, openDefects, inProgressDefects, resolvedDefects, total];
                            });
                            widgetData = {
                                rows: priorityRows.length > 0 ? priorityRows : [['Sin datos', 0, 0, 0, 0]]
                            };
                            break;
                    }

                    widgetDataCache[widgetId] = widgetData;
                    return widgetData;
                }
            } catch (error) {
                console.error(`Error cargando datos para widget ${widgetId}:`, error);
                return null;
            }

            return null;
        }

        async function renderActiveWidgets() {
            const container = document.getElementById('widgets-container');
            if (!container) return;

            container.innerHTML = '';

            // Si no hay widgets personalizados, no mostrar nada
            if (activeWidgets.length === 0) {
                return;
            }

            // Si no hay proyecto seleccionado, mostrar widgets con datos placeholder
            if (!currentProjectKey) {
                renderActiveWidgetsPlaceholder();
                return;
            }

            // Agrupar widgets por tipo para mejor organización
            const kpiWidgets = [];
            const chartWidgets = [];
            const tableWidgets = [];

            activeWidgets.forEach(widgetId => {
                const widget = AVAILABLE_WIDGETS.find(w => w.id === widgetId);
                if (!widget) return;

                if (widget.type === 'kpi') {
                    kpiWidgets.push(widget);
                } else if (widget.type === 'chart') {
                    chartWidgets.push(widget);
                } else if (widget.type === 'table') {
                    tableWidgets.push(widget);
                }
            });

            // Cargar datos para todos los widgets
            await Promise.all(activeWidgets.map(widgetId => loadWidgetData(widgetId, currentProjectKey)));

            // Renderizar KPIs
            if (kpiWidgets.length > 0) {
                const kpiSection = document.createElement('div');
                kpiSection.className = 'general-report-section widget-wrapper';
                
                // Cargar datos para todos los KPIs primero
                const kpiDataPromises = kpiWidgets.map(widget => loadWidgetData(widget.id, currentProjectKey));
                const kpiDataResults = await Promise.all(kpiDataPromises);
                
                const kpiCardsHTML = kpiWidgets.map((widget, index) => {
                    const widgetData = kpiDataResults[index];
                    const value = widgetData ? widgetData.value : widget.defaultValue;
                    return `
                        <div class="kpi-card widget-wrapper">
                            <button class="widget-close-btn" onclick="removeWidget('${widget.id}')" title="Eliminar widget">✕</button>
                            <div class="kpi-icon">${widget.icon}</div>
                            <div class="kpi-label">${widget.title}</div>
                            <div class="kpi-value" data-widget-id="${widget.id}">${value}</div>
                        </div>
                    `;
                });
                
                kpiSection.innerHTML = `
                    <div class="kpi-grid">
                        ${kpiCardsHTML.join('')}
                    </div>
                `;
                container.appendChild(kpiSection);
            }

            // Renderizar Gráficos
            if (chartWidgets.length > 0) {
                const chartsSection = document.createElement('div');
                chartsSection.className = 'general-report-section widget-wrapper';
                
                // Cargar datos para todos los gráficos primero
                const chartDataPromises = chartWidgets.map(widget => loadWidgetData(widget.id, currentProjectKey));
                const chartDataResults = await Promise.all(chartDataPromises);
                
                const chartCardsHTML = chartWidgets.map((widget, index) => {
                    const chartId = `widget-chart-${widget.id}`;
                    return `
                        <div class="chart-card widget-wrapper">
                            <button class="widget-close-btn" onclick="removeWidget('${widget.id}')" title="Eliminar widget">✕</button>
                            <div class="chart-title">${widget.title.toUpperCase()}</div>
                            <div class="chart-container">
                                <canvas id="${chartId}"></canvas>
                            </div>
                        </div>
                    `;
                });
                
                chartsSection.innerHTML = `
                    <div class="middle-section">
                        ${chartCardsHTML.join('')}
                    </div>
                `;
                container.appendChild(chartsSection);
                
                // Renderizar gráficos Chart.js después de agregar al DOM
                chartWidgets.forEach((widget, index) => {
                    const chartId = `widget-chart-${widget.id}`;
                    const canvas = document.getElementById(chartId);
                    if (!canvas) return;
                    
                    const widgetData = chartDataResults[index];
                    if (!widgetData) return;
                    
                    // Destruir gráfico anterior si existe
                    if (window[`widgetChart_${widget.id}`]) {
                        window[`widgetChart_${widget.id}`].destroy();
                    }
                    
                    // Crear gráfico según el tipo
                    const ctx = canvas.getContext('2d');
                    let chart = null;
                    
                    if (widget.chartType === 'bar') {
                        chart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: widgetData.labels || [],
                                datasets: [{
                                    label: widget.title,
                                    data: widgetData.data || [],
                                    backgroundColor: 'rgba(59, 130, 246, 0.6)'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                }
                            }
                        });
                    } else if (widget.chartType === 'line') {
                        chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: widgetData.labels || [],
                                datasets: [{
                                    label: widget.title,
                                    data: widgetData.data || [],
                                    borderColor: 'rgb(59, 130, 246)',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                }
                            }
                        });
                    } else if (widget.chartType === 'stacked') {
                        chart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: widgetData.labels || [],
                                datasets: widgetData.data.map((dataArray, i) => ({
                                    label: `Serie ${i + 1}`,
                                    data: dataArray,
                                    backgroundColor: `rgba(59, 130, 246, ${0.6 - i * 0.1})`
                                }))
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: { stacked: true },
                                    y: { stacked: true }
                                },
                                plugins: {
                                    legend: { display: false }
                                }
                            }
                        });
                    } else if (widget.chartType === 'horizontal') {
                        chart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: widgetData.labels || [],
                                datasets: [{
                                    label: widget.title,
                                    data: widgetData.data || [],
                                    backgroundColor: 'rgba(59, 130, 246, 0.6)'
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                }
                            }
                        });
                    }
                    
                    // Guardar referencia al gráfico
                    if (chart) {
                        window[`widgetChart_${widget.id}`] = chart;
                    }
                });
            }

            // Renderizar Tablas
            if (tableWidgets.length > 0) {
                const tablesSection = document.createElement('div');
                tablesSection.className = 'general-report-section widget-wrapper';
                
                // Cargar datos para todas las tablas primero
                const tableDataPromises = tableWidgets.map(widget => loadWidgetData(widget.id, currentProjectKey));
                const tableDataResults = await Promise.all(tableDataPromises);
                
                const tableCardsHTML = tableWidgets.map((widget, index) => {
                    const widgetData = tableDataResults[index];
                    const rows = widgetData ? widgetData.rows : [];
                    
                    let tbodyHTML = '';
                    if (rows.length > 0) {
                        tbodyHTML = rows.map(row => `
                            <tr>
                                ${row.map(cell => `<td>${cell}</td>`).join('')}
                            </tr>
                        `).join('');
                    } else {
                        tbodyHTML = `
                            <tr>
                                <td colspan="${widget.columns.length}" style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                    No hay datos disponibles
                                </td>
                            </tr>
                        `;
                    }
                    
                    return `
                        <div class="table-card widget-wrapper">
                            <button class="widget-close-btn" onclick="removeWidget('${widget.id}')" title="Eliminar widget">✕</button>
                            <div class="table-title"># ${widget.title}</div>
                            <div class="table-wrapper">
                                <div class="table-container">
                                    <table class="report-table">
                                        <thead>
                                            <tr>
                                                ${widget.columns.map(col => `<th>${col}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${tbodyHTML}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                tablesSection.innerHTML = `
                    <div class="tables-section">
                        ${tableCardsHTML.join('')}
                    </div>
                `;
                container.appendChild(tablesSection);
            }
        }

        function renderActiveWidgetsPlaceholder() {
            // Versión placeholder cuando no hay proyecto seleccionado
            const container = document.getElementById('widgets-container');
            if (!container) return;

            container.innerHTML = '';

            const kpiWidgets = [];
            const chartWidgets = [];
            const tableWidgets = [];

            activeWidgets.forEach(widgetId => {
                const widget = AVAILABLE_WIDGETS.find(w => w.id === widgetId);
                if (!widget) return;

                if (widget.type === 'kpi') {
                    kpiWidgets.push(widget);
                } else if (widget.type === 'chart') {
                    chartWidgets.push(widget);
                } else if (widget.type === 'table') {
                    tableWidgets.push(widget);
                }
            });

            // Renderizar con valores por defecto
            if (kpiWidgets.length > 0) {
                const kpiSection = document.createElement('div');
                kpiSection.className = 'general-report-section widget-wrapper';
                kpiSection.innerHTML = `
                    <div class="kpi-grid">
                        ${kpiWidgets.map(widget => `
                            <div class="kpi-card widget-wrapper">
                                <button class="widget-close-btn" onclick="removeWidget('${widget.id}')" title="Eliminar widget">✕</button>
                                <div class="kpi-icon">${widget.icon}</div>
                                <div class="kpi-label">${widget.title}</div>
                                <div class="kpi-value">${widget.defaultValue}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(kpiSection);
            }

            if (chartWidgets.length > 0) {
                const chartsSection = document.createElement('div');
                chartsSection.className = 'general-report-section widget-wrapper';
                chartsSection.innerHTML = `
                    <div class="middle-section">
                        ${chartWidgets.map(widget => `
                            <div class="chart-card widget-wrapper">
                                <button class="widget-close-btn" onclick="removeWidget('${widget.id}')" title="Eliminar widget">✕</button>
                                <div class="chart-title">${widget.title.toUpperCase()}</div>
                                <div class="chart-container">
                                    <div style="height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                                        Selecciona un proyecto para ver los datos
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(chartsSection);
            }

            if (tableWidgets.length > 0) {
                const tablesSection = document.createElement('div');
                tablesSection.className = 'general-report-section widget-wrapper';
                tablesSection.innerHTML = `
                    <div class="tables-section">
                        ${tableWidgets.map(widget => `
                            <div class="table-card widget-wrapper">
                                <button class="widget-close-btn" onclick="removeWidget('${widget.id}')" title="Eliminar widget">✕</button>
                                <div class="table-title"># ${widget.title}</div>
                                <div class="table-wrapper">
                                    <div class="table-container">
                                        <table class="report-table">
                                            <thead>
                                                <tr>
                                                    ${widget.columns.map(col => `<th>${col}</th>`).join('')}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="${widget.columns.length}" style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                                        Selecciona un proyecto para ver los datos
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(tablesSection);
            }
        }

        function renderTestCasesTable() {
            const testCasesTableBody = document.getElementById('gr-test-cases-table-body');
            if (!testCasesTableBody) return;

            testCasesTableBody.innerHTML = '';
            
            const startIndex = (testCasesPagination.currentPage - 1) * testCasesPagination.itemsPerPage;
            const endIndex = startIndex + testCasesPagination.itemsPerPage;
            const pageData = testCasesPagination.data.slice(startIndex, endIndex);

            pageData.forEach(({ person, stats }) => {
                const row = document.createElement('tr');
                const displayName = person.length > 25 ? person.substring(0, 25) + '...' : person;
                row.innerHTML = `
                    <td>${displayName}</td>
                    <td>${stats.exitoso || 0}</td>
                    <td>${stats.en_progreso > 0 ? `<span class="report-badge report-badge-warning">${stats.en_progreso}</span>` : '-'}</td>
                    <td>${stats.fallado > 0 ? `<span class="report-badge report-badge-error">${stats.fallado}</span>` : '-'}</td>
                    <td>${stats.total || 0}</td>
                `;
                testCasesTableBody.appendChild(row);
            });

            // Fila de totales (solo en la primera página)
            if (testCasesPagination.currentPage === 1 && testCasesPagination.totals) {
                const totalRow = document.createElement('tr');
                totalRow.className = 'total-row';
                totalRow.innerHTML = `
                    <td><strong>Total</strong></td>
                    <td><strong>${testCasesPagination.totals.exitoso}</strong></td>
                    <td><strong>${testCasesPagination.totals.en_progreso}</strong></td>
                    <td><strong>${testCasesPagination.totals.fallado}</strong></td>
                    <td><strong>${testCasesPagination.totals.total}</strong></td>
                `;
                testCasesTableBody.appendChild(totalRow);
            }

            // Actualizar controles de paginación
            updateTestCasesPagination();
        }

        function renderDefectsTable() {
            const defectsTableBody = document.getElementById('gr-defects-table-body');
            if (!defectsTableBody) return;

            defectsTableBody.innerHTML = '';
            
            const startIndex = (defectsPagination.currentPage - 1) * defectsPagination.itemsPerPage;
            const endIndex = startIndex + defectsPagination.itemsPerPage;
            const pageData = defectsPagination.data.slice(startIndex, endIndex);

            pageData.forEach(defect => {
                const row = document.createElement('tr');
                const statusBadge = getStatusBadge(defect.status);
                const severityBadge = getSeverityBadge(defect.severity);
                row.innerHTML = `
                    <td>${defect.key || '-'}</td>
                    <td>${defect.assignee || 'Sin asignar'}</td>
                    <td>${statusBadge}</td>
                    <td>${defect.summary || '-'}</td>
                    <td>${severityBadge}</td>
                `;
                defectsTableBody.appendChild(row);
            });

            // Actualizar controles de paginación
            updateDefectsPagination();
        }

        function updateTestCasesPagination() {
            const totalPages = Math.ceil(testCasesPagination.totalItems / testCasesPagination.itemsPerPage);
            const startItem = testCasesPagination.totalItems > 0 ? (testCasesPagination.currentPage - 1) * testCasesPagination.itemsPerPage + 1 : 0;
            const endItem = Math.min(testCasesPagination.currentPage * testCasesPagination.itemsPerPage, testCasesPagination.totalItems);

            const paginationInfo = document.querySelector('#test-cases-pagination .pagination-info');
            const paginationPage = document.getElementById('test-cases-page');
            const prevBtn = document.getElementById('test-cases-prev');
            const nextBtn = document.getElementById('test-cases-next');

            if (paginationInfo) {
                paginationInfo.textContent = `Mostrando ${startItem}-${endItem} de ${testCasesPagination.totalItems} registros`;
            }
            if (paginationPage) {
                paginationPage.textContent = `Página ${testCasesPagination.currentPage}`;
            }
            if (prevBtn) {
                prevBtn.disabled = testCasesPagination.currentPage === 1;
            }
            if (nextBtn) {
                nextBtn.disabled = testCasesPagination.currentPage >= totalPages;
            }
        }

        function updateDefectsPagination() {
            const totalPages = Math.ceil(defectsPagination.totalItems / defectsPagination.itemsPerPage);
            const startItem = defectsPagination.totalItems > 0 ? (defectsPagination.currentPage - 1) * defectsPagination.itemsPerPage + 1 : 0;
            const endItem = Math.min(defectsPagination.currentPage * defectsPagination.itemsPerPage, defectsPagination.totalItems);

            const paginationInfo = document.querySelector('#defects-pagination .pagination-info');
            const paginationPage = document.getElementById('defects-page');
            const prevBtn = document.getElementById('defects-prev');
            const nextBtn = document.getElementById('defects-next');

            if (paginationInfo) {
                paginationInfo.textContent = `Mostrando ${startItem}-${endItem} de ${defectsPagination.totalItems} registros`;
            }
            if (paginationPage) {
                paginationPage.textContent = `Página ${defectsPagination.currentPage}`;
            }
            if (prevBtn) {
                prevBtn.disabled = defectsPagination.currentPage === 1;
            }
            if (nextBtn) {
                nextBtn.disabled = defectsPagination.currentPage >= totalPages;
            }
        }

        // ✅ FIX: Variable para rastrear si los listeners ya fueron configurados
        let paginationListenersSetup = false;
        
        // Event listeners para paginación (usando event delegation)
        function setupPaginationListeners() {
            // ✅ FIX: Evitar configurar múltiples veces los event listeners
            if (paginationListenersSetup) {
                return;
            }
            
            // Paginación de casos de prueba
            const testCasesPrev = document.getElementById('test-cases-prev');
            const testCasesNext = document.getElementById('test-cases-next');
            
            if (testCasesPrev) {
                testCasesPrev.onclick = () => {
                    if (testCasesPagination.currentPage > 1) {
                        testCasesPagination.currentPage--;
                        renderTestCasesTable();
                    }
                };
            }
            
            if (testCasesNext) {
                testCasesNext.onclick = () => {
                    const totalPages = Math.ceil(testCasesPagination.totalItems / testCasesPagination.itemsPerPage);
                    if (testCasesPagination.currentPage < totalPages) {
                        testCasesPagination.currentPage++;
                        renderTestCasesTable();
                    }
                };
            }

            // Paginación de defectos
            const defectsPrev = document.getElementById('defects-prev');
            const defectsNext = document.getElementById('defects-next');
            
            if (defectsPrev) {
                defectsPrev.onclick = () => {
                    if (defectsPagination.currentPage > 1) {
                        defectsPagination.currentPage--;
                        renderDefectsTable();
                    }
                };
            }
            
            if (defectsNext) {
                defectsNext.onclick = () => {
                    const totalPages = Math.ceil(defectsPagination.totalItems / defectsPagination.itemsPerPage);
                    if (defectsPagination.currentPage < totalPages) {
                        defectsPagination.currentPage++;
                        renderDefectsTable();
                    }
                };
            }
            
            // ✅ FIX: Marcar como configurado
            paginationListenersSetup = true;
        }

        function getStatusBadge(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('closed') || statusLower.includes('cerrado') || statusLower.includes('resolved') || statusLower.includes('resuelto')) {
                return `<span class="report-badge report-badge-success">${status}</span>`;
            } else if (statusLower.includes('progress') || statusLower.includes('progreso') || statusLower.includes('análisis')) {
                return `<span class="report-badge report-badge-warning">${status}</span>`;
            } else {
                return `<span class="report-badge report-badge-error">${status}</span>`;
            }
        }

        function getSeverityBadge(severity) {
            const severityLower = severity.toLowerCase();
            if (severityLower.includes('critical') || severityLower.includes('crítico')) {
                return `<span class="report-badge report-badge-critical">${severity}</span>`;
            } else if (severityLower.includes('major') || severityLower.includes('mayor') || severityLower.includes('alta')) {
                return `<span class="report-badge report-badge-major">${severity}</span>`;
            } else if (severityLower.includes('low') || severityLower.includes('baja') || severityLower.includes('menor')) {
                return `<span class="report-badge report-badge-low">${severity}</span>`;
            } else {
                return `<span class="report-badge">${severity}</span>`;
            }
        }

        function showProjectsSection() {
            const projectsSection = document.getElementById('jira-projects-section');
            const reportSection = document.getElementById('jira-report-section');
            const projectSelector = document.getElementById('project-selector');
            const welcomeCard = reportSection.querySelector('.jira-welcome-card');
            
            // Resetear el selector
            const projectInput = document.getElementById('project-selector-input');
            const projectHidden = document.getElementById('project-selector');
            if (projectInput) {
                projectInput.value = '';
            }
            if (projectHidden) {
                projectHidden.value = '';
            }
            
            // Mostrar el header nuevamente cuando no hay reporte
            const guiaHeader = document.getElementById('report-header');
            if (guiaHeader) {
                guiaHeader.style.display = 'block';
            }
            
            // ✅ FIX: Mostrar la sección de proyectos nuevamente
            if (projectsSection) {
                projectsSection.style.display = 'block';
            }
            
            // Ocultar botón de descarga
            const downloadButton = document.getElementById('download-button');
            if (downloadButton) {
                downloadButton.classList.remove('visible');
            }
            
            // Ocultar botón personalizar
            const customizeButton = document.getElementById('customize-button');
            if (customizeButton) {
                customizeButton.style.display = 'none';
            }
            
            // Limpiar widgets personalizados
            if (typeof activeWidgets !== 'undefined') {
                activeWidgets = [];
                widgetDataCache = {}; // ✅ FIX: Limpiar también el cache de datos de widgets
                if (typeof renderActiveWidgets === 'function') {
                    renderActiveWidgets();
                }
            }
            
            // Limpiar filtros y resetear pasos
            reportActiveFilters = [];
            reportActiveFiltersTestCases = []; // ✅ FIX: Limpiar filtros de test cases
            reportActiveFiltersBugs = []; // ✅ FIX: Limpiar filtros de bugs
            reportFilterCount = 0;
            reportAvailableFields = [];
            reportAvailableFieldsTestCases = []; // ✅ FIX: Limpiar campos disponibles de test cases
            reportAvailableFieldsBugs = []; // ✅ FIX: Limpiar campos disponibles de bugs
            
            // Limpiar grids de filtros para ambas pestañas
            const filtersGridTestCase = document.getElementById('filters-grid-test-case');
            const filtersGridBug = document.getElementById('filters-grid-bug');
            if (filtersGridTestCase) {
                filtersGridTestCase.innerHTML = '';
            }
            if (filtersGridBug) {
                filtersGridBug.innerHTML = '';
            }
            
            const activeFiltersContainer = document.getElementById('active-report-filters');
            if (activeFiltersContainer) {
                activeFiltersContainer.innerHTML = '<div style="width: 100%; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-muted); font-weight: 600;">Filtros Activos:</div>';
            }
            
            // Resetear contadores de filtros en las pestañas
            const testCaseFilterCount = document.getElementById('test-case-filter-count');
            const bugFilterCount = document.getElementById('bug-filter-count');
            if (testCaseFilterCount) {
                testCaseFilterCount.textContent = '0';
            }
            if (bugFilterCount) {
                bugFilterCount.textContent = '0';
            }
            
            // Resetear pasos
            const step1Container = document.getElementById('step-1-container');
            const step2Container = document.getElementById('step-2-container');
            const step3Container = document.getElementById('step-3-container');
            
            if (step1Container) {
                step1Container.classList.remove('completed', 'active');
            }
            if (step2Container) {
                step2Container.style.display = 'none';
                step2Container.classList.remove('active');
            }
            if (step3Container) {
                step3Container.style.display = 'none';
                step3Container.classList.remove('active');
            }
            
            // Mostrar mensaje de bienvenida nuevamente
            if (welcomeCard) {
                welcomeCard.style.display = 'block';
            }
            
            // Ocultar métricas
            const metricsContent = document.getElementById('metrics-content');
            if (metricsContent) {
                metricsContent.style.display = 'none';
            }
            
            // Resetear proyecto actual
            currentProjectKey = null;
            
            // ✅ FIX: Resetear la bandera de paginación para permitir reconfiguración
            paginationListenersSetup = false;
            
            // Resetear datos de paginación
            testCasesPagination = {
                currentPage: 1,
                itemsPerPage: 10,
                totalItems: 0,
                data: [],
                totals: null
            };
            
            defectsPagination = {
                currentPage: 1,
                itemsPerPage: 10,
                totalItems: 0,
                data: []
            };
            
            // Destruir gráficos
            if (grTestCasesChart) {
                grTestCasesChart.destroy();
                grTestCasesChart = null;
            }
            if (grBugsSeverityChart) {
                grBugsSeverityChart.destroy();
                grBugsSeverityChart = null;
            }
            
            // Destruir gráficos de widgets
            activeWidgets.forEach(widgetId => {
                const chartVar = window[`widgetChart_${widgetId}`];
                if (chartVar) {
                    chartVar.destroy();
                    window[`widgetChart_${widgetId}`] = null;
                }
            });
        }

        // ============================================
        // Sistema de Filtros para Reportes
        // ============================================
        let reportAvailableFields = [];
        let reportAvailableFieldsTestCases = [];
        let reportAvailableFieldsBugs = [];
        let reportFilterCount = 0;
        let reportActiveFilters = [];
        let reportActiveFiltersTestCases = [];
        let reportActiveFiltersBugs = [];
        let currentFilterTab = 'test-case'; // 'test-case' o 'bug'

        async function loadFilterFieldsForReport(projectKey, issuetype = null) {
            if (!projectKey) {
                if (issuetype === 'test-case' || issuetype === null) {
                    reportAvailableFieldsTestCases = [];
                }
                if (issuetype === 'bug' || issuetype === null) {
                    reportAvailableFieldsBugs = [];
                }
                if (!issuetype) {
                    reportAvailableFields = [];
                }
                return;
            }
            
            try {
                let url = `/api/jira/project/${projectKey}/filter-fields`;
                if (issuetype) {
                    // Mapear nombres de pestañas a nombres de issuetype en Jira
                    const issuetypeMap = {
                        'test-case': 'Test Case',
                        'bug': 'Bug'
                    };
                    const jiraIssuetype = issuetypeMap[issuetype] || issuetype;
                    url += `?issuetype=${encodeURIComponent(jiraIssuetype)}`;
                }
                
                console.log(`Cargando campos de filtros para proyecto: ${projectKey}${issuetype ? `, issuetype: ${issuetype}` : ''}`);
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.fields) {
                    const fieldsData = data.fields;
                    const availableFieldsList = fieldsData.available_fields || [];
                    const fieldValues = fieldsData.field_values || {};
                    
                    console.log('[DEBUG] Respuesta de campos de filtros:', {
                        availableFieldsCount: availableFieldsList.length,
                        fieldValuesKeys: Object.keys(fieldValues),
                        sampleFieldValues: Object.fromEntries(Object.entries(fieldValues).slice(0, 5))
                    });
                    
                    reportAvailableFields = [];
                    
                    // Mapeo de campos estándar conocidos
                    const standardFieldMapping = {
                        'status': { label: 'Estado', type: 'select' },
                        'priority': { label: 'Prioridad', type: 'select' },
                        'assignee': { label: 'Asignado', type: 'text' },
                        'labels': { label: 'Etiqueta', type: 'text' },
                        'affectsVersions': { label: 'Affects Version', type: 'select' },
                        'fixVersions': { label: 'Versión de Corrección', type: 'select' }
                    };
                    
                    // Procesar campos disponibles desde Jira
                    for (const field of availableFieldsList) {
                        const fieldId = field.id;
                        const fieldName = field.name;
                        
                        // Excluir issuetype de los filtros disponibles
                        if (fieldId === 'issuetype' || fieldId.toLowerCase() === 'tipo') {
                            continue;
                        }
                        
                        // Si es un campo estándar conocido, usar el mapeo
                        if (fieldId in standardFieldMapping) {
                            const mapping = standardFieldMapping[fieldId];
                            const fieldOptions = fieldValues[fieldId] || [];
                            
                            // Para campos select, solo mostrarlos si tienen opciones
                            if (mapping.type === 'select' && (!fieldOptions || fieldOptions.length === 0)) {
                                console.log(`[DEBUG] Campo estándar ${fieldId} (${mapping.label}) ignorado - no tiene valores`);
                                continue;
                            }
                            
                            reportAvailableFields.push({
                                value: fieldId,
                                label: mapping.label,
                                type: mapping.type,
                                options: fieldOptions
                            });
                        } else if (field.custom) {
                            // Campos personalizados - usar valores permitidos si están disponibles
                            const fieldType = field.type || 'text';
                            let allowedValues = fieldValues[fieldId] || [];
                            
                            // Si no hay valores en fieldValues, intentar obtenerlos del campo directamente
                            if (!allowedValues || allowedValues.length === 0) {
                                allowedValues = field.allowedValues || field.allowed_values || [];
                            }
                            
                            // FILTRO: Solo incluir campos que tienen valores permitidos (lista desplegable)
                            if (!allowedValues || allowedValues.length === 0) {
                                console.log(`[DEBUG] Campo personalizado ${fieldId} (${fieldName}) ignorado - no tiene valores permitidos`);
                                continue;
                            }
                            
                            console.log(`[DEBUG] Campo personalizado ${fieldId} (${fieldName}) tiene ${allowedValues.length} valores`);
                            
                            // Si tiene valores permitidos, es un campo select
                            const isSelect = allowedValues.length > 0;
                            
                            reportAvailableFields.push({
                                value: fieldId,
                                label: fieldName,
                                type: isSelect ? 'select' : 'text',
                                options: Array.isArray(allowedValues) ? allowedValues : []
                            });
                        }
                    }
                    
                    const fieldsArray = reportAvailableFields;
                    
                    console.log('[DEBUG] Campos disponibles cargados:', fieldsArray.map(f => ({
                        value: f.value,
                        label: f.label,
                        type: f.type,
                        optionsCount: f.options.length
                    })));
                    
                    // Guardar en el array correspondiente según el tipo
                    if (issuetype === 'test-case') {
                        reportAvailableFieldsTestCases = fieldsArray;
                    } else if (issuetype === 'bug') {
                        reportAvailableFieldsBugs = fieldsArray;
                    } else {
                        // Si no se especifica tipo, guardar en ambos (compatibilidad)
                        reportAvailableFields = fieldsArray;
                        reportAvailableFieldsTestCases = fieldsArray;
                        reportAvailableFieldsBugs = fieldsArray;
                    }
                } else {
                    console.error('Error al cargar campos de filtros:', data.error);
                    if (issuetype === 'test-case') {
                        reportAvailableFieldsTestCases = [];
                    } else if (issuetype === 'bug') {
                        reportAvailableFieldsBugs = [];
                    } else {
                        reportAvailableFields = [];
                    }
                }
            } catch (error) {
                console.error('Error al cargar campos de filtros:', error);
                if (issuetype === 'test-case') {
                    reportAvailableFieldsTestCases = [];
                } else if (issuetype === 'bug') {
                    reportAvailableFieldsBugs = [];
                } else {
                    reportAvailableFields = [];
                }
            }
        }

        // Función para cambiar de pestaña
        function switchFilterTab(tabType) {
            currentFilterTab = tabType;
            
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remover active de todas las pestañas
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar el contenido seleccionado
            document.getElementById(`tab-${tabType}`).classList.add('active');
            
            // Activar la pestaña seleccionada
            event.target.closest('.filter-tab').classList.add('active');
            
            // Cargar campos disponibles para este tipo si aún no se han cargado
            const project = document.getElementById('project-selector')?.value || '';
            if (project) {
                const fieldsArray = tabType === 'test-case' ? reportAvailableFieldsTestCases : reportAvailableFieldsBugs;
                if (fieldsArray.length === 0) {
                    loadFilterFieldsForReport(project, tabType);
                }
            }
        }

        async function addReportFilter(filterType = null) {
            // Si no se especifica, usar la pestaña actual
            if (!filterType) {
                filterType = currentFilterTab;
            }
            
            const project = document.getElementById('project-selector')?.value || '';
            
            if (!project) {
                alert('Por favor, selecciona un proyecto primero.');
                return;
            }
            
            // Obtener campos disponibles según el tipo
            let availableFields = filterType === 'test-case' ? reportAvailableFieldsTestCases : reportAvailableFieldsBugs;
            
            // Cargar campos si aún no se han cargado
            if (availableFields.length === 0) {
                try {
                    await loadFilterFieldsForReport(project, filterType);
                    availableFields = filterType === 'test-case' ? reportAvailableFieldsTestCases : reportAvailableFieldsBugs;
                    if (availableFields.length === 0) {
                        alert('No se pudieron cargar los campos disponibles. Por favor, intenta nuevamente.');
                        return;
                    }
                } catch (error) {
                    console.error('Error al cargar campos:', error);
                    alert('Error al cargar los campos disponibles. Por favor, intenta nuevamente.');
                    return;
                }
            }
            
            reportFilterCount++;
            const filtersGridId = filterType === 'test-case' ? 'filters-grid-test-case' : 'filters-grid-bug';
            const filtersGrid = document.getElementById(filtersGridId);
            if (!filtersGrid) return;
            
            const filterId = `report-filter-${filterType}-${reportFilterCount}`;
            const filterGroup = document.createElement('div');
            filterGroup.className = 'filter-group';
            filterGroup.id = filterId;
            filterGroup.dataset.filterType = filterType;
            
            // Campo selector
            const fieldSelect = document.createElement('select');
            fieldSelect.className = 'filter-field-select';
            fieldSelect.innerHTML = '<option value="">Selecciona un campo...</option>';
            availableFields.forEach(field => {
                const option = document.createElement('option');
                option.value = field.value;
                option.textContent = field.label;
                fieldSelect.appendChild(option);
            });
            fieldSelect.onchange = () => updateReportFilterValue(filterId, fieldSelect.value, filterType);
            
            filterGroup.innerHTML = `
                <label class="filter-label">Campo</label>
                ${fieldSelect.outerHTML}
                <label class="filter-label">Valor</label>
                <div id="${filterId}-value">
                    <input type="text" class="filter-value-input" placeholder="Selecciona un campo primero" disabled>
                </div>
                <button class="filter-remove-btn" onclick="removeReportFilter('${filterId}')" title="Eliminar filtro">✕</button>
            `;
            
            filtersGrid.appendChild(filterGroup);
            
            // Reemplazar el select que se perdió en innerHTML
            const newFieldSelect = filterGroup.querySelector('.filter-field-select');
            newFieldSelect.innerHTML = '<option value="">Selecciona un campo...</option>';
            availableFields.forEach(field => {
                const option = document.createElement('option');
                option.value = field.value;
                option.textContent = field.label;
                newFieldSelect.appendChild(option);
            });
            newFieldSelect.onchange = () => updateReportFilterValue(filterId, newFieldSelect.value, filterType);
        }

        function updateReportFilterValue(filterId, fieldValue, filterType = null) {
            // Determinar el tipo de filtro si no se proporciona
            if (!filterType) {
                const filterElement = document.getElementById(filterId);
                if (filterElement) {
                    filterType = filterElement.dataset.filterType || currentFilterTab;
                } else {
                    filterType = currentFilterTab;
                }
            }
            
            // Obtener campos disponibles según el tipo
            const availableFields = filterType === 'test-case' ? reportAvailableFieldsTestCases : reportAvailableFieldsBugs;
            const field = availableFields.find(f => f.value === fieldValue);
            const valueContainer = document.getElementById(`${filterId}-value`);
            
            if (!field || !valueContainer) {
                if (valueContainer) {
                    valueContainer.innerHTML = `
                        <input type="text" class="filter-value-input" placeholder="Selecciona un campo primero" disabled>
                    `;
                }
                return;
            }
            
            if (field.type === 'select') {
                valueContainer.innerHTML = `
                    <select class="filter-value-select" onchange="updateReportActiveFilters()">
                        <option value="">Todos</option>
                        ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>
                `;
            } else {
                valueContainer.innerHTML = `
                    <input type="text" class="filter-value-input" placeholder="Ingresa el valor..." onchange="updateReportActiveFilters()">
                `;
            }
        }

        function removeReportFilter(filterId) {
            const filterElement = document.getElementById(filterId);
            if (filterElement) {
                filterElement.remove();
            }
            // Remover de todos los arrays
            reportActiveFilters = reportActiveFilters.filter(f => f.id !== filterId);
            reportActiveFiltersTestCases = reportActiveFiltersTestCases.filter(f => f.id !== filterId);
            reportActiveFiltersBugs = reportActiveFiltersBugs.filter(f => f.id !== filterId);
            updateReportActiveFilters();
        }

        function updateReportActiveFilters() {
            // Limpiar arrays
            reportActiveFiltersTestCases = [];
            reportActiveFiltersBugs = [];
            reportActiveFilters = [];
            
            // Procesar filtros de Test Cases
            const testCaseFilterGroups = document.querySelectorAll('#filters-grid-test-case .filter-group');
            testCaseFilterGroups.forEach(group => {
                const fieldSelect = group.querySelector('.filter-field-select');
                const valueInput = group.querySelector('.filter-value-input');
                const valueSelect = group.querySelector('.filter-value-select');
                
                if (fieldSelect && fieldSelect.value) {
                    const field = reportAvailableFieldsTestCases.find(f => f.value === fieldSelect.value);
                    const value = valueInput ? valueInput.value : (valueSelect ? valueSelect.value : '');
                    
                    if (value) {
                        const filter = {
                            id: group.id,
                            field: fieldSelect.value,
                            fieldLabel: field ? field.label : fieldSelect.value,
                            value: value,
                            type: 'test-case'
                        };
                        reportActiveFiltersTestCases.push(filter);
                        reportActiveFilters.push(filter);
                    }
                }
            });
            
            // Procesar filtros de Bugs
            const bugFilterGroups = document.querySelectorAll('#filters-grid-bug .filter-group');
            bugFilterGroups.forEach(group => {
                const fieldSelect = group.querySelector('.filter-field-select');
                const valueInput = group.querySelector('.filter-value-input');
                const valueSelect = group.querySelector('.filter-value-select');
                
                if (fieldSelect && fieldSelect.value) {
                    const field = reportAvailableFieldsBugs.find(f => f.value === fieldSelect.value);
                    const value = valueInput ? valueInput.value : (valueSelect ? valueSelect.value : '');
                    
                    if (value) {
                        const filter = {
                            id: group.id,
                            field: fieldSelect.value,
                            fieldLabel: field ? field.label : fieldSelect.value,
                            value: value,
                            type: 'bug'
                        };
                        reportActiveFiltersBugs.push(filter);
                        reportActiveFilters.push(filter);
                    }
                }
            });
            
            // Actualizar contadores en las pestañas
            document.getElementById('test-case-filter-count').textContent = reportActiveFiltersTestCases.length;
            document.getElementById('bug-filter-count').textContent = reportActiveFiltersBugs.length;
            
            // Actualizar badges de filtros activos
            const activeFiltersContainer = document.getElementById('active-report-filters');
            if (!activeFiltersContainer) return;
            
            // Limpiar contenedor pero mantener el título
            const titleElement = activeFiltersContainer.querySelector('div:first-child');
            activeFiltersContainer.innerHTML = '';
            if (titleElement) {
                activeFiltersContainer.appendChild(titleElement);
            } else {
                const title = document.createElement('div');
                title.style.cssText = 'width: 100%; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-muted); font-weight: 600;';
                title.textContent = 'Filtros Activos:';
                activeFiltersContainer.appendChild(title);
            }
            
            if (reportActiveFilters.length > 0) {
                reportActiveFilters.forEach(filter => {
                    const badge = document.createElement('div');
                    badge.className = `filter-badge ${filter.type}`;
                    badge.innerHTML = `
                        <span class="filter-badge-type">${filter.type === 'test-case' ? 'TC' : 'BUG'}</span>
                        <span>${filter.fieldLabel}: ${filter.value}</span>
                        <span class="filter-badge-remove" onclick="removeReportFilter('${filter.id}')">✕</span>
                    `;
                    activeFiltersContainer.appendChild(badge);
                });
            }
        }

        function generateReportWithFilters() {
            const projectKey = document.getElementById('project-selector')?.value || '';
            const projectInput = document.getElementById('project-selector-input');
            const projectName = projectInput ? projectInput.value.split(' (')[0] : '';
            
            if (!projectKey) {
                alert('Por favor, selecciona un proyecto primero.');
                return;
            }
            
            // Ocultar sección de proyectos y mostrar reporte
            const projectsSection = document.getElementById('jira-projects-section');
            const reportSection = document.getElementById('jira-report-section');
            
            if (projectsSection) {
                projectsSection.style.display = 'none';
            }
            if (reportSection) {
                reportSection.style.display = 'block';
            }
            
            // Generar reporte con filtros separados
            // Enviar objeto con filtros separados por tipo
            const filtersByType = {
                testCases: reportActiveFiltersTestCases,
                bugs: reportActiveFiltersBugs
            };
            
            loadProjectMetrics(projectKey, projectName, filtersByType);
        }

        async function onProjectChange() {
            const project = document.getElementById('project-selector')?.value || '';
            
            if (project) {
                // Proyecto seleccionado - cargar campos disponibles para ambos tipos
                // Cargar campos para Test Cases
                await loadFilterFieldsForReport(project, 'test-case');
                // Cargar campos para Bugs
                await loadFilterFieldsForReport(project, 'bug');
            } else {
                // Limpiar campos si no hay proyecto
                reportAvailableFieldsTestCases = [];
                reportAvailableFieldsBugs = [];
                reportAvailableFields = [];
            }
        }

        // ============================================
        // Funciones de Descarga
        // ============================================
        function toggleDownloadDropdown(event) {
            if (event) {
                event.stopPropagation();
            }
            const dropdown = document.getElementById('download-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('active');
            }
        }

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('download-dropdown');
            const button = e.target.closest('.download-button');
            if (!button && !e.target.closest('.download-dropdown')) {
                if (dropdown) {
                    dropdown.classList.remove('active');
                }
            }
        });

        async function downloadPDF() {
            const projectKey = document.getElementById('project-selector')?.value || '';
            if (!projectKey) {
                alert('Por favor, selecciona un proyecto primero');
                return;
            }
            
            const dropdown = document.getElementById('download-dropdown');
            if (dropdown) {
                dropdown.classList.remove('active');
            }
            
            // Mostrar notificación de inicio inmediatamente
            showDownloadNotification('Procesando archivo...', 'loading');
            
            try {
                // Convertir gráficos Chart.js a imágenes base64
                const chartImages = {};
                
                // Gráfico de Test Cases
                if (grTestCasesChart) {
                    const testCasesCanvas = document.getElementById('gr-test-cases-chart');
                    if (testCasesCanvas) {
                        chartImages['test_cases'] = testCasesCanvas.toDataURL('image/png');
                    }
                }
                
                // Gráfico de Bugs
                if (grBugsSeverityChart) {
                    const bugsCanvas = document.getElementById('gr-bugs-severity-chart');
                    if (bugsCanvas) {
                        chartImages['bugs_severity'] = bugsCanvas.toDataURL('image/png');
                    }
                }
                
                // Capturar gráficos de widgets personalizados
                const widgetChartImages = {};
                activeWidgets.forEach(widgetId => {
                    const widget = AVAILABLE_WIDGETS.find(w => w.id === widgetId);
                    if (widget && widget.type === 'chart') {
                        const chartVar = window[`widgetChart_${widgetId}`];
                        if (chartVar) {
                            const canvas = document.getElementById(`widget-chart-${widgetId}`);
                            if (canvas) {
                                widgetChartImages[widgetId] = canvas.toDataURL('image/png');
                            }
                        }
                    }
                });
                
                // Obtener datos de widgets personalizados
                const widgetData = {};
                for (const widgetId of activeWidgets) {
                    const widget = AVAILABLE_WIDGETS.find(w => w.id === widgetId);
                    if (!widget) continue;
                    
                    if (widget.type === 'table') {
                        const widgetTableData = widgetDataCache[widgetId];
                        if (widgetTableData && widgetTableData.rows) {
                            widgetData[widgetId] = {
                                type: 'table',
                                title: widget.title,
                                columns: widget.columns,
                                rows: widgetTableData.rows
                            };
                        }
                    } else if (widget.type === 'kpi') {
                        const widgetKpiData = widgetDataCache[widgetId];
                        if (widgetKpiData) {
                            widgetData[widgetId] = {
                                type: 'kpi',
                                title: widget.title,
                                icon: widget.icon,
                                value: widgetKpiData.value || widget.defaultValue
                            };
                        }
                    } else if (widget.type === 'chart') {
                        // Los gráficos ya se capturaron como imágenes
                        widgetData[widgetId] = {
                            type: 'chart',
                            title: widget.title,
                            chartType: widget.chartType
                        };
                    }
                }
                
                // Obtener los filtros activos (vacío por ahora, ya que los datos vienen filtrados del backend)
                const filters = {};
                
                // Obtener datos completos de las tablas desde el reporte general
                const generalReportSection = document.getElementById('general-report-section');
                let tableData = {
                    test_cases_by_person: [],
                    defects_by_person: []
                };
                
                // Obtener datos de casos de prueba por persona (todos los datos, no solo la página actual)
                if (testCasesPagination && testCasesPagination.data) {
                    tableData.test_cases_by_person = testCasesPagination.data.map(({ person, stats }) => ({
                        person: person,
                        exitoso: stats.exitoso || 0,
                        en_progreso: stats.en_progreso || 0,
                        fallado: stats.fallado || 0,
                        total: stats.total || 0
                    }));
                }
                
                // Obtener datos de defectos por persona (todos los datos, no solo la página actual)
                if (defectsPagination && defectsPagination.data) {
                    tableData.defects_by_person = defectsPagination.data.map(defect => ({
                        key: defect.key || '-',
                        assignee: defect.assignee || 'Sin asignar',
                        status: defect.status || '-',
                        summary: defect.summary || '-',
                        severity: defect.severity || '-'
                    }));
                }
                
                // Llamar al backend para generar el PDF
                const response = await fetch('/api/jira/download-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({
                        project_key: projectKey,
                        format: 'pdf',
                        filters: filters,
                        chart_images: chartImages,
                        table_data: tableData,
                        active_widgets: activeWidgets,
                        widget_chart_images: widgetChartImages,
                        widget_data: widgetData
                    })
                });
                
                // Verificar si la respuesta es un error (JSON) o un PDF (blob)
                const contentType = response.headers.get('content-type') || '';
                
                if (!response.ok || contentType.includes('application/json')) {
                    // Es un error JSON
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al generar el reporte PDF');
                }
                
                // Descargar el archivo PDF
                const blob = await response.blob();
                
                // Verificar que el blob no sea un JSON de error
                if (blob.type === 'application/json' || blob.size < 100) {
                    const text = await blob.text();
                    try {
                        const errorData = JSON.parse(text);
                        throw new Error(errorData.error || 'Error al generar el reporte PDF');
                    } catch (e) {
                        throw new Error('Error al generar el reporte PDF');
                    }
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reporte_jira_${projectKey}_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                // Incrementar métricas de reportes
                const projectInput = document.getElementById('project-selector-input');
                const projectName = projectInput ? projectInput.value.split(' (')[0] : projectKey;
                incrementReportCount(projectKey, projectName);
                
                // Actualizar notificación
                showDownloadNotification('Reporte PDF descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error al descargar PDF:', error);
                const errorMessage = error.message || 'Error al generar el reporte PDF';
                showDownloadNotification(errorMessage, 'error');
            }
        }



        // Función para abrir el modal de guía
        function openGuideModal() {
            const modal = document.getElementById('guide-modal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        // Función para cerrar el modal de guía
        function closeGuideModal(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            const modal = document.getElementById('guide-modal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        // Inicializar botón de guía
        document.addEventListener('DOMContentLoaded', () => {
            const helpButton = document.getElementById('help-guide-button');
            if (helpButton) {
                helpButton.addEventListener('click', openGuideModal);
            }

            // Cerrar con ESC
        document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeGuideModal();
                }
            });
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // [REMOVED] new AIAgentChat(); - Obsoleto
            
            // Load metrics on page load
            await loadMetrics();
            
            // Set dashboard as default active section if no section is active
            const currentSection = document.querySelector('.content-section.active');
            if (!currentSection) {
                navigateToSection('dashboard');
            } else {
                const sectionId = currentSection.id;
                // Update nav item to show active state
                const activeNav = document.querySelector(`[data-section="${sectionId}"]`);
                if (activeNav) {
                    activeNav.classList.add('active-link');
                }
                
                // Cargar métricas del dashboard si es la sección activa inicial
                if (sectionId === 'dashboard') {
                    await loadDashboardMetrics();
                }
                
                // Inicializar reportes si la sección activa es jira-reportes
                if (sectionId === 'jira-reportes') {
                    initJiraReports();
                }
                
                // Inicializar carga masiva si la sección activa es jira-carga-masiva
                if (sectionId === 'jira-carga-masiva') {
                    initCargaMasiva();
                }
            }
            
            // Initialize charts if on infografía section
            if (currentSection && currentSection.id === 'infografia') {
                setTimeout(() => {
                    initializeCharts();
                }, 100);
            }
            
            // Configurar event listeners de paginación (por si acaso ya existen los elementos)
            setupPaginationListeners();
        });

        // ============================================
        // Funcionalidad de Carga Masiva Jira
        // ============================================
        
        // Variables para almacenar referencias de event listeners
        let cargaMasivaEventListeners = {
            uploadBtn: null,
            removeFileBtn: null,
            prevStepBtn: null,
            revalidateBtn: null,
            previewBtn: null,
            downloadTemplateLink: null,
            projectSelector: null
        };
        
        // Flag para prevenir ejecuciones múltiples
        let isUploadingCsv = false;
        
        // Función para parsear CSV correctamente respetando comillas
        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let insideQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        // Comilla escapada ("" dentro de comillas)
                        currentField += '"';
                        i++; // Saltar la siguiente comilla
                    } else {
                        // Toggle estado de comillas
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    // Fin de campo
                    currentRow.push(currentField.trim());
                    currentField = '';
                } else if ((char === '\n' || char === '\r') && !insideQuotes) {
                    // Fin de fila
                    if (currentField || currentRow.length > 0) {
                        currentRow.push(currentField.trim());
                        rows.push(currentRow);
                        currentRow = [];
                        currentField = '';
                    }
                    // Saltar \r\n si existe
                    if (char === '\r' && nextChar === '\n') {
                        i++;
                    }
                } else {
                    currentField += char;
                }
            }
            
            // Agregar última fila si hay contenido
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                rows.push(currentRow);
            }
            
            return rows;
        }
        
        let selectedCsvFile = null;
        let cargaMasivaProjects = [];
        let currentStep = 1;
        let csvColumns = [];
        let csvData = [];
        let validationResult = null;
        let fieldMappings = {};
        let defaultValues = {};
        let currentUserRole = null;
        let currentUserEmail = null;
        let projectAccessState = { status: 'unknown', hasAccess: false, message: '' };

        // Variables para combobox de carga masiva
        let cargaMasivaHighlightedIndex = -1;

        async function loadCurrentUserInfo() {
            if (currentUserRole) return;
            try {
                const resp = await fetch('/auth/session', { headers: { 'Accept': 'application/json' } });
                if (resp.ok) {
                    const data = await resp.json();
                    currentUserRole = data.role || 'usuario';
                    currentUserEmail = data.email || '';
                } else {
                    currentUserRole = 'usuario';
                }
            } catch (e) {
                currentUserRole = 'usuario';
            }
        }

        function updateCargaMasivaAccessMessage(type, message) {
            const msgEl = document.getElementById('carga-masiva-access-message');
            const uploadBtn = document.getElementById('upload-csv-btn');
            if (!msgEl) return;

            if (!message) {
                msgEl.style.display = 'none';
            } else {
                msgEl.style.display = 'block';
                msgEl.textContent = message;
                msgEl.style.color = type === 'error' ? '#ef4444' : type === 'loading' ? 'var(--text-secondary)' : '#22c55e';
            }

            if (uploadBtn) {
                if (type === 'error' || type === 'loading') {
                    uploadBtn.disabled = true;
                } else if (type === 'success') {
                    uploadBtn.disabled = false;
                }
            }
        }

        async function validateCargaMasivaProjectAccess(projectKey) {
            await loadCurrentUserInfo();

            if (!projectKey) {
                projectAccessState = { status: 'unknown', hasAccess: false, message: '' };
                updateCargaMasivaAccessMessage(null, '');
                return false;
            }

            if (['admin', 'analista_qa'].includes(currentUserRole || 'usuario')) {
                projectAccessState = { status: 'done', hasAccess: true, message: 'Acceso permitido por rol' };
                updateCargaMasivaAccessMessage('success', 'Acceso permitido por rol');
                return true;
            }

            projectAccessState = { status: 'loading', hasAccess: false, message: '' };
            updateCargaMasivaAccessMessage('loading', 'Verificando permisos en el proyecto...');

            try {
                const resp = await fetch('/api/jira/validate-project-access', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ project_key: projectKey, email: currentUserEmail })
                });
                const data = await resp.json();
                const allowed = !!data.hasAccess;
                projectAccessState = { status: 'done', hasAccess: allowed, message: data.message || '' };

                if (allowed) {
                    updateCargaMasivaAccessMessage('success', data.message || 'Acceso validado');
                } else {
                    updateCargaMasivaAccessMessage('error', data.message || 'No tienes acceso a este proyecto. Contacta al administrador del proyecto en Jira.');
                }
                return allowed;
            } catch (error) {
                projectAccessState = { status: 'error', hasAccess: false, message: error.message };
                updateCargaMasivaAccessMessage('error', 'No se pudo validar el acceso. Intenta nuevamente.');
                return false;
            }
        }

        async function initCargaMasiva() {
            await loadCurrentUserInfo();
            const projectInput = document.getElementById('carga-masiva-project-selector-input');
            const projectsLoading = document.getElementById('carga-masiva-projects-loading');
            const projectsError = document.getElementById('carga-masiva-projects-error');
            
            if (!projectInput) return;

            // Mostrar loading
            if (projectsLoading) {
                projectsLoading.style.display = 'block';
            }
            if (projectsError) {
                projectsError.style.display = 'none';
            }

            // Cargar proyectos
            try {
                const response = await fetch('/api/jira/projects');
                const data = await response.json();

                if (data.success && data.projects.length > 0) {
                    cargaMasivaProjects = data.projects.map(project => ({
                        key: project.key,
                        name: project.name,
                        displayText: `${project.name} (${project.key})`
                    }));
                    console.log('Proyectos de carga masiva cargados:', cargaMasivaProjects.length);
                    
                    // Ocultar loading
                    if (projectsLoading) {
                        projectsLoading.style.display = 'none';
                    }
                } else {
                    console.warn('No se encontraron proyectos para carga masiva');
                    if (projectsLoading) {
                        projectsLoading.style.display = 'none';
                    }
                    if (projectsError) {
                        projectsError.style.display = 'block';
                        projectsError.innerHTML = `<span>❌ ${data.error || 'No se encontraron proyectos'}</span>`;
                    }
                }
            } catch (error) {
                console.error('Error al cargar proyectos:', error);
                if (projectsLoading) {
                    projectsLoading.style.display = 'none';
                }
                if (projectsError) {
                    projectsError.style.display = 'block';
                    projectsError.innerHTML = `<span>❌ Error: ${error.message}</span>`;
                }
            }

            // Resetear estado de permisos
            projectAccessState = { status: 'unknown', hasAccess: false, message: '' };
            updateCargaMasivaAccessMessage(null, '');

            // Configurar zona de arrastre
            setupDropZone();
            
            // Configurar botones
            setupCargaMasivaButtons();
            
            // Inicializar paso 1
            updateStepIndicator(1);
        }

        // Funciones para combobox de carga masiva
        function renderCargaMasivaOptions(projects) {
            const dropdown = document.getElementById('carga-masiva-dropdown');
            if (!dropdown) return;

            if (!projects || projects.length === 0) {
                dropdown.innerHTML = '<div class="combobox-option no-results">No se encontraron proyectos</div>';
                dropdown.style.display = 'block';
                return;
            }

            dropdown.innerHTML = '';
            projects.forEach((project) => {
                const option = document.createElement('div');
                option.className = 'combobox-option';
                option.textContent = project.displayText;
                option.dataset.projectKey = project.key;
                option.dataset.projectName = project.name;
                option.onclick = () => selectCargaMasivaProject(project.key, project.name, project.displayText);
                dropdown.appendChild(option);
            });

            dropdown.style.display = 'block';
            cargaMasivaHighlightedIndex = -1;
        }

        function filterCargaMasivaProjects(searchText) {
            if (!cargaMasivaProjects || cargaMasivaProjects.length === 0) {
                console.warn('No hay proyectos para filtrar en carga masiva');
                return;
            }

            const searchLower = searchText.toLowerCase().trim();
            
            if (searchLower === '') {
                renderCargaMasivaOptions(cargaMasivaProjects);
                return;
            }

            const filtered = cargaMasivaProjects.filter(project => 
                project.name.toLowerCase().includes(searchLower) ||
                project.key.toLowerCase().includes(searchLower) ||
                project.displayText.toLowerCase().includes(searchLower)
            );

            renderCargaMasivaOptions(filtered);
        }

        function showCargaMasivaDropdown() {
            const dropdown = document.getElementById('carga-masiva-dropdown');
            const input = document.getElementById('carga-masiva-project-selector-input');
            
            if (!dropdown || !input) return;

            if (!cargaMasivaProjects || cargaMasivaProjects.length === 0) {
                console.warn('No hay proyectos cargados en carga masiva');
                return;
            }

            const searchText = input.value.trim();
            if (searchText === '') {
                renderCargaMasivaOptions(cargaMasivaProjects);
            } else {
                filterCargaMasivaProjects(searchText);
            }
        }

        function hideCargaMasivaDropdown() {
            setTimeout(() => {
                const dropdown = document.getElementById('carga-masiva-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
                cargaMasivaHighlightedIndex = -1;
            }, 200);
        }

        async function selectCargaMasivaProject(projectKey, projectName, displayText) {
            const input = document.getElementById('carga-masiva-project-selector-input');
            const hiddenInput = document.getElementById('carga-masiva-project-selector');
            const dropdown = document.getElementById('carga-masiva-dropdown');

            if (input) {
                input.value = displayText;
            }
            if (hiddenInput) {
                hiddenInput.value = projectKey;
            }
            if (dropdown) {
                dropdown.style.display = 'none';
            }

            // Validar acceso al proyecto seleccionado
            projectAccessState = { status: 'loading', hasAccess: false, message: '' };
            await loadCurrentUserInfo();
            const allowed = await validateCargaMasivaProjectAccess(projectKey);

            // Avanzar al paso 2 cuando se selecciona un proyecto
            if (projectKey && (allowed || ['admin', 'analista_qa'].includes(currentUserRole || 'usuario'))) {
                goToStep(2);
                
                // Si ya hay archivo CSV cargado, iniciar validación automática
                if (selectedCsvFile && csvColumns.length > 0) {
                    setTimeout(() => {
                        startValidation();
                    }, 500);
                }
            } else {
                // Bloquear avance si no hay acceso o se deselecciona
                goToStep(1);
            }
        }

        function handleCargaMasivaKeydown(event) {
            const dropdown = document.getElementById('carga-masiva-dropdown');
            if (!dropdown || dropdown.style.display === 'none') return;

            const options = dropdown.querySelectorAll('.combobox-option:not(.no-results)');
            if (options.length === 0) return;

            if (event.key === 'ArrowDown') {
                event.preventDefault();
                cargaMasivaHighlightedIndex = (cargaMasivaHighlightedIndex + 1) % options.length;
                updateCargaMasivaHighlight(options);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                cargaMasivaHighlightedIndex = cargaMasivaHighlightedIndex <= 0 ? options.length - 1 : cargaMasivaHighlightedIndex - 1;
                updateCargaMasivaHighlight(options);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (cargaMasivaHighlightedIndex >= 0 && cargaMasivaHighlightedIndex < options.length) {
                    const option = options[cargaMasivaHighlightedIndex];
                    const projectKey = option.dataset.projectKey;
                    const projectName = option.dataset.projectName;
                    const displayText = option.textContent;
                    selectCargaMasivaProject(projectKey, projectName, displayText);
                }
            } else if (event.key === 'Escape') {
                dropdown.style.display = 'none';
                cargaMasivaHighlightedIndex = -1;
            }
        }

        function updateCargaMasivaHighlight(options) {
            options.forEach((option, index) => {
                if (index === cargaMasivaHighlightedIndex) {
                    option.classList.add('highlighted');
                    option.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    option.classList.remove('highlighted');
                }
            });
        }

        function setupDropZone() {
            const dropZone = document.getElementById('csv-drop-zone');
            const fileInput = document.getElementById('csv-file-input');
            
            if (!dropZone || !fileInput) return;

            // Click en la zona de arrastre - FIX: usar mousedown en lugar de click para evitar doble click
            dropZone.addEventListener('mousedown', (e) => {
                // Solo si el click es directamente en el dropZone, no en elementos hijos
                if (e.target === dropZone || e.target.closest('.drop-zone-content')) {
                    e.preventDefault();
                    fileInput.click();
                }
            });

            // Prevenir comportamiento por defecto del navegador
            dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            // Cambio de archivo desde el input
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        async function handleFileSelect(file) {
            // Validar que sea CSV
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showUploadStatus('error', '❌ Solo se permiten archivos CSV');
                return;
            }

            selectedCsvFile = file;
            
            // Mostrar información del archivo
            const fileInfo = document.getElementById('file-info');
            const fileName = document.getElementById('file-name');
            
            if (fileInfo && fileName) {
                fileName.textContent = file.name;
                fileInfo.style.display = 'flex';
            }
            
            // Leer CSV para obtener columnas
            try {
                const text = await file.text();
                const lines = text.split('\n');
                if (lines.length > 0) {
                    csvColumns = lines[0].split(',').map(col => col.trim().replace(/^"|"$/g, ''));
                    
                    // Leer todas las filas para vista previa
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const csvText = e.target.result;
                        // Usar función de parsing CSV que respeta comillas
                        const parsed = parseCSV(csvText);
                        if (parsed.length > 0) {
                            const headers = parsed[0];
                            csvData = [];
                            // Leer máximo 5 filas para preview
                            for (let i = 1; i < Math.min(parsed.length, 6); i++) {
                                if (parsed[i] && parsed[i].length > 0) {
                                    const row = {};
                                    headers.forEach((h, idx) => {
                                        row[h] = parsed[i][idx] || '';
                                    });
                                    csvData.push(row);
                                }
                            }
                        }
                    };
                    reader.readAsText(file, 'UTF-8');
                }
                
                // Avanzar al paso 2
                goToStep(2);
                
                // Si hay proyecto seleccionado, iniciar validación automática
                const projectSelector = document.getElementById('carga-masiva-project-selector');
                if (projectSelector && projectSelector.value) {
                    setTimeout(() => {
                        startValidation();
                    }, 500);
                }
            } catch (error) {
                console.error('Error al leer CSV:', error);
                showUploadStatus('error', '❌ Error al leer el archivo CSV');
            }
        }

        function setupCargaMasivaButtons() {
            const removeFileBtn = document.getElementById('remove-file-btn');
            const projectSelector = document.getElementById('carga-masiva-project-selector');
            const downloadTemplateLink = document.getElementById('download-template-link');
            const prevStepBtn = document.getElementById('prev-step-btn');
            const revalidateBtn = document.getElementById('revalidate-btn');
            const previewBtn = document.getElementById('preview-btn');
            const uploadBtn = document.getElementById('upload-csv-btn');

            // Remover listeners anteriores si existen
            if (cargaMasivaEventListeners.removeFileBtn && removeFileBtn) {
                removeFileBtn.removeEventListener('click', cargaMasivaEventListeners.removeFileBtn);
            }
            if (cargaMasivaEventListeners.uploadBtn && uploadBtn) {
                uploadBtn.removeEventListener('click', cargaMasivaEventListeners.uploadBtn);
            }
            if (cargaMasivaEventListeners.prevStepBtn && prevStepBtn) {
                prevStepBtn.removeEventListener('click', cargaMasivaEventListeners.prevStepBtn);
            }
            if (cargaMasivaEventListeners.revalidateBtn && revalidateBtn) {
                revalidateBtn.removeEventListener('click', cargaMasivaEventListeners.revalidateBtn);
            }
            if (cargaMasivaEventListeners.previewBtn && previewBtn) {
                previewBtn.removeEventListener('click', cargaMasivaEventListeners.previewBtn);
            }
            if (cargaMasivaEventListeners.downloadTemplateLink && downloadTemplateLink) {
                downloadTemplateLink.removeEventListener('click', cargaMasivaEventListeners.downloadTemplateLink);
            }
            if (cargaMasivaEventListeners.projectSelector && projectSelector) {
                projectSelector.removeEventListener('change', cargaMasivaEventListeners.projectSelector);
            }

            // Botón para remover archivo
            if (removeFileBtn) {
                const removeFileHandler = () => {
                    resetCargaMasiva();
                };
                removeFileBtn.addEventListener('click', removeFileHandler);
                cargaMasivaEventListeners.removeFileBtn = removeFileHandler;
            }

            // Cambio de proyecto
            if (projectSelector) {
                const projectChangeHandler = async () => {
                    await loadCurrentUserInfo();
                    projectAccessState = { status: 'loading', hasAccess: false, message: '' };
                    const allowed = await validateCargaMasivaProjectAccess(projectSelector.value);

                    if (projectSelector.value && (allowed || ['admin', 'analista_qa'].includes(currentUserRole || 'usuario'))) {
                        // Avanzar al paso 2 cuando se selecciona un proyecto
                        if (currentStep === 1) {
                            goToStep(2);
                        }
                        // Si ya hay archivo cargado, iniciar validación
                        if (selectedCsvFile && csvColumns.length > 0) {
                            startValidation();
                        }
                    } else {
                        // Bloquear avance si no hay acceso o se deselecciona
                        goToStep(1);
                    }
                };
                projectSelector.addEventListener('change', projectChangeHandler);
                cargaMasivaEventListeners.projectSelector = projectChangeHandler;
            }

            // Botón anterior
            if (prevStepBtn) {
                const prevStepHandler = () => {
                    if (currentStep > 1) {
                        goToStep(currentStep - 1);
                    }
                };
                prevStepBtn.addEventListener('click', prevStepHandler);
                cargaMasivaEventListeners.prevStepBtn = prevStepHandler;
            }

            // Botón re-validar
            if (revalidateBtn) {
                const revalidateHandler = () => {
                    startValidation();
                };
                revalidateBtn.addEventListener('click', revalidateHandler);
                cargaMasivaEventListeners.revalidateBtn = revalidateHandler;
            }

            // Botón para cargar CSV
            if (uploadBtn) {
                const uploadHandler = async () => {
                    if (isUploadingCsv) {
                        console.warn('Ya hay una carga en progreso, ignorando click duplicado');
                        return;
                    }
                    await uploadCsvToJira();
                };
                uploadBtn.addEventListener('click', uploadHandler);
                cargaMasivaEventListeners.uploadBtn = uploadHandler;
            }

            // Enlace para descargar plantilla
            if (downloadTemplateLink) {
                const downloadTemplateHandler = async (e) => {
                    e.preventDefault();
                    try {
                        // Obtener el project_key seleccionado
                        const projectKey = projectSelector ? projectSelector.value : null;
                        let url = '/api/jira/download-template';
                        if (projectKey) {
                            url += `?project_key=${encodeURIComponent(projectKey)}`;
                        }
                        
                        const response = await fetch(url);
                        if (response.ok) {
                            const blob = await response.blob();
                            const url_obj = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url_obj;
                            a.download = 'plantilla_carga_masiva_jira.csv';
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url_obj);
                            document.body.removeChild(a);
                        } else {
                            showUploadStatus('error', '❌ Error al descargar la plantilla');
                        }
                    } catch (error) {
                        console.error('Error al descargar plantilla:', error);
                        showUploadStatus('error', '❌ Error al descargar la plantilla');
                    }
                };
                downloadTemplateLink.addEventListener('click', downloadTemplateHandler);
                cargaMasivaEventListeners.downloadTemplateLink = downloadTemplateHandler;
            }
        }

        // Funciones para manejar pasos
        function goToStep(step) {
            currentStep = step;
            updateStepIndicator(step);
            showStepContent(step);
            updateActionsBar(step);
        }

        function updateStepIndicator(step) {
            const steps = document.querySelectorAll('.step');
            steps.forEach((s, idx) => {
                const stepNum = parseInt(s.dataset.step || idx + 1);
                s.classList.remove('active', 'completed');
                if (stepNum < step) {
                    s.classList.add('completed');
                } else if (stepNum === step) {
                    s.classList.add('active');
                }
            });
        }

        function showStepContent(step) {
            // Ocultar todos los pasos
            for (let i = 1; i <= 7; i++) {
                const content = document.getElementById(`step-${i}-content`);
                if (content) {
                    content.style.display = 'none';
                    content.classList.remove('active');
                }
            }
            
            // Mostrar el paso actual
            const currentContent = document.getElementById(`step-${step}-content`);
            if (currentContent) {
                currentContent.style.display = 'block';
                currentContent.classList.add('active');
            }
        }

        function updateActionsBar(step) {
            const actionsBar = document.getElementById('carga-masiva-actions');
            const prevBtn = document.getElementById('prev-step-btn');
            const revalidateBtn = document.getElementById('revalidate-btn');
            const uploadBtn = document.getElementById('upload-csv-btn');
            
            if (!actionsBar) return;
            
            // Mostrar barra de acciones desde el paso 2
            if (step >= 2) {
                actionsBar.style.display = 'flex';
            } else {
                actionsBar.style.display = 'none';
            }
            
            // Mostrar/ocultar botones según el paso
            if (prevBtn) {
                prevBtn.style.display = step > 1 ? 'inline-flex' : 'none';
            }
            
            if (revalidateBtn) {
                revalidateBtn.style.display = (step >= 4 && step <= 5) ? 'inline-flex' : 'none';
            }
            
            if (uploadBtn) {
                uploadBtn.style.display = step === 7 ? 'inline-flex' : 'none';
            }
            
            // Agregar botón "Siguiente" para pasos intermedios
            const nextBtn = document.getElementById('next-step-btn');
            if (nextBtn) {
                nextBtn.remove();
            }
            
            if (step === 4 || step === 5 || step === 6) {
                const nextButton = document.createElement('button');
                nextButton.id = 'next-step-btn';
                nextButton.className = 'btn btn-primary';
                nextButton.textContent = step === 4 ? 'Continuar al Mapeo →' : 
                                         step === 5 ? 'Continuar a Vista Previa →' :
                                         'Continuar a Carga →';
                nextButton.onclick = () => {
                    if (step === 4) {
                        goToStep(5);
                        renderMappingStep();
                    } else if (step === 5) {
                        // Asegurar que la configuración esté renderizada antes de avanzar
                        renderConfigStep();
                        goToStep(6);
                        // Usar setTimeout para asegurar que el paso 6 esté visible antes de renderizar
                        setTimeout(() => {
                            showPreview();
                        }, 100);
                    } else if (step === 6) {
                        goToStep(7);
                        renderUploadStep();
                    }
                };
                const actionsRight = actionsBar.querySelector('.actions-right');
                if (actionsRight) {
                    actionsRight.insertBefore(nextButton, actionsRight.firstChild);
                }
            }
        }

        async function startValidation() {
            const projectSelector = document.getElementById('carga-masiva-project-selector');
            if (!projectSelector || !projectSelector.value || !selectedCsvFile || csvColumns.length === 0) {
                return;
            }

            if ((currentUserRole || 'usuario') === 'usuario') {
                if (projectAccessState.status === 'loading') {
                    updateCargaMasivaAccessMessage('loading', 'Verificando permisos en el proyecto...');
                    return;
                }
                if (!projectAccessState.hasAccess) {
                    updateCargaMasivaAccessMessage('error', 'No tienes acceso a este proyecto. Contacta al administrador del proyecto en Jira.');
                    goToStep(1);
                    return;
                }
            }
            
            goToStep(3);
            
            const validationSteps = document.getElementById('validation-steps');
            if (validationSteps) {
                validationSteps.innerHTML = `
                    <div class="validation-step">
                        <span>Leyendo columnas del CSV...</span>
                        <span id="step-1-status" style="color: var(--accent);">⏳</span>
                    </div>
                    <div class="validation-step">
                        <span>Obteniendo campos del proyecto...</span>
                        <span id="step-2-status" style="color: var(--text-muted);">⏸</span>
                    </div>
                    <div class="validation-step">
                        <span>Comparando y buscando coincidencias...</span>
                        <span id="step-3-status" style="color: var(--text-muted);">⏸</span>
                    </div>
                    <div class="validation-step">
                        <span>Generando sugerencias de mapeo...</span>
                        <span id="step-4-status" style="color: var(--text-muted);">⏸</span>
                    </div>
                `;
            }
            
            try {
                // Paso 1: Completado
                updateValidationStep(1, true);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Paso 2: Obtener campos del proyecto
                updateValidationStep(2, true);
                const projectKey = projectSelector.value;
                
                // Paso 3: Validar campos
                updateValidationStep(3, true);
                const validationResponse = await fetch('/api/jira/validate-csv-fields', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({
                        csv_columns: csvColumns,
                        project_key: projectKey
                    })
                });
                
                const validationData = await validationResponse.json();
                validationResult = validationData;
                
                // Debug: verificar qué se recibió
                console.log('[DEBUG] Validation response:', validationData);
                console.log('[DEBUG] Required fields:', validationData.required_fields);
                console.log('[DEBUG] Optional fields:', validationData.optional_fields);
                
                // Paso 4: Completado
                updateValidationStep(4, true);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Avanzar al paso 4
                goToStep(4);
                
                // Esperar a que el DOM se actualice antes de renderizar
                await new Promise(resolve => setTimeout(resolve, 100));
                renderFieldsStep();
                
            } catch (error) {
                console.error('Error en validación:', error);
                showUploadStatus('error', '❌ Error al validar campos');
            }
        }

        function updateValidationStep(stepNum, completed) {
            const statusEl = document.getElementById(`step-${stepNum}-status`);
            if (statusEl) {
                statusEl.textContent = completed ? '✓' : '⏳';
                statusEl.style.color = completed ? 'var(--success)' : 'var(--accent)';
            }
        }

        function renderFieldsStep() {
            console.log('[DEBUG] renderFieldsStep called');
            console.log('[DEBUG] validationResult:', validationResult);
            
            if (!validationResult || !validationResult.success) {
                console.log('[DEBUG] Validation result is invalid or not successful');
                return;
            }
            
            console.log('[DEBUG] Required fields count:', validationResult.required_fields?.length || 0);
            console.log('[DEBUG] Optional fields count:', validationResult.optional_fields?.length || 0);
            
            const summaryEl = document.getElementById('validation-summary');
            const requiredSection = document.getElementById('required-fields-section');
            const optionalSection = document.getElementById('optional-fields-section');
            const unmappedSection = document.getElementById('unmapped-csv-columns');
            
            console.log('[DEBUG] DOM elements found:');
            console.log('[DEBUG] - summaryEl:', summaryEl);
            console.log('[DEBUG] - requiredSection:', requiredSection);
            console.log('[DEBUG] - optionalSection:', optionalSection);
            console.log('[DEBUG] - unmappedSection:', unmappedSection);
            
            // Resumen
            const mappedCount = validationResult.mappings.filter(m => m.suggested).length;
            const totalColumns = csvColumns.length;
            if (summaryEl) {
                summaryEl.className = 'validation-summary success';
                summaryEl.style.display = 'block';
                summaryEl.textContent = `✓ Validación completada. Se encontraron ${mappedCount} coincidencias automáticas de ${totalColumns} columnas.`;
            }
            
            // Filtrar campos que no deben mostrarse (solo Project)
            const filteredRequiredFields = (validationResult.required_fields || []).filter(f => {
                const fieldId = f.id ? f.id.toLowerCase() : '';
                const fieldName = f.name ? f.name.toLowerCase() : '';
                return fieldId !== 'project' && fieldName !== 'project' && fieldName !== 'proyecto';
            });
            
            // Campos requeridos
            if (requiredSection) {
                if (filteredRequiredFields.length > 0) {
                    requiredSection.innerHTML = `
                        <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                            <span>⚠️</span>
                            <span>Campos Requeridos de Jira</span>
                        </h3>
                        <div style="background: var(--secondary-bg); border-radius: 8px; padding: 1rem;">
                            ${renderFieldList(filteredRequiredFields, validationResult.mappings)}
                        </div>
                    `;
                } else {
                    requiredSection.innerHTML = `
                        <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                            <span>⚠️</span>
                            <span>Campos Requeridos de Jira</span>
                        </h3>
                        <div style="background: var(--secondary-bg); border-radius: 8px; padding: 1rem; text-align: center; color: var(--text-muted);">
                            No hay campos requeridos adicionales (Project ya está seleccionado)
                        </div>
                    `;
                }
            }
            
            // Campos opcionales - mostrar TODOS los campos opcionales disponibles
            const filteredOptionalFields = (validationResult.optional_fields || []).filter(f => {
                const fieldId = f.id ? f.id.toLowerCase() : '';
                const fieldName = f.name ? f.name.toLowerCase() : '';
                return fieldId !== 'project' && fieldName !== 'project' && fieldName !== 'proyecto';
            });
            
            if (optionalSection) {
                optionalSection.innerHTML = `
                    <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <span>ℹ️</span>
                        <span>Campos Opcionales de Jira (${filteredOptionalFields.length} disponibles)</span>
                    </h3>
                    <div style="background: var(--secondary-bg); border-radius: 8px; padding: 1rem; max-height: 400px; overflow-y: auto;">
                        ${filteredOptionalFields.length > 0 
                            ? renderFieldList(filteredOptionalFields, validationResult.mappings)
                            : '<div style="text-align: center; color: var(--text-muted);">No hay campos opcionales disponibles</div>'
                        }
                    </div>
                `;
            }
            
            // Columnas sin mapeo (excluyendo Project y Priority que son mapeables)
            const unmappedCols = (validationResult.unmapped_csv_columns || []).filter(col => {
                const colLower = col.toLowerCase();
                // Priority debe ser mapeable, no se muestra como "sin equivalente"
                return colLower !== 'priority' && colLower !== 'prioridad';
            });
            
            if (unmappedSection && unmappedCols.length > 0) {
                unmappedSection.innerHTML = `
                    <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--warning); display: flex; align-items: center; gap: 0.5rem;">
                        <span>⚠️</span>
                        <span>Columnas del CSV sin Equivalente en Jira</span>
                    </h3>
                    <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); border-radius: 8px; padding: 1rem;">
                        ${unmappedCols.map(col => `
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="color: var(--warning);">⚠</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${col}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">Esta columna se ignorará al cargar</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (unmappedSection) {
                unmappedSection.innerHTML = '';
            }
        }

        function renderFieldList(fields, mappings) {
            return fields.map(field => {
                const mapping = mappings.find(m => m.jira_field_id === field.id && m.suggested);
                const mapped = !!mapping;
                const statusIcon = mapped ? '✓' : '○';
                const statusColor = mapped ? 'var(--success)' : 'var(--accent)';
                const statusText = mapped ? `Mapeado desde: "${mapping.csv_column}"` : 'Disponible para mapear';
                
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: ${mapped ? 'rgba(16, 185, 129, 0.1)' : 'rgba(59, 130, 246, 0.1)'}; border: 1px solid ${mapped ? 'var(--success)' : 'var(--accent)'}; border-radius: 6px; margin-bottom: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
                            <span style="color: ${statusColor}; font-size: 1.2rem; font-weight: bold;">${statusIcon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 0.95rem; margin-bottom: 0.25rem;">${field.name || 'Campo sin nombre'}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">${statusText}</div>
                            </div>
                        </div>
                        <span class="field-type-badge" style="white-space: nowrap;">${getFieldTypeIcon(field.type || 'texto')} ${field.type || 'texto'}</span>
                    </div>
                `;
            }).join('');
        }

        function getFieldTypeIcon(type) {
            const icons = {
                'texto': '📝',
                'número': '🔢',
                'fecha': '📅',
                'usuario': '👤',
                'opción': '📋',
                'lista': '📋',
                'prioridad': '⚡',
                'estado': '📊'
            };
            return icons[type] || '📄';
        }

        function renderMappingStep() {
            if (!validationResult || !validationResult.success) {
                return;
            }
            
            const mappingContainer = document.getElementById('mapping-table-container');
            const summaryEl = document.getElementById('mapping-validation-summary');
            
            if (!mappingContainer) return;
            
            // Construir mapeos iniciales desde las sugerencias
            if (Object.keys(fieldMappings).length === 0) {
                validationResult.mappings.forEach(mapping => {
                    if (mapping.suggested && mapping.jira_field_id) {
                        fieldMappings[mapping.csv_column] = {
                            jira_field_id: mapping.jira_field_id,
                            jira_field_name: mapping.jira_field_name,
                            jira_field_type: mapping.jira_field_type
                        };
                    }
                });
            }
            
            // Obtener todos los campos disponibles (filtrando solo Project)
            const allFields = [
                ...(validationResult.required_fields || []),
                ...(validationResult.optional_fields || [])
            ].filter(f => {
                const fieldId = f.id ? f.id.toLowerCase() : '';
                const fieldName = f.name ? f.name.toLowerCase() : '';
                return fieldId !== 'project' && fieldName !== 'project' && fieldName !== 'proyecto';
            });
            
            // Validación (excluyendo solo Project que ya está seleccionado)
            const requiredFieldsToCheck = (validationResult.required_fields || []).filter(f => {
                const fieldId = f.id ? f.id.toLowerCase() : '';
                const fieldName = f.name ? f.name.toLowerCase() : '';
                return fieldId !== 'project' && fieldName !== 'project' && fieldName !== 'proyecto';
            });
            
            const requiredMapped = requiredFieldsToCheck.every(req => {
                return Object.values(fieldMappings).some(m => m.jira_field_id === req.id);
            });
            
            if (summaryEl) {
                summaryEl.className = requiredMapped ? 'validation-summary success' : 'validation-summary warning';
                summaryEl.style.display = 'block';
                summaryEl.textContent = requiredMapped 
                    ? '✓ Mapeo válido. Todos los campos requeridos están mapeados.'
                    : '⚠ Algunos campos requeridos no están mapeados. Revisa los mapeos antes de continuar.';
            }
            
            // Construir tabla
            let tableHTML = `
                <table class="mapping-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Columna CSV</th>
                            <th style="width: 35%;">Campo de Jira</th>
                            <th style="width: 15%;">Tipo</th>
                            <th style="width: 10%;">Requerido</th>
                            <th style="width: 15%;">Estado</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            csvColumns.forEach(csvCol => {
                // Omitir Project (ya está seleccionado)
                const csvColLower = csvCol.toLowerCase();
                if (csvColLower === 'project' || csvColLower === 'proyecto' || csvColLower === 'project key') {
                    return; // No mostrar Project en la tabla de mapeo
                }
                
                const currentMapping = fieldMappings[csvCol];
                const suggestedMapping = validationResult.mappings.find(m => m.csv_column === csvCol && !m.skip);
                const isRequired = suggestedMapping && suggestedMapping.required;
                
                // Encontrar campo Jira mapeado
                const mappedField = currentMapping 
                    ? allFields.find(f => f.id === currentMapping.jira_field_id)
                    : null;
                
                tableHTML += `
                    <tr>
                        <td>
                            <div class="csv-column">${csvCol}</div>
                            ${csvData.length > 0 && csvData[0][csvCol] ? 
                                `<div class="csv-sample">Ejemplo: "${String(csvData[0][csvCol]).substring(0, 30)}${String(csvData[0][csvCol]).length > 30 ? '...' : ''}"</div>` 
                                : ''}
                        </td>
                        <td>
                            <select class="jira-field-select" data-csv-column="${csvCol}" onchange="updateFieldMapping('${csvCol}', this.value)" style="color: var(--text-primary); background: var(--primary-bg);">
                                <option value="" style="color: var(--text-muted); background: var(--primary-bg);">-- No mapear --</option>
                                ${allFields.map(field => {
                                    const selected = currentMapping && currentMapping.jira_field_id === field.id;
                                    const suggested = suggestedMapping && suggestedMapping.jira_field_id === field.id;
                                    const fieldName = field.name || 'Campo sin nombre';
                                    return `<option value="${field.id}" ${selected ? 'selected' : ''} style="color: var(--text-primary); background: var(--primary-bg);">${fieldName}${suggested ? ' ✓' : ''}</option>`;
                                }).join('')}
                            </select>
                        </td>
                        <td>
                            ${mappedField ? `<span class="field-type-badge">${getFieldTypeIcon(mappedField.type)} ${mappedField.type}</span>` : '<span style="color: var(--text-muted);">-</span>'}
                        </td>
                        <td>
                            ${isRequired ? '<span class="required-badge">⚠ Requerido</span>' : '<span style="color: var(--text-muted); font-size: 0.85rem;">Opcional</span>'}
                        </td>
                        <td>
                            <div class="mapping-status ${mappedField ? 'status-valid' : 'status-warning'}">
                                <span>${mappedField ? '✓' : '○'}</span>
                                <span>${mappedField ? 'Válido' : 'Sin mapear'}</span>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            mappingContainer.innerHTML = tableHTML;
            
            // Renderizar configuración de valores por defecto en el mismo paso
            renderConfigStep();
            
            // Configurar botones de guardar/cargar mapeo
            setupMappingButtons();
        }

        function setupMappingButtons() {
            const saveMappingBtn = document.getElementById('save-mapping-btn');
            const loadMappingBtn = document.getElementById('load-mapping-btn');
            
            if (saveMappingBtn) {
                saveMappingBtn.onclick = () => {
                    saveMapping();
                };
            }
            
            if (loadMappingBtn) {
                loadMappingBtn.onclick = () => {
                    loadMapping();
                };
            }
        }

        function saveMapping() {
            const projectSelector = document.getElementById('carga-masiva-project-selector');
            if (!projectSelector || !projectSelector.value) {
                showUploadStatus('error', '❌ Debes seleccionar un proyecto');
                return;
            }
            
            const mappingData = {
                project_key: projectSelector.value,
                field_mappings: fieldMappings,
                default_values: defaultValues,
                csv_columns: csvColumns,
                saved_at: new Date().toISOString()
            };
            
            const mappingName = prompt('Ingresa un nombre para este mapeo:');
            if (!mappingName) {
                return;
            }
            
            try {
                const savedMappings = JSON.parse(localStorage.getItem('jira_field_mappings') || '{}');
                savedMappings[mappingName] = mappingData;
                localStorage.setItem('jira_field_mappings', JSON.stringify(savedMappings));
                showUploadStatus('success', '✅ Mapeo guardado exitosamente');
            } catch (error) {
                console.error('Error al guardar mapeo:', error);
                showUploadStatus('error', '❌ Error al guardar el mapeo');
            }
        }

        function loadMapping() {
            const projectSelector = document.getElementById('carga-masiva-project-selector');
            if (!projectSelector || !projectSelector.value) {
                showUploadStatus('error', '❌ Debes seleccionar un proyecto');
                return;
            }
            
            try {
                const savedMappings = JSON.parse(localStorage.getItem('jira_field_mappings') || '{}');
                const mappingNames = Object.keys(savedMappings);
                
                if (mappingNames.length === 0) {
                    showUploadStatus('error', '❌ No hay mapeos guardados');
                    return;
                }
                
                // Filtrar mapeos del proyecto actual
                const projectMappings = mappingNames.filter(name => {
                    return savedMappings[name].project_key === projectSelector.value;
                });
                
                if (projectMappings.length === 0) {
                    showUploadStatus('error', '❌ No hay mapeos guardados para este proyecto');
                    return;
                }
                
                // Mostrar selector de mapeos
                const mappingName = prompt(`Mapeos disponibles:\n${projectMappings.join('\n')}\n\nIngresa el nombre del mapeo a cargar:`);
                if (!mappingName || !savedMappings[mappingName]) {
                    return;
                }
                
                const mappingData = savedMappings[mappingName];
                if (mappingData.project_key !== projectSelector.value) {
                    showUploadStatus('error', '❌ Este mapeo no corresponde al proyecto seleccionado');
                    return;
                }
                
                // Cargar mapeos
                fieldMappings = mappingData.field_mappings || {};
                defaultValues = mappingData.default_values || {};
                
                // Re-renderizar el paso de mapeo
                renderMappingStep();
                showUploadStatus('success', '✅ Mapeo cargado exitosamente');
            } catch (error) {
                console.error('Error al cargar mapeo:', error);
                showUploadStatus('error', '❌ Error al cargar el mapeo');
            }
        }

        function updateFieldMapping(csvColumn, jiraFieldId) {
            const allFields = [
                ...(validationResult.required_fields || []),
                ...(validationResult.optional_fields || [])
            ];
            
            if (jiraFieldId) {
                const field = allFields.find(f => f.id === jiraFieldId);
                if (field) {
                    fieldMappings[csvColumn] = {
                        jira_field_id: field.id,
                        jira_field_name: field.name,
                        jira_field_type: field.type
                    };
                }
            } else {
                delete fieldMappings[csvColumn];
            }
            
            // Re-renderizar para actualizar estados
            renderMappingStep();
        }

        function renderConfigStep() {
            const configPanel = document.getElementById('config-panel');
            if (!configPanel) return;
            
            configPanel.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Tipo de Issue por Defecto</label>
                    <select class="form-select" id="default-issue-type" style="color: var(--text-primary); background: var(--secondary-bg);">
                        <option value="Story" ${defaultValues.issue_type === 'Story' || !defaultValues.issue_type ? 'selected' : ''} style="color: var(--text-primary); background: var(--secondary-bg);">Story</option>
                        <option value="Bug" ${defaultValues.issue_type === 'Bug' ? 'selected' : ''} style="color: var(--text-primary); background: var(--secondary-bg);">Bug</option>
                        <option value="Task" ${defaultValues.issue_type === 'Task' ? 'selected' : ''} style="color: var(--text-primary); background: var(--secondary-bg);">Task</option>
                        <option value="Epic" ${defaultValues.issue_type === 'Epic' ? 'selected' : ''} style="color: var(--text-primary); background: var(--secondary-bg);">Epic</option>
                    </select>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
                        Se usará si no se mapea el campo "Tipo de Issue"
                    </div>
                </div>
            `;
            
            // Agregar event listener solo para issue type (Priority se mapea, no es valor por defecto)
            const issueTypeSelect = document.getElementById('default-issue-type');
            
            if (issueTypeSelect) {
                issueTypeSelect.addEventListener('change', (e) => {
                    defaultValues.issue_type = e.target.value;
                });
            }
            
            // Remover priority de defaultValues si existe
            if (defaultValues.priority) {
                delete defaultValues.priority;
            }
        }

        function resetCargaMasiva() {
            selectedCsvFile = null;
            csvColumns = [];
            csvData = [];
            validationResult = null;
            fieldMappings = {};
            defaultValues = {};
            currentStep = 1;
            isUploadingCsv = false; // Resetear flag de carga
            
            // Habilitar botón de carga si existe
            const uploadBtn = document.getElementById('upload-csv-btn');
            if (uploadBtn) {
                uploadBtn.disabled = false;
            }
            
            // Resetear selector de proyecto
            const projectInput = document.getElementById('carga-masiva-project-selector-input');
            const projectHidden = document.getElementById('carga-masiva-project-selector');
            const projectDropdown = document.getElementById('carga-masiva-dropdown');
            if (projectInput) {
                projectInput.value = '';
            }
            if (projectHidden) {
                projectHidden.value = '';
            }
            if (projectDropdown) {
                projectDropdown.style.display = 'none';
            }
            
            // Resetear información de archivo
            const fileInfo = document.getElementById('file-info');
            const fileInput = document.getElementById('csv-file-input');
            if (fileInfo) fileInfo.style.display = 'none';
            if (fileInput) fileInput.value = '';
            
            // Limpiar vista previa
            const previewSummary = document.getElementById('preview-summary');
            const previewTable = document.getElementById('preview-table-container');
            if (previewSummary) {
                previewSummary.innerHTML = '';
            }
            if (previewTable) {
                previewTable.innerHTML = '';
            }
            
            // Limpiar secciones de validación y mapeo
            const validationSummary = document.getElementById('validation-summary');
            const requiredFieldsSection = document.getElementById('required-fields-section');
            const optionalFieldsSection = document.getElementById('optional-fields-section');
            const fieldMappingsSection = document.getElementById('field-mappings-section');
            
            if (validationSummary) {
                validationSummary.innerHTML = '';
                validationSummary.style.display = 'none';
            }
            if (requiredFieldsSection) {
                requiredFieldsSection.innerHTML = '';
            }
            if (optionalFieldsSection) {
                optionalFieldsSection.innerHTML = '';
            }
            if (fieldMappingsSection) {
                fieldMappingsSection.innerHTML = '';
            }
            
            // Limpiar estado de carga
            const uploadFinalStatus = document.getElementById('upload-final-status');
            if (uploadFinalStatus) {
                uploadFinalStatus.innerHTML = '';
            }
            projectAccessState = { status: 'unknown', hasAccess: false, message: '' };
            updateCargaMasivaAccessMessage(null, '');
            
            // Resetear a paso 1
            goToStep(1);
            hideUploadStatus();
        }

        async function uploadCsvToJira() {
            // Prevenir ejecuciones múltiples
            if (isUploadingCsv) {
                console.warn('Ya hay una carga en progreso, ignorando llamada duplicada');
                return;
            }

            const projectSelector = document.getElementById('carga-masiva-project-selector');
            if (!projectSelector || !projectSelector.value || !selectedCsvFile) {
                showUploadStatus('error', '❌ Faltan datos para cargar');
                return;
            }

            if ((currentUserRole || 'usuario') === 'usuario') {
                if (projectAccessState.status === 'loading') {
                    updateCargaMasivaAccessMessage('loading', 'Verificando permisos en el proyecto...');
                    return;
                }
                if (!projectAccessState.hasAccess) {
                    updateCargaMasivaAccessMessage('error', 'No tienes acceso a este proyecto. Contacta al administrador del proyecto en Jira.');
                    return;
                }
            }

            // Marcar como en proceso
            isUploadingCsv = true;

            const uploadStatus = document.getElementById('upload-status');
            const uploadStatusIcon = document.getElementById('upload-status-icon');
            const uploadStatusMessage = document.getElementById('upload-status-message');
            const uploadBtn = document.getElementById('upload-csv-btn');

            // Mostrar estado de carga
            if (uploadStatus) {
                uploadStatus.style.display = 'block';
                uploadStatus.className = 'upload-status-card';
            }
            if (uploadStatusIcon) uploadStatusIcon.textContent = '⏳';
            if (uploadStatusMessage) uploadStatusMessage.textContent = 'Procesando archivo CSV...';
            if (uploadBtn) uploadBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', selectedCsvFile);
                formData.append('project_key', projectSelector.value);
                formData.append('field_mappings', JSON.stringify(fieldMappings));
                formData.append('default_values', JSON.stringify(defaultValues));

                const response = await fetch('/api/jira/upload-csv', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    if (uploadStatusIcon) uploadStatusIcon.textContent = '✅';
                    if (uploadStatusMessage) {
                        uploadStatusMessage.textContent = `✅ ${data.message || 'Archivo cargado exitosamente'}`;
                    }
                    if (uploadStatus) {
                        uploadStatus.classList.add('success');
                    }

                    // Incrementar métricas de carga masiva
                    const itemsCount = data.results?.success_count || 0;
                    const projectKey = projectSelector.value;
                    const projectInput = document.getElementById('project-selector-input');
                    const projectName = projectInput ? projectInput.value.split(' (')[0] : projectKey;
                    const issueTypesDistribution = data.results?.issue_types_distribution || {};
                    incrementUploadCount(itemsCount, projectKey, projectName, issueTypesDistribution);

                    // Descargar archivo TXT si está disponible
                    if (data.txt_content && data.txt_filename) {
                        downloadTxtFile(data.txt_content, data.txt_filename);
                    }

                    // Habilitar botón antes de resetear
                    if (uploadBtn) uploadBtn.disabled = false;
                    // Resetear flag después de éxito
                    isUploadingCsv = false;

                    // Limpiar selección después de 5 segundos
                    setTimeout(() => {
                        resetCargaMasiva();
                    }, 5000);
                } else {
                    if (uploadStatusIcon) uploadStatusIcon.textContent = '❌';
                    if (uploadStatusMessage) {
                        uploadStatusMessage.textContent = `❌ ${data.error || 'Error al cargar el archivo'}`;
                    }
                    if (uploadStatus) {
                        uploadStatus.classList.add('error');
                    }
                    
                    // Descargar archivo TXT si está disponible (incluso con errores)
                    if (data.txt_content && data.txt_filename) {
                        downloadTxtFile(data.txt_content, data.txt_filename);
                    }
                    
                    if (uploadBtn) uploadBtn.disabled = false;
                    // Resetear flag después de error
                    isUploadingCsv = false;
                }
                // Resetear flag al finalizar (éxito o error)
                isUploadingCsv = false;
            } catch (error) {
                console.error('Error al cargar CSV:', error);
                if (uploadStatusIcon) uploadStatusIcon.textContent = '❌';
                if (uploadStatusMessage) {
                    uploadStatusMessage.textContent = `❌ Error: ${error.message}`;
                }
                if (uploadStatus) {
                    uploadStatus.classList.add('error');
                }
                if (uploadBtn) uploadBtn.disabled = false;
                // Resetear flag en caso de excepción
                isUploadingCsv = false;
            }
        }

        function showPreview() {
            // Leer el archivo completo para obtener el total de filas
            if (selectedCsvFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const csvText = e.target.result;
                    // Usar función de parsing CSV que respeta comillas
                    const parsed = parseCSV(csvText);
                    if (parsed.length > 1) {
                        const headers = parsed[0];
                        const previewData = [];
                        // Leer primeras 5 filas para vista previa
                        for (let i = 1; i < Math.min(parsed.length, 6); i++) {
                            if (parsed[i] && parsed[i].length > 0) {
                                const row = {};
                                headers.forEach((h, idx) => {
                                    row[h] = parsed[i][idx] || '';
                                });
                                previewData.push(row);
                            }
                        }
                        renderPreviewTable(previewData, parsed.length - 1);
                    }
                };
                reader.readAsText(selectedCsvFile, 'UTF-8');
            } else if (csvData.length > 0) {
                renderPreviewTable(csvData, csvData.length);
            }
        }

        function renderPreviewTable(data, totalRows) {
            const previewSummary = document.getElementById('preview-summary');
            const previewTable = document.getElementById('preview-table-container');
            
            if (previewSummary) {
                const projectSelector = document.getElementById('carga-masiva-project-selector');
                const projectKey = projectSelector ? projectSelector.value : 'N/A';
                previewSummary.innerHTML = `
                    <div style="padding: 1rem; background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); border-radius: 8px; color: var(--success); margin-bottom: 1rem;">
                        ✓ Se crearán <strong>${totalRows}</strong> issues en el proyecto <strong>${projectKey}</strong>
                    </div>
                `;
            }
            
            if (previewTable && data.length > 0) {
                // Construir tabla de vista previa
                const headers = Object.keys(data[0] || {});
                let tableHTML = `
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                ${headers.map(h => `<th>${h}</th>`).join('')}
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.slice(0, 5).forEach((row, idx) => {
                    tableHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            ${headers.map(h => `<td>${String(row[h] || '-').substring(0, 50)}${String(row[h] || '').length > 50 ? '...' : ''}</td>`).join('')}
                            <td><span style="color: var(--success);">✓</span></td>
                        </tr>
                    `;
                });
                
                if (totalRows > 5) {
                    tableHTML += `
                        <tr>
                            <td colspan="${headers.length + 2}" style="text-align: center; color: var(--text-muted);">
                                ... y ${totalRows - 5} más
                            </td>
                        </tr>
                    `;
                }
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                previewTable.innerHTML = tableHTML;
            }
        }

        function renderUploadStep() {
            const uploadFinalStatus = document.getElementById('upload-final-status');
            if (!uploadFinalStatus) return;
            
            const projectSelector = document.getElementById('carga-masiva-project-selector');
            const projectKey = projectSelector ? projectSelector.value : 'N/A';
            
            uploadFinalStatus.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🚀</div>
                    <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">
                        Listo para Cargar
                    </div>
                    <div style="color: var(--text-muted); margin-bottom: 2rem;">
                        Se crearán los issues en el proyecto <strong>${projectKey}</strong> con los mapeos configurados
                    </div>
                    <div style="background: var(--secondary-bg); border-radius: 8px; padding: 1.5rem; text-align: left; max-width: 600px; margin: 0 auto;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-secondary);">Proyecto:</span>
                            <span style="font-weight: 600; color: var(--text-primary);">${projectKey}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-secondary);">Archivo CSV:</span>
                            <span style="font-weight: 600; color: var(--text-primary);">${selectedCsvFile ? selectedCsvFile.name : 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-secondary);">Campos mapeados:</span>
                            <span style="font-weight: 600; color: var(--text-primary);">${Object.keys(fieldMappings).length}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Valores por defecto:</span>
                            <span style="font-weight: 600; color: var(--text-primary);">${Object.keys(defaultValues).length}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function downloadTxtFile(base64Content, filename) {
            try {
                // Mostrar notificación de inicio inmediatamente
                showDownloadNotification('Procesando archivo...', 'loading');
                
                // Decodificar base64
                const binaryString = atob(base64Content);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Crear blob y descargar
                const blob = new Blob([bytes], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Actualizar notificación
                showDownloadNotification('Archivo TXT descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error al descargar archivo TXT:', error);
                showDownloadNotification('Error al descargar archivo TXT', 'error');
            }
        }

        function showUploadStatus(type, message) {
            const uploadStatus = document.getElementById('upload-status');
            const uploadStatusIcon = document.getElementById('upload-status-icon');
            const uploadStatusMessage = document.getElementById('upload-status-message');
            
            if (uploadStatus) {
                uploadStatus.style.display = 'block';
                uploadStatus.className = 'upload-status-card';
                if (type === 'success') {
                    uploadStatus.classList.add('success');
                } else if (type === 'error') {
                    uploadStatus.classList.add('error');
                }
            }
            if (uploadStatusIcon) uploadStatusIcon.textContent = type === 'success' ? '✅' : '❌';
            if (uploadStatusMessage) uploadStatusMessage.textContent = message;
        }

        function hideUploadStatus() {
            const uploadStatus = document.getElementById('upload-status');
            if (uploadStatus) {
                uploadStatus.style.display = 'none';
                uploadStatus.className = 'upload-status-card';
            }
        }
    </script>

    <!-- Modal/Popup de Guía -->
    <div class="modal-overlay" id="guide-modal" onclick="closeGuideModal(event)">
        <div class="modal-container" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">Guía de Uso</h2>
                <button class="modal-close" onclick="closeGuideModal()">✕</button>
            </div>
            <div class="modal-content">
                <div class="guia-section">
                    <div class="guia-section-title">
                        <div class="guia-section-icon">🚀</div>
                        <span>Inicio Rápido</span>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        El Generador H/CP te permite crear automáticamente Historias de Usuario y Casos de Prueba a partir de documentos. Sigue estos pasos para comenzar:
                    </p>

                    <div class="guia-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">Sube tu documento</div>
                            <div class="step-description">
                                Haz clic en el área de carga de archivos y selecciona un documento en formato PDF o DOCX que contenga los requerimientos o especificaciones del proyecto.
                            </div>
                        </div>
                    </div>

                    <div class="guia-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">Espera el análisis automático</div>
                            <div class="step-description">
                                El sistema analizará automáticamente el contenido de tu documento y determinará qué tipo de contenido puede generar (historias de usuario, casos de prueba, o ambos).
                            </div>
                        </div>
                    </div>

                    <div class="guia-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">Selecciona qué generar</div>
                            <div class="step-description">
                                El agente te mostrará opciones basadas en el análisis. Puedes elegir:
                                <ul class="step-list">
                                    <li>Generar solo Historias de Usuario</li>
                                    <li>Generar solo Matriz de Pruebas (Casos de Prueba)</li>
                                    <li>Generar ambos tipos de contenido</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="guia-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <div class="step-title">Descarga tus resultados</div>
                            <div class="step-description">
                                Una vez completado el procesamiento, el archivo se descargará automáticamente. Las Historias de Usuario se generan en formato Word (.docx) y las Matrices de Prueba en formato ZIP (contiene CSV y JSON).
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guia-section">
                    <div class="guia-section-title">
                        <div class="guia-section-icon">📝</div>
                        <span>Generar Historias de Usuario</span>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Las Historias de Usuario se generan siguiendo el formato estándar COMO/QUIERO/PARA con criterios de aceptación detallados.
                    </p>

                    <div class="guia-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">Prepara tu documento</div>
                            <div class="step-description">
                                Asegúrate de que tu documento contenga:
                                <ul class="step-list">
                                    <li>Requerimientos funcionales claros</li>
                                    <li>Descripción de funcionalidades</li>
                                    <li>Reglas de negocio</li>
                                    <li>Casos de uso o escenarios</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="guia-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">Sube el documento</div>
                            <div class="step-description">
                                Arrastra y suelta o selecciona tu archivo PDF o DOCX en el área de carga.
                            </div>
                        </div>
                    </div>

                    <div class="guia-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">Selecciona "Generar Historias de Usuario"</div>
                            <div class="step-description">
                                Una vez que el sistema analice tu documento, haz clic en el botón "📝 Generar Historias de Usuario" que aparecerá en el chat.
                            </div>
                        </div>
                    </div>

                    <div class="guia-tip">
                        <div class="guia-tip-title">
                            <span>💡</span>
                            <span>Consejo</span>
                        </div>
                        <div class="guia-tip-text">
                            Cuanto más detallado y estructurado sea tu documento, mejores y más completas serán las historias de usuario generadas. Incluye contexto de negocio cuando sea posible.
                        </div>
                    </div>
                </div>

                <div class="guia-section">
                    <div class="guia-section-title">
                        <div class="guia-section-icon">🧪</div>
                        <span>Generar Matriz de Pruebas</span>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        La Matriz de Pruebas genera casos de prueba funcionales y no funcionales con pasos detallados y resultados esperados.
                    </p>

                    <div class="guia-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">Prepara tu documento</div>
                            <div class="step-description">
                                Tu documento debe contener información sobre:
                                <ul class="step-list">
                                    <li>Funcionalidades a probar</li>
                                    <li>Flujos de usuario</li>
                                    <li>Validaciones y reglas de negocio</li>
                                    <li>Requisitos de rendimiento o seguridad (para pruebas no funcionales)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="guia-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">Sube el documento</div>
                            <div class="step-description">
                                Carga tu archivo PDF o DOCX con los requerimientos de prueba.
                            </div>
                        </div>
                    </div>

                    <div class="guia-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">Selecciona "Generar Matriz de Pruebas"</div>
                            <div class="step-description">
                                Haz clic en el botón "🧪 Generar Matriz de Pruebas" después del análisis del documento.
                            </div>
                        </div>
                    </div>

                    <div class="guia-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <div class="step-title">Descarga y revisa</div>
                            <div class="step-description">
                                El archivo ZIP descargado contiene:
                                <ul class="step-list">
                                    <li>Archivo CSV: Para importar en herramientas de gestión de pruebas (JIRA, TestRail, etc.)</li>
                                    <li>Archivo JSON: Para integraciones con APIs o sistemas automatizados</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guia-section">
                    <div class="guia-section-title">
                        <div class="guia-section-icon">⚡</div>
                        <span>Generar Ambos (Historias + Casos de Prueba)</span>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Puedes generar ambos tipos de contenido en una sola operación cuando tu documento contiene información completa del proyecto.
                    </p>

                    <div class="guia-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">Documento completo</div>
                            <div class="step-description">
                                Asegúrate de que tu documento incluya tanto requerimientos funcionales como especificaciones de prueba.
                            </div>
                        </div>
                    </div>

                    <div class="guia-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">Selecciona "Ambos"</div>
                            <div class="step-description">
                                Después del análisis, haz clic en el botón "⚡ Ambos (Historias + Matriz)" para generar ambos tipos de contenido simultáneamente.
                            </div>
                        </div>
                    </div>

                    <div class="guia-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">Descarga los archivos</div>
                            <div class="step-description">
                                Recibirás dos archivos de descarga:
                                <ul class="step-list">
                                    <li>Un archivo .docx con las Historias de Usuario</li>
                                    <li>Un archivo .zip con la Matriz de Pruebas</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guia-section">
                    <div class="guia-section-title">
                        <div class="guia-section-icon">❓</div>
                        <span>Preguntas Frecuentes</span>
                    </div>

                    <div class="guia-step">
                        <div class="step-content">
                            <div class="step-title">¿Qué formatos de archivo acepta?</div>
                            <div class="step-description">
                                Actualmente acepta archivos PDF (.pdf) y documentos de Word (.docx). El tamaño máximo es de 16MB.
                            </div>
                        </div>
                    </div>

                    <div class="guia-step">
                        <div class="step-content">
                            <div class="step-title">¿Cuánto tiempo tarda en generar el contenido?</div>
                            <div class="step-description">
                                El tiempo depende del tamaño y complejidad del documento. Generalmente toma entre 30 segundos y 3 minutos. Documentos más grandes pueden tardar más tiempo.
                            </div>
                        </div>
                    </div>

                    <div class="guia-step">
                        <div class="step-content">
                            <div class="step-title">¿Puedo editar las historias o casos generados?</div>
                            <div class="step-description">
                                Sí, los archivos generados son completamente editables. Las Historias de Usuario están en formato Word y los Casos de Prueba en CSV/JSON, ambos pueden ser modificados según tus necesidades.
                            </div>
                        </div>
                    </div>

                    <div class="guia-step">
                        <div class="step-content">
                            <div class="step-title">¿Las métricas se guardan automáticamente?</div>
                            <div class="step-description">
                                Sí, cada vez que generas contenido, las métricas se actualizan automáticamente. Puedes ver el historial y estadísticas en la sección "Métricas" del menú lateral.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guia-warning">
                    <div class="guia-warning-title">
                        <span>⚠️</span>
                        <span>Importante</span>
                    </div>
                    <div class="guia-warning-text">
                        Asegúrate de que tu documento contenga texto legible y estructurado. Los documentos escaneados o con imágenes sin texto extraíble pueden no funcionar correctamente. El sistema funciona mejor con documentos que tienen texto seleccionable.
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Admin Panel Section -->
        {% if user_info and user_info.role == 'admin' %}
        <section id="admin" class="content-section">
            <div class="admin-header">
                <h1><i class="fas fa-shield-alt"></i> Panel de Administración</h1>
                <p>Gestión de usuarios y configuración del sistema</p>
            </div>

            <div id="admin-alert-container"></div>

            <!-- Estadísticas -->
            <div class="admin-stats-grid" id="admin-stats-grid">
                <div class="admin-stat-card">
                    <div class="admin-stat-value" id="admin-stat-total">-</div>
                    <div class="admin-stat-label">Total Usuarios</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value" id="admin-stat-active">-</div>
                    <div class="admin-stat-label">Usuarios Activos</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value" id="admin-stat-inactive">-</div>
                    <div class="admin-stat-label">Usuarios Inactivos</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value" id="admin-stat-admins">-</div>
                    <div class="admin-stat-label">Administradores</div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="admin-filters">
                <div class="admin-filters-grid">
                    <div class="admin-filter-group">
                        <label for="admin-search-input"><i class="fas fa-search"></i> Buscar por email</label>
                        <input type="text" id="admin-search-input" placeholder="email@ejemplo.com">
                    </div>
                    <div class="admin-filter-group">
                        <label for="admin-role-filter"><i class="fas fa-user-tag"></i> Filtrar por rol</label>
                        <select id="admin-role-filter">
                            <option value="">Todos los roles</option>
                            <option value="admin">Administrador</option>
                            <option value="analista_qa">Analista QA</option>
                            <option value="usuario">Usuario</option>
                        </select>
                    </div>
                    <div class="admin-filter-group">
                        <label for="admin-status-filter"><i class="fas fa-toggle-on"></i> Estado</label>
                        <select id="admin-status-filter">
                            <option value="">Todos</option>
                            <option value="active">Activos</option>
                            <option value="inactive">Inactivos</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Tabla de usuarios -->
            <div class="admin-users-table">
                <div class="admin-table-header">
                    <h2><i class="fas fa-users"></i> Usuarios</h2>
                    <button class="admin-btn admin-btn-primary" onclick="adminLoadUsers()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                <div class="admin-table-container">
                    <div id="admin-loading" class="admin-loading" style="display: block;">
                        <i class="fas fa-spinner fa-spin"></i> Cargando usuarios...
                    </div>
                    <table id="admin-users-table" class="admin-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Creado</th>
                                <th>Último Login</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="admin-users-tbody">
                        </tbody>
                    </table>
                    <div id="admin-empty-state" class="admin-empty-state" style="display: none;">
                        <i class="fas fa-users-slash"></i>
                        <p>No se encontraron usuarios</p>
                    </div>
                </div>
            </div>
        </section>
        {% endif %}
    </main>

    <!-- Admin Panel JavaScript -->
    <script>
        let adminCurrentUser = null;

        // Obtener información del usuario actual
        async function adminGetCurrentUser() {
            try {
                const response = await fetch('/auth/session');
                if (response.ok) {
                    const data = await response.json();
                    adminCurrentUser = data;
                }
            } catch (e) {
                console.error('Error al obtener usuario actual:', e);
            }
        }

        // Cargar usuarios
        async function adminLoadUsers() {
            const loading = document.getElementById('admin-loading');
            const table = document.getElementById('admin-users-table');
            const tbody = document.getElementById('admin-users-tbody');
            const emptyState = document.getElementById('admin-empty-state');

            if (loading) loading.style.display = 'block';
            if (table) table.style.display = 'none';
            if (emptyState) emptyState.style.display = 'none';

            try {
                const searchInput = document.getElementById('admin-search-input');
                const roleFilter = document.getElementById('admin-role-filter');
                const statusFilter = document.getElementById('admin-status-filter');
                
                const search = searchInput ? searchInput.value : '';
                const role = roleFilter ? roleFilter.value : '';
                const status = statusFilter ? statusFilter.value : '';

                let url = '/admin/users?';
                if (search) url += `search=${encodeURIComponent(search)}&`;
                if (role) url += `role=${encodeURIComponent(role)}&`;
                if (status === 'active') url += 'active_only=true&';
                if (status === 'inactive') url += 'active_only=false&';

                const response = await fetch(url);

                if (!response.ok) {
                    const errorText = await response.text();
                    adminShowAlert(`Error HTTP ${response.status}: ${errorText.substring(0, 100)}`, 'error');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    adminDisplayUsers(data.users);
                    adminUpdateStats(data.statistics);
                } else {
                    const errorMsg = data.error || 'Error desconocido al cargar usuarios';
                    adminShowAlert(`Error: ${errorMsg}`, 'error');
                }
            } catch (e) {
                adminShowAlert(`Error al cargar usuarios: ${e.message}`, 'error');
            } finally {
                if (loading) loading.style.display = 'none';
            }
        }

        // Mostrar usuarios en la tabla
        function adminDisplayUsers(users) {
            const tbody = document.getElementById('admin-users-tbody');
            const table = document.getElementById('admin-users-table');
            const emptyState = document.getElementById('admin-empty-state');
            const loading = document.getElementById('admin-loading');
            const roleLabels = { admin: 'Administrador', analista_qa: 'Analista QA', usuario: 'Usuario' };

            if (!tbody || !table || !emptyState) {
                return;
            }

            if (loading) loading.style.display = 'none';
            tbody.innerHTML = '';

            if (!users || users.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyState.style.display = 'none';

            users.forEach((user, index) => {
                try {
                    const row = document.createElement('tr');
                    const createdDate = user.created_at ? new Date(user.created_at).toLocaleDateString('es-ES') : 'N/A';
                    const lastLogin = user.last_login ? new Date(user.last_login).toLocaleDateString('es-ES') : 'Nunca';
                    const role = (user.role || 'usuario').toLowerCase();
                    const roleLabel = roleLabels[role] || role;

                    row.innerHTML = `
                        <td>${user.email || 'N/A'}</td>
                        <td>
                            <span class="admin-badge ${role}">${roleLabel}</span>
                        </td>
                        <td>
                            <span class="admin-badge ${user.active ? 'active' : 'inactive'}">
                                ${user.active ? 'Activo' : 'Inactivo'}
                            </span>
                        </td>
                        <td>${createdDate}</td>
                        <td>${lastLogin}</td>
                        <td>
                            <div class="admin-actions">
                                <select class="admin-btn admin-btn-sm admin-btn-secondary" onchange="adminChangeRole('${user.id}', this.value)" ${user.id === adminCurrentUser?.user_id ? 'disabled' : ''}>
                                    <option value="admin" ${role === 'admin' ? 'selected' : ''}>Administrador</option>
                                    <option value="analista_qa" ${role === 'analista_qa' ? 'selected' : ''}>Analista QA</option>
                                    <option value="usuario" ${role === 'usuario' ? 'selected' : ''}>Usuario</option>
                                </select>
                                <button class="admin-btn admin-btn-sm ${user.active ? 'admin-btn-danger' : 'admin-btn-primary'}" 
                                        onclick="adminToggleStatus('${user.id}', ${!user.active})"
                                        ${user.id === adminCurrentUser?.user_id ? 'disabled' : ''}>
                                    <i class="fas fa-${user.active ? 'ban' : 'check'}"></i>
                                    ${user.active ? 'Desactivar' : 'Activar'}
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                } catch (e) {
                    console.error(`Error al agregar usuario ${index}:`, e);
                }
            });
        }

        // Actualizar estadísticas
        function adminUpdateStats(stats) {
            try {
                const statTotal = document.getElementById('admin-stat-total');
                const statActive = document.getElementById('admin-stat-active');
                const statInactive = document.getElementById('admin-stat-inactive');
                const statAdmins = document.getElementById('admin-stat-admins');

                if (statTotal) statTotal.textContent = stats?.total || 0;
                if (statActive) statActive.textContent = stats?.active || 0;
                if (statInactive) statInactive.textContent = stats?.inactive || 0;
                if (statAdmins) statAdmins.textContent = stats?.by_role?.admin || 0;
            } catch (e) {
                console.error('Error al actualizar estadísticas:', e);
            }
        }

        // Cambiar rol
        async function adminChangeRole(userId, newRole) {
            if (!confirm(`¿Cambiar rol a ${newRole}?`)) {
                adminLoadUsers();
                return;
            }

            try {
                const response = await fetch(`/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ role: newRole })
                });

                const data = await response.json();

                if (data.success) {
                    adminShowAlert(`Rol actualizado a ${newRole}`, 'success');
                    adminLoadUsers();
                } else {
                    adminShowAlert(data.error || 'Error al actualizar rol', 'error');
                    adminLoadUsers();
                }
            } catch (e) {
                console.error('Error:', e);
                adminShowAlert('Error al actualizar rol', 'error');
                adminLoadUsers();
            }
        }

        // Cambiar estado (activar/desactivar)
        async function adminToggleStatus(userId, newStatus) {
            const action = newStatus ? 'activar' : 'desactivar';
            if (!confirm(`¿${action.charAt(0).toUpperCase() + action.slice(1)} este usuario?`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ active: newStatus })
                });

                const data = await response.json();

                if (data.success) {
                    adminShowAlert(`Usuario ${action}do exitosamente`, 'success');
                    adminLoadUsers();
                } else {
                    adminShowAlert(data.error || 'Error al actualizar estado', 'error');
                }
            } catch (e) {
                console.error('Error:', e);
                adminShowAlert('Error al actualizar estado', 'error');
            }
        }

        // Mostrar alerta
        function adminShowAlert(message, type = 'success') {
            const container = document.getElementById('admin-alert-container');
            if (!container) return;
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }

        // Inicializar cuando se navega a la sección admin
        function adminInitPanel() {
            try {
                adminGetCurrentUser().then(() => {
                    adminLoadUsers();
                }).catch(error => {
                    adminShowAlert('Error al obtener información del usuario actual', 'error');
                });
            } catch (e) {
                adminShowAlert(`Error al inicializar panel: ${e.message}`, 'error');
            }
        }

        // Event listeners para filtros (cuando el DOM esté listo)
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('admin-search-input');
            const roleFilter = document.getElementById('admin-role-filter');
            const statusFilter = document.getElementById('admin-status-filter');

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    if (typeof debounce === 'function') {
                        debounce(adminLoadUsers, 500)();
                    } else {
                        clearTimeout(window.adminSearchTimeout);
                        window.adminSearchTimeout = setTimeout(adminLoadUsers, 500);
                    }
                });
            }
            if (roleFilter) {
                roleFilter.addEventListener('change', adminLoadUsers);
            }
            if (statusFilter) {
                statusFilter.addEventListener('change', adminLoadUsers);
            }
        });

        // ========================================================================
        // CREAR HISTORIAS - JavaScript
        // ========================================================================
        (function() {
            // Función para resetear el generador de historias
            function resetStoriesGenerator() {
                const formContainer = document.getElementById('stories-form-container');
                const previewSection = document.getElementById('stories-preview-section');
                const backBtnContainer = document.getElementById('stories-back-btn-container');
                const storiesForm = document.getElementById('stories-form');
                const storiesFileInput = document.getElementById('stories-file');
                const storiesFileInfo = document.getElementById('stories-file-info');
                const storiesFileName = document.getElementById('stories-file-name');
                const storiesRemoveFileBtn = document.getElementById('stories-remove-file-btn');
                const storiesContext = document.getElementById('stories-context');
                const storiesContextCounter = document.getElementById('stories-context-counter');
                const storiesType = document.getElementById('stories-type');
                const storiesArea = document.getElementById('stories-area');
                const previewTbody = document.getElementById('stories-preview-tbody');
                const previewCount = document.getElementById('stories-preview-count');
                const selectedCount = document.getElementById('stories-selected-count');
                
                // Resetear formulario
                if (storiesForm) storiesForm.reset();
                if (storiesFileInput) storiesFileInput.value = '';
                if (storiesFileInfo) storiesFileInfo.style.display = 'none';
                if (storiesFileName) storiesFileName.textContent = '';
                if (storiesRemoveFileBtn) storiesRemoveFileBtn.style.display = 'none';
                if (storiesContext) storiesContext.value = '';
                if (storiesContextCounter) storiesContextCounter.textContent = '0 / 2000 caracteres';
                if (storiesType) storiesType.value = 'funcionalidad';
                if (storiesArea) storiesArea.value = '';
                
                // Limpiar vista previa
                if (previewTbody) previewTbody.innerHTML = '';
                if (previewCount) previewCount.textContent = '0';
                if (selectedCount) selectedCount.textContent = '0 historias seleccionadas';
                
                // Resetear checkboxes
                const selectAllCheckbox = document.getElementById('stories-select-all');
                const tableSelectAllCheckbox = document.getElementById('stories-table-select-all');
                if (selectAllCheckbox) selectAllCheckbox.checked = false;
                if (tableSelectAllCheckbox) tableSelectAllCheckbox.checked = false;
                
                // Limpiar variables globales
                window.selectedStoriesForUpload = [];
                window.storiesData = null;
                currentStoriesData = null;
                currentStoriesHtml = null;
                currentStoriesCsv = null;
                
                // Mostrar formulario y ocultar vista previa
                if (formContainer) formContainer.style.display = 'block';
                if (previewSection) previewSection.style.display = 'none';
                if (backBtnContainer) backBtnContainer.style.display = 'none';
                
                // Asegurar que el form-card también se muestre
                const storiesFormCard = document.getElementById('stories-form');
                if (storiesFormCard) {
                    const formCard = storiesFormCard.closest('.form-card');
                    if (formCard) formCard.style.display = 'block';
                }
                
                // Activar la sección de crear historias
                if (typeof navigateToSection === 'function') {
                    navigateToSection('crear-historias');
                } else {
                    // Fallback: activar manualmente si navigateToSection no está disponible
                    const crearHistoriasSection = document.getElementById('crear-historias');
                    if (crearHistoriasSection) {
                        // Ocultar todas las secciones
                        document.querySelectorAll('.content-section').forEach(section => {
                            section.classList.remove('active');
                        });
                        // Activar la sección de crear historias
                        crearHistoriasSection.classList.add('active');
                        // Actualizar nav-item activo
                        document.querySelectorAll('.nav-item').forEach(item => {
                            item.classList.remove('active-link', 'active');
                        });
                        const activeNav = document.querySelector('[data-section="crear-historias"]');
                        if (activeNav) {
                            activeNav.classList.add('active-link');
                        }
                        crearHistoriasSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }
            
            // Botón de regreso
            const backBtn = document.getElementById('stories-back-btn');
            if (backBtn) {
                backBtn.onclick = function() {
                    resetStoriesGenerator();
                };
            }
            
            // Botón de reset
            const resetBtn = document.getElementById('stories-reset-btn');
            if (resetBtn) {
                resetBtn.onclick = function() {
                    if (confirm('¿Estás seguro de que deseas hacer una nueva generación? Se perderán los datos actuales.')) {
                        resetStoriesGenerator();
                    }
                };
            }
            const storiesDropZone = document.getElementById('stories-drop-zone');
            const storiesFileInput = document.getElementById('stories-file');
            const storiesForm = document.getElementById('stories-form');
            const storiesContext = document.getElementById('stories-context');
            const storiesCounter = document.getElementById('stories-context-counter');
            const storiesGenerateBtn = document.getElementById('stories-generate-btn');
            const storiesFileInfo = document.getElementById('stories-file-info');
            const storiesFileName = document.getElementById('stories-file-name');
            const storiesRemoveFileBtn = document.getElementById('stories-remove-file-btn');

            if (!storiesForm) return;

            // Setup drag and drop (igual que carga masiva)
            function setupStoriesDropZone() {
                if (!storiesDropZone || !storiesFileInput) return;

                // Click en la zona de arrastre - FIX: usar mousedown en lugar de click para evitar doble click
                storiesDropZone.addEventListener('mousedown', (e) => {
                    // Solo si el click es directamente en el dropZone, no en elementos hijos
                    if (e.target === storiesDropZone || e.target.closest('.drop-zone-content')) {
                        e.preventDefault();
                        storiesFileInput.click();
                    }
                });

                // Prevenir comportamiento por defecto del navegador
                storiesDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    storiesDropZone.classList.add('drag-over');
                });

                storiesDropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    storiesDropZone.classList.remove('drag-over');
                });

                storiesDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    storiesDropZone.classList.remove('drag-over');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleStoriesFileSelect(files[0]);
                    }
                });

                // Cambio de archivo desde el input - FIX: usar change directamente sin prevenir default
                storiesFileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleStoriesFileSelect(e.target.files[0]);
                    }
                });
            }

            function handleStoriesFileSelect(file) {
                // Validar que sea DOCX o PDF
                const validExtensions = ['.docx', '.pdf'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                if (!validExtensions.includes(fileExtension)) {
                    showDownloadNotification('❌ Solo se permiten archivos DOCX o PDF', 'error');
                    return;
                }

                // Mostrar información del archivo
                if (storiesFileInfo && storiesFileName) {
                    storiesFileName.textContent = file.name;
                    storiesFileInfo.style.display = 'flex';
                }
            }

            // Botón para remover archivo
            if (storiesRemoveFileBtn) {
                storiesRemoveFileBtn.addEventListener('click', () => {
                    storiesFileInput.value = '';
                    if (storiesFileInfo) {
                        storiesFileInfo.style.display = 'none';
                    }
                });
            }

            // Character counter
            if (storiesContext && storiesCounter) {
                storiesContext.addEventListener('input', (e) => {
                    const length = e.target.value.length;
                    const maxLength = 2000;
                    storiesCounter.textContent = `${length} / ${maxLength} caracteres`;
                    storiesCounter.classList.remove('warning', 'error');
                    if (length > maxLength * 0.9) {
                        storiesCounter.classList.add('error');
                    } else if (length > maxLength * 0.8) {
                        storiesCounter.classList.add('warning');
                    }
                });
            }

            // Generate handler
            if (storiesForm) {
                storiesForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!storiesFileInput.files.length) {
                        showDownloadNotification('Por favor selecciona un archivo primero', 'error');
                        return;
                    }

                    const areaSelect = document.getElementById('stories-area');
                    if (!areaSelect || !areaSelect.value) {
                        showDownloadNotification('Por favor selecciona un área', 'error');
                        return;
                    }

                    const selectedArea = areaSelect.value;
                    const formData = new FormData(storiesForm);
                    storiesGenerateBtn.disabled = true;
                    storiesGenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
                    
                    showDownloadNotification('Generando historias...', 'loading');

                    try {
                        const response = await fetchWithTimeout('/api/stories/generate', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-CSRFToken': getCsrfToken()
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            
                            if (data.status === 'success' && data.stories) {
                                // Ocultar formulario y mostrar vista previa
                                const formContainer = document.getElementById('stories-form-container');
                                const previewSection = document.getElementById('stories-preview-section');
                                const backBtnContainer = document.getElementById('stories-back-btn-container');
                                
                                if (formContainer) formContainer.style.display = 'none';
                                if (previewSection) previewSection.style.display = 'block';
                                if (backBtnContainer) backBtnContainer.style.display = 'block';
                                
                                // Mostrar vista previa
                                displayStoriesPreview(data);
                                
                                // Actualizar métricas con el área seleccionada
                                if (data.stories_count > 0) {
                                    updateMetrics('stories', data.stories_count, selectedArea);
                                }
                                
                                showDownloadNotification(`Historias generadas exitosamente: ${data.stories_count} historias`, 'success');
                                
                                // Scroll suave a la parte superior de la sección
                                document.getElementById('crear-historias').scrollIntoView({ behavior: 'smooth', block: 'start' });
                            } else {
                                showDownloadNotification('Error: ' + (data.message || 'Error desconocido'), 'error');
                            }
                        } else {
                            const error = await response.json();
                            showDownloadNotification('Error: ' + (error.message || 'Error desconocido'), 'error');
                        }
                    } catch (error) {
                        showDownloadNotification('Error de conexión: ' + error.message, 'error');
                    } finally {
                        storiesGenerateBtn.disabled = false;
                        storiesGenerateBtn.innerHTML = '<i class="fas fa-eye"></i> Generar e Ir a Vista Previa';
                    }
                });
            }

            // Inicializar drag and drop
            setupStoriesDropZone();

            // Variables globales para historias
            let currentStoriesData = null;
            let currentStoriesHtml = null;
            let currentStoriesCsv = null;

            // Función para mostrar vista previa de historias
            function displayStoriesPreview(data) {
                currentStoriesData = data.stories;
                // Si no viene nuevo HTML/CSV, mantenemos el original para preservar estilos
                if (data.html_content) currentStoriesHtml = data.html_content;
                if (data.csv_content) currentStoriesCsv = data.csv_content;

                const previewSection = document.getElementById('stories-preview-section');
                const previewCount = document.getElementById('stories-preview-count');
                const previewTbody = document.getElementById('stories-preview-tbody');

                if (!previewSection || !previewCount || !previewTbody) return;

                // Mostrar sección
                previewSection.style.display = 'block';
                previewCount.textContent = data.stories_count;

                // Limpiar tabla
                previewTbody.innerHTML = '';

                // Agregar historias a la tabla
                data.stories.forEach((story, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                            <input type="checkbox" class="story-checkbox" data-index="${index}" checked style="width: 18px; height: 18px; cursor: pointer;">
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--accent); text-align: center;">${story.index}</td>
                        <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                            <input type="text" class="story-summary-input" data-index="${index}" value="${escapeHtml(story.summary)}" style="width: 100%; max-width: 300px; padding: 0.5rem; background: transparent; border: 1px solid transparent; border-radius: 4px; color: var(--text-primary); font-family: inherit; font-size: 0.9rem;">
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                            <textarea class="story-description-input" data-index="${index}" rows="2" style="width: 100%; max-width: 400px; padding: 0.5rem; background: transparent; border: 1px solid transparent; border-radius: 4px; color: var(--text-secondary); font-family: inherit; font-size: 0.85rem; resize: none; min-height: 50px;">${escapeHtml(story.description)}</textarea>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                            <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; background: rgba(59, 130, 246, 0.2); color: var(--accent);">${story.issuetype}</span>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                            <select class="story-priority-select" data-index="${index}" style="padding: 0.5rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-family: inherit; font-size: 0.9rem;">
                                <option value="High" ${story.priority === 'High' ? 'selected' : ''}>High</option>
                                <option value="Medium" ${story.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="Low" ${story.priority === 'Low' ? 'selected' : ''}>Low</option>
                            </select>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button class="story-edit-btn" data-index="${index}" style="padding: 0.5rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: var(--accent); border-radius: 6px; cursor: pointer; font-size: 1rem;" title="Editar">✏️</button>
                                <button class="story-delete-btn" data-index="${index}" style="padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--error); border-radius: 6px; cursor: pointer; font-size: 1rem;" title="Eliminar">🗑️</button>
                            </div>
                        </td>
                    `;
                    previewTbody.appendChild(row);
                });

                // Event listeners para edición
                updateStoriesEventListeners();
                updateSelectedCount();
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Función para formatear una historia individual para HTML
            function formatStoryForHTML(story, storyNum) {
                const title = story.summary || `Historia ${storyNum}`;
                const description = story.description || '';
                const priority = story.priority || 'Medium';
                const issuetype = story.issuetype || 'Story';
                
                // Parsear descripción para extraer COMO, QUIERO, PARA, etc.
                const comoMatch = description.match(/COMO:\s*([^\n]+)/i);
                const quieroMatch = description.match(/QUIERO:\s*([^\n]+)/i);
                const paraMatch = description.match(/PARA:\s*([^\n]+)/i);
                const criteriosMatch = description.match(/CRITERIOS\s+DE\s+ACEPTACI[ÓO]N:\s*([\s\S]*?)(?:\s+REGLAS|PRIORIDAD|COMPLEJIDAD|$)/i);
                
                let html = `<div class="story-container">
        <div class="story-title">HISTORIA #${storyNum}: ${escapeHtml(title)}</div>`;
                
                if (comoMatch) {
                    html += `
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">COMO:</span>
                            <span class="story-item-content"> ${escapeHtml(comoMatch[1].trim())}</span>
                        </div>`;
                }
                
                if (quieroMatch) {
                    html += `
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">QUIERO:</span>
                            <span class="story-item-content"> ${escapeHtml(quieroMatch[1].trim())}</span>
                        </div>`;
                }
                
                if (paraMatch) {
                    html += `
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">PARA:</span>
                            <span class="story-item-content"> ${escapeHtml(paraMatch[1].trim())}</span>
                        </div>`;
                }
                
                // Si no hay estructura COMO/QUIERO/PARA, mostrar descripción completa
                if (!comoMatch && !quieroMatch && !paraMatch && description) {
                    html += `
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">Descripción:</span>
                            <span class="story-item-content"> ${escapeHtml(description)}</span>
                        </div>`;
                }
                
                // Agregar criterios de aceptación si existen
                if (criteriosMatch) {
                    const criterios = criteriosMatch[1].trim();
                    html += `
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">Criterios de Aceptación:</span>
                            <span class="story-item-content"> ${escapeHtml(criterios)}</span>
                        </div>`;
                }
                
                html += `
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">Tipo:</span>
                            <span class="story-item-content"> ${issuetype}</span>
                        </div>
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">Prioridad:</span>
                            <span class="story-item-content"> ${priority}</span>
                        </div>
                    </div>`;
                
                return html;
            }

            function updateStoriesEventListeners() {
                // Select all checkboxes
                const selectAllCheckbox = document.getElementById('stories-select-all');
                const tableSelectAllCheckbox = document.getElementById('stories-table-select-all');
                
                if (selectAllCheckbox) {
                    selectAllCheckbox.onchange = function() {
                        const checkboxes = document.querySelectorAll('.story-checkbox');
                        checkboxes.forEach(cb => cb.checked = this.checked);
                        if (tableSelectAllCheckbox) tableSelectAllCheckbox.checked = this.checked;
                        updateSelectedCount();
                    };
                }

                if (tableSelectAllCheckbox) {
                    tableSelectAllCheckbox.onchange = function() {
                        const checkboxes = document.querySelectorAll('.story-checkbox');
                        checkboxes.forEach(cb => cb.checked = this.checked);
                        if (selectAllCheckbox) selectAllCheckbox.checked = this.checked;
                        updateSelectedCount();
                    };
                }

                // Individual checkboxes
                document.querySelectorAll('.story-checkbox').forEach(cb => {
                    cb.onchange = updateSelectedCount;
                });

                // Update story data on input change
                document.querySelectorAll('.story-summary-input, .story-description-input, .story-priority-select').forEach(input => {
                    input.onchange = function() {
                        const index = parseInt(this.dataset.index);
                        if (currentStoriesData && currentStoriesData[index]) {
                            if (this.classList.contains('story-summary-input')) {
                                currentStoriesData[index].summary = this.value;
                            } else if (this.classList.contains('story-description-input')) {
                                currentStoriesData[index].description = this.value;
                            } else if (this.classList.contains('story-priority-select')) {
                                currentStoriesData[index].priority = this.value;
                            }
                        }
                    };
                });

                // Edit buttons
                document.querySelectorAll('.story-edit-btn').forEach(btn => {
                    btn.onclick = function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        openEditStoryModal(index);
                    };
                });

                // Delete buttons
                document.querySelectorAll('.story-delete-btn').forEach(btn => {
                    btn.onclick = function() {
                        const index = parseInt(this.dataset.index);
                        if (confirm('¿Estás seguro de eliminar esta historia?')) {
                            currentStoriesData.splice(index, 1);
                            displayStoriesPreview({ stories: currentStoriesData, stories_count: currentStoriesData.length });
                        }
                    };
                });
            }

            function updateSelectedCount() {
                const checkboxes = document.querySelectorAll('.story-checkbox:checked');
                const count = checkboxes.length;
                const countEl = document.getElementById('stories-selected-count');
                if (countEl) {
                    countEl.textContent = `${count} historias seleccionadas`;
                }
            }

            // Variables para el modal de edición de historias
            let editingStoryIndex = null;

            function openEditStoryModal(index) {
                if (!currentStoriesData || !currentStoriesData[index]) {
                    showDownloadNotification('Error: Historia no encontrada', 'error');
                    return;
                }
                
                const story = currentStoriesData[index];
                editingStoryIndex = index;
                
                // Llenar campos del modal
                const summaryInput = document.getElementById('edit-story-summary');
                const descriptionInput = document.getElementById('edit-story-description');
                const issuetypeSelect = document.getElementById('edit-story-issuetype');
                const prioritySelect = document.getElementById('edit-story-priority');
                
                if (summaryInput) summaryInput.value = story.summary || '';
                if (descriptionInput) descriptionInput.value = story.description || '';
                if (issuetypeSelect) issuetypeSelect.value = story.issuetype || 'Story';
                if (prioritySelect) prioritySelect.value = story.priority || 'Medium';
                
                // Mostrar modal
                const modal = document.getElementById('edit-story-modal');
                if (modal) modal.style.display = 'flex';
            }

            function closeEditStoryModal() {
                const modal = document.getElementById('edit-story-modal');
                if (modal) modal.style.display = 'none';
                editingStoryIndex = null;
            }

            function saveStoryChanges() {
                if (editingStoryIndex === null) return;
                
                const summaryInput = document.getElementById('edit-story-summary');
                const descriptionInput = document.getElementById('edit-story-description');
                const issuetypeSelect = document.getElementById('edit-story-issuetype');
                const prioritySelect = document.getElementById('edit-story-priority');
                
                if (!summaryInput || !descriptionInput || !issuetypeSelect || !prioritySelect) {
                    showDownloadNotification('Error: Campos del modal no encontrados', 'error');
                    return;
                }
                
                const summary = summaryInput.value.trim();
                const description = descriptionInput.value.trim();
                const issuetype = issuetypeSelect.value;
                const priority = prioritySelect.value;
                
                if (!summary || !description) {
                    showDownloadNotification('Por favor completa todos los campos requeridos', 'error');
                    return;
                }
                
                // Actualizar datos
                currentStoriesData[editingStoryIndex].summary = summary;
                currentStoriesData[editingStoryIndex].description = description;
                currentStoriesData[editingStoryIndex].issuetype = issuetype;
                currentStoriesData[editingStoryIndex].priority = priority;
                
                // Actualizar vista previa
                displayStoriesPreview({ stories: currentStoriesData, stories_count: currentStoriesData.length });
                
                closeEditStoryModal();
                showDownloadNotification('Historia actualizada exitosamente', 'success');
            }

            // Event listeners del modal de edición de historias
            const editStoryModalClose = document.getElementById('edit-story-modal-close');
            const editStoryCancel = document.getElementById('edit-story-cancel');
            const editStorySave = document.getElementById('edit-story-save');
            if (editStoryModalClose) editStoryModalClose.onclick = closeEditStoryModal;
            if (editStoryCancel) editStoryCancel.onclick = closeEditStoryModal;
            if (editStorySave) editStorySave.onclick = saveStoryChanges;

            // Botón revisar historias (visualizar HTML)
            const reviewBtn = document.getElementById('stories-review-btn');
            if (reviewBtn) {
                reviewBtn.onclick = function() {
                    if (!currentStoriesData || currentStoriesData.length === 0) {
                        showDownloadNotification('No hay historias para revisar', 'error');
                        return;
                    }
                    openStoriesReview();
                };
            }

            function openStoriesReview() {
                const modal = document.getElementById('stories-review-modal');
                const iframe = document.getElementById('stories-html-viewer');
                
                if (!modal || !iframe) {
                    showDownloadNotification('Error: Modal de revisión no encontrado', 'error');
                    return;
                }

                // NO regenerar HTML - usar el HTML original guardado
                if (!currentStoriesHtml) {
                    showDownloadNotification('No hay HTML disponible para revisar', 'error');
                    return;
                }

                // Crear blob con el HTML original y mostrarlo en iframe
                const blob = new Blob([currentStoriesHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                iframe.src = url;
                
                modal.style.display = 'flex';
            }

            // Hacer funciones accesibles globalmente para los onclick del modal
            window.closeStoriesReview = function() {
                const modal = document.getElementById('stories-review-modal');
                const iframe = document.getElementById('stories-html-viewer');
                
                if (iframe && iframe.src) {
                    URL.revokeObjectURL(iframe.src);
                    iframe.src = '';
                }
                
                if (modal) {
                    modal.style.display = 'none';
                }
            };

            window.downloadStoriesHTML = function() {
                if (!currentStoriesData || currentStoriesData.length === 0) {
                    showDownloadNotification('No hay historias para descargar', 'error');
                    return;
                }

                // NO regenerar HTML - usar el HTML original guardado
                if (!currentStoriesHtml) {
                    showDownloadNotification('No hay HTML disponible para descargar', 'error');
                    return;
                }

                const blob = new Blob([currentStoriesHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'historias_usuario.html';
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showDownloadNotification('HTML descargado exitosamente', 'success');
            };

            // Botón subir a Jira
            const uploadJiraBtn = document.getElementById('stories-upload-jira-btn');
            if (uploadJiraBtn) {
                uploadJiraBtn.onclick = function() {
                    const selected = document.querySelectorAll('.story-checkbox:checked');
                    if (selected.length === 0) {
                        showDownloadNotification('Por favor selecciona al menos una historia para subir', 'error');
                        return;
                    }

                    // Obtener historias seleccionadas
                    const selectedStories = Array.from(selected).map(cb => {
                        const index = parseInt(cb.dataset.index);
                        return currentStoriesData[index];
                    });

                    // Cargar proyectos de Jira y mostrar modal
                    loadJiraProjects().then(() => {
                        document.getElementById('jira-modal-stories-count').textContent = `${selectedStories.length} historias seleccionadas para subir`;
                        window.selectedStoriesForUpload = selectedStories;
                        document.getElementById('jira-upload-modal').style.display = 'flex';
                    });
                };
            }

            // Cerrar modal
            const modalClose = document.getElementById('jira-modal-close');
            const modalCancel = document.getElementById('jira-modal-cancel');
            if (modalClose) modalClose.onclick = closeJiraModal;
            if (modalCancel) modalCancel.onclick = closeJiraModal;

            function closeJiraModal() {
                document.getElementById('jira-upload-modal').style.display = 'none';
                document.getElementById('jira-assignee-input').value = '';
                document.getElementById('jira-assignee-validation').style.display = 'none';
            }

            // Validar email de asignado
            const assigneeInput = document.getElementById('jira-assignee-input');
            if (assigneeInput) {
                assigneeInput.addEventListener('blur', async function() {
                    const email = this.value.trim();
                    const validationDiv = document.getElementById('jira-assignee-validation');
                    
                    if (!email) {
                        validationDiv.style.display = 'none';
                        return;
                    }

                    // Validar formato
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        validationDiv.style.display = 'block';
                        validationDiv.style.color = 'var(--error)';
                        validationDiv.textContent = '❌ Formato de email inválido';
                        return;
                    }

                    // Validar en Jira
                    validationDiv.style.display = 'block';
                    validationDiv.style.color = 'var(--text-muted)';
                    validationDiv.textContent = '⏳ Validando usuario...';

                    try {
                        const response = await fetch('/api/jira/validate-user', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken()
                            },
                            body: JSON.stringify({ email: email })
                        });

                        const data = await response.json();
                        if (data.valid) {
                            validationDiv.style.color = 'var(--success)';
                            validationDiv.textContent = '✅ Usuario encontrado en Jira';
                            window.assigneeAccountId = data.accountId;
                        } else {
                            validationDiv.style.color = 'var(--error)';
                            validationDiv.textContent = '❌ ' + (data.error || 'Este correo no tiene cuenta en Jira');
                            window.assigneeAccountId = null;
                        }
                    } catch (error) {
                        validationDiv.style.color = 'var(--error)';
                        validationDiv.textContent = '❌ Error al validar usuario';
                        window.assigneeAccountId = null;
                    }
                });
            }

            // Cargar proyectos de Jira
            async function loadJiraProjects() {
                const select = document.getElementById('jira-project-select');
                if (!select) return;

                try {
                    const response = await fetch('/api/jira/projects', {
                        headers: { 'X-CSRFToken': getCsrfToken() }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // El endpoint retorna {success: true, projects: [...]}
                        const projects = data.projects || [];
                        select.innerHTML = '<option value="">Seleccionar proyecto...</option>';
                        
                        if (projects.length === 0) {
                            select.innerHTML += '<option value="" disabled>No hay proyectos disponibles</option>';
                            showDownloadNotification('No se encontraron proyectos de Jira. Verifica tu configuración.', 'error');
                            return;
                        }
                        
                        projects.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project.key || project.get?.('key', '');
                            option.textContent = `${project.key || project.get?.('key', '')} - ${project.name || project.get?.('name', '')}`;
                            select.appendChild(option);
                        });
                    } else {
                        const errorData = await response.json();
                        showDownloadNotification('Error al cargar proyectos: ' + (errorData.error || 'Error desconocido'), 'error');
                    }
                } catch (error) {
                    console.error('Error al cargar proyectos:', error);
                    showDownloadNotification('Error de conexión al cargar proyectos', 'error');
                }
            }

            // Subir a Jira
            const modalUploadBtn = document.getElementById('jira-modal-upload');
            if (modalUploadBtn) {
                modalUploadBtn.onclick = async function() {
                    const projectKey = document.getElementById('jira-project-select').value;
                    if (!projectKey) {
                        showDownloadNotification('Por favor selecciona un proyecto', 'error');
                        return;
                    }

                    const assigneeEmail = document.getElementById('jira-assignee-input').value.trim();
                    const validationDiv = document.getElementById('jira-assignee-validation');
                    
                    // Validar asignado si se proporciona
                    if (assigneeEmail) {
                        // Si no se ha validado aún o la validación falló, validar ahora
                        const isValidated = validationDiv.style.display === 'block' && validationDiv.textContent.includes('✅');
                        const isInvalid = validationDiv.style.display === 'block' && validationDiv.textContent.includes('❌');
                        
                        if (!isValidated && !isInvalid) {
                            // Validar ahora antes de continuar
                            validationDiv.style.display = 'block';
                            validationDiv.style.color = 'var(--text-muted)';
                            validationDiv.textContent = '⏳ Validando usuario...';
                            
                            try {
                                const validateResponse = await fetch('/api/jira/validate-user', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': getCsrfToken()
                                    },
                                    body: JSON.stringify({ email: assigneeEmail })
                                });
                                
                                const validateData = await validateResponse.json();
                                if (validateData.valid) {
                                    validationDiv.style.color = 'var(--success)';
                                    validationDiv.textContent = '✅ Usuario encontrado en Jira';
                                    window.assigneeAccountId = validateData.accountId;
                                } else {
                                    validationDiv.style.color = 'var(--error)';
                                    validationDiv.textContent = '❌ ' + (validateData.error || 'Este correo no tiene cuenta en Jira');
                                    window.assigneeAccountId = null;
                                    showDownloadNotification('Por favor verifica que el email del asignado sea válido y tenga cuenta en Jira', 'error');
                                    return;
                                }
                            } catch (error) {
                                validationDiv.style.color = 'var(--error)';
                                validationDiv.textContent = '❌ Error al validar usuario';
                                window.assigneeAccountId = null;
                                showDownloadNotification('Error al validar usuario de Jira', 'error');
                                return;
                            }
                        } else if (isInvalid) {
                            // Ya se validó y es inválido
                            showDownloadNotification('Por favor verifica que el email del asignado sea válido y tenga cuenta en Jira', 'error');
                            return;
                        } else if (!isValidated) {
                            // No se ha validado aún
                            showDownloadNotification('Por favor verifica que el email del asignado sea válido y tenga cuenta en Jira', 'error');
                            return;
                        }
                    }

                    // Mostrar loading
                    document.getElementById('stories-loading-overlay').style.display = 'flex';

                    try {
                        const response = await fetch('/api/stories/upload-to-jira', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken()
                            },
                            body: JSON.stringify({
                                stories: window.selectedStoriesForUpload,
                                project_key: projectKey,
                                assignee_email: assigneeEmail || null
                            })
                        });

                        const data = await response.json();
                        
                        document.getElementById('stories-loading-overlay').style.display = 'none';
                        closeJiraModal();

                        if (data.success) {
                            showDownloadNotification(data.message || 'Historias subidas exitosamente a Jira', 'success');
                            
                            // Descargar archivo TXT si está disponible
                            if (data.txt_content && data.txt_filename) {
                                try {
                                    // Decodificar base64 y convertir a UTF-8
                                    const binaryString = atob(data.txt_content);
                                    const bytes = new Uint8Array(binaryString.length);
                                    for (let i = 0; i < binaryString.length; i++) {
                                        bytes[i] = binaryString.charCodeAt(i);
                                    }
                                    const txtBlob = new Blob([bytes], { type: 'text/plain;charset=utf-8' });
                                    const txtUrl = URL.createObjectURL(txtBlob);
                                    const txtLink = document.createElement('a');
                                    txtLink.href = txtUrl;
                                    txtLink.download = data.txt_filename;
                                    document.body.appendChild(txtLink);
                                    txtLink.click();
                                    document.body.removeChild(txtLink);
                                    URL.revokeObjectURL(txtUrl);
                                } catch (error) {
                                    console.error('Error al descargar TXT:', error);
                                }
                            }
                            
                            // Opcional: ocultar historias subidas o actualizar vista
                        } else {
                            showDownloadNotification('Error: ' + (data.error || 'No se pudieron subir las historias'), 'error');
                            
                            // Descargar TXT incluso si hay errores
                            if (data.txt_content && data.txt_filename) {
                                try {
                                    // Decodificar base64 y convertir a UTF-8
                                    const binaryString = atob(data.txt_content);
                                    const bytes = new Uint8Array(binaryString.length);
                                    for (let i = 0; i < binaryString.length; i++) {
                                        bytes[i] = binaryString.charCodeAt(i);
                                    }
                                    const txtBlob = new Blob([bytes], { type: 'text/plain;charset=utf-8' });
                                    const txtUrl = URL.createObjectURL(txtBlob);
                                    const txtLink = document.createElement('a');
                                    txtLink.href = txtUrl;
                                    txtLink.download = data.txt_filename;
                                    document.body.appendChild(txtLink);
                                    txtLink.click();
                                    document.body.removeChild(txtLink);
                                    URL.revokeObjectURL(txtUrl);
                                } catch (error) {
                                    console.error('Error al descargar TXT:', error);
                                }
                            }
                        }
                    } catch (error) {
                        document.getElementById('stories-loading-overlay').style.display = 'none';
                        showDownloadNotification('Error de conexión: ' + error.message, 'error');
                    }
                };
            }
        })();

        // ========================================================================
        // CREAR CASOS DE PRUEBA - JavaScript
        // ========================================================================
        (function() {
            // Función para resetear el generador de casos de prueba
            function resetTestsGenerator() {
                const formContainer = document.getElementById('tests-form-container');
                const previewSection = document.getElementById('tests-preview-section');
                const backBtnContainer = document.getElementById('tests-back-btn-container');
                const testsForm = document.getElementById('tests-form');
                const testsFileInput = document.getElementById('tests-file');
                const testsFileInfo = document.getElementById('tests-file-info');
                const testsFileName = document.getElementById('tests-file-name');
                const testsRemoveFileBtn = document.getElementById('tests-remove-file-btn');
                const testsContext = document.getElementById('tests-context');
                const testsContextCounter = document.getElementById('tests-context-counter');
                const testsType = document.getElementById('tests-type');
                const testsArea = document.getElementById('tests-area');
                const previewTbody = document.getElementById('tests-preview-tbody');
                const previewCount = document.getElementById('tests-preview-count');
                const selectedCount = document.getElementById('tests-selected-count');
                
                // Resetear formulario
                if (testsForm) testsForm.reset();
                if (testsFileInput) testsFileInput.value = '';
                if (testsFileInfo) testsFileInfo.style.display = 'none';
                if (testsFileName) testsFileName.textContent = '';
                if (testsRemoveFileBtn) testsRemoveFileBtn.style.display = 'none';
                if (testsContext) testsContext.value = '';
                if (testsContextCounter) testsContextCounter.textContent = '0 / 2000 caracteres';
                if (testsType) testsType.value = 'funcionalidad';
                if (testsArea) testsArea.value = '';
                
                // Limpiar vista previa
                if (previewTbody) previewTbody.innerHTML = '';
                if (previewCount) previewCount.textContent = '0';
                if (selectedCount) selectedCount.textContent = '0 casos seleccionados';
                
                // Resetear checkboxes
                const selectAllCheckbox = document.getElementById('tests-select-all');
                const tableSelectAllCheckbox = document.getElementById('tests-table-select-all');
                if (selectAllCheckbox) selectAllCheckbox.checked = false;
                if (tableSelectAllCheckbox) tableSelectAllCheckbox.checked = false;
                
                // Limpiar variables globales
                window.selectedTestsForUpload = [];
                window.testsData = null;
                currentTestsData = null;
                currentTestsHtml = null;
                currentTestsCsv = null;
                
                // Mostrar formulario y ocultar vista previa
                if (formContainer) formContainer.style.display = 'block';
                if (previewSection) previewSection.style.display = 'none';
                if (backBtnContainer) backBtnContainer.style.display = 'none';
                
                // Asegurar que el form-card también se muestre
                const testsFormCard = document.getElementById('tests-form');
                if (testsFormCard) {
                    const formCard = testsFormCard.closest('.form-card');
                    if (formCard) formCard.style.display = 'block';
                }
                
                // Activar la sección de crear casos de prueba
                if (typeof navigateToSection === 'function') {
                    navigateToSection('crear-casos-prueba');
                } else {
                    // Fallback: activar manualmente si navigateToSection no está disponible
                    const crearCasosPruebaSection = document.getElementById('crear-casos-prueba');
                    if (crearCasosPruebaSection) {
                        // Ocultar todas las secciones
                        document.querySelectorAll('.content-section').forEach(section => {
                            section.classList.remove('active');
                        });
                        // Activar la sección de crear casos de prueba
                        crearCasosPruebaSection.classList.add('active');
                        // Actualizar nav-item activo
                        document.querySelectorAll('.nav-item').forEach(item => {
                            item.classList.remove('active-link', 'active');
                        });
                        const activeNav = document.querySelector('[data-section="crear-casos-prueba"]');
                        if (activeNav) {
                            activeNav.classList.add('active-link');
                        }
                        crearCasosPruebaSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }
            
            // Botón de reset
            const resetBtn = document.getElementById('tests-reset-btn');
            if (resetBtn) {
                resetBtn.onclick = function() {
                    if (confirm('¿Estás seguro de que deseas hacer una nueva generación? Se perderán los datos actuales.')) {
                        resetTestsGenerator();
                    }
                };
            }
            
            const testsDropZone = document.getElementById('tests-drop-zone');
            const testsFileInput = document.getElementById('tests-file');
            const testsForm = document.getElementById('tests-form');
            const testsGenerateBtn = document.getElementById('tests-generate-btn');
            const testsFileInfo = document.getElementById('tests-file-info');
            const testsFileName = document.getElementById('tests-file-name');
            const testsRemoveFileBtn = document.getElementById('tests-remove-file-btn');

            if (!testsForm) return;

            // Setup drag and drop (igual que carga masiva)
            function setupTestsDropZone() {
                if (!testsDropZone || !testsFileInput) return;

                // Click en la zona de arrastre - FIX: usar mousedown en lugar de click para evitar doble click
                testsDropZone.addEventListener('mousedown', (e) => {
                    // Solo si el click es directamente en el dropZone, no en elementos hijos
                    if (e.target === testsDropZone || e.target.closest('.drop-zone-content')) {
                        e.preventDefault();
                        testsFileInput.click();
                    }
                });

                // Prevenir comportamiento por defecto del navegador
                testsDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    testsDropZone.classList.add('drag-over');
                });

                testsDropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    testsDropZone.classList.remove('drag-over');
                });

                testsDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    testsDropZone.classList.remove('drag-over');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleTestsFileSelect(files[0]);
                    }
                });

                // Cambio de archivo desde el input - FIX: usar change directamente sin prevenir default
                testsFileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleTestsFileSelect(e.target.files[0]);
                    }
                });
            }

            function handleTestsFileSelect(file) {
                // Validar que sea DOCX o PDF
                const validExtensions = ['.docx', '.pdf'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                if (!validExtensions.includes(fileExtension)) {
                    showDownloadNotification('❌ Solo se permiten archivos DOCX o PDF', 'error');
                    return;
                }

                // Mostrar información del archivo
                if (testsFileInfo && testsFileName) {
                    testsFileName.textContent = file.name;
                    testsFileInfo.style.display = 'flex';
                }
            }

            // Botón para remover archivo
            if (testsRemoveFileBtn) {
                testsRemoveFileBtn.addEventListener('click', () => {
                    testsFileInput.value = '';
                    if (testsFileInfo) {
                        testsFileInfo.style.display = 'none';
                    }
                });
            }

            // Variables globales para casos de prueba
            let currentTestsData = null;
            let currentTestsHtml = null;
            let currentTestsCsv = null;

            // Función helper para escapar HTML (necesaria para displayTestsPreview)
            function escapeHtml(text) {
                if (text === null || text === undefined) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Función para formatear un caso de prueba individual para HTML
            function formatTestCaseForHTML(testCase, caseNum) {
                const title = testCase.summary || `Caso de Prueba ${caseNum}`;
                const description = testCase.description || '';
                const priority = testCase.priority || 'Medium';
                const categoria = testCase.categoria || '';
                const tipoPrueba = testCase.tipo_prueba || 'Funcional';
                
                // Extraer información adicional de la descripción si está disponible
                const pasosMatch = description.match(/Pasos?:?\s*([\s\S]*?)(?=Resultado|$)/i);
                const resultadoMatch = description.match(/Resultado\s+esperado:?\s*([\s\S]*?)(?=Precondiciones|$)/i);
                const precondicionesMatch = description.match(/Precondiciones:?\s*([\s\S]*?)(?=Pasos|Resultado|$)/i);
                
                let html = `<div class="story-container">
        <div class="story-title">CASO DE PRUEBA #${caseNum}: ${escapeHtml(title)}</div>`;
                
                if (description) {
                    // Si hay pasos y resultado en la descripción, mostrarlos por separado
                    if (pasosMatch || resultadoMatch || precondicionesMatch) {
                        if (precondicionesMatch) {
                            html += `
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">Precondiciones:</span>
                            <span class="story-item-content"> ${escapeHtml(precondicionesMatch[1].trim())}</span>
                        </div>`;
                        }
                        
                        if (pasosMatch) {
                            const pasos = pasosMatch[1].trim().split(/\d+\./).filter(p => p.trim());
                            if (pasos.length > 0) {
                                html += `
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">Pasos:</span>
                            <div class="story-sublist">`;
                                pasos.forEach((paso, i) => {
                                    if (paso.trim()) {
                                        html += `
                                <div class="story-sublist-item">
                                    <span class="bullet">*</span>
                                    <strong>Paso ${i + 1}:</strong> ${escapeHtml(paso.trim())}
                                </div>`;
                                    }
                                });
                                html += `
                            </div>
                        </div>`;
                            }
                        }
                        
                        if (resultadoMatch) {
                            html += `
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">Resultado Esperado:</span>
                            <span class="story-item-content"> ${escapeHtml(resultadoMatch[1].trim())}</span>
                        </div>`;
                        }
                    } else {
                        // Mostrar descripción completa si no tiene estructura
                        html += `
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">Descripción:</span>
                            <span class="story-item-content"> ${escapeHtml(description)}</span>
                        </div>`;
                    }
                }
                
                if (tipoPrueba) {
                    html += `
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">Tipo de Prueba:</span>
                            <span class="story-item-content"> ${escapeHtml(tipoPrueba)}</span>
                        </div>`;
                }
                
                if (categoria) {
                    html += `
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">Categoría:</span>
                            <span class="story-item-content"> ${escapeHtml(categoria)}</span>
                        </div>`;
                }
                
                html += `
                        <div class="story-item">
                            <span class="bullet">*</span>
                            <span class="story-item-label">Prioridad:</span>
                            <span class="story-item-content"> ${priority}</span>
                        </div>
                    </div>`;
                
                return html;
            }

            // Función para mostrar vista previa de casos de prueba
            function displayTestsPreview(data) {
                console.log('🔍 displayTestsPreview INICIADO');
                console.log('📦 data recibida:', data);
                console.log('📋 data.test_cases:', data.test_cases);
                console.log('🔢 Cantidad de casos:', data.test_cases ? data.test_cases.length : 'undefined');
                
                currentTestsData = data.test_cases;
                // Si no llega HTML/CSV en esta actualización (ej. edición), conservamos el original
                if (data.html_content) currentTestsHtml = data.html_content;
                if (data.csv_content) currentTestsCsv = data.csv_content;

                const previewSection = document.getElementById('tests-preview-section');
                const previewCount = document.getElementById('tests-preview-count');
                const previewTbody = document.getElementById('tests-preview-tbody');
                const testsForm = document.getElementById('tests-form');

                console.log('🔍 Elementos DOM encontrados:', {
                    previewSection: !!previewSection,
                    previewCount: !!previewCount,
                    previewTbody: !!previewTbody,
                    testsForm: !!testsForm
                });

                if (!previewSection || !previewCount || !previewTbody) {
                    console.error('❌ ERROR: Elementos del DOM no encontrados');
                    return;
                }

                // Ocultar formulario y mostrar vista previa
                if (testsForm) {
                    testsForm.closest('.form-card').style.display = 'none';
                }
                previewSection.style.display = 'block';
                previewCount.textContent = data.test_cases_count || (data.test_cases ? data.test_cases.length : 0);
                console.log('✅ Sección de vista previa mostrada, contador actualizado:', previewCount.textContent);

                // Limpiar tabla
                previewTbody.innerHTML = '';
                console.log('🧹 Tabla limpiada');

                // Agregar casos de prueba a la tabla
                console.log('🔄 Iniciando forEach para agregar casos...');
                let casosAgregados = 0;
                data.test_cases.forEach((testCase, index) => {
                    try {
                        console.log(`📝 Procesando caso ${index + 1}:`, testCase);
                        
                        // Validar y obtener valores con fallbacks seguros
                        const caseIndex = testCase.index !== undefined ? testCase.index : (index + 1);
                        const caseSummary = testCase.summary || 'Sin título';
                        const caseDescription = testCase.description || '';
                        const caseIssuetype = testCase.issuetype || 'Test Case';
                        const casePriority = testCase.priority || 'Medium';
                        const caseTipoPrueba = testCase.tipo_prueba || 'Funcional';
                        const caseCategoria = testCase.categoria || '';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                                <input type="checkbox" class="test-checkbox" data-index="${index}" checked style="width: 18px; height: 18px; cursor: pointer;">
                            </td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--accent); text-align: center;">${caseIndex}</td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                                <input type="text" class="test-summary-input" data-index="${index}" value="${escapeHtml(caseSummary)}" style="width: 100%; max-width: 300px; padding: 0.5rem; background: transparent; border: 1px solid transparent; border-radius: 4px; color: var(--text-primary); font-family: inherit; font-size: 0.9rem;">
                            </td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                                <textarea class="test-description-input" data-index="${index}" rows="2" style="width: 100%; max-width: 400px; padding: 0.5rem; background: transparent; border: 1px solid transparent; border-radius: 4px; color: var(--text-secondary); font-family: inherit; font-size: 0.85rem; resize: none; min-height: 50px;">${escapeHtml(caseDescription)}</textarea>
                            </td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                                <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; background: rgba(59, 130, 246, 0.2); color: var(--accent);">${escapeHtml(caseIssuetype)}</span>
                            </td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                                <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; background: rgba(34, 197, 94, 0.2); color: #22c55e;">${escapeHtml(caseTipoPrueba)}</span>
                            </td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                                <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; background: rgba(168, 85, 247, 0.2); color: #a855f7;">${escapeHtml(caseCategoria)}</span>
                            </td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                                <select class="test-priority-select" data-index="${index}" style="padding: 0.5rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-family: inherit; font-size: 0.9rem;">
                                    <option value="High" ${casePriority === 'High' ? 'selected' : ''}>High</option>
                                    <option value="Medium" ${casePriority === 'Medium' ? 'selected' : ''}>Medium</option>
                                    <option value="Low" ${casePriority === 'Low' ? 'selected' : ''}>Low</option>
                                </select>
                            </td>
                            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <button class="test-edit-btn" data-index="${index}" style="padding: 0.5rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: var(--accent); border-radius: 6px; cursor: pointer; font-size: 1rem;" title="Editar">✏️</button>
                                    <button class="test-delete-btn" data-index="${index}" style="padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--error); border-radius: 6px; cursor: pointer; font-size: 1rem;" title="Eliminar">🗑️</button>
                                </div>
                            </td>
                        `;
                        previewTbody.appendChild(row);
                        casosAgregados++;
                        console.log(`✅ Caso ${index + 1} agregado exitosamente`);
                    } catch (error) {
                        console.error(`❌ Error al agregar caso ${index + 1}:`, error, testCase);
                    }
                });
                
                console.log(`✅ Total de casos agregados a la tabla: ${casosAgregados}`);
                console.log(`📊 Filas en tbody: ${previewTbody.children.length}`);

                // Event listeners para edición
                updateTestsEventListeners();
                updateTestsSelectedCount();
                console.log('✅ displayTestsPreview COMPLETADO');
            }

            function updateTestsEventListeners() {
                // Select all checkboxes
                const selectAllCheckbox = document.getElementById('tests-select-all');
                const tableSelectAllCheckbox = document.getElementById('tests-table-select-all');
                
                if (selectAllCheckbox) {
                    selectAllCheckbox.onchange = function() {
                        const checkboxes = document.querySelectorAll('.test-checkbox');
                        checkboxes.forEach(cb => cb.checked = this.checked);
                        if (tableSelectAllCheckbox) tableSelectAllCheckbox.checked = this.checked;
                        updateTestsSelectedCount();
                    };
                }

                if (tableSelectAllCheckbox) {
                    tableSelectAllCheckbox.onchange = function() {
                        const checkboxes = document.querySelectorAll('.test-checkbox');
                        checkboxes.forEach(cb => cb.checked = this.checked);
                        if (selectAllCheckbox) selectAllCheckbox.checked = this.checked;
                        updateTestsSelectedCount();
                    };
                }

                // Individual checkboxes
                document.querySelectorAll('.test-checkbox').forEach(cb => {
                    cb.onchange = updateTestsSelectedCount;
                });

                // Update test case data on input change
                document.querySelectorAll('.test-summary-input, .test-description-input, .test-priority-select').forEach(input => {
                    input.onchange = function() {
                        const index = parseInt(this.dataset.index);
                        if (currentTestsData && currentTestsData[index]) {
                            if (this.classList.contains('test-summary-input')) {
                                currentTestsData[index].summary = this.value;
                            } else if (this.classList.contains('test-description-input')) {
                                currentTestsData[index].description = this.value;
                            } else if (this.classList.contains('test-priority-select')) {
                                currentTestsData[index].priority = this.value;
                            }
                        }
                    };
                });

                // Edit buttons
                document.querySelectorAll('.test-edit-btn').forEach(btn => {
                    btn.onclick = function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        openEditTestModal(index);
                    };
                });

                // Delete buttons
                document.querySelectorAll('.test-delete-btn').forEach(btn => {
                    btn.onclick = function() {
                        const index = parseInt(this.dataset.index);
                        if (confirm('¿Estás seguro de eliminar este caso de prueba?')) {
                            currentTestsData.splice(index, 1);
                            displayTestsPreview({ test_cases: currentTestsData, test_cases_count: currentTestsData.length });
                        }
                    };
                });
            }

            function updateTestsSelectedCount() {
                const checkboxes = document.querySelectorAll('.test-checkbox:checked');
                const count = checkboxes.length;
                const countEl = document.getElementById('tests-selected-count');
                if (countEl) {
                    countEl.textContent = `${count} casos seleccionados`;
                }
            }

            // Variables para el modal de edición de casos de prueba
            let editingTestIndex = null;

            function openEditTestModal(index) {
                if (!currentTestsData || !currentTestsData[index]) {
                    showDownloadNotification('Error: Caso de prueba no encontrado', 'error');
                    return;
                }
                
                const testCase = currentTestsData[index];
                editingTestIndex = index;
                
                // Llenar campos del modal
                const summaryInput = document.getElementById('edit-test-summary');
                const descriptionInput = document.getElementById('edit-test-description');
                const prioritySelect = document.getElementById('edit-test-priority');
                const categoriaInput = document.getElementById('edit-test-categoria');
                
                if (summaryInput) summaryInput.value = testCase.summary || '';
                if (descriptionInput) descriptionInput.value = testCase.description || '';
                if (prioritySelect) prioritySelect.value = testCase.priority || 'Medium';
                if (categoriaInput) categoriaInput.value = testCase.categoria || '';
                
                // Mostrar modal
                const modal = document.getElementById('edit-test-modal');
                if (modal) modal.style.display = 'flex';
            }

            function closeEditTestModal() {
                const modal = document.getElementById('edit-test-modal');
                if (modal) modal.style.display = 'none';
                editingTestIndex = null;
            }

            function saveTestChanges() {
                if (editingTestIndex === null) return;
                
                const summaryInput = document.getElementById('edit-test-summary');
                const descriptionInput = document.getElementById('edit-test-description');
                const prioritySelect = document.getElementById('edit-test-priority');
                const categoriaInput = document.getElementById('edit-test-categoria');
                
                if (!summaryInput || !descriptionInput || !prioritySelect || !categoriaInput) {
                    showDownloadNotification('Error: Campos del modal no encontrados', 'error');
                    return;
                }
                
                const summary = summaryInput.value.trim();
                const description = descriptionInput.value.trim();
                const priority = prioritySelect.value;
                const categoria = categoriaInput.value.trim();
                
                if (!summary || !description) {
                    showDownloadNotification('Por favor completa todos los campos requeridos', 'error');
                    return;
                }
                
                // Actualizar datos
                currentTestsData[editingTestIndex].summary = summary;
                currentTestsData[editingTestIndex].description = description;
                currentTestsData[editingTestIndex].priority = priority;
                currentTestsData[editingTestIndex].categoria = categoria;
                
                // Actualizar vista previa
                displayTestsPreview({ test_cases: currentTestsData, test_cases_count: currentTestsData.length });
                
                closeEditTestModal();
                showDownloadNotification('Caso de prueba actualizado exitosamente', 'success');
            }

            // Event listeners del modal de edición de casos de prueba
            const editTestModalClose = document.getElementById('edit-test-modal-close');
            const editTestCancel = document.getElementById('edit-test-cancel');
            const editTestSave = document.getElementById('edit-test-save');
            if (editTestModalClose) editTestModalClose.onclick = closeEditTestModal;
            if (editTestCancel) editTestCancel.onclick = closeEditTestModal;
            if (editTestSave) editTestSave.onclick = saveTestChanges;

            // Botón revisar casos (visualizar HTML)
            const testsReviewBtn = document.getElementById('tests-review-btn');
            if (testsReviewBtn) {
                testsReviewBtn.onclick = function() {
                    if (!currentTestsData || currentTestsData.length === 0) {
                        showDownloadNotification('No hay casos de prueba para revisar', 'error');
                        return;
                    }
                    openTestsReview();
                };
            }

            function openTestsReview() {
                const modal = document.getElementById('tests-review-modal');
                const iframe = document.getElementById('tests-html-viewer');
                
                if (!modal || !iframe) {
                    showDownloadNotification('Error: Modal de revisión no encontrado', 'error');
                    return;
                }

                // NO regenerar HTML - usar el HTML original guardado
                if (!currentTestsHtml) {
                    showDownloadNotification('No hay HTML disponible para revisar', 'error');
                    return;
                }

                // Crear blob con el HTML original y mostrarlo en iframe
                const blob = new Blob([currentTestsHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                iframe.src = url;
                
                modal.style.display = 'flex';
            }

            // Hacer funciones accesibles globalmente para los onclick del modal
            window.closeTestsReview = function() {
                const modal = document.getElementById('tests-review-modal');
                const iframe = document.getElementById('tests-html-viewer');
                
                if (iframe && iframe.src) {
                    URL.revokeObjectURL(iframe.src);
                    iframe.src = '';
                }
                
                if (modal) {
                    modal.style.display = 'none';
                }
            };

            window.downloadTestsHTML = function() {
                if (!currentTestsData || currentTestsData.length === 0) {
                    showDownloadNotification('No hay casos de prueba para descargar', 'error');
                    return;
                }

                // NO regenerar HTML - usar el HTML original guardado
                if (!currentTestsHtml) {
                    showDownloadNotification('No hay HTML disponible para descargar', 'error');
                    return;
                }

                const blob = new Blob([currentTestsHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'casos_prueba.html';
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showDownloadNotification('HTML descargado exitosamente', 'success');
            };

            // Botón subir a Jira
            const testsUploadJiraBtn = document.getElementById('tests-upload-jira-btn');
            if (testsUploadJiraBtn) {
                testsUploadJiraBtn.onclick = function() {
                    const selected = document.querySelectorAll('.test-checkbox:checked');
                    if (selected.length === 0) {
                        showDownloadNotification('Por favor selecciona al menos un caso de prueba para subir', 'error');
                        return;
                    }

                    // Obtener casos seleccionados
                    const selectedTests = Array.from(selected).map(cb => {
                        const index = parseInt(cb.dataset.index);
                        return currentTestsData[index];
                    });

                    window.selectedTestsForUpload = selectedTests;
                    openJiraTestsModal();
                };
            }

            // Generate handler
            if (testsForm) {
                testsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!testsFileInput.files.length) {
                        showDownloadNotification('Por favor selecciona un archivo primero', 'error');
                        return;
                    }

                    const areaSelect = document.getElementById('tests-area');
                    if (!areaSelect || !areaSelect.value) {
                        showDownloadNotification('Por favor selecciona un área', 'error');
                        return;
                    }

                    const selectedArea = areaSelect.value;
                    const selectedTypes = Array.from(document.querySelectorAll('input[name="test_types"]:checked')).map(cb => cb.value);
                    if (selectedTypes.length === 0) {
                        showDownloadNotification('Por favor selecciona al menos un tipo de prueba', 'error');
                        return;
                    }

                    const formData = new FormData(testsForm);
                    selectedTypes.forEach(type => formData.append('test_types', type));

                    testsGenerateBtn.disabled = true;
                    testsGenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
                    
                    showDownloadNotification('Procesando archivo...', 'loading');

                    try {
                        const response = await fetchWithTimeout('/api/tests/generate', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-CSRFToken': getCsrfToken()
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            console.log('📊 Respuesta completa:', data);
                            console.log('📋 test_cases recibidos:', data.test_cases);
                            console.log('🔢 Cantidad:', data.test_cases ? data.test_cases.length : 0);
                            
                            // Validar estructura
                            if (!data.test_cases || !Array.isArray(data.test_cases)) {
                                console.error('❌ Error: test_cases no es un array válido');
                                showDownloadNotification('Error: Formato de datos incorrecto', 'error');
                                return;
                            }
                            
                            if (data.test_cases.length === 0) {
                                console.warn('⚠️ Advertencia: test_cases está vacío');
                                showDownloadNotification('No se generaron casos de prueba', 'error');
                                return;
                            }
                            
                            // Actualizar métricas con el área seleccionada
                            if (data.test_cases_count > 0) {
                                updateMetrics('test_cases', data.test_cases_count, selectedArea);
                            }
                            
                            // Mostrar vista previa
                            displayTestsPreview(data);
                            
                            showDownloadNotification('Casos de prueba generados exitosamente', 'success');
                        } else {
                            const error = await response.json();
                            showDownloadNotification('Error: ' + (error.error || error.message || 'Error desconocido'), 'error');
                        }
                    } catch (error) {
                        showDownloadNotification('Error de conexión: ' + error.message, 'error');
                    } finally {
                        testsGenerateBtn.disabled = false;
                        testsGenerateBtn.innerHTML = '<i class="fas fa-eye"></i> Generar e Ir a Vista Previa';
                    }
                });
            }

            // Inicializar drag and drop
            setupTestsDropZone();

            // Funciones para modal de Jira (casos de prueba)
            function openJiraTestsModal() {
                const modal = document.getElementById('jira-upload-tests-modal');
                const projectSelect = document.getElementById('jira-tests-project-select');
                const casesCountEl = document.getElementById('jira-tests-modal-cases-count');
                
                if (!modal || !projectSelect) {
                    showDownloadNotification('Error: Modal de Jira no encontrado', 'error');
                    return;
                }

                // Actualizar contador
                if (casesCountEl && window.selectedTestsForUpload) {
                    casesCountEl.textContent = `${window.selectedTestsForUpload.length} casos seleccionados para subir`;
                }

                // Cargar proyectos de Jira
                loadJiraProjectsForTests();

                modal.style.display = 'flex';
            }

            function closeJiraTestsModal() {
                const modal = document.getElementById('jira-upload-tests-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
                // Limpiar campos y resetear pasos
                const projectSelect = document.getElementById('jira-tests-project-select');
                const assigneeInput = document.getElementById('jira-tests-assignee-input');
                const step1 = document.getElementById('jira-tests-step1');
                const step1_5 = document.getElementById('jira-tests-step1-5');
                const step2 = document.getElementById('jira-tests-step2');
                const validationResult = document.getElementById('jira-tests-validation-result');
                const validateBtn = document.getElementById('jira-tests-validate-fields-btn');
                const uploadBtn = document.getElementById('jira-tests-modal-upload');
                
                if (projectSelect) projectSelect.value = '';
                if (assigneeInput) assigneeInput.value = '';
                
                // Reiniciar selects de campos
                const selects = ['jira-tests-tipo-prueba-select', 'jira-tests-nivel-prueba-select', 
                                'jira-tests-tipo-ejecucion-select', 'jira-tests-ambiente-select'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.value = '';
                        select.innerHTML = '<option value="">Cargando valores...</option>';
                    }
                });
                
                // Ocultar mensajes
                const messages = ['jira-tests-tipo-prueba-message', 'jira-tests-nivel-prueba-message',
                                'jira-tests-tipo-ejecucion-message', 'jira-tests-ambiente-message'];
                messages.forEach(msgId => {
                    const msg = document.getElementById(msgId);
                    if (msg) {
                        msg.style.display = 'none';
                        msg.innerHTML = '';
                    }
                });
                
                if (step1) step1.style.display = 'block';
                if (step1_5) step1_5.style.display = 'none';
                if (step2) step2.style.display = 'none';
                if (validationResult) {
                    validationResult.style.display = 'none';
                    validationResult.innerHTML = '';
                }
                if (validateBtn) {
                    validateBtn.disabled = true;
                    validateBtn.innerHTML = '<span>🔍</span><span>Validar Campos</span>';
                }
                if (uploadBtn) uploadBtn.style.display = 'none';
                
                // Resetear variables de validación
                testsAssigneeAccountId = null;
                testsAssigneeValidated = false;
                testsAssigneeInvalid = false;
                const assigneeValidation = document.getElementById('jira-tests-assignee-validation');
                if (assigneeValidation) {
                    assigneeValidation.style.display = 'none';
                    assigneeValidation.innerHTML = '';
                }
            }

            async function loadJiraProjectsForTests() {
                const projectSelect = document.getElementById('jira-tests-project-select');
                const validateBtn = document.getElementById('jira-tests-validate-fields-btn');
                if (!projectSelect) return;

                try {
                    const response = await fetch('/api/jira/projects', {
                        headers: {
                            'X-CSRFToken': getCsrfToken()
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        projectSelect.innerHTML = '<option value="">Seleccionar proyecto...</option>';
                        if (data.projects && Array.isArray(data.projects)) {
                            data.projects.forEach(project => {
                                const option = document.createElement('option');
                                option.value = project.key;
                                option.textContent = `${project.name} (${project.key})`;
                                projectSelect.appendChild(option);
                            });
                        }
                        
                        // Habilitar botón de validar cuando se seleccione un proyecto
                        if (projectSelect) {
                            projectSelect.onchange = function() {
                                if (validateBtn) {
                                    validateBtn.disabled = !this.value;
                                }
                                // Resetear validación si cambia el proyecto
                                const validationResult = document.getElementById('jira-tests-validation-result');
                                const step1_5 = document.getElementById('jira-tests-step1-5');
                                const step2 = document.getElementById('jira-tests-step2');
                                const uploadBtn = document.getElementById('jira-tests-modal-upload');
                                if (validationResult) {
                                    validationResult.style.display = 'none';
                                    validationResult.innerHTML = '';
                                }
                                if (step1_5) step1_5.style.display = 'none';
                                if (step2) step2.style.display = 'none';
                                if (uploadBtn) uploadBtn.style.display = 'none';
                                
                                // Reiniciar selects de campos
                                const selects = ['jira-tests-tipo-prueba-select', 'jira-tests-nivel-prueba-select', 
                                                'jira-tests-tipo-ejecucion-select', 'jira-tests-ambiente-select'];
                                selects.forEach(selectId => {
                                    const select = document.getElementById(selectId);
                                    if (select) {
                                        select.value = '';
                                        select.innerHTML = '<option value="">Cargando valores...</option>';
                                    }
                                });
                                
                                // Ocultar mensajes
                                const messages = ['jira-tests-tipo-prueba-message', 'jira-tests-nivel-prueba-message',
                                                'jira-tests-tipo-ejecucion-message', 'jira-tests-ambiente-message'];
                                messages.forEach(msgId => {
                                    const msg = document.getElementById(msgId);
                                    if (msg) {
                                        msg.style.display = 'none';
                                        msg.innerHTML = '';
                                    }
                                });
                            };
                        }
                    }
                } catch (error) {
                    console.error('Error al cargar proyectos de Jira:', error);
                }
            }
            
            // Función para cargar valores de campos select
            async function loadTestCaseFieldValues(projectKey) {
                try {
                    const response = await fetch('/api/jira/get-test-case-field-values', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({ project_key: projectKey })
                    });
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        showDownloadNotification('Error al cargar valores de campos: ' + (data.error || 'Error desconocido'), 'error');
                        return;
                    }
                    
                    const fieldConfig = {
                        'tipo_prueba': {
                            select: 'jira-tests-tipo-prueba-select',
                            container: 'jira-tests-tipo-prueba-container',
                            message: 'jira-tests-tipo-prueba-message',
                            label: 'Tipo de Prueba'
                        },
                        'nivel_prueba': {
                            select: 'jira-tests-nivel-prueba-select',
                            container: 'jira-tests-nivel-prueba-container',
                            message: 'jira-tests-nivel-prueba-message',
                            label: 'Nivel de Prueba'
                        },
                        'tipo_ejecucion': {
                            select: 'jira-tests-tipo-ejecucion-select',
                            container: 'jira-tests-tipo-ejecucion-container',
                            message: 'jira-tests-tipo-ejecucion-message',
                            label: 'Tipo de Ejecución'
                        },
                        'ambiente': {
                            select: 'jira-tests-ambiente-select',
                            container: 'jira-tests-ambiente-container',
                            message: 'jira-tests-ambiente-message',
                            label: 'Ambiente'
                        }
                    };
                    
                    // Procesar cada campo
                    for (const [fieldKey, config] of Object.entries(fieldConfig)) {
                        const fieldData = data.field_values[fieldKey];
                        const selectEl = document.getElementById(config.select);
                        const containerEl = document.getElementById(config.container);
                        const messageEl = document.getElementById(config.message);
                        
                        if (!selectEl || !containerEl || !messageEl) continue;
                        
                        // Resetear
                        selectEl.innerHTML = '';
                        selectEl.removeAttribute('required');
                        messageEl.style.display = 'none';
                        messageEl.innerHTML = '';
                        
                        if (!fieldData || !fieldData.exists) {
                            // Campo no existe
                            containerEl.style.display = 'block';
                            selectEl.style.display = 'none';
                            messageEl.style.display = 'block';
                            messageEl.style.color = 'var(--warning)';
                            messageEl.innerHTML = `⚠️ El campo "${config.label}" no existe en este proyecto. Si realizas la carga ahora, este campo no se mostrará en los casos de prueba.`;
                        } else if (!fieldData.has_values || fieldData.values.length === 0) {
                            // Campo existe pero no tiene valores
                            containerEl.style.display = 'block';
                            selectEl.style.display = 'none';
                            messageEl.style.display = 'block';
                            messageEl.style.color = 'var(--warning)';
                            messageEl.innerHTML = `⚠️ El campo "${config.label}" existe pero no tiene opciones configuradas en el proyecto. Si realizas la carga ahora, este campo no se mostrará en los casos de prueba.`;
                        } else {
                            // Campo existe y tiene valores
                            containerEl.style.display = 'block';
                            selectEl.style.display = 'block';
                            selectEl.setAttribute('required', 'required');
                            selectEl.innerHTML = '<option value="">Seleccionar...</option>';
                            fieldData.values.forEach(val => {
                                const option = document.createElement('option');
                                option.value = val.value;
                                option.textContent = val.name || val.value;
                                selectEl.appendChild(option);
                            });
                        }
                    }
                    
                    // Configurar event listeners para los selects
                    setupSelectFieldsListeners();
                    
                    // Mostrar paso 1.5
                    const step1_5 = document.getElementById('jira-tests-step1-5');
                    if (step1_5) step1_5.style.display = 'block';
                    
                    // Verificar estado inicial después de cargar valores
                    setTimeout(() => {
                        checkAndShowUploadButton();
                    }, 100);
                    
                } catch (error) {
                    console.error('Error al cargar valores de campos:', error);
                    showDownloadNotification('Error al cargar valores de campos: ' + error.message, 'error');
                }
            }
            
            // Función para validar que todos los campos select requeridos estén llenos
            function validateSelectFields() {
                const requiredSelects = document.querySelectorAll('#jira-tests-step1-5 select[required]');
                for (let select of requiredSelects) {
                    if (!select.value || select.value.trim() === '') {
                        return false;
                    }
                }
                return true;
            }
            
            // Función para verificar y mostrar el botón de subir
            function checkAndShowUploadButton() {
                const step2 = document.getElementById('jira-tests-step2');
                const uploadBtn = document.getElementById('jira-tests-modal-upload');
                const assigneeInput = document.getElementById('jira-tests-assignee-input');
                
                // Verificar que todos los campos select requeridos estén llenos
                if (!validateSelectFields()) {
                    // Aún faltan campos - ocultar paso 2 y botón
                    if (step2) step2.style.display = 'none';
                    if (uploadBtn) uploadBtn.style.display = 'none';
                    return;
                }
                
                // Todos los campos select están llenos - mostrar paso 2
                if (step2) step2.style.display = 'block';
                
                // Verificar asignado
                const assigneeEmail = assigneeInput ? assigneeInput.value.trim() : '';
                if (assigneeEmail) {
                    // Si hay email, debe estar validado
                    if (testsAssigneeValidated && !testsAssigneeInvalid) {
                        if (uploadBtn) uploadBtn.style.display = 'flex';
                    } else {
                        if (uploadBtn) uploadBtn.style.display = 'none';
                    }
                } else {
                    // Si no hay email, mostrar botón directamente
                    if (uploadBtn) uploadBtn.style.display = 'flex';
                }
            }
            
            // Configurar event listeners para los campos select
            function setupSelectFieldsListeners() {
                const selects = ['jira-tests-tipo-prueba-select', 'jira-tests-nivel-prueba-select', 
                                'jira-tests-tipo-ejecucion-select', 'jira-tests-ambiente-select'];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        // Remover listeners anteriores si existen
                        const newSelect = select.cloneNode(true);
                        select.parentNode.replaceChild(newSelect, select);
                        
                        newSelect.addEventListener('change', function() {
                            checkAndShowUploadButton();
                        });
                    }
                });
            }
            
            // Función para validar campos del proyecto
            async function validateTestCaseFields() {
                const projectSelect = document.getElementById('jira-tests-project-select');
                const validateBtn = document.getElementById('jira-tests-validate-fields-btn');
                const validationResult = document.getElementById('jira-tests-validation-result');
                const step2 = document.getElementById('jira-tests-step2');
                const uploadBtn = document.getElementById('jira-tests-modal-upload');
                
                if (!projectSelect || !projectSelect.value) {
                    showDownloadNotification('Por favor selecciona un proyecto primero', 'error');
                    return;
                }
                
                if (validateBtn) {
                    validateBtn.disabled = true;
                    validateBtn.innerHTML = '<span>⏳</span><span>Validando...</span>';
                }
                
                try {
                    const response = await fetch('/api/jira/validate-test-case-fields', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            project_key: projectSelect.value
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (validateBtn) {
                        validateBtn.disabled = false;
                        validateBtn.innerHTML = '<span>🔍</span><span>Validar Campos</span>';
                    }
                    
                    if (validationResult) {
                        validationResult.style.display = 'block';
                        
                        if (data.success) {
                            // Campos válidos - cargar valores de campos select
                            validationResult.innerHTML = `
                                <div style="padding: 1rem; border-radius: 8px; background: rgba(16, 185, 129, 0.2); border: 1px solid var(--success); color: #6ee7b7;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span>✅</span>
                                        <span style="font-weight: 600;">Todos los campos necesarios están disponibles</span>
                                    </div>
                                    <div style="font-size: 0.85rem; margin-top: 0.5rem;">
                                        El proyecto cuenta con todos los campos requeridos para crear casos de prueba.
                                    </div>
                                </div>
                            `;
                            
                            // Cargar valores de campos select
                            await loadTestCaseFieldValues(projectSelect.value);
                            
                            // Ocultar paso 1, mostrar paso 1.5
                            const step1 = document.getElementById('jira-tests-step1');
                            if (step1) step1.style.display = 'none';
                            
                            // Ocultar paso 2 y botón de subir hasta que se llenen los campos select
                            if (step2) step2.style.display = 'none';
                            if (uploadBtn) uploadBtn.style.display = 'none';
                        } else {
                            // Campos faltantes
                            const missingFields = data.missing_fields || [];
                            const missingList = missingFields.map(f => {
                                const possibleNames = f.possible_names || [];
                                return `<li>${f.field} (posibles nombres: ${possibleNames.join(', ')})</li>`;
                            }).join('');
                            
                            validationResult.innerHTML = `
                                <div style="padding: 1rem; border-radius: 8px; background: rgba(239, 68, 68, 0.2); border: 1px solid var(--error); color: #fca5a5;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span>❌</span>
                                        <span style="font-weight: 600;">Campos faltantes en el proyecto</span>
                                    </div>
                                    <div style="font-size: 0.85rem; margin-top: 0.5rem; margin-bottom: 0.5rem;">
                                        ${data.message || 'El proyecto no cuenta con todos los campos necesarios.'}
                                    </div>
                                    <div style="font-size: 0.85rem; margin-top: 0.5rem;">
                                        <strong>Campos faltantes:</strong>
                                        <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                            ${missingList}
                                        </ul>
                                    </div>
                                    <div style="font-size: 0.85rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(239, 68, 68, 0.3);">
                                        Por favor, configura los campos faltantes en el proyecto de Jira antes de continuar.
                                    </div>
                                </div>
                            `;
                            
                            // Ocultar pasos
                            const step1_5 = document.getElementById('jira-tests-step1-5');
                            if (step1_5) step1_5.style.display = 'none';
                            if (step2) step2.style.display = 'none';
                            if (uploadBtn) uploadBtn.style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('Error al validar campos:', error);
                    if (validateBtn) {
                        validateBtn.disabled = false;
                        validateBtn.innerHTML = '<span>🔍</span><span>Validar Campos</span>';
                    }
                    showDownloadNotification('Error al validar campos: ' + error.message, 'error');
                }
            }

            // Event listeners del modal
            const testsModalClose = document.getElementById('jira-tests-modal-close');
            const testsModalCancel = document.getElementById('jira-tests-modal-cancel');
            const validateFieldsBtn = document.getElementById('jira-tests-validate-fields-btn');
            if (testsModalClose) testsModalClose.onclick = closeJiraTestsModal;
            if (testsModalCancel) testsModalCancel.onclick = closeJiraTestsModal;
            if (validateFieldsBtn) validateFieldsBtn.onclick = validateTestCaseFields;

            // Validación de asignado
            let testsAssigneeAccountId = null;
            let testsAssigneeValidated = false;
            let testsAssigneeInvalid = false;

            const testsAssigneeInput = document.getElementById('jira-tests-assignee-input');
            if (testsAssigneeInput) {
                testsAssigneeInput.onblur = async function() {
                    const email = this.value.trim();
                    const validationDiv = document.getElementById('jira-tests-assignee-validation');
                    
                    if (!email) {
                        testsAssigneeAccountId = null;
                        testsAssigneeValidated = false;
                        testsAssigneeInvalid = false;
                        if (validationDiv) {
                            validationDiv.style.display = 'none';
                        }
                        // Si no hay email, verificar si se puede mostrar el botón
                        checkAndShowUploadButton();
                        return;
                    }

                    // Validar formato de email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        if (validationDiv) {
                            validationDiv.style.display = 'block';
                            validationDiv.style.color = 'var(--error)';
                            validationDiv.textContent = '❌ Formato de email inválido';
                        }
                        testsAssigneeInvalid = true;
                        testsAssigneeValidated = false;
                        return;
                    }

                    // Validar con Jira
                    if (validationDiv) {
                        validationDiv.style.display = 'block';
                        validationDiv.style.color = 'var(--text-muted)';
                        validationDiv.textContent = '⏳ Validando...';
                    }

                    try {
                        const response = await fetch('/api/jira/validate-user', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken()
                            },
                            body: JSON.stringify({ email: email })
                        });

                        if (response.ok) {
                            const validateData = await response.json();
                            if (validateData.valid && validateData.accountId) {
                                testsAssigneeAccountId = validateData.accountId;
                                testsAssigneeValidated = true;
                                testsAssigneeInvalid = false;
                                if (validationDiv) {
                                    validationDiv.style.color = 'var(--success)';
                                    validationDiv.textContent = '✅ Usuario encontrado en Jira';
                                }
                                // Verificar si se puede mostrar el botón de subir
                                checkAndShowUploadButton();
                            } else {
                                testsAssigneeInvalid = true;
                                testsAssigneeValidated = false;
                                if (validationDiv) {
                                    validationDiv.style.color = 'var(--error)';
                                    validationDiv.textContent = '❌ ' + (validateData.error || 'Este correo no tiene cuenta en Jira');
                                }
                                // Ocultar botón si el asignado es inválido
                                const uploadBtn = document.getElementById('jira-tests-modal-upload');
                                if (uploadBtn) uploadBtn.style.display = 'none';
                            }
                        } else {
                            const validateData = await response.json();
                            testsAssigneeInvalid = true;
                            testsAssigneeValidated = false;
                            if (validationDiv) {
                                validationDiv.style.color = 'var(--error)';
                                validationDiv.textContent = '❌ ' + (validateData.error || 'Error al validar usuario');
                            }
                            // Ocultar botón si hay error
                            const uploadBtn = document.getElementById('jira-tests-modal-upload');
                            if (uploadBtn) uploadBtn.style.display = 'none';
                        }
                    } catch (error) {
                        if (validationDiv) {
                            validationDiv.style.color = 'var(--error)';
                            validationDiv.textContent = '❌ Error al validar usuario';
                        }
                        testsAssigneeInvalid = true;
                        testsAssigneeValidated = false;
                    }
                };
            }

            // Botón subir a Jira
            const testsModalUploadBtn = document.getElementById('jira-tests-modal-upload');
            if (testsModalUploadBtn) {
                testsModalUploadBtn.onclick = async function() {
                    const projectSelect = document.getElementById('jira-tests-project-select');
                    const assigneeInput = document.getElementById('jira-tests-assignee-input');
                    
                    if (!projectSelect || !projectSelect.value) {
                        showDownloadNotification('Por favor selecciona un proyecto de Jira', 'error');
                        return;
                    }

                    const projectKey = projectSelect.value;
                    const assigneeEmail = assigneeInput ? assigneeInput.value.trim() : '';
                    
                    // Obtener valores de campos select
                    const tipoPruebaSelect = document.getElementById('jira-tests-tipo-prueba-select');
                    const nivelPruebaSelect = document.getElementById('jira-tests-nivel-prueba-select');
                    const tipoEjecucionSelect = document.getElementById('jira-tests-tipo-ejecucion-select');
                    const ambienteSelect = document.getElementById('jira-tests-ambiente-select');
                    
                    const tipoPrueba = tipoPruebaSelect ? tipoPruebaSelect.value.trim() : '';
                    const nivelPrueba = nivelPruebaSelect ? nivelPruebaSelect.value.trim() : '';
                    const tipoEjecucion = tipoEjecucionSelect ? tipoEjecucionSelect.value.trim() : '';
                    const ambiente = ambienteSelect ? ambienteSelect.value.trim() : '';

                    // Validar asignado si se proporciona
                    if (assigneeEmail) {
                        if (testsAssigneeInvalid) {
                            showDownloadNotification('Por favor verifica que el email del asignado sea válido y tenga cuenta en Jira', 'error');
                            return;
                        } else if (!testsAssigneeValidated) {
                            // Intentar validar ahora
                            if (assigneeInput) {
                                assigneeInput.focus();
                                assigneeInput.blur();
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                
                                if (testsAssigneeInvalid || !testsAssigneeValidated) {
                                    showDownloadNotification('Por favor verifica que el email del asignado sea válido y tenga cuenta en Jira', 'error');
                                    return;
                                }
                            }
                        }
                    }

                    // Mostrar loading
                    const loadingOverlay = document.getElementById('tests-loading-overlay');
                    if (loadingOverlay) loadingOverlay.style.display = 'flex';

                    try {
                        const response = await fetch('/api/tests/upload-to-jira', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken()
                            },
                            body: JSON.stringify({
                                test_cases: window.selectedTestsForUpload,
                                project_key: projectKey,
                                assignee_email: assigneeEmail || null,
                                tipo_prueba: tipoPrueba,
                                nivel_prueba: nivelPrueba,
                                tipo_ejecucion: tipoEjecucion,
                                ambiente: ambiente
                            })
                        });

                        const data = await response.json();
                        
                        if (loadingOverlay) loadingOverlay.style.display = 'none';
                        closeJiraTestsModal();

                        if (data.success) {
                            showDownloadNotification(data.message || 'Casos de prueba subidos exitosamente a Jira', 'success');
                            
                            // Descargar archivo TXT si está disponible
                            if (data.txt_content && data.txt_filename) {
                                try {
                                    // Decodificar base64
                                    const txtContent = atob(data.txt_content);
                                    
                                    const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = data.txt_filename;
                                    document.body.appendChild(a);
                                    a.click();
                                    URL.revokeObjectURL(url);
                                    document.body.removeChild(a);
                                } catch (txtError) {
                                    console.error('Error al descargar TXT:', txtError);
                                }
                            }
                        } else {
                            showDownloadNotification('Error: ' + (data.error || 'No se pudieron subir los casos de prueba'), 'error');
                        }
                    } catch (error) {
                        if (loadingOverlay) loadingOverlay.style.display = 'none';
                        showDownloadNotification('Error de conexión: ' + error.message, 'error');
                    }
                };
            }
        })();

        // ============================================================================
        // FEEDBACK - Funcionalidad de Feedback
        // ============================================================================
        (function() {
            let selectedFeedbackIssueType = 'Bug';
            let selectedFeedbackProjectKey = '';
            let feedbackProjectLocked = false; // Variable para bloquear cambio de proyecto
            let feedbackAllProjects = []; // Almacenar todos los proyectos

            // Cargar TODOS los proyectos disponibles (reutiliza endpoint existente)
            function loadFeedbackProjects() {
                fetch('/api/jira/projects', {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.projects && data.projects.length > 0) {
                        feedbackAllProjects = data.projects;
                        renderFeedbackProjects(feedbackAllProjects);
                    } else {
                        showDownloadNotification(data.error || 'No hay proyectos disponibles', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error cargando proyectos:', error);
                    showDownloadNotification('Error al cargar proyectos: ' + error.message, 'error');
                });
            }

            // Renderizar proyectos en el dropdown
            function renderFeedbackProjects(projects) {
                const dropdown = document.getElementById('feedback-dropdown');
                if (!dropdown) return;

                dropdown.innerHTML = '';
                
                if (projects.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'combobox-option';
                    noResults.style.color = 'var(--text-muted)';
                    noResults.style.cursor = 'default';
                    noResults.textContent = 'No se encontraron proyectos';
                    dropdown.appendChild(noResults);
                    return;
                }
                
                projects.forEach(project => {
                    const option = document.createElement('div');
                    option.className = 'combobox-option';
                    option.textContent = `${project.name} (${project.key})`;
                    option.dataset.key = project.key;
                    option.dataset.name = project.name;
                    option.dataset.isNexus = project.key === 'NA';
                    
                    option.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        selectFeedbackProject(project.key, project.name);
                    });
                    
                    dropdown.appendChild(option);
                });
            }

            // Filtrar proyectos
            window.filterFeedbackProjects = function(searchTerm) {
                if (feedbackProjectLocked) return; // No permitir filtrar si está bloqueado
                
                const filtered = feedbackAllProjects.filter(project => 
                    project.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    project.key.toLowerCase().includes(searchTerm.toLowerCase())
                );
                renderFeedbackProjects(filtered);
            };

            // Mostrar dropdown
            window.showFeedbackDropdown = function() {
                if (feedbackProjectLocked) return; // No permitir abrir si está bloqueado
                
                const dropdown = document.getElementById('feedback-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'block';
                    
                    // Si ya hay proyectos cargados, mostrarlos
                    if (feedbackAllProjects.length > 0) {
                        renderFeedbackProjects(feedbackAllProjects);
                    }
                    // Si no, el mensaje "Cargando..." ya está en el HTML
                }
            };

            // Ocultar dropdown
            window.hideFeedbackDropdown = function() {
                setTimeout(() => {
                    const dropdown = document.getElementById('feedback-dropdown');
                    if (dropdown) dropdown.style.display = 'none';
                }, 200);
            };

            // Manejar teclas
            window.handleFeedbackKeydown = function(event) {
                if (feedbackProjectLocked) {
                    event.preventDefault();
                    return;
                }
                // Aquí puedes agregar navegación con flechas si lo deseas
            };

            // Mostrar notificación temporal de feedback
            function showFeedbackNotification(message, type = 'warning') {
                // Crear elemento de notificación
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'warning' ? 'rgba(245, 158, 11, 0.95)' : 'rgba(239, 68, 68, 0.95)'};
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                    z-index: 9999;
                    animation: slideIn 0.3s ease;
                    max-width: 400px;
                    font-size: 0.9rem;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // Auto-ocultar después de 3 segundos
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }, 3000);
            }

            // Seleccionar proyecto
            function selectFeedbackProject(projectKey, projectName) {
                if (feedbackProjectLocked && projectKey !== selectedFeedbackProjectKey) {
                    showFeedbackNotification('El proyecto ya ha sido seleccionado y no puede ser cambiado', 'warning');
                    return;
                }

                const input = document.getElementById('feedback-project-selector-input');
                const hiddenInput = document.getElementById('feedback-project-selector');
                
                // Verificar si es Nexus AI (NA)
                const isNexusAI = projectKey === 'NA';
                
                if (!isNexusAI) {
                    showFeedbackNotification('⚠️ Por favor, asegúrate de seleccionar el proyecto "Nexus AI (NA)" para enviar feedback', 'warning');
                    
                    if (input) input.value = '';
                    if (hiddenInput) hiddenInput.value = '';
                    return;
                }
                
                // Es Nexus AI, proceder
                if (input) input.value = `${projectName} (${projectKey})`;
                if (hiddenInput) hiddenInput.value = projectKey;
                
                // Validar proyecto
                validateFeedbackProject(projectKey);
            }

            // Validar proyecto
            function validateFeedbackProject(projectKey) {
                const input = document.getElementById('feedback-project-selector-input');
                
                // Mostrar indicador de validación
                if (input) {
                    input.style.opacity = '0.6';
                    input.value = input.value + ' ⏳ Validando...';
                }
                
                fetch('/api/feedback/validate-project', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ project_key: projectKey })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.valid) {
                        selectedFeedbackProjectKey = projectKey;
                        feedbackProjectLocked = true; // Bloquear cambio de proyecto
                        handleFeedbackProjectChange(true);
                        
                        // Deshabilitar el input visualmente
                        if (input) {
                            // Remover el mensaje de validación
                            const projectName = input.value.replace(' ⏳ Validando...', '');
                            input.value = projectName + ' ✓';
                            input.setAttribute('readonly', 'readonly');
                            input.style.opacity = '0.7';
                            input.style.cursor = 'not-allowed';
                        }
                        
                        showDownloadNotification('Proyecto validado correctamente. Ya puedes enviar tu feedback.', 'success');
                    } else {
                        showDownloadNotification(data.error || 'Proyecto no válido', 'error');
                        // Resetear selección
                        const hiddenInput = document.getElementById('feedback-project-selector');
                        if (input) {
                            input.value = '';
                            input.style.opacity = '1';
                        }
                        if (hiddenInput) hiddenInput.value = '';
                    }
                })
                .catch(error => {
                    console.error('Error validando proyecto:', error);
                    showDownloadNotification('Error al validar proyecto: ' + error.message, 'error');
                    // Resetear en caso de error
                    if (input) {
                        input.value = '';
                        input.style.opacity = '1';
                    }
                });
            }

            // Manejo de cambio de proyecto
            function handleFeedbackProjectChange(isValid) {
                const feedbackForm = document.getElementById('feedback-form');
                const noProjectMessage = document.getElementById('feedback-no-project-message');

                if (isValid) {
                    if (feedbackForm) feedbackForm.classList.remove('disabled');
                    if (noProjectMessage) noProjectMessage.style.display = 'none';
                } else {
                    if (feedbackForm) feedbackForm.classList.add('disabled');
                    if (noProjectMessage) noProjectMessage.style.display = 'block';
                }
            }

            // Selección de tipo de issue
            window.selectFeedbackIssueType = function(type) {
                selectedFeedbackIssueType = type;
                const buttons = document.querySelectorAll('.feedback-issue-type-btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                
                if (type === 'Bug') {
                    buttons[0].classList.add('active');
                } else {
                    buttons[1].classList.add('active');
                }
            };

            // Formato de texto
            window.formatFeedbackText = function(command) {
                document.execCommand(command, false, null);
                const editorContent = document.getElementById('feedback-editor-content');
                if (editorContent) editorContent.focus();
            };

            // Insertar enlace
            window.insertFeedbackLink = function() {
                const url = prompt('Ingresa la URL:');
                if (url) {
                    document.execCommand('createLink', false, url);
                }
            };

            // Insertar imagen
            window.insertFeedbackImage = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.maxWidth = '100%';
                        const editorContent = document.getElementById('feedback-editor-content');
                        if (editorContent) {
                            editorContent.appendChild(img);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Enviar feedback
            window.submitFeedback = async function() {
                const summary = document.getElementById('feedback-summary');
                const editorContent = document.getElementById('feedback-editor-content');

                if (!summary || !editorContent) return;

                const summaryValue = summary.value.trim();
                const descriptionValue = editorContent.innerHTML.trim();

                if (!summaryValue) {
                    showDownloadNotification('Por favor, ingresa un resumen para tu reporte', 'warning');
                    return;
                }

                if (!descriptionValue || descriptionValue === '<br>') {
                    showDownloadNotification('Por favor, ingresa una descripción para tu reporte', 'warning');
                    return;
                }

                // Mostrar indicador de carga
                const feedbackForm = document.getElementById('feedback-form');
                const loadingIndicator = document.getElementById('feedback-loading-indicator');
                if (feedbackForm) feedbackForm.style.display = 'none';
                if (loadingIndicator) loadingIndicator.classList.add('active');

                try {
                    const response = await fetch('/api/feedback/submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            project_key: selectedFeedbackProjectKey,
                            issue_type: selectedFeedbackIssueType,
                            summary: summaryValue,
                            description: descriptionValue
                        })
                    });

                    const data = await response.json();
                    
                    if (loadingIndicator) loadingIndicator.classList.remove('active');

                    if (data.success) {
                        const successMessage = document.getElementById('feedback-success-message');
                        const successText = document.getElementById('feedback-success-text');
                        
                        if (successMessage) successMessage.classList.add('active');
                        if (successText) {
                            successText.innerHTML = `Tu reporte ha sido creado como <strong>${data.issue_key}</strong>. <a href="${data.issue_url}" target="_blank" style="color: var(--accent); text-decoration: underline;">Ver en Jira</a>`;
                        }
                        
                        showDownloadNotification(data.message || 'Feedback enviado exitosamente', 'success');
                        resetFeedbackForm();
                        
                        // Ocultar mensaje de éxito después de 10 segundos
                        setTimeout(() => {
                            if (successMessage) successMessage.classList.remove('active');
                            if (feedbackForm) feedbackForm.style.display = 'block';
                        }, 10000);
                    } else {
                        if (feedbackForm) feedbackForm.style.display = 'block';
                        showDownloadNotification('Error: ' + (data.error || 'No se pudo enviar el feedback'), 'error');
                    }
                } catch (error) {
                    if (loadingIndicator) loadingIndicator.classList.remove('active');
                    if (feedbackForm) feedbackForm.style.display = 'block';
                    showDownloadNotification('Error de conexión: ' + error.message, 'error');
                }
            };

            // Resetear formulario
            window.resetFeedbackForm = function() {
                const summary = document.getElementById('feedback-summary');
                const editorContent = document.getElementById('feedback-editor-content');
                
                if (summary) summary.value = '';
                if (editorContent) editorContent.innerHTML = '';
                
                selectFeedbackIssueType('Bug');
            };

            // Inicializar cuando se muestra la sección de feedback
            const feedbackSection = document.getElementById('feedback');
            if (feedbackSection) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'class') {
                            if (feedbackSection.classList.contains('active')) {
                                loadFeedbackProjects();
                                
                                // Mostrar mensaje inicial
                                const noProjectMessage = document.getElementById('feedback-no-project-message');
                                if (noProjectMessage) noProjectMessage.style.display = 'block';
                            }
                        }
                    });
                });
                
                observer.observe(feedbackSection, { attributes: true });
            }
        })();
    </script>
</body>
</html>
