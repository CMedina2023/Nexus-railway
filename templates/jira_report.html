<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Jira - {{ project_key }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #0f172a;
            --secondary-bg: #1e293b;
            --card-bg: #1e293b;
            --accent: #3b82f6;
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        @page {
            size: A4 landscape;
            margin: 10mm;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            line-height: 1.3;
            padding: 0.5rem;
            page-break-inside: avoid;
        }

        .report-container {
            max-width: 100%;
            margin: 0 auto;
        }

        .report-header {
            text-align: center;
            margin-bottom: 0.75rem;
        }

        .report-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.25rem;
        }

        .report-date {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .kpi-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.6rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 70px;
        }

        .kpi-icon {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .kpi-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            line-height: 1.1;
        }

        .kpi-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
        }

        .middle-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .chart-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            page-break-inside: avoid;
        }

        .chart-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .chart-container {
            height: 180px;
            position: relative;
        }

        .tables-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 0.75rem;
            page-break-inside: avoid;
        }

        .table-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            page-break-inside: avoid;
        }

        .table-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .table-wrapper {
            display: flex;
            flex-direction: column;
        }

        .table-container {
            height: 200px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: var(--primary-bg);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .report-table th {
            background: var(--primary-bg);
            color: var(--text-primary);
            padding: 0.4rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.7rem;
            border-bottom: 2px solid var(--border);
        }

        .report-table td {
            padding: 0.4rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.7rem;
        }

        .report-table tr:last-child td {
            border-bottom: none;
        }

        .total-row {
            background: var(--primary-bg);
            font-weight: 600;
        }

        .total-row td {
            color: var(--text-primary);
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }

        .pagination-info {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .pagination-page {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="report-container">
        <div class="report-header">
            <h1 class="report-title">REPORTE DE JIRA - PROYECTO: {{ project_key }}</h1>
            <div class="report-date">Fecha: {{ date }}</div>
        </div>

        <!-- KPIs -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon">üìã</div>
                <div class="kpi-label">Total Test Cases</div>
                <div class="kpi-value">{{ report.total_test_cases or 0 }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">‚úÖ</div>
                <div class="kpi-label">% Successful Test Cases</div>
                <div class="kpi-value">{{ report.successful_test_cases_percentage or 0 }}%</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">üìä</div>
                <div class="kpi-label">Real Coverage</div>
                <div class="kpi-value">{{ report.real_coverage or 0 }}%</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">üêõ</div>
                <div class="kpi-label">Total Defects</div>
                <div class="kpi-value">{{ report.total_defects or 0 }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">üìà</div>
                <div class="kpi-label">Defect Rate</div>
                <div class="kpi-value">{{ report.defect_rate or 0 }}%</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">üîì</div>
                <div class="kpi-label">Open Defects</div>
                <div class="kpi-value">{{ report.open_defects or 0 }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">üîí</div>
                <div class="kpi-label">Closed Defects</div>
                <div class="kpi-value">{{ report.closed_defects or 0 }}</div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="middle-section">
            <div class="chart-card">
                <div class="chart-title">CASOS DE PRUEBA POR STATUS</div>
                <div class="chart-container">
                    {% if chart_images.test_cases %}
                    <img src="{{ chart_images.test_cases }}" alt="Gr√°fico de Test Cases" style="width: 100%; height: 100%; object-fit: contain;">
                    {% else %}
                    <canvas id="test-cases-chart"></canvas>
                    {% endif %}
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">BUGS POR SEVERIDAD (Abiertos)</div>
                <div class="chart-container">
                    {% if chart_images.bugs_severity %}
                    <img src="{{ chart_images.bugs_severity }}" alt="Gr√°fico de Bugs" style="width: 100%; height: 100%; object-fit: contain;">
                    {% else %}
                    <canvas id="bugs-severity-chart"></canvas>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tablas -->
        <div class="tables-section">
            <div class="table-card">
                <div class="table-title"># Casos de prueba por persona</div>
                <div class="table-wrapper">
                    <div class="table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Asignado</th>
                                    <th>Exitoso</th>
                                    <th>En Progreso</th>
                                    <th>Fallado</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if test_cases_data %}
                                    {% for item in test_cases_data %}
                                    <tr>
                                        <td>{{ item.person or 'Sin asignar' }}</td>
                                        <td>{{ item.exitoso or 0 }}</td>
                                        <td>{{ item.en_progreso or 0 }}</td>
                                        <td>{{ item.fallado or 0 }}</td>
                                        <td>{{ item.total or 0 }}</td>
                                    </tr>
                                    {% endfor %}
                                    <tr class="total-row">
                                        <td><strong>Total</strong></td>
                                        <td><strong>{{ test_cases_totals.exitoso or 0 }}</strong></td>
                                        <td><strong>{{ test_cases_totals.en_progreso or 0 }}</strong></td>
                                        <td><strong>{{ test_cases_totals.fallado or 0 }}</strong></td>
                                        <td><strong>{{ test_cases_totals.total or 0 }}</strong></td>
                                    </tr>
                                {% else %}
                                    <tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No hay datos disponibles</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination">
                        <div class="pagination-info">
                            Mostrando {{ test_cases_pagination.start_item }}-{{ test_cases_pagination.end_item }} de {{ test_cases_pagination.total_items }} registros
                        </div>
                        <div class="pagination-page">
                            P√°gina {{ test_cases_pagination.current_page }} de {{ test_cases_pagination.total_pages }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-card">
                <div class="table-title"># Defectos por Persona</div>
                <div class="table-wrapper">
                    <div class="table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Asignado</th>
                                    <th>Status</th>
                                    <th>Summary</th>
                                    <th>Severity</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if defects_data %}
                                    {% for item in defects_data %}
                                    <tr>
                                        <td>{{ item.key or '-' }}</td>
                                        <td>{{ item.assignee or 'Sin asignar' }}</td>
                                        <td>{{ item.status or '-' }}</td>
                                        <td>{{ item.summary or '-' }}</td>
                                        <td>{{ item.severity or '-' }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No hay datos disponibles</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination">
                        <div class="pagination-info">
                            Mostrando {{ defects_pagination.start_item }}-{{ defects_pagination.end_item }} de {{ defects_pagination.total_items }} registros
                        </div>
                        <div class="pagination-page">
                            P√°gina {{ defects_pagination.current_page }} de {{ defects_pagination.total_pages }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widgets Personalizados -->
        {% if active_widgets and active_widgets|length > 0 %}
        <div style="margin-top: 0.75rem;">
            {% for widget_id in active_widgets %}
                {% if widget_data.get(widget_id) %}
                    {% set widget = widget_data[widget_id] %}
                    
                    {% if widget.type == 'kpi' %}
                        <!-- KPI Widget -->
                        <div class="kpi-card" style="margin-bottom: 0.5rem;">
                            <div class="kpi-icon">{{ widget.icon }}</div>
                            <div class="kpi-label">{{ widget.title }}</div>
                            <div class="kpi-value">{{ widget.value }}</div>
                        </div>
                    {% elif widget.type == 'chart' %}
                        <!-- Chart Widget -->
                        <div class="chart-card" style="margin-bottom: 0.75rem;">
                            <div class="chart-title">{{ widget.title|upper }}</div>
                            <div class="chart-container">
                                {% if widget_chart_images.get(widget_id) %}
                                <img src="{{ widget_chart_images[widget_id] }}" alt="{{ widget.title }}" style="width: 100%; height: 100%; object-fit: contain;">
                                {% else %}
                                <div style="height: 180px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                                    Gr√°fico: {{ widget.title }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% elif widget.type == 'table' %}
                        <!-- Table Widget -->
                        <div class="table-card" style="margin-bottom: 0.75rem;">
                            <div class="table-title"># {{ widget.title }}</div>
                            <div class="table-wrapper">
                                <div class="table-container">
                                    <table class="report-table">
                                        <thead>
                                            <tr>
                                                {% for col in widget.columns %}
                                                <th>{{ col }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% if widget.rows %}
                                                {% for row in widget.rows %}
                                                <tr>
                                                    {% for cell in row %}
                                                    <td>{{ cell }}</td>
                                                    {% endfor %}
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr>
                                                    <td colspan="{{ widget.columns|length }}" style="text-align: center; color: var(--text-muted);">
                                                        No hay datos disponibles
                                                    </td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
</body>
</html>

