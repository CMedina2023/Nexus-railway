# ğŸ› ï¸ PATRONES DE DESARROLLO Y REGLAS PARA AGENTES - NEXUS AI

> **PropÃ³sito**: Este documento es la "ConstituciÃ³n TÃ©cnica" de Nexus AI. Define reglas estrictas y detalladas que cualquier desarrollador (humano o AGENTE AI) debe seguir sin excepciÃ³n para asegurar la integridad, seguridad y escalabilidad del sistema.

**VersiÃ³n**: 3.0 (Detallada)  
**Ãšltima actualizaciÃ³n**: 2025-12-21

---

## ğŸ“‹ REGLAS GENERALES PARA EL AGENTE
1. **No asumas, valida**: Antes de modificar cÃ³digo, lee los docstrings y las interfaces de los servicios existentes.
2. **Proactividad controlada**: Si detectas una brecha de seguridad (ej. falta de sanitizaciÃ³n), corrÃ­gela e infÃ³rmalo.
3. **PreservaciÃ³n de Estilo**: No mezcles `camelCase` con `snake_case` en el mismo lenguaje (Python: snake, JS: camel).
4. **DocumentaciÃ³n Obligatoria**: Cada nueva funciÃ³n DEBE incluir docstring en formato Google Style.

---

## ğŸ“ LÃMITES ESTRICTOS DE TAMAÃ‘O DE ARCHIVOS

**REGLA CRÃTICA**: NingÃºn archivo debe exceder los lÃ­mites establecidos. Si un archivo alcanza el 80% del lÃ­mite, DEBE refactorizarse INMEDIATAMENTE antes de agregar mÃ¡s cÃ³digo.

### LÃ­mites por Tipo de Archivo

| Tipo | LÃ­mite MÃ¡ximo | LÃ­mite Recomendado | AcciÃ³n al 80% |
|------|---------------|-------------------|---------------|
| **Python (.py)** | 400 lÃ­neas | 300 lÃ­neas | Dividir en mÃ³dulos |
| **JavaScript (.js)** | 400 lÃ­neas | 300 lÃ­neas | Dividir en mÃ³dulos |
| **CSS (.css)** | 200 lÃ­neas | 150 lÃ­neas | Modularizar componentes |
| **HTML (.html)** | 300 lÃ­neas | 200 lÃ­neas | Extraer partials |
| **JSON (.json)** | 500 lÃ­neas | 300 lÃ­neas | Dividir configuraciÃ³n |
| **Markdown (.md)** | 800 lÃ­neas | 600 lÃ­neas | Dividir en secciones |

### LÃ­mites por FunciÃ³n/MÃ©todo

- **MÃ¡ximo absoluto**: 80 lÃ­neas
- **Recomendado**: 25-30 lÃ­neas
- **Ideal**: 15-20 lÃ­neas
- **Complejidad ciclomÃ¡tica**: MÃ¡ximo 10

### Acciones Obligatorias al Detectar Violaciones

**Si encuentras un archivo que excede el lÃ­mite:**
1. âœ… **DETENER** inmediatamente cualquier adiciÃ³n de cÃ³digo
2. âœ… **INFORMAR** al usuario sobre la violaciÃ³n
3. âœ… **PROPONER** un plan de refactorizaciÃ³n antes de continuar
4. âœ… **NO AGREGAR** mÃ¡s cÃ³digo hasta que se refactorice

**Si necesitas agregar cÃ³digo a un archivo cercano al lÃ­mite (>80%):**
1. âœ… Primero refactoriza el archivo existente
2. âœ… Divide en mÃ³dulos especializados
3. âœ… Luego agrega el nuevo cÃ³digo al mÃ³dulo apropiado

---

## ğŸš« NOMBRES GENÃ‰RICOS PROHIBIDOS

**REGLA ABSOLUTA**: Los siguientes nombres de archivo estÃ¡n PROHIBIDOS porque atraen cÃ³digo sin estructura y violan SRP:

### Archivos Python Prohibidos
- âŒ `helpers.py` â†’ Usar nombres especÃ­ficos: `text_normalizer.py`, `date_formatter.py`
- âŒ `utils.py` â†’ Usar nombres especÃ­ficos: `string_utils.py`, `validation_utils.py`
- âŒ `common.py` â†’ Usar nombres especÃ­ficos segÃºn responsabilidad
- âŒ `misc.py` â†’ Usar nombres especÃ­ficos segÃºn responsabilidad
- âŒ `tools.py` â†’ Usar nombres especÃ­ficos segÃºn responsabilidad
- âŒ `functions.py` â†’ Usar nombres especÃ­ficos segÃºn responsabilidad
- âŒ `manager.py` â†’ Usar nombres especÃ­ficos: `user_manager.py`, `session_manager.py`

### Archivos JavaScript Prohibidos
- âŒ `helpers.js` â†’ Usar nombres especÃ­ficos: `formatters.js`, `validators.js`
- âŒ `utils.js` â†’ Usar nombres especÃ­ficos: `dom-utils.js`, `api-utils.js`
- âŒ `common.js` â†’ Usar nombres especÃ­ficos segÃºn responsabilidad
- âŒ `misc.js` â†’ Usar nombres especÃ­ficos segÃºn responsabilidad
- âŒ `tools.js` â†’ Usar nombres especÃ­ficos segÃºn responsabilidad
- âŒ `functions.js` â†’ Usar nombres especÃ­ficos segÃºn responsabilidad

### Nombres de Funciones Prohibidos
- âŒ `process_data()` â†’ Usar nombres especÃ­ficos: `parse_csv_data()`, `validate_user_input()`
- âŒ `handle_request()` â†’ Usar nombres especÃ­ficos: `create_user_account()`, `update_profile()`
- âŒ `do_something()` â†’ Usar nombres especÃ­ficos segÃºn la acciÃ³n real
- âŒ `manage_stuff()` â†’ Usar nombres especÃ­ficos segÃºn la responsabilidad

### Alternativas Correctas

**En lugar de `helpers.py`:**
```python
# âœ… CORRECTO: Nombres especÃ­ficos por responsabilidad
text_normalizer.py      # NormalizaciÃ³n de texto
date_formatter.py       # Formateo de fechas
email_validator.py      # ValidaciÃ³n de emails
currency_converter.py   # ConversiÃ³n de monedas
```

**En lugar de `utils.js`:**
```javascript
// âœ… CORRECTO: Nombres especÃ­ficos por responsabilidad
dom-manipulator.js      // ManipulaciÃ³n del DOM
api-client.js          // Cliente HTTP
form-validator.js      // ValidaciÃ³n de formularios
date-formatter.js      // Formateo de fechas
```

### Regla de Nomenclatura

**Formato obligatorio para nombres de archivo:**
- Debe describir **QUÃ‰ hace** o **QUÃ‰ contiene**
- Debe ser **especÃ­fico** y **descriptivo**
- Debe seguir el patrÃ³n: `[sustantivo]_[verbo/acciÃ³n].extensiÃ³n`
- Ejemplos: `user_authenticator.py`, `invoice_generator.js`, `email_sender.py`

**Si no puedes pensar en un nombre especÃ­fico:**
- âŒ NO uses un nombre genÃ©rico
- âœ… Pregunta al usuario o revisa la responsabilidad del cÃ³digo
- âœ… Si el cÃ³digo hace mÃºltiples cosas, divÃ­delo primero

---

## 1. ğŸ“ ARQUITECTURA DETALLADA (SOLID & PATTERNS)

### Principios de ImplementaciÃ³n de CÃ³digo
Cualquier fragmento de cÃ³digo debe pasar la prueba "SOLID":

*   **SRP (Single Responsibility)**: Las funciones no deben superar las 25 lÃ­neas. Si una funciÃ³n hace "A y luego B", debe dividirse en `_process_A()` y `_process_B()`.
*   **DIP (Dependency Inversion)**: NUNCA instancies clases pesadas dentro de un constructor. Usa inyecciÃ³n.
    ```python
    # âœ… REGLA: InyecciÃ³n de Dependencias
    class JiraReporter:
        def __init__(self, api_client: JiraClientProtocol): # Usa Protocolos o ABCs
            self.client = api_client
    ```

### Patrones Obligatorios
*   **Factory**: Usa fÃ¡bricas para instanciar generadores AI segÃºn el modelo (Gemini, OpenAI, etc.).
*   **Strategy**: Si el algoritmo de extracciÃ³n de datos varÃ­a segÃºn el tipo de archivo (PDF, CSV), implementa una `ExtractionStrategy`.

---

## 2. ğŸ›¡ï¸ SEGURIDAD TÃ‰CNICA (BASADO EN OWASP WSTG v4.2)

El Agente debe aplicar estas reglas en cada commit:

### A. PrevenciÃ³n de InyecciÃ³n (WSTG-INPV)
*   **Prohibido**: `f"SELECT * FROM users WHERE id = {user_id}"`.
*   **Obligatorio**: Uso de parÃ¡metros vinculados o SQLAlchemy ORM.
*   **SanitizaciÃ³n JS**: En el frontend, usa `textContent` en lugar de `innerHTML` para datos que provienen del usuario.

### B. GestiÃ³n de Secretos y ConfiguraciÃ³n (WSTG-CONF)
*   **Regla de Oro**: NUNCA hardcodees credenciales.
*   **ValidaciÃ³n**: Antes de subir cÃ³digo, el Agente debe verificar que no existan strings que parezcan API Keys (`sk-...`, `AIza...`).
*   **Entorno**: Usa la clase `Config` centralizada en `app/core/config.py`.

### C. Headers de Seguridad
Cada respuesta de API debe incluir:
*   `X-Content-Type-Options: nosniff`
*   `X-Frame-Options: DENY` (Previene Clickjacking)
*   `Content-Security-Policy`: Restringir a dominios conocidos.

---

## 3. ğŸ—ï¸ ESTRUCTURA DE MICROSERVICIOS (ANTIMONOLITO)

Nexus AI opera bajo una filosofÃ­a de **SoberanÃ­a de Servicio**:

### Reglas para Nuevos MÃ³dulos:
1.  **Aislamiento de Datos**: Un servicio NO puede leer la base de datos de otro. Debe solicitar los datos vÃ­a API REST.
2.  **Stateless**: Los servicios no deben guardar estado local. Usa Redis o la DB para persistencia.
3.  **Contratos API**: Antes de implementar la lÃ³gica, define el esquema JSON (Request/Response).
4.  **Estructura de Carpeta por Servicio**:
    ```text
    /services/nombre-servicio/
    â”œâ”€â”€ domain/         # Modelos y lÃ³gica pura
    â”œâ”€â”€ infrastructure/ # Conexiones externas, DB, APIs
    â”œâ”€â”€ application/    # Casos de uso y orquestaciÃ³n
    â””â”€â”€ api/            # Endpoints y Serializadores
    ```

---

## 4. âœ… BUENAS PRÃCTICAS DE DESARROLLO (DETALLE TÃ‰CNICO)

### Nomenclatura Estricta
*   **Clases**: `PascalCase` (ej. `DocumentProcessor`).
*   **Variables/Funciones Python**: `snake_case` (ej. `get_user_data`).
*   **Variables/Funciones JS**: `camelCase` (ej. `handleFileUpload`).
*   **Archivos**: `snake_case` (ej. `auth_middleware.py`).

### Manejo de Errores (Error Handling)
*   **No usar Try-Except GenÃ©rico**: `except Exception:` estÃ¡ prohibido a menos que se haga re-raise o logging crÃ­tico.
*   **Custom Exceptions**: Define excepciones en `app/utils/exceptions.py`.
    ```python
    class NexusSecurityError(Exception):
        """Error especÃ­fico para violaciones de reglas de seguridad"""
    ```

### Logging y Trazabilidad
*   Cada log debe incluir un `correlation_id` para seguir la traza entre microservicios.
*   Log Levels:
    *   `DEBUG`: Variables internas, payloads de entrada.
    *   `INFO`: Inicio/Fin de procesos importantes.
    *   `ERROR`: Fallos controlados que requieren atenciÃ³n.

### Checklist para el Agente AI antes de entregar:
- [ ] Â¿He aplicado `type hints` en todas las firmas de funciones?
- [ ] Â¿He verificado que no hay lÃ³gica de negocio en el archivo `app.py` (debe estar en `/services`)?
- [ ] Â¿He aÃ±adido un test unitario bÃ¡sico para la lÃ³gica nueva?
- [ ] Â¿He sanitizado los inputs que vienen del cliente?
- [ ] Â¿El cÃ³digo es legible para un humano sin necesidad de comentarios excesivos?

---

**Cualquier desviaciÃ³n de estas reglas serÃ¡ considerada un "Bug de Arquitectura" y debe ser corregida prioritariamente.**